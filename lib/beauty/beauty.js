!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Mars=t():e.Mars=t()}("undefined"==typeof window?global:window,(function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="dev/",n(n.s=47)}([function(e,t,n){"use strict";function i(e){for(var t=arguments,n=function(n){var i=t[n];i&&Object.keys(i).forEach((function(t){e[t]=i[t]}))},i=1;i<arguments.length;i++)n(i);return e}function r(e,t){if("string"==typeof e){var n=e;e=new Image,t||/^data:/.test(n)||(e.crossOrigin="*"),e.src=n}return e.complete?Promise.resolve(e):new Promise((function(t,n){e.onload=function(){return e.onload=null,t(e)},e.onerror=function(t){return e.onerror=null,n(t)}}))}function a(e,t){var n=e.indexOf(t);if(n>-1)return e.splice(n,1),!0}function o(e,t){if(-1===e.indexOf(t))return e.push(t),!0}function s(e,t,n){if(c(e))if(void 0===n&&(n=e),e instanceof Array||"length"in e)Array.prototype.slice.call(e).forEach(t,n);else for(var i in e)e.hasOwnProperty(i)&&t.call(n,e[i],i);return e}function u(e){return"function"==typeof e}function c(e){return"object"==typeof e&&e}function l(e){return"string"==typeof e}function f(){}function h(e,t){if(e.fill)e.fill(t);else for(var n=0;n<e.length;n++)e[n]=t;return e}function d(e,t){return e+Math.random()*(t-e)}function _(e,t){var n=Math.floor(Math.random()*e.length),i=e[n];return t||e.splice(n,1),i}function p(e,t){return t=t||{},new Promise((function(n,i){var r=new XMLHttpRequest;r.responseType=t.responseType||"json",r.addEventListener("load",(function(){return n(r.response)})),r.addEventListener("error",i),r.open(t.method||"get",e),r.send(t.data)}))}function m(e){return e===parseInt(e,10)}n.d(t,"k",(function(){return i})),n.d(t,"i",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return o})),n.d(t,"d",(function(){return s})),n.d(t,"e",(function(){return u})),n.d(t,"g",(function(){return c})),n.d(t,"h",(function(){return l})),n.d(t,"j",(function(){return f})),n.d(t,"b",(function(){return h})),n.d(t,"l",(function(){return d})),n.d(t,"m",(function(){return _})),n.d(t,"n",(function(){return p})),n.d(t,"f",(function(){return m})),Array.prototype.find||(Array.prototype.find=function(e,t){for(var n=t||this,i=0;i<this.length;i++){var r=this[i];if(e.call(n,r,i))return r}},Array.prototype.findIndex=function(e,t){for(var n=t||this,i=0;i<this.length;i++){var r=this[i];if(e.call(n,r,i))return i}})},function(e,t,n){"use strict";n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return u})),n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return m})),n.d(t,"c",(function(){return O}));var i=n(0),r=n(7);function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function o(e){return Array.isArray(e)&&Object(i.h)(e[0])?e[1]:e}var s={random:function(e){return e[0]instanceof Array?new d(e):new h(e)},static:function(e){return new l(e)},constant:function(e){return new l(e)},curve:function(e){return new m(e)},linear:function(e){return new _(e)},randomSet:function(e){return new f(e)},color:function(e){return new l(Object(r.b)(e,!0))},colors:function(e){return new f(e.map((function(e){return Object(r.b)(e,!0)})))},lines:function(e){return 2===e.length&&0===e[0][0]&&1===e[1][0]?new _([e[0][1],e[1][1]]):new v(e)},gradient:function(e){return new p(e)},path:function(e){return new g(e)},bezier:function(e){return new y(e)}};function u(e){return e&&isNaN(+e)?s[e[0]](e[1]):new l(e||0)}var c=function(){function e(e){this.onCreate(e)}var t=e.prototype;return t.onCreate=function(e){throw Error("not_implement")},t.getIntegrateValue=function(e,t,n){throw Error("not_implement")},t.getIntegrateByTime=function(e,t){throw Error("not_implement")},t.getValue=function(e){throw Error("not_implement")},t.toUniform=function(e){throw Error("not_implement")},t.map=function(e){throw Error("not_implement")},t.scaleXCoord=function(e){return this},e}(),l=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this._value=e},n.getIntegrateValue=function(e,t,n){return this._value*(t-e)},n.getIntegrateByTime=function(e,t){return.5*this._value*(t*t-e*e)},n.getValue=function(e){return this._value},n.toUniform=function(e){return new Float32Array([0,this._value,0,0])},n.map=function(e){var t=this._value;return this._value=t instanceof Array?t.map(e):e(t),this},t}(c),f=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this._items=e},n.getValue=function(e){var t=this._items;return t[Math.floor(Math.random()*t.length)]},n.map=function(e){return this._items=this._items.map(e),this},t}(c),h=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this._min=e[0],this._max=e[1]},n.getValue=function(e){return Object(i.l)(this._min,this._max)},n.toUniform=function(e){return new Float32Array([4,this._min,this._max,0])},n.map=function(e){return this._min=e(this._min),this._max=e(this._max),this},t}(c),d=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this._min=e[0],this._max=e[1]},n.getValue=function(e){for(var t=this._min,n=this._max,i=[],r=0;r<t.length;r++){var a=Math.random();i[r]=t[r]*(1-a)+n[r]*a}return i},n.map=function(e){return this._min=this._min.map(e),this._max=this._max.map(e),this},t}(c),_=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this._min=e[0],this._max=e[1],this._xCoord=1},n.getValue=function(e){return e/=this._xCoord,this._min*(1-e)+this._max*e},n.toUniform=function(){return new Float32Array([1,this._min,this._max,this._xCoord])},n.getIntegrateValue=function(e,t,n){var i=this._min,r=this._max,a=this._xCoord*(n||1);return((i+t/a*(r-i)+i)*t-(i+e/a*(r-i)+i)*e)/2},n.getIntegrateByTime=function(e,t){return T(t,0,this._xCoord,this._min,this._max)-T(e,0,this._xCoord,this._min,this._max)},n.map=function(e){return this._min=e(this._min),this._max=e(this._max),this},n.scaleXCoord=function(e){return this._xCoord=e,this},t}(c),p=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this.stops=Object(r.a)(e,!0)},n.getValue=function(e){for(var t=this.stops,n=t.length-1,i=0;i<n;i++){var a=t[i],o=t[i+1];if(a.stop<=e&&o.stop>e){var s=(e-a.stop)/(o.stop-a.stop);return Object(r.f)(a.color,o.color,s,!0)}}return n.color.slice()},t}(c),m=function(e){function t(){return e.apply(this,arguments)||this}a(t,e),t.getAllData=function(e){for(var t=new Float32Array(4*e.index),n=0,i=0,r=e.curves;n<r.length;n++){var a=r[n].toData();t.set(a,i),i+=a.length}return t};var n=t.prototype;return n.onCreate=function(e){this.keys=e.map((function(e){if(e instanceof Array)return e.slice(0,4);if(Object(i.g)(e))return[e.time,e.value,e.inTangent||0,e.outTangent||0];throw Error("invalid keyframe")})).sort((function(e,t){return e[0]-t[0]})),this.isCurveValue=!0},n.getValue=function(e){var t=this.keys;if(e<=t[0][0])return t[0][1];for(var n=t.length-1,i=0;i<n;i++){var r=t[i],a=t[i+1];if(e>r[0]&&e<=a[0])return b(e,r,a)}return t[n][1]},n.getIntegrateByTime=function(e,t){return this._integrate(t,!0)-this._integrate(e,!0)},n.getIntegrateValue=function(e,t,n){return n=n||1,(this._integrate(t/n,!1)-this._integrate(e/n,!1))*n},n._integrate=function(e,t){var n=this.keys;if(e<=n[0][0])return 0;for(var i=0,r=n.length-1,a=t?A:E,o=0;o<r;o++){var s=n[o],u=n[o+1],c=s[0],l=u[0];if(e>c&&e<=l)return i+a(e,s,u);i+=a(l,s,u)}return i},n.toData=function(){for(var e=this.keys,t=new Float32Array(4*e.length),n=0,i=0;n<e.length;n++,i+=4)t.set(e[n],i);return t},n.toUniform=function(e){var t=e.index,n=this.keys;return e.curves.push(this),e.index+=n.length,e.max=Math.max(e.max,n.length),e.curveCount+=n.length,new Float32Array([2,t,n.length,0])},n.map=function(e){return this.keys.forEach((function(t){t[1]=e(t[1])})),this},n.scaleXCoord=function(e){return this.keys.forEach((function(t){return t[0]=e*t[0]})),this},t}(c),v=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this.keys=e.map((function(e){return e.slice?e.slice(0,2):[e.time,e.value]})).sort((function(e,t){return e[0]-t[0]})),this.isLineSeg=!0},n.getValue=function(e){var t=this.keys;if(e<t[0][0])return t[0][1];for(var n=t.length-1,i=0;i<n;i++){var r=t[i],a=t[i+1],o=r[0],s=a[0];if(e>=o&&e<=s){var u=(e-o)/(s-o),c=r[1];return c+u*(a[1]-c)}}return t[n][1]},n.getIntegrateValue=function(e,t,n){return this._integrate(t,!1,n)-this._integrate(e,!1,n)},n.getIntegrateByTime=function(e,t){return this._integrate(t,!0)-this._integrate(e,!0)},n._integrate=function(e,t,n){var i=this.keys;if(e<=i[0][0])return 0;n=n||1;for(var r=0,a=i.length-1,o=t?T:x,s=0;s<a;s++){var u=i[s],c=i[s+1],l=u[0]*n,f=c[0]*n;if(e>l&&e<=f)return r+o(e,l,f,u[1],c[1]);r+=o(f,l,f,u[1],c[1])}return r},n.toData=function(){for(var e=this.keys,t=new Float32Array(4*Math.ceil(e.length/2)),n=0,i=0;n<e.length;n++,i+=2)t.set(e[n],i);return t.set(e[e.length-1],t.length-2),t},n.toUniform=function(e){var t=e.index,n=this.keys,i=Math.ceil(n.length/2);return e.lineSegCount+=i,e.curves.push(this),e.index+=i,e.max=Math.max(e.max,i),new Float32Array([3,t,i,0])},n.map=function(e){return this.keys.forEach((function(t){return t[1]=e(t[1])})),this},n.scaleXCoord=function(e){return this.keys.forEach((function(t){return t[0]=e*t[0]})),this},t}(c),g=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(e){this.keys=e[0],this.values=e[1]},n.getValue=function(e){for(var t=this.keys,n=this.values,i=0;i<t.length-1;i++){var r=t[i],a=t[i+1];if(r[0]<=e&&a[0]>=e){var o=(b(e,r,a)-r[1])/(a[1]-r[1]);return this._calculateVec(i,o)}}return e<=0?n[0].slice():n[n.length-1].slice()},n._calculateVec=function(e,t){for(var n=this.values[e],i=this.values[e+1],r=[],a=0;a<n.length;a++)r[a]=n[a]*(1-t)+i[a]*t;return r},t}(c),y=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.onCreate=function(t){e.prototype.onCreate.call(this,t),this.cps=t[2]},n._calculateVec=function(e,t){for(var n=this.values[e],i=this.values[e+1],r=this.cps[e+e],a=this.cps[e+e+1],o=[],s=1-t,u=s*s*s,c=3*t*s*s,l=3*t*t*s,f=t*t*t,h=0;h<n.length;h++)o[h]=u*n[h]+c*r[h]+l*a[h]+f*i[h];return o},t}(g);function x(e,t,n,i,r){var a=e-t;return(i+i+(r-i)*a/(n-t))*a/2}function T(e,t,n,i,r){var a=e*e,o=t*t;return(2*(a*e)*(i-r)+3*a*(t*r-n*i)-o*t*(2*i+r)+3*o*n*i)/(6*(t-n))}function b(e,t,n){var i=n[0]-t[0],r=t[3]*i,a=n[2]*i,o=(e-t[0])/i,s=o*o,u=s*o,c=u-2*s+o,l=u-s,f=-2*u+3*s;return(2*u-3*s+1)*t[1]+c*r+l*a+f*n[1]}function E(e,t,n){var i=n[0]-t[0],r=t[3]*i,a=n[2]*i,o=t[0],s=t[1],u=n[1],c=o-e,l=c*c,f=l*c;return(r+a+2*s-2*u)*f*c/(4*i*i*i)+(2*r+a+3*s-3*u)*f/(3*i*i)+r*l/2/i-s*c}function A(e,t,n){var i=n[0]-t[0],r=t[3]*i,a=n[2]*i,o=t[0],s=t[1],u=n[1],c=o-e,l=c*c,f=l*c,h=i*i,d=h*i;return(-30*d*s*(o+e)*c+10*h*r*(o+2*e)*l+5*i*(o+3*e)*(2*r+a+3*s-3*u)*f+3*(o+4*e)*(r+a+2*s-2*u)*f*c)/60/d}function O(){return{curves:[],index:0,max:0,lineSegCount:0,curveCount:0}}},function(e,t,n){"use strict";function i(e,t,n){for(var i=0,r=t.length;i<r;i++)e[i]=t[i]+n[i];return e}function r(e,t,n){if(t&&n){for(var i=0,r=t.length;i<r;i++)e[i]=t[i]+n[i];return e}return t||n}function a(e,t,n){if(t&&n){for(var i=0,r=t.length;i<r;i++)e[i]=t[i]*n[i];return e}return t||n}function o(e,t,n){for(var i=0,r=t.length;i<r;i++)e[i]=t[i]-n[i];return e}function s(e,t){for(var n=0,i=0,r=e.length;i<r;i++){var a=e[i]-t[i];n+=a*a}return n}n.d(t,"k",(function(){return i})),n.d(t,"l",(function(){return r})),n.d(t,"o",(function(){return a})),n.d(t,"n",(function(){return o})),n.d(t,"r",(function(){return s})),n.d(t,"q",(function(){return c})),n.d(t,"p",(function(){return l})),n.d(t,"m",(function(){return f})),n.d(t,"g",(function(){return h})),n.d(t,"i",(function(){return d})),n.d(t,"j",(function(){return _})),n.d(t,"h",(function(){return p})),n.d(t,"e",(function(){return m})),n.d(t,"d",(function(){return v})),n.d(t,"b",(function(){return g})),n.d(t,"c",(function(){return y})),n.d(t,"a",(function(){return T})),n.d(t,"f",(function(){return b}));var u=Number.EPSILON||Math.pow(2,-32);function c(e){for(var t=0,n=0,i=e.length;n<i;n++)t+=e[n]*e[n];return 0===(t=Math.sqrt(t))?e.slice():e.map((function(e){return e/t}))}function l(e,t,n){for(var i=0,r=t.length;i<r;i++)e[i]=t[i]*n;return e}function f(e,t,n){if(isNaN(n)){for(var i=0,r=0,a=t.length;r<a;r++)i+=e[r]*t[r];return i}for(var o=0,s=t.length;o<s;o++)e[o]=t[o]*n;return e}function h(e,t,n){var i=t[0],r=t[1],a=t[2],o=n[0],s=n[1],u=n[2];return e[0]=r*u-a*s,e[1]=a*o-i*u,e[2]=i*s-r*o,e}function d(e,t,n){var i=t[0],r=t[1],a=t[2],o=n[3]*i+n[7]*r+n[11]*a+n[15];return o=o||1,e[0]=(n[0]*i+n[4]*r+n[8]*a+n[12])/o,e[1]=(n[1]*i+n[5]*r+n[9]*a+n[13])/o,e[2]=(n[2]*i+n[6]*r+n[10]*a+n[14])/o,e}function _(e,t,n){var i=t[0],r=t[1],a=t[2],o=n[3]*i+n[7]*r+n[11]*a+n[15]||1;return e[0]=(n[0]*i+n[4]*r+n[8]*a)/o,e[1]=(n[1]*i+n[5]*r+n[9]*a)/o,e[2]=(n[2]*i+n[6]*r+n[10]*a)/o,e}function p(e,t,n){var i=t[0],r=t[1],a=t[2];return e[0]=i*n[0]+r*n[3]+a*n[6],e[1]=i*n[1]+r*n[4]+a*n[7],e[2]=i*n[2]+r*n[5]+a*n[8],e}function m(e){var t,n;return t=Math.sin(e),[n=Math.cos(e),t,0,-t,n,0,0,0,1]}function v(e){var t=Math.cos(e[0]),n=Math.cos(e[1]),i=Math.cos(e[2]),r=Math.sin(e[0]),a=Math.sin(e[1]),o=Math.sin(e[2]);return[n*i,n*o,-a,-t*o+r*a*i,t*i+r*a*o,r*n,o*r+t*a*i,-r*i+t*a*o,t*n]}function g(e,t){var n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],u=t[6],c=t[7],l=t[8],f=t[9],h=t[10],d=t[11],_=t[12],p=t[13],m=t[14],v=t[15],g=n*s-i*o,y=n*u-r*o,x=n*c-a*o,T=i*u-r*s,b=i*c-a*s,E=r*c-a*u,A=l*p-f*_,O=l*m-h*_,C=l*v-d*_,R=f*m-h*p,S=f*v-d*p,w=h*v-d*m,M=g*w-y*S+x*R+T*C-b*O+E*A;return M?(M=1/M,e[0]=(s*w-u*S+c*R)*M,e[1]=(r*S-i*w-a*R)*M,e[2]=(p*E-m*b+v*T)*M,e[3]=(h*b-f*E-d*T)*M,e[4]=(u*C-o*w-c*O)*M,e[5]=(n*w-r*C+a*O)*M,e[6]=(m*x-_*E-v*y)*M,e[7]=(l*E-h*x+d*y)*M,e[8]=(o*S-s*C+c*A)*M,e[9]=(i*C-n*S-a*A)*M,e[10]=(_*b-p*x+v*g)*M,e[11]=(f*x-l*b-d*g)*M,e[12]=(s*O-o*R-u*A)*M,e[13]=(n*R-i*O+r*A)*M,e[14]=(p*y-_*T-m*g)*M,e[15]=(l*T-f*y+h*g)*M,e):null}function y(e){for(var t=0,n=e.length;t<n;t++)if(Math.abs(e[t])>u)return!1;return!0}var x=Array.isArray;function T(e){return x(e)?[e[0],e[1],e[2]]:[0,0,0]}function b(e,t,n){var i=Math.cos(n),r=Math.sin(n),a=t[0],o=t[1];return e[0]=i*a+r*o,e[1]=-r*a+i*o,e}},function(e,t,n){"use strict";var i,r;function a(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w}n.d(t,"a",(function(){return Ut})),n.d(t,"b",(function(){return It})),n.d(t,"c",(function(){return kn})),n.d(t,"d",(function(){return Fn})),n.d(t,"e",(function(){return Oi})),n.d(t,"f",(function(){return Cn})),n.d(t,"g",(function(){return St})),n.d(t,"h",(function(){return _e})),n.d(t,"i",(function(){return rt})),n.d(t,"j",(function(){return Je})),n.d(t,"m",(function(){return Ci})),n.d(t,"n",(function(){return Mn})),n.d(t,"o",(function(){return Ln})),n.d(t,"p",(function(){return ee})),n.d(t,"t",(function(){return yn})),n.d(t,"u",(function(){return Bn})),n.d(t,"w",(function(){return gt})),n.d(t,"x",(function(){return ne})),n.d(t,"y",(function(){return Zn})),n.d(t,"z",(function(){return ft})),n.d(t,"A",(function(){return Dn})),n.d(t,"B",(function(){return xn})),n.d(t,"C",(function(){return Tn})),n.d(t,"D",(function(){return me})),n.d(t,"H",(function(){return jn})),n.d(t,"I",(function(){return Wn})),n.d(t,"J",(function(){return Sn})),n.d(t,"N",(function(){return $r})),n.d(t,"q",(function(){return o})),n.d(t,"r",(function(){return f})),n.d(t,"s",(function(){return c})),n.d(t,"v",(function(){return l})),n.d(t,"E",(function(){return _})),n.d(t,"F",(function(){return s})),n.d(t,"G",(function(){return v})),n.d(t,"k",(function(){return so})),n.d(t,"l",(function(){return co})),n.d(t,"K",(function(){return lo})),n.d(t,"L",(function(){return yo})),n.d(t,"M",(function(){return bo})),(r=i||(i={}))[r.EXCLUDE=0]="EXCLUDE",r[r.INTERSECT=1]="INTERSECT",r[r.INCLUDE=2]="INCLUDE";var o=function(){function e(){}return e.clamp=function(e,t,n){return Math.max(t,Math.min(n,e))},e.equals=function(t,n){return Math.abs(t-n)<=e.zeroTolerance},e.isPowerOf2=function(e){return 0==(e&e-1)},e.radianToDegree=function(t){return t*e.radToDegreeFactor},e.degreeToRadian=function(t){return t*e.degreeToRadFactor},e}();o.zeroTolerance=1e-6,o.radToDegreeFactor=180/Math.PI,o.degreeToRadFactor=Math.PI/180;var s=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},e.cross=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,u=t.z;n.x=r*u-a*s,n.y=a*o-i*u,n.z=i*s-r*o},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y,o=e.z;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=Math.sqrt(n*n+i*i+r*r);a>0&&(a=1/a,t.x=n*a,t.y=i*a,t.z=r*a)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t},e.transformNormal=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8],n.y=i*o[1]+r*o[5]+a*o[9],n.z=i*o[2]+r*o[6]+a*o[10]},e.transformToVec3=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14]},e.transformToVec4=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements;n.x=i*o[0]+r*o[4]+a*o[8]+o[12],n.y=i*o[1]+r*o[5]+a*o[9]+o[13],n.z=i*o[2]+r*o[6]+a*o[10]+o[14],n.w=i*o[3]+r*o[7]+a*o[11]+o[15]},e.transformCoordinate=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.elements,s=i*o[3]+r*o[7]+a*o[11]+o[15];s=1/s,n.x=(i*o[0]+r*o[4]+a*o[8]+o[12])*s,n.y=(i*o[1]+r*o[5]+a*o[9]+o[13])*s,n.z=(i*o[2]+r*o[6]+a*o[10]+o[14])*s},e.transformByQuat=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=t.x,s=t.y,u=t.z,c=t.w,l=c*i+s*a-u*r,f=c*r+u*i-o*a,h=c*a+o*r-s*i,d=-o*i-s*r-u*a;n.x=l*c-d*o-f*u+h*s,n.y=f*c-d*s-h*o+l*u,n.z=h*c-d*u-l*s+f*o};var t=e.prototype;return t.setValue=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},t.length=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z;return e*e+t*t+n*n},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z},t.clone=function(){return new e(this.x,this.y,this.z)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e},t.transformNormal=function(t){return e.transformNormal(this,t,this),this},t.transformToVec3=function(t){return e.transformToVec3(this,t,this),this},t.transformCoordinate=function(t){return e.transformCoordinate(this,t,this),this},t.transformByQuat=function(t){return e.transformByQuat(this,t,this),this},e}();s._zero=new s(0,0,0),s._one=new s(1,1,1),s._tempVector3=new s;var u=function(){function e(e,t){this.min=new s,this.max=new s,this.update(e,t)}var t=e.prototype;return t.update=function(e,t){e.cloneTo(this.min),t.cloneTo(this.max)},t.setFromCenterAndSize=function(e,t){var n=new s;s.scale(t,.5,n),s.subtract(e,n,this.min),s.add(e,n,this.max)},t.intersectsFrustum=function(e){for(var t=this.min,n=this.max,r=new s,o=new s,u=0;u<6;u++){var c=e[u];r.x=c.x>0?t.x:n.x,o.x=c.x>0?n.x:t.x,r.y=c.y>0?t.y:n.y,o.y=c.y>0?n.y:t.y,r.z=c.z>0?t.z:n.z,o.z=c.z>0?n.z:t.z;var l=a(c,r),f=a(c,o);if(l<0&&f<0)return i.EXCLUDE;if(l<0||f<0)return i.INTERSECT}return i.INCLUDE},t.isInFrustum=function(e){for(var t=this.min,n=this.max,i=new s,r=0;r<6;r++){var o=e[r];if(i.x=o.x>0?n.x:t.x,i.y=o.y>0?n.y:t.y,i.z=o.z>0?n.z:t.z,a(o,i)<0)return!1}return!0},t.clone=function(){return new e(this.min,this.max)},t.cloneTo=function(e){this.min.cloneTo(e.min),this.max.cloneTo(e.max)},e}(),c=function(){function e(e,t,n,i,r,a,o,s,u){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===u&&(u=1),this.elements=new Float32Array(9);var c=this.elements;c[0]=e,c[1]=t,c[2]=n,c[3]=i,c[4]=r,c[5]=a,c[6]=o,c[7]=s,c[8]=u}e.add=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]+r[0],a[1]=i[1]+r[1],a[2]=i[2]+r[2],a[3]=i[3]+r[3],a[4]=i[4]+r[4],a[5]=i[5]+r[5],a[6]=i[6]+r[6],a[7]=i[7]+r[7],a[8]=i[8]+r[8]},e.subtract=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]-r[0],a[1]=i[1]-r[1],a[2]=i[2]-r[2],a[3]=i[3]-r[3],a[4]=i[4]-r[4],a[5]=i[5]-r[5],a[6]=i[6]-r[6],a[7]=i[7]-r[7],a[8]=i[8]-r[8]},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],u=i[2],c=i[3],l=i[4],f=i[5],h=i[6],d=i[7],_=i[8],p=r[0],m=r[1],v=r[2],g=r[3],y=r[4],x=r[5],T=r[6],b=r[7],E=r[8];a[0]=o*p+c*m+h*v,a[1]=s*p+l*m+d*v,a[2]=u*p+f*m+_*v,a[3]=o*g+c*y+h*x,a[4]=s*g+l*y+d*x,a[5]=u*g+f*y+_*x,a[6]=o*T+c*b+h*E,a[7]=s*T+l*b+d*E,a[8]=u*T+f*b+_*E},e.equals=function(e,t){var n=e.elements,i=t.elements;return o.equals(n[0],i[0])&&o.equals(n[1],i[1])&&o.equals(n[2],i[2])&&o.equals(n[3],i[3])&&o.equals(n[4],i[4])&&o.equals(n[5],i[5])&&o.equals(n[6],i[6])&&o.equals(n[7],i[7])&&o.equals(n[8],i[8])},e.rotationQuaternion=function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,u=r+r,c=a+a,l=i*s,f=r*s,h=r*u,d=a*s,_=a*u,p=a*c,m=o*s,v=o*u,g=o*c;n[0]=1-h-p,n[3]=f-g,n[6]=d+v,n[1]=f+g,n[4]=1-l-p,n[7]=_-m,n[2]=d-v,n[5]=_+m,n[8]=1-l-h},e.scaling=function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=e.y,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e.x,n[7]=e.y,n[8]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],c=n[5],l=n[6],f=n[7],h=n[8],d=h*u-c*f,_=-h*s+c*l,p=f*s-u*l,m=r*d+a*_+o*p;m&&(m=1/m,i[0]=d*m,i[1]=(-h*a+o*f)*m,i[2]=(c*a-o*u)*m,i[3]=_*m,i[4]=(h*r-o*l)*m,i[5]=(-c*r+o*s)*m,i[6]=p*m,i[7]=(-f*r+a*l)*m,i[8]=(u*r-a*s)*m)},e.normalMatrix=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],c=n[5],l=n[6],f=n[7],h=n[8],d=n[9],_=n[10],p=n[11],m=n[12],v=n[13],g=n[14],y=n[15],x=r*c-a*u,T=r*l-o*u,b=r*f-s*u,E=a*l-o*c,A=a*f-s*c,O=o*f-s*l,C=h*v-d*m,R=h*g-_*m,S=h*y-p*m,w=d*g-_*v,M=d*y-p*v,P=_*y-p*g,L=x*P-T*M+b*w+E*S-A*R+O*C;if(!L)return null;L=1/L,i[0]=(c*P-l*M+f*w)*L,i[1]=(l*S-u*P-f*R)*L,i[2]=(u*M-c*S+f*C)*L,i[3]=(o*M-a*P-s*w)*L,i[4]=(r*P-o*S+s*R)*L,i[5]=(a*S-r*M-s*C)*L,i[6]=(v*O-g*A+y*E)*L,i[7]=(g*b-m*O-y*T)*L,i[8]=(m*A-v*b+y*x)*L},e.rotate=function(e,t,n){var i=e.elements,r=n.elements,a=Math.sin(t),o=Math.cos(t),s=i[0],u=i[1],c=i[2],l=i[3],f=i[4],h=i[5],d=i[6],_=i[7],p=i[8];r[0]=o*s+a*l,r[1]=o*u+a*f,r[2]=o*c+a*h,r[3]=o*l-a*s,r[4]=o*f-a*u,r[5]=o*h-a*c,r[6]=d,r[7]=_,r[8]=p},e.scale=function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements;o[0]=i*a[0],o[1]=i*a[1],o[2]=i*a[2],o[3]=r*a[3],o[4]=r*a[4],o[5]=r*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]},e.translate=function(e,t,n){var i=t.x,r=t.y,a=e.elements,o=n.elements,s=a[0],u=a[1],c=a[2],l=a[3],f=a[4],h=a[5],d=a[6],_=a[7],p=a[8];o[0]=s,o[1]=u,o[2]=c,o[3]=l,o[4]=f,o[5]=h,o[6]=i*s+r*l+d,o[7]=i*u+r*f+_,o[8]=i*c+r*h+p},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[5];i[1]=n[3],i[2]=n[6],i[3]=r,i[5]=n[7],i[6]=a,i[7]=o}else i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8]};var t=e.prototype;return t.setValue=function(e,t,n,i,r,a,o,s,u){var c=this.elements;return c[0]=e,c[1]=t,c[2]=n,c[3]=i,c[4]=r,c[5]=a,c[6]=o,c[7]=s,c[8]=u,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<12;i++)n[i]=e[i+t];return this},t.setValueByMatrix=function(e){var t=e.elements,n=this.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],this},t.toArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},t.cloneTo=function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],e},t.add=function(t){return e.add(this,t,this),this},t.subtract=function(t){return e.subtract(this,t,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],u=e[7],c=e[8];return t*(c*a-o*u)+n*(-c*r+o*s)+i*(u*r-a*s)},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotate=function(t){return e.rotate(this,t,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}(),l=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this.x=e,this.y=t,this.z=n,this.w=i}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w},e.multiply=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,u=t.y,c=t.z,l=t.w;n.x=i*l+o*s+r*c-a*u,n.y=r*l+o*u+a*s-i*c,n.z=a*l+o*c+i*u-r*s,n.w=o*l-i*s-r*u-a*c},e.conjugate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)&&o.equals(e.w,t.w)},e.rotationAxisAngle=function(t,n,i){var r=e._tempVector3;s.normalize(t,r),n*=.5;var a=Math.sin(n);i.x=r.x*a,i.y=r.y*a,i.z=r.z*a,i.w=Math.cos(n)},e.rotationEuler=function(t,n,i,r){e.rotationYawPitchRoll(n,t,i,r)},e.rotationYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),u=Math.cos(r),c=Math.sin(a),l=Math.cos(a),f=Math.sin(o),h=Math.cos(o),d=h*l,_=f*c;i.x=h*c*u+f*l*s,i.y=f*l*u-h*c*s,i.z=d*s-_*u,i.w=d*u+_*s},e.rotationMatrix3x3=function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],u=r[3],c=r[4],l=r[5],f=r[6],h=r[7],d=r[8],_=a+c+d;_>0?(n=Math.sqrt(_+1),t.w=.5*n,n=.5/n,t.x=(l-h)*n,t.y=(f-s)*n,t.z=(o-u)*n):a>=c&&a>=d?(i=.5/(n=Math.sqrt(1+a-c-d)),t.x=.5*n,t.y=(o+u)*i,t.z=(s+f)*i,t.w=(l-h)*i):c>d?(i=.5/(n=Math.sqrt(1+c-a-d)),t.x=(u+o)*i,t.y=.5*n,t.z=(h+l)*i,t.w=(f-s)*i):(i=.5/(n=Math.sqrt(1+d-a-c)),t.x=(s+f)*i,t.y=(l+h)*i,t.z=.5*n,t.w=(o-u)*i)},e.invert=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=n*n+i*i+r*r+a*a;if(s>o.zeroTolerance){var u=1/s;t.x=-n*u,t.y=-i*u,t.z=-r*u,t.w=a*u}},e.lerp=function(t,n,i,r){var a=1-i;e.dot(t,n)>=0?(r.x=t.x*a+n.x*i,r.y=t.y*a+n.y*i,r.z=t.z*a+n.z*i,r.w=t.w*a+n.w*i):(r.x=t.x*a-n.x*i,r.y=t.y*a-n.y*i,r.z=t.z*a-n.z*i,r.w=t.w*a-n.w*i),r.normalize()},e.slerp=function(e,t,n,i){var r,a,s=e.x,u=e.y,c=e.z,l=e.w,f=t.x,h=t.y,d=t.z,_=t.w,p=s*f+u*h+c*d+l*_;if(p<0&&(p=-p,f=-f,h=-h,d=-d,_=-_),1-p>o.zeroTolerance){var m=Math.acos(p),v=Math.sin(m);r=Math.sin((1-n)*m)/v,a=Math.sin(n*m)/v}else r=1-n,a=n;i.x=r*s+a*f,i.y=r*u+a*h,i.z=r*c+a*d,i.w=r*l+a*_},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=Math.sqrt(n*n+i*i+r*r+a*a);s>o.zeroTolerance&&(s=1/s,t.x=n*s,t.y=i*s,t.z=r*s,t.w=a*s)},e.rotationX=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=n,t.y=0,t.z=0,t.w=i},e.rotationY=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=n,t.z=0,t.w=i},e.rotationZ=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t.x=0,t.y=0,t.z=n,t.w=i},e.rotateX=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u+o*s,n.y=r*u+a*s,n.z=a*u-r*s,n.w=o*u-i*s},e.rotateY=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u-a*s,n.y=r*u+o*s,n.z=a*u+i*s,n.w=o*u-r*s},e.rotateZ=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w;t*=.5;var s=Math.sin(t),u=Math.cos(t);n.x=i*u+r*s,n.y=r*u-i*s,n.z=a*u+o*s,n.w=o*u-a*s},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t};var t=e.prototype;return t.setValue=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.getAxisAngle=function(e){var t=this.x,n=this.y,i=this.z,r=t*t+n*n+i*i;if(r<o.zeroTolerance)return e.x=1,e.y=0,e.z=0,0;var a=1/r;return e.x=this.x*a,e.y=this.y*a,e.z=this.z*a,2*Math.acos(this.w)},t.identity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},t.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},t.normalize=function(){return e.normalize(this,this),this},t.toEuler=function(e){this.toYawPitchRoll(e);var t=e.x;return e.x=e.y,e.y=t,e},t.toYawPitchRoll=function(e){var t=this.x,n=this.y,i=this.z,r=this.w,a=t*t,s=n*n,u=i*i,c=t*n,l=i*r,f=i*t,h=n*r,d=n*i,_=t*r;return e.y=Math.asin(2*(_-d)),Math.cos(e.y)>o.zeroTolerance?(e.z=Math.atan2(2*(c+l),1-2*(u+a)),e.x=Math.atan2(2*(f+h),1-2*(s+a))):(e.z=Math.atan2(-2*(c-l),1-2*(s+u)),e.x=0),e},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},t.rotateX=function(t){return e.rotateX(this,t,this),this},t.rotateY=function(t){return e.rotateY(this,t,this),this},t.rotateZ=function(t){return e.rotateZ(this,t,this),this},t.rotationAxisAngle=function(t,n){return e.rotationAxisAngle(t,n,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.invert=function(){return e.invert(this,this),this},t.dot=function(t){return e.dot(this,t)},t.lerp=function(t,n){return e.lerp(this,t,n,this),this},e}();l._tempVector3=new s;var f=function(){function e(e,t,n,i,r,a,o,s,u,c,l,f,h,d,_,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===u&&(u=0),void 0===c&&(c=0),void 0===l&&(l=1),void 0===f&&(f=0),void 0===h&&(h=0),void 0===d&&(d=0),void 0===_&&(_=0),void 0===p&&(p=1),this.elements=new Float32Array(16);var m=this.elements;m[0]=e,m[1]=t,m[2]=n,m[3]=i,m[4]=r,m[5]=a,m[6]=o,m[7]=s,m[8]=u,m[9]=c,m[10]=l,m[11]=f,m[12]=h,m[13]=d,m[14]=_,m[15]=p}e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],u=i[2],c=i[3],l=i[4],f=i[5],h=i[6],d=i[7],_=i[8],p=i[9],m=i[10],v=i[11],g=i[12],y=i[13],x=i[14],T=i[15],b=r[0],E=r[1],A=r[2],O=r[3],C=r[4],R=r[5],S=r[6],w=r[7],M=r[8],P=r[9],L=r[10],I=r[11],F=r[12],N=r[13],D=r[14],z=r[15];a[0]=o*b+l*E+_*A+g*O,a[1]=s*b+f*E+p*A+y*O,a[2]=u*b+h*E+m*A+x*O,a[3]=c*b+d*E+v*A+T*O,a[4]=o*C+l*R+_*S+g*w,a[5]=s*C+f*R+p*S+y*w,a[6]=u*C+h*R+m*S+x*w,a[7]=c*C+d*R+v*S+T*w,a[8]=o*M+l*P+_*L+g*I,a[9]=s*M+f*P+p*L+y*I,a[10]=u*M+h*P+m*L+x*I,a[11]=c*M+d*P+v*L+T*I,a[12]=o*F+l*N+_*D+g*z,a[13]=s*F+f*N+p*D+y*z,a[14]=u*F+h*N+m*D+x*z,a[15]=c*F+d*N+v*D+T*z},e.equals=function(e,t){var n=e.elements,i=t.elements;return o.equals(n[0],i[0])&&o.equals(n[1],i[1])&&o.equals(n[2],i[2])&&o.equals(n[3],i[3])&&o.equals(n[4],i[4])&&o.equals(n[5],i[5])&&o.equals(n[6],i[6])&&o.equals(n[7],i[7])&&o.equals(n[8],i[8])&&o.equals(n[9],i[9])&&o.equals(n[10],i[10])&&o.equals(n[11],i[11])&&o.equals(n[12],i[12])&&o.equals(n[13],i[13])&&o.equals(n[14],i[14])&&o.equals(n[15],i[15])},e.rotationQuaternion=function(e,t){var n=t.elements,i=e.x,r=e.y,a=e.z,o=e.w,s=i+i,u=r+r,c=a+a,l=i*s,f=r*s,h=r*u,d=a*s,_=a*u,p=a*c,m=o*s,v=o*u,g=o*c;n[0]=1-h-p,n[1]=f+g,n[2]=d-v,n[3]=0,n[4]=f-g,n[5]=1-l-p,n[6]=_+m,n[7]=0,n[8]=d+v,n[9]=_-m,n[10]=1-l-h,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.rotationAxisAngle=function(e,t,n){var i,r,a,s=n.elements,u=e.x,c=e.y,l=e.z,f=Math.sqrt(u*u+c*c+l*l);Math.abs(f)<o.zeroTolerance||(u*=f=1/f,c*=f,l*=f,i=Math.sin(t),a=1-(r=Math.cos(t)),s[0]=u*u*a+r,s[1]=c*u*a+l*i,s[2]=l*u*a-c*i,s[3]=0,s[4]=u*c*a-l*i,s[5]=c*c*a+r,s[6]=l*c*a+u*i,s[7]=0,s[8]=u*l*a+c*i,s[9]=c*l*a-u*i,s[10]=l*l*a+r,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1)},e.rotationTranslation=function(t,n,i){e.rotationQuaternion(t,i);var r=i.elements;r[12]=n.x,r[13]=n.y,r[14]=n.z},e.affineTransformation=function(e,t,n,i){var r=i.elements,a=t.x,o=t.y,s=t.z,u=t.w,c=a+a,l=o+o,f=s+s,h=a*c,d=a*l,_=a*f,p=o*l,m=o*f,v=s*f,g=u*c,y=u*l,x=u*f,T=e.x,b=e.y,E=e.z;r[0]=(1-(p+v))*T,r[1]=(d+x)*T,r[2]=(_-y)*T,r[3]=0,r[4]=(d-x)*b,r[5]=(1-(h+v))*b,r[6]=(m+g)*b,r[7]=0,r[8]=(_+y)*E,r[9]=(m-g)*E,r[10]=(1-(h+p))*E,r[11]=0,r[12]=n.x,r[13]=n.y,r[14]=n.z,r[15]=1},e.scaling=function(e,t){var n=t.elements;n[0]=e.x,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e.y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e.z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],u=n[4],c=n[5],l=n[6],f=n[7],h=n[8],d=n[9],_=n[10],p=n[11],m=n[12],v=n[13],g=n[14],y=n[15],x=r*c-a*u,T=r*l-o*u,b=r*f-s*u,E=a*l-o*c,A=a*f-s*c,O=o*f-s*l,C=h*v-d*m,R=h*g-_*m,S=h*y-p*m,w=d*g-_*v,M=d*y-p*v,P=_*y-p*g,L=x*P-T*M+b*w+E*S-A*R+O*C;if(!L)return null;L=1/L,i[0]=(c*P-l*M+f*w)*L,i[1]=(o*M-a*P-s*w)*L,i[2]=(v*O-g*A+y*E)*L,i[3]=(_*A-d*O-p*E)*L,i[4]=(l*S-u*P-f*R)*L,i[5]=(r*P-o*S+s*R)*L,i[6]=(g*b-m*O-y*T)*L,i[7]=(h*O-_*b+p*T)*L,i[8]=(u*M-c*S+f*C)*L,i[9]=(a*S-r*M-s*C)*L,i[10]=(m*A-v*b+y*x)*L,i[11]=(d*b-h*A-p*x)*L,i[12]=(c*R-u*w-l*C)*L,i[13]=(r*w-a*R+o*C)*L,i[14]=(v*T-m*E-g*x)*L,i[15]=(h*E-d*T+_*x)*L},e.lookAt=function(t,n,i,r){var a=r.elements,o=e._tempVec30,u=e._tempVec31,c=e._tempVec32;s.subtract(t,n,c),c.normalize(),s.cross(i,c,o),o.normalize(),s.cross(c,o,u),a[0]=o.x,a[1]=u.x,a[2]=c.x,a[3]=0,a[4]=o.y,a[5]=u.y,a[6]=c.y,a[7]=0,a[8]=o.z,a[9]=u.z,a[10]=c.z,a[11]=0,a[12]=-s.dot(o,t),a[13]=-s.dot(u,t),a[14]=-s.dot(c,t),a[15]=1},e.ortho=function(e,t,n,i,r,a,o){var s=o.elements,u=1/(e-t),c=1/(n-i),l=1/(r-a);s[0]=-2*u,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(e+t)*u,s[13]=(i+n)*c,s[14]=(a+r)*l,s[15]=1},e.perspective=function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(i+n)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n*s,a[15]=0},e.rotateAxisAngle=function(e,t,n,i){var r=t.x,a=t.y,s=t.z,u=Math.sqrt(r*r+a*a+s*s);if(!(Math.abs(u)<o.zeroTolerance)){var c,l,f,h=e.elements,d=i.elements;r*=u=1/u,a*=u,s*=u,c=Math.sin(n),f=1-(l=Math.cos(n));var _=h[0],p=h[1],m=h[2],v=h[3],g=h[4],y=h[5],x=h[6],T=h[7],b=h[8],E=h[9],A=h[10],O=h[11],C=r*r*f+l,R=a*r*f+s*c,S=s*r*f-a*c,w=r*a*f-s*c,M=a*a*f+l,P=s*a*f+r*c,L=r*s*f+a*c,I=a*s*f-r*c,F=s*s*f+l;d[0]=_*C+g*R+b*S,d[1]=p*C+y*R+E*S,d[2]=m*C+x*R+A*S,d[3]=v*C+T*R+O*S,d[4]=_*w+g*M+b*P,d[5]=p*w+y*M+E*P,d[6]=m*w+x*M+A*P,d[7]=v*w+T*M+O*P,d[8]=_*L+g*I+b*F,d[9]=p*L+y*I+E*F,d[10]=m*L+x*I+A*F,d[11]=v*L+T*I+O*F,e!==i&&(d[12]=h[12],d[13]=h[13],d[14]=h[14],d[15]=h[15])}},e.scale=function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;r[0]=i[0]*a,r[1]=i[1]*a,r[2]=i[2]*a,r[3]=i[3]*a,r[4]=i[4]*o,r[5]=i[5]*o,r[6]=i[6]*o,r[7]=i[7]*o,r[8]=i[8]*s,r[9]=i[9]*s,r[10]=i[10]*s,r[11]=i[11]*s,r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15]},e.translate=function(e,t,n){var i=e.elements,r=n.elements,a=t.x,o=t.y,s=t.z;if(e===n)r[12]=i[0]*a+i[4]*o+i[8]*s+i[12],r[13]=i[1]*a+i[5]*o+i[9]*s+i[13],r[14]=i[2]*a+i[6]*o+i[10]*s+i[14],r[15]=i[3]*a+i[7]*o+i[11]*s+i[15];else{var u=i[0],c=i[1],l=i[2],f=i[3],h=i[4],d=i[5],_=i[6],p=i[7],m=i[8],v=i[9],g=i[10],y=i[11];r[0]=u,r[1]=c,r[2]=l,r[3]=f,r[4]=h,r[5]=d,r[6]=_,r[7]=p,r[8]=m,r[9]=v,r[10]=g,r[11]=y,r[12]=u*a+h*o+m*s+i[12],r[13]=c*a+d*o+v*s+i[13],r[14]=l*a+_*o+g*s+i[14],r[15]=f*a+p*o+y*s+i[15]}},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[3],s=n[6],u=n[7],c=n[11];i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=r,i[6]=n[9],i[7]=n[13],i[8]=a,i[9]=s,i[11]=n[14],i[12]=o,i[13]=u,i[14]=c}else i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15]};var t=e.prototype;return t.setValue=function(e,t,n,i,r,a,o,s,u,c,l,f,h,d,_,p){var m=this.elements;return m[0]=e,m[1]=t,m[2]=n,m[3]=i,m[4]=r,m[5]=a,m[6]=o,m[7]=s,m[8]=u,m[9]=c,m[10]=l,m[11]=f,m[12]=h,m[13]=d,m[14]=_,m[15]=p,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<16;i++)n[i]=e[i+t];return this},t.toArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},t.cloneTo=function(e){var t=this.elements,n=e.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],e},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],u=e[7],c=e[8],l=e[9],f=e[10],h=e[11],d=e[12],_=e[13],p=e[14],m=e[15];return(t*o-n*a)*(f*m-h*p)-(t*s-i*a)*(l*m-h*_)+(t*u-r*a)*(l*p-f*_)+(n*s-i*o)*(c*m-h*d)-(n*u-r*o)*(c*p-f*d)+(i*u-r*s)*(c*_-l*d)},t.decompose=function(t,n,i){var r=e._tempMat30,a=this.elements,s=r.elements,u=a[0],c=a[1],f=a[2],h=a[3],d=a[4],_=a[5],p=a[6],m=a[7],v=a[8],g=a[9],y=a[10],x=a[11];t.x=a[12],t.y=a[13],t.z=a[14];var T=Math.sign(u*c*f*h)<0?-1:1,b=Math.sign(d*_*p*m)<0?-1:1,E=Math.sign(v*g*y*x)<0?-1:1,A=T*Math.sqrt(u*u+c*c+f*f),O=b*Math.sqrt(d*d+_*_+p*p),C=E*Math.sqrt(v*v+g*g+y*y);if(i.x=A,i.y=O,i.z=C,Math.abs(A)<o.zeroTolerance||Math.abs(O)<o.zeroTolerance||Math.abs(C)<o.zeroTolerance)return n.identity(),!1;var R=1/A,S=1/O,w=1/C;return s[0]=u*R,s[1]=c*R,s[2]=f*R,s[3]=d*S,s[4]=_*S,s[5]=p*S,s[6]=v*w,s[7]=g*w,s[8]=y*w,l.rotationMatrix3x3(r,n),!0},t.getRotation=function(e){var t=this.elements,n=t[0]+t[5]+t[10];if(n>o.zeroTolerance){var i=2*Math.sqrt(n+1);e.w=.25*i,e.x=(t[6]-t[9])/i,e.y=(t[8]-t[2])/i,e.z=(t[1]-t[4])/i}else if(t[0]>t[5]&&t[0]>t[10]){var r=2*Math.sqrt(1+t[0]-t[5]-t[10]);e.w=(t[6]-t[9])/r,e.x=.25*r,e.y=(t[1]+t[4])/r,e.z=(t[8]+t[2])/r}else if(t[5]>t[10]){var a=2*Math.sqrt(1+t[5]-t[0]-t[10]);e.w=(t[8]-t[2])/a,e.x=(t[1]+t[4])/a,e.y=.25*a,e.z=(t[6]+t[9])/a}else{var s=2*Math.sqrt(1+t[10]-t[0]-t[5]);e.w=(t[1]-t[4])/s,e.x=(t[8]+t[2])/s,e.y=(t[6]+t[9])/s,e.z=.25*s}return e},t.getScaling=function(e){var t=this.elements,n=t[0],i=t[1],r=t[2],a=t[4],o=t[5],s=t[6],u=t[8],c=t[9],l=t[10];return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(u*u+c*c+l*l),e},t.getTranslation=function(e){var t=this.elements;return e.x=t[12],e.y=t[13],e.z=t[14],e},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotateAxisAngle=function(t,n){return e.rotateAxisAngle(this,t,n,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}();f._tempVec30=new s,f._tempVec31=new s,f._tempVec32=new s,f._tempMat30=new c,f._tempMat40=new f,f._identity=new f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),(function(){function e(e,t,n){this.min=new s,this.max=new s,this.corners=[],this.minWorld=new s,this.maxWorld=new s,this.cornersWorld=[],e.cloneTo(this.min),t.cloneTo(this.max),this.corners=this.getCornersFromMinMax(e,t),this.updateByModelMatrix(n)}var t=e.prototype;return t.getCornersFromMinMax=function(e,t){var n=e.x,i=e.y,r=e.z,a=t.x,o=t.y,u=t.z;return[new s(n,i,r),new s(a,o,u),new s(a,i,r),new s(n,o,r),new s(n,i,u),new s(a,o,r),new s(n,o,u),new s(a,i,u)]},t.updateByModelMatrix=function(t){var n=this.minWorld,i=this.maxWorld;n.setValue(1/0,1/0,1/0),i.setValue(-1/0,-1/0,-1/0);for(var r=0;r<8;++r){var a=this.corners[r],o=e._tempVec3;s.transformCoordinate(a,t,o),s.min(n,o,n),s.max(i,o,i),this.cornersWorld[r]=new s,o.cloneTo(this.cornersWorld[r])}},t.intersectsFrustum=function(e){for(var t=this.cornersWorld,n=0;n<6;n++){for(var r=e[n],o=!1,s=0;s<8;s++)if(a(r,t[s])>0)o=!0;else if(o)return i.INTERSECT;if(!o)return i.EXCLUDE}return i.INCLUDE},t.isInFrustum=function(e){for(var t=this.cornersWorld,n=0;n<6;n++){for(var i=e[n],r=!1,o=0;o<8;o++)if(a(i,t[o])>0){r=!0;break}if(!r)return!1}return!0},e}())._tempVec3=new s;var h=function(){function e(e,t){this.origin=new s,this.direction=new s,e&&e.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var t=e.prototype;return t.intersectPlane=function(e,t){var n=this.origin,i=s.dot(t,this.direction);if(Math.abs(i)>1e-6){var r=new s;s.subtract(e,n,r);var a=s.dot(r,t)/i;if(a>=0)return a}return!1},t.getPoint=function(e){var t=new s;return s.scale(this.direction,e,t),t.add(this.origin)},t.intersectSphere=function(e,t){var n=this.direction,i=new s;s.subtract(this.origin,e,i);var r=s.dot(n,n),a=2*s.dot(n,i),o=s.dot(i,i)-t*t,u=this._solveQuadratic(r,a,o);return!!u&&u[0]},t.intersectAABB=function(e,t){var n=this.direction,i=this.origin,r=new s(1/n.x,1/n.y,1/n.z),a=[t,e],o=[n.x<0?1:0,n.y<0?1:0,n.z<0?1:0],u=(a[o[0]].x-i.x)*r.x,c=(a[1-o[0]].x-i.x)*r.x,l=(a[o[1]].y-i.y)*r.y,f=(a[1-o[1]].y-i.y)*r.y;if(u>f||l>c)return!1;l>u&&(u=l),f<c&&(c=f);var h=(a[o[2]].z-i.z)*r.z,d=(a[1-o[2]].z-i.z)*r.z;if(u>d||h>c)return!1;h>u&&(u=h),d<c&&(c=d);var _=u;return!(_<0&&(_=c)<0)&&_},t._solveQuadratic=function(e,t,n){var i=t*t-4*e*n;if(i<0)return!1;if(0==i){var r=-.5*t/e;return[r,r]}var a=Math.sqrt(i),o=t>0?-.5*(t+a):-.5*(t-a),s=o/e,u=n/o;return s<=u?[s,u]:[u,s]},e}(),d=function(){this.distance=Number.MAX_VALUE,this.collider=null,this.point=null},_=(o.zeroTolerance,function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y},e.dot=function(e,t){return e.x*t.x+e.y*t.y},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y},e.normalize=function(e,t){var n=e.x,i=e.y,r=Math.sqrt(n*n+i*i);r>o.zeroTolerance&&(r=1/r,t.x=n*r,t.y=i*r)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t};var t=e.prototype;return t.setValue=function(e,t){return this.x=e,this.y=t,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this},t.length=function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)},t.lengthSquared=function(){var e=this.x,t=this.y;return e*e+t*t},t.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y},t.clone=function(){return new e(this.x,this.y)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e},e}());_._zero=new _(0,0),_._one=new _(1,1);var p,m,v=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}e.add=function(e,t,n){n.x=e.x+t.x,n.y=e.y+t.y,n.z=e.z+t.z,n.w=e.w+t.w},e.subtract=function(e,t,n){n.x=e.x-t.x,n.y=e.y-t.y,n.z=e.z-t.z,n.w=e.w-t.w},e.multiply=function(e,t,n){n.x=e.x*t.x,n.y=e.y*t.y,n.z=e.z*t.z,n.w=e.w*t.w},e.divide=function(e,t,n){n.x=e.x/t.x,n.y=e.y/t.y,n.z=e.z/t.z,n.w=e.w/t.w},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+a*a)},e.distanceSquared=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return n*n+i*i+r*r+a*a},e.equals=function(e,t){return o.equals(e.x,t.x)&&o.equals(e.y,t.y)&&o.equals(e.z,t.z)&&o.equals(e.w,t.w)},e.lerp=function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=e.w;i.x=r+(t.x-r)*n,i.y=a+(t.y-a)*n,i.z=o+(t.z-o)*n,i.w=s+(t.w-s)*n},e.max=function(e,t,n){n.x=Math.max(e.x,t.x),n.y=Math.max(e.y,t.y),n.z=Math.max(e.z,t.z),n.w=Math.max(e.w,t.w)},e.min=function(e,t,n){n.x=Math.min(e.x,t.x),n.y=Math.min(e.y,t.y),n.z=Math.min(e.z,t.z),n.w=Math.min(e.w,t.w)},e.negate=function(e,t){t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w},e.normalize=function(e,t){var n=e.x,i=e.y,r=e.z,a=e.w,s=Math.sqrt(n*n+i*i+r*r+a*a);s>o.zeroTolerance&&(s=1/s,t.x=n*s,t.y=i*s,t.z=r*s,t.w=a*s)},e.scale=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w*t},e.transform=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.elements;n.x=i*s[0]+r*s[4]+a*s[8]+o*s[12],n.y=i*s[1]+r*s[5]+a*s[9]+o*s[13],n.z=i*s[2]+r*s[6]+a*s[10]+o*s[14],n.w=i*s[3]+r*s[7]+a*s[11]+o*s[15]},e.transformByQuat=function(e,t,n){var i=e.x,r=e.y,a=e.z,o=e.w,s=t.x,u=t.y,c=t.z,l=t.w,f=l*i+u*a-c*r,h=l*r+c*i-s*a,d=l*a+s*r-u*i,_=-s*i-u*r-c*a;n.x=f*l-_*s-h*c+d*u,n.y=h*l-_*u-d*s+f*c,n.z=d*l-_*c-f*u+h*s,n.w=o};var t=e.prototype;return t.setValue=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},t.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.multiply=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},t.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},t.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w},t.clone=function(){return new e(this.x,this.y,this.z,this.w)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e},e}();function g(){return(g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function x(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return T(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return T(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function E(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),e}function A(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function O(e){var t="function"==typeof Map?new Map:void 0;return(O=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return C(e,arguments,w(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),S(i,e)})(e)}function C(e,t,n){return(C=R()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&S(r,n.prototype),r}).apply(null,arguments)}function R(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(e){return(w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}v._zero=new v(0,0,0,0),v._one=new v(1,1,1,1),(m=p||(p={}))[m.Success=0]="Success",m[m.Pending=1]="Pending",m[m.Failed=2]="Failed";var M=function(e){A(n,e),n.all=function(e){return new n((function(t,n,i){if(!Array.isArray(e))return t([e]);var r=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,i((r+=1)/a),r==a&&t(o)})).catch((function(e){return n(e)}))}))}))};var t=n.prototype;function n(t){var n,i,r=function(e){if(!(e<=n._progress)){n._progress=e;for(var t,i=x(n._listeners);!(t=i()).done;){(0,t.value)(e)}}};return(n=e.call(this,(function(e,a){t((function(t){Promise.resolve().then((function(){r(1),n._status=0,e(t)}))}),i=function(e){Promise.resolve().then((function(){n._status=2,a(e)}))},(function(e){Promise.resolve().then((function(){r(e)}))}))}))||this)._reject=i,n._listeners=new Set,n._progress=0,n._status=1,n}return t.onProgress=function(e){return this._listeners.add(e),this},t.cancel=function(){return 1!==this._status||this._reject("Promise Canceled"),this},E(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(O(Promise)),P={isArray:"isArray"in Array?Array.isArray:function(e){return"[object Array]"===toString.call(e)},isArrayLike:function(e){return!!e&&"number"==typeof e.length&&"function"!=typeof e},clone:function(e){if("object"!=typeof e||null===e)return e;var t;if(P.isArrayLike(e)){t=e.slice();for(var n=0,i=e.length;n<i;n++)t[n]=P.clone(e[n])}else for(var r in t={},e)e.hasOwnProperty(r)&&(t[r]=P.clone(e[r]));return t},downloadBlob:function(e,t){if(void 0===t&&(t=""),navigator&&navigator.msSaveBlob)navigator.msSaveBlob(e,t);else{var n=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style.display="none",i.href=n,i.download=t,i.addEventListener("click",(function(){i.parentElement&&i.parentElement.removeChild(i)})),i.click(),window.URL.revokeObjectURL(n)}}};function L(e,t){var n=e.indexOf(t);if(n<0)return!1;var i=e.length-1;if(n!==i){var r=e[i];e[n]=r}return e.length--,!0}function I(e){return Object.keys(e).map((function(t){return e[t]}))}var F=function(){function e(e){this.engine=e,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}e._addLoader=function(e,t,n){this._loaders[e]=t;for(var i=0,r=n.length;i<r;i++)this._extTypeMapping[n[i]]=e},e._getTypeByUrl=function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]};var t=e.prototype;return t.load=function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var n=e.map((function(e){return t._loadSingleItem(e)}));return M.all(n)},t.cancelNotLoaded=function(e){var t=this;if(e)if("string"==typeof e){var n;null==(n=this._loadingPromises[e])||n.cancel()}else e.forEach((function(e){var n;null==(n=t._loadingPromises[e])||n.cancel()}));else I(this._loadingPromises).forEach((function(e){e.cancel()}))},t.gc=function(){for(var e=I(this._refObjectPool),t=0,n=e.length;t<n;t++)e[t].isGCIgnored||e[t].destroy()},t.getAssetPath=function(e){return this._assetPool[e]},t._addAsset=function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t},t._deleteAsset=function(e){var t=e.instanceId,n=this._assetPool[t];n&&(delete this._assetPool[t],delete this._assetUrlPool[n])},t._addRefObject=function(e,t){this._refObjectPool[e]=t},t._deleteRefObject=function(e){delete this._refObjectPool[e]},t._assignDefaultOptions=function(t){var n,i,r,a,o;if(t.type=null!=(n=t.type)?n:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: "+t.url;return t.retryCount=null!=(i=t.retryCount)?i:this.retryCount,t.timeout=null!=(r=t.timeout)?r:this.timeout,t.retryInterval=null!=(a=t.retryInterval)?a:this.retryInterval,t.url=null!=(o=t.url)?o:t.urls.join(","),t},t._loadSingleItem=function(t){var n=this,i=this._assignDefaultOptions("string"==typeof t?{url:t}:t),r=i.url;if(this._assetUrlPool[r])return new M((function(e){e(n._assetUrlPool[r])}));if(this._loadingPromises[r])return this._loadingPromises[i.url];var a=e._loaders[i.type],o=a.load(i,this);return this._loadingPromises[r]=o,o.then((function(e){a.useCache&&n._addAsset(r,e),delete n._loadingPromises[r]})).catch((function(){})),o},e}();function N(e,t,n){return void 0===n&&(n=!0),function(i){var r=new i(n);F._addLoader(e,r,t)}}F._loaders={},F._extTypeMapping={};var D,z,V=function(){function e(e,t,n,i){void 0===t&&(t=null),void 0===n&&(n={}),void 0===i&&(i=!0),this._timeStamp=(new Date).getTime(),this._target=t,this.data=n,this._currentTarget=null,this._bubbles=i,this._propagationStopped=!1,this._type=e}return E(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),e.prototype.stopPropagation=function(){this._propagationStopped=!0},e}();function B(e,t){G.registerCloneMode(e,t,D.Ignore)}function U(e,t){G.registerCloneMode(e,t,D.Shallow)}function k(e,t){G.registerCloneMode(e,t,D.Deep)}(z=D||(D={}))[z.Ignore=0]="Ignore",z[z.Assignment=1]="Assignment",z[z.Shallow=2]="Shallow",z[z.Deep=3]="Deep";var G=function(){function e(){}return e.registerCloneMode=function(t,n,i){var r=e._subCloneModeMap.get(t.constructor);r||(r=Object.create(null),e._subCloneModeMap.set(t.constructor,r)),r[n]=i},e.getCloneModeMode=function(t){var n=e._cloneModeMap.get(t);if(!n){n=Object.create(null),e._cloneModeMap.set(t,n);for(var i=e._obejctType,r=e._subCloneModeMap;t!==i;){var a=r.get(t);a&&Object.assign(n,a),t=Object.getPrototypeOf(t)}}return n},e}();G._subCloneModeMap=new Map,G._cloneModeMap=new Map,G._obejctType=Object.getPrototypeOf(Object);var j=Object.defineProperty,H=Object.getOwnPropertyDescriptor,W=function(e,t,n,i){for(var r,a=i>1?void 0:i?H(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&j(t,n,a),a},X=function e(t){this.instanceId=++e._instanceIdCounter,this._engine=t};X._instanceIdCounter=0,W([B],X.prototype,"instanceId",2),W([B],X.prototype,"_engine",2);var q=Object.defineProperty,K=Object.getOwnPropertyDescriptor,Y=function(e){function t(){var t;return(t=e.apply(this,arguments)||this)._evts=Object.create(null),t._evtCount=0,t}A(t,e);var n=t.prototype;return n.hasEvent=function(e){return null!=this._evts[e]},n.eventNames=function(){return 0===this._evtCount?[]:Object.keys(this._evts)},n.listenerCount=function(e){var t=this._evts[e];return t?t.fn?1:t.length:0},n.dispatch=function(e,t){if(!this._evts[e])return!1;var n=this._evts[e];if(n.fn)n.once&&this.removeEventListener(e,n.fn),n.fn(t);else for(var i=n.length,r=0;r<i;r++)n[r].once&&this.removeEventListener(e,n[r].fn),n[r].fn(t);return!0},n.on=function(e,t){return this.addEventListener(e,t)},n.once=function(e,t){return this.addEventListener(e,t,!0)},n.addEventListener=function(e,t,n){var i={fn:t,once:n},r=this._evts;return r[e]?r[e].fn?r[e]=[r[e],i]:r[e].push(i):(r[e]=i,this._evtCount++),this},n.off=function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var n=this._evts[e];if(n.fn&&n.fn===t)this._clearEvent(e);else{var i=n.indexOf(t);if(i>-1){var r=n[n.length-1];n[i]=r,n.length--,1===n.length&&(this._evts[e]=n[0])}}return this},n.removeEventListener=function(e,t){return this.off(e,t)},n.removeAllEventListeners=function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)},n.trigger=function(e){this.dispatch(e.type,e.data)},n._clearEvent=function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]},t}(X);!function(e,t,n,i){for(var r,a=i>1?void 0:i?K(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);i&&a&&q(t,n,a)}([B],Y.prototype,"_evts",2);var Q,Z,J,$,ee,te,ne,ie,re,ae,oe,se,ue,ce,le,fe,he,de,_e,pe,me,ve,ge,ye,xe,Te,be,Ee,Ae,Oe,Ce,Re,Se,we,Me=function(e){},Pe=(console.log.bind(console),console.info.bind(console),console.warn.bind(console),console.error.bind(console),Me),Le=Me,Ie=Me,Fe=Me,Ne=!1,De=function(){function e(){this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var e=this._clock.now();this._startTime=e,this._lastTickTime=e}var t=e.prototype;return t.reset=function(){this._lastTickTime=this._clock.now()},t.tick=function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e},E(e,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}();(Z=Q||(Q={}))[Z.Scene=1]="Scene",Z[Z.Cache=2]="Cache",($=J||(J={}))[$.DONT_CLEAR=0]="DONT_CLEAR",$[$.SOLID_COLOR=1]="SOLID_COLOR",$[$.DEPTH_ONLY=2]="DEPTH_ONLY",$[$.COLOR_ONLY=3]="COLOR_ONLY",$[$.STENCIL_ONLY=4]="STENCIL_ONLY",$[$.ALL_CLEAR=5]="ALL_CLEAR",(te=ee||(ee={}))[te.OPAQUE=1e3]="OPAQUE",te[te.TRANSPARENT=2e3]="TRANSPARENT",(ie=ne||(ne={}))[ie.BLEND=3042]="BLEND",ie[ie.CULL_FACE=2884]="CULL_FACE",ie[ie.DEPTH_TEST=2929]="DEPTH_TEST",ie[ie.ALPHA_TEST=3008]="ALPHA_TEST",ie[ie.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",ie[ie.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",ie[ie.SCISSOR_TEST=3089]="SCISSOR_TEST",(ae=re||(re={}))[ae.CW=2304]="CW",ae[ae.CCW=2305]="CCW",(se=oe||(oe={}))[se.FRONT=1028]="FRONT",se[se.BACK=1029]="BACK",se[se.FRONT_AND_BACK=1032]="FRONT_AND_BACK",(ce=ue||(ue={}))[ce.FRONT=0]="FRONT",ce[ce.BACK=1]="BACK",ce[ce.NONE=2]="NONE",ce[ce.DOUBLE=3]="DOUBLE",(fe=le||(le={}))[fe.NEVER=512]="NEVER",fe[fe.LESS=513]="LESS",fe[fe.EQUAL=514]="EQUAL",fe[fe.LEQUAL=515]="LEQUAL",fe[fe.GREATER=516]="GREATER",fe[fe.NOTEQUAL=517]="NOTEQUAL",fe[fe.GEQUAL=518]="GEQUAL",fe[fe.ALWAYS=519]="ALWAYS",(de=he||(he={}))[de.NEAREST=9728]="NEAREST",de[de.LINEAR=9729]="LINEAR",de[de.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",de[de.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",de[de.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",de[de.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",(pe=_e||(_e={}))[pe.FLOAT=5126]="FLOAT",pe[pe.FLOAT_VEC2=35664]="FLOAT_VEC2",pe[pe.FLOAT_VEC3=35665]="FLOAT_VEC3",pe[pe.FLOAT_VEC4=35666]="FLOAT_VEC4",pe[pe.INT=5124]="INT",pe[pe.INT_VEC2=35667]="INT_VEC2",pe[pe.INT_VEC3=35668]="INT_VEC3",pe[pe.INT_VEC4=35669]="INT_VEC4",pe[pe.BOOL=35670]="BOOL",pe[pe.BOOL_VEC2=35671]="BOOL_VEC2",pe[pe.BOOL_VEC3=35672]="BOOL_VEC3",pe[pe.BOOL_VEC4=35673]="BOOL_VEC4",pe[pe.FLOAT_MAT2=35674]="FLOAT_MAT2",pe[pe.FLOAT_MAT3=35675]="FLOAT_MAT3",pe[pe.FLOAT_MAT4=35676]="FLOAT_MAT4",pe[pe.FLOAT_ARRAY=35677]="FLOAT_ARRAY",pe[pe.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",pe[pe.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",pe[pe.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",pe[pe.INT_ARRAY=100003]="INT_ARRAY",pe[pe.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",pe[pe.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",pe[pe.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",pe[pe.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",pe[pe.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",pe[pe.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",pe[pe.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",pe[pe.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",pe[pe.SAMPLER_2D=35678]="SAMPLER_2D",pe[pe.SAMPLER_CUBE=35680]="SAMPLER_CUBE",pe[pe.BYTE=5120]="BYTE",pe[pe.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",pe[pe.SHORT=5122]="SHORT",pe[pe.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",pe[pe.UNSIGNED_INT=5125]="UNSIGNED_INT",(ve=me||(me={}))[ve.LOCAL=1]="LOCAL",ve[ve.MODEL=2]="MODEL",ve[ve.VIEW=3]="VIEW",ve[ve.PROJECTION=4]="PROJECTION",ve[ve.MODELVIEW=5]="MODELVIEW",ve[ve.VIEWPROJECTION=21]="VIEWPROJECTION",ve[ve.MODELVIEWPROJECTION=6]="MODELVIEWPROJECTION",ve[ve.MODELINVERSE=7]="MODELINVERSE",ve[ve.VIEWINVERSE=8]="VIEWINVERSE",ve[ve.PROJECTIONINVERSE=9]="PROJECTIONINVERSE",ve[ve.MODELVIEWINVERSE=10]="MODELVIEWINVERSE",ve[ve.MODELVIEWPROJECTIONINVERSE=11]="MODELVIEWPROJECTIONINVERSE",ve[ve.MODELINVERSETRANSPOSE=12]="MODELINVERSETRANSPOSE",ve[ve.MODELVIEWINVERSETRANSPOSE=13]="MODELVIEWINVERSETRANSPOSE",ve[ve.VIEWPORT=14]="VIEWPORT",ve[ve.JOINTMATRIX=15]="JOINTMATRIX",ve[ve.MORPHWEIGHTS=16]="MORPHWEIGHTS",ve[ve.EYEPOS=17]="EYEPOS",ve[ve.TIME=18]="TIME",ve[ve.JOINTTEXTURE=19]="JOINTTEXTURE",ve[ve.JOINTCOUNT=20]="JOINTCOUNT",(ye=ge||(ge={}))[ye.ZERO=0]="ZERO",ye[ye.ONE=1]="ONE",ye[ye.SRC_COLOR=768]="SRC_COLOR",ye[ye.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",ye[ye.SRC_ALPHA=770]="SRC_ALPHA",ye[ye.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",ye[ye.DST_ALPHA=772]="DST_ALPHA",ye[ye.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",ye[ye.DST_COLOR=774]="DST_COLOR",ye[ye.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",ye[ye.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",ye[ye.enumANT_COLOR=32769]="enumANT_COLOR",ye[ye.ONE_MINUS_enumANT_COLOR=32770]="ONE_MINUS_enumANT_COLOR",ye[ye.enumANT_ALPHA=32771]="enumANT_ALPHA",ye[ye.ONE_MINUS_enumANT_ALPHA=32772]="ONE_MINUS_enumANT_ALPHA",(Te=xe||(xe={}))[Te.MASK1=1]="MASK1",Te[Te.MASK2=2]="MASK2",Te[Te.MASK3=4]="MASK3",Te[Te.MASK4=8]="MASK4",Te[Te.MASK5=16]="MASK5",Te[Te.MASK6=32]="MASK6",Te[Te.MASK7=64]="MASK7",Te[Te.MASK8=128]="MASK8",Te[Te.MASK9=256]="MASK9",Te[Te.MASK10=512]="MASK10",Te[Te.MASK11=1024]="MASK11",Te[Te.MASK12=2048]="MASK12",Te[Te.MASK13=4096]="MASK13",Te[Te.MASK14=8192]="MASK14",Te[Te.MASK15=16384]="MASK15",Te[Te.MASK16=32768]="MASK16",Te[Te.MASK17=65536]="MASK17",Te[Te.MASK18=131072]="MASK18",Te[Te.MASK19=262144]="MASK19",Te[Te.MASK20=524288]="MASK20",Te[Te.EVERYTHING=268435455]="EVERYTHING",Te[Te.SHADOW=268435456]="SHADOW",Te[Te.SHADOW_MAP=536870912]="SHADOW_MAP",(Ee=be||(be={}))[Ee.ONCE=1]="ONCE",Ee[Ee.EVERYFRAME=2]="EVERYFRAME",(Oe=Ae||(Ae={}))[Oe.AABB=0]="AABB",Oe[Oe.OBB=1]="OBB",Oe[Oe.SPHERE=2]="SPHERE",(Re=Ce||(Ce={})).standardDerivatives="OES_standard_derivatives",Re.shaderTextureLod="EXT_shader_texture_lod",Re.elementIndexUint="OES_element_index_uint",Re.depthTexture="WEBGL_depth_texture",Re.drawBuffers="WEBGL_draw_buffers",Re.vertexArrayObject="OES_vertex_array_object",Re.instancedArrays="ANGLE_instanced_arrays",Re.multipleSample="multipleSampleOnlySupportedInWebGL2",Re.textureFloat="OES_texture_float",Re.textureFloatLinear="OES_texture_float_linear",Re.textureHalfFloat="OES_texture_half_float",Re.textureHalfFloatLinear="OES_texture_half_float_linear",Re.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",Re.colorBufferFloat="EXT_color_buffer_float",Re.colorBufferHalfFloat="EXT_color_buffer_half_float",Re.textureFilterAnisotropic="EXT_texture_filter_anisotropic",Re.astc="WEBGL_compressed_texture_astc",Re.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",Re.etc="WEBGL_compressed_texture_etc",Re.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",Re.etc1="WEBGL_compressed_texture_etc1",Re.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",Re.pvrtc="WEBGL_compressed_texture_pvrtc",Re.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",Re.s3tc="WEBGL_compressed_texture_s3tc",Re.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc",(we=Se||(Se={}))[we.WEIGHTED_AVERAGE=0]="WEIGHTED_AVERAGE",we[we.DEPTH_PEEL=1]="DEPTH_PEEL",we[we.DUAL_DEPTH_PEEL=2]="DUAL_DEPTH_PEEL";var ze,Ve,Be=function(){function e(e){void 0===e&&(e=0),this.length=0,this._elements=new Array(e)}var t=e.prototype;return t.add=function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++},t.delete=function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)},t.deleteByIndex=function(e){var t=this._elements,n=null,i=this.length-1;return e!==i&&(n=t[i],t[e]=n),this.length--,n},t.garbageCollection=function(){this._elements.length=this.length},e}(),Ue=function(){function e(){this._onStartScripts=new Be,this._onUpdateScripts=new Be,this._onLateUpdateScripts=new Be,this._destoryComponents=[],this._onUpdateAnimations=new Be,this._renderers=new Be,this._onUpdateRenderers=new Be,this._componentsContainerPool=[]}var t=e.prototype;return t.addRenderer=function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)},t.removeRenderer=function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1},t.addOnStartScript=function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)},t.removeOnStartScript=function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1},t.addOnUpdateScript=function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)},t.removeOnUpdateScript=function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnLateUpdateScript=function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)},t.removeOnLateUpdateScript=function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1},t.addOnUpdateAnimations=function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)},t.removeOnUpdateAnimations=function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnUpdateRenderers=function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)},t.removeOnUpdateRenderers=function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addDestoryComponent=function(e){this._destoryComponents.push(e)},t.callScriptOnStart=function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,n=0;n<e.length;n++){var i=t[n];i._started=!0,i._onStartIndex=-1,i.onStart()}e.length=0}},t.callScriptOnUpdate=function(e){for(var t=this._onUpdateScripts._elements,n=this._onUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onUpdate(e)}},t.callScriptOnLateUpdate=function(e){for(var t=this._onLateUpdateScripts._elements,n=this._onLateUpdateScripts.length-1;n>=0;--n){var i=t[n];i._started&&i.onLateUpdate(e)}},t.callAnimationUpdate=function(e){for(var t=this._onUpdateAnimations._elements,n=this._onUpdateAnimations.length-1;n>=0;--n)t[n].update(e)},t.callRendererOnUpdate=function(e){for(var t=this._onUpdateRenderers._elements,n=this._onUpdateRenderers.length-1;n>=0;--n)t[n].update(e)},t.callRender=function(e){for(var t=this._renderers._elements,n=this._renderers.length-1;n>=0;--n)t[n]._render(e)},t.callComponentDestory=function(){var e=this._destoryComponents,t=e.length;if(t>0){for(var n=t-1;n>=0;--n)e[n].onDestroy();e.length=0}},t.callCameraOnBeginRender=function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onBeginRender(e)}},t.callCameraOnEndRender=function(e){for(var t=e.entity._components,n=t.length-1;n>=0;--n){var i=t[n];i.onBeginRender&&i.onEndRender(e)}},t.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},t.putActiveChangedTempList=function(e){e.length=0,this._componentsContainerPool.push(e)},e}(),ke=function(){function e(){}return e.cloneComponent=function(t,n){for(var i=G.getCloneModeMode(t.constructor),r=Object.keys(t),a=0,o=r.length;a<o;a++){var s=r[a];switch(i[s]){case void 0:case D.Assignment:n[s]=t[s];break;case D.Shallow:var u=t[s];if(u instanceof Object){var c=n[s];null==c&&(c=n[s]=u.constructor()),Object.assign(c,u)}else n[s]=u;break;case D.Deep:var l=t[s];if(l instanceof Object){var f=n[s];null==f&&(f=n[s]=l.constructor()),e._cloneComponentProp(l,f)}else n[s]=l}}},e._cloneComponentProp=function(t,n){var i=t.constructor;if(i===Object)for(var r=Object.keys(t),a=0,o=r.length;a<o;a++){var s=r[a],u=t[s];if(u instanceof Object){var c=n[s];null==c&&(n[s]=c=u.constructor()),e._cloneComponentProp(u,c)}else n[s]=u}else if(i===Array){var l=t,f=n,h=l.length;f.length=h;for(var d=0;d<h;d++){var _=l[d];if(_ instanceof Object){var p=f[d];null==p&&(f[d]=p=_.constructor()),e._cloneComponentProp(_,p)}else f[d]=_}}else t.cloneTo(n)},e}(),Ge=function(){function e(){}return e.register=function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)},e._addCheck=function(t,n){var i=e._dependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(!t.getComponent(i[r]))throw"you should add "+i[r]+" before adding "+n},e._removeCheck=function(t,n){var i=e._invDependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(t.getComponent(i[r]))throw"you should remove "+i[r]+" before adding "+n},e._addDependency=function(e,t,n){var i=n.get(e);i||(i=[],n.set(e,i)),-1===i.indexOf(t)&&i.push(t)},e}();Ge._dependenciesMap=new Map,Ge._invDependenciesMap=new Map,(Ve=ze||(ze={}))[Ve.Layer0=1]="Layer0",Ve[Ve.Layer1=2]="Layer1",Ve[Ve.Layer2=4]="Layer2",Ve[Ve.Layer3=8]="Layer3",Ve[Ve.Layer4=16]="Layer4",Ve[Ve.Layer5=32]="Layer5",Ve[Ve.Layer6=64]="Layer6",Ve[Ve.Layer7=128]="Layer7",Ve[Ve.Layer8=256]="Layer8",Ve[Ve.Layer9=512]="Layer9",Ve[Ve.Layer10=1024]="Layer10",Ve[Ve.Layer11=2048]="Layer11",Ve[Ve.Layer12=4096]="Layer12",Ve[Ve.Layer13=8192]="Layer13",Ve[Ve.Layer14=16384]="Layer14",Ve[Ve.Layer15=32768]="Layer15",Ve[Ve.Layer16=65536]="Layer16",Ve[Ve.Layer17=131072]="Layer17",Ve[Ve.Layer18=262144]="Layer18",Ve[Ve.Layer19=524288]="Layer19",Ve[Ve.Layer20=1048576]="Layer20",Ve[Ve.Layer21=2097152]="Layer21",Ve[Ve.Layer22=4194304]="Layer22",Ve[Ve.Layer23=8388608]="Layer23",Ve[Ve.Layer24=16777216]="Layer24",Ve[Ve.Layer25=33554432]="Layer25",Ve[Ve.Layer26=67108864]="Layer26",Ve[Ve.Layer27=134217728]="Layer27",Ve[Ve.Layer28=268435456]="Layer28",Ve[Ve.Layer29=536870912]="Layer29",Ve[Ve.Layer30=1073741824]="Layer30",Ve[Ve.Layer31=2147483648]="Layer31",Ve[Ve.Everything=4294967295]="Everything",Ve[Ve.Nothing=0]="Nothing";var je=Object.defineProperty,He=Object.getOwnPropertyDescriptor,We=function(e,t,n,i){for(var r,a=i>1?void 0:i?He(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&je(t,n,a),a},Xe=function(e){function t(t){var n;return(n=e.call(this,t.engine)||this)._destroyed=!1,n._enabled=!0,n._awaked=!1,n._renderPriority=0,n._cullDistanceSq=0,n._entity=t,n._renderPassFlag=xe.EVERYTHING,n._passMasks=[xe.EVERYTHING],n}A(t,e);var n=t.prototype;return n.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())},n._onAwake=function(){},n._onEnable=function(){},n._onDisable=function(){},n._onDestroy=function(){},n._onActive=function(){},n._onInActive=function(){},n._setActive=function(e){e?(this._awaked||(this._awaked=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())},n.setPassMasks=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._passMasks=t,this._renderPassFlag=t.reduce((function(e,t){return e|t}),0)},n.addPassMasks=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=this._passMasks.indexOf(a);o<0&&this._passMasks.push(a)}this.setPassMasks.apply(this,this._passMasks)},n.removePassMasks=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var a=r[i],o=this._passMasks.indexOf(a);o>-1&&this._passMasks.splice(o,1)}this.setPassMasks.apply(this,this._passMasks)},E(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}},{key:"engine",get:function(){return this._entity.engine}},{key:"renderPriority",get:function(){return this._renderPriority},set:function(e){this._renderPriority=e}},{key:"cullDistanceSq",get:function(){return this._cullDistanceSq}},{key:"cullDistance",get:function(){return Math.sqrt(this._cullDistanceSq)},set:function(e){this._cullDistanceSq=e*e}},{key:"renderPassFlag",get:function(){return this._renderPassFlag},set:function(e){this._renderPassFlag=e}}]),t}(Y);We([B],Xe.prototype,"_entity",2),We([B],Xe.prototype,"_destroyed",2),We([B],Xe.prototype,"_enabled",2),We([B],Xe.prototype,"_awaked",2);var qe=function(){function e(e){void 0===e&&(e=[]),this._flags=e,this.flag=!0}return e.prototype.destroy=function(){L(this._flags,this),this._flags=null},e}(),Ke=Object.defineProperty,Ye=Object.getOwnPropertyDescriptor,Qe=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ye(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Ke(t,n,a),a},Ze=function(e){function t(){var n;return(n=e.apply(this,arguments)||this)._position=new s,n._rotation=new s,n._rotationQuaternion=new l,n._scale=new s(1,1,1),n._worldPosition=new s,n._worldRotation=new s,n._worldRotationQuaternion=new l,n._lossyWorldScale=new s(1,1,1),n._localMatrix=new f,n._worldMatrix=new f,n._changeFlags=[],n._isParentDirty=!0,n._parentTransformCache=null,n._dirtyFlag=t._WM_WP_WE_WQ_WS_FLAGS,n}A(t,e);var n=t.prototype;return n.setPosition=function(e,t,n){this._position.setValue(e,t,n),this.position=this._position},n.setRotation=function(e,t,n){this._rotation.setValue(e,t,n),this.rotation=this._rotation},n.setRotationQuaternion=function(e,t,n,i){this._rotationQuaternion.setValue(e,t,n,i),this.rotationQuaternion=this._rotationQuaternion},n.setScale=function(e,t,n){this._scale.setValue(e,t,n),this.scale=this._scale},n.setWorldPosition=function(e,t,n){this._worldPosition.setValue(e,t,n),this.worldPosition=this._worldPosition},n.setWorldRotation=function(e,t,n){this._worldRotation.setValue(e,t,n),this.worldRotation=this._worldRotation},n.setWorldRotationQuaternion=function(e,t,n,i){this._worldRotationQuaternion.setValue(e,t,n,i),this.worldRotationQuaternion=this._worldRotationQuaternion},n.getWorldForward=function(e){var t=this.worldMatrix.elements;return e.setValue(-t[8],-t[9],-t[10]),e.normalize()},n.getWorldRight=function(e){var t=this.worldMatrix.elements;return e.setValue(t[0],t[1],t[2]),e.normalize()},n.getWorldUp=function(e){var t=this.worldMatrix.elements;return e.setValue(t[4],t[5],t[6]),e.normalize()},n.translate=function(e,n){if(void 0===n&&(n=!0),n){var i=t._tempMat40;f.rotationQuaternion(this.rotationQuaternion,i),s.transformCoordinate(e,i,t._tempVec3),this.position=this._position.add(t._tempVec3)}else this.worldPosition=this._worldPosition.add(e)},n.translateXYZ=function(e,n,i,r){void 0===r&&(r=!0);var a=t._tempVec3;a.setValue(e,n,i),this.translate(a,r)},n.rotate=function(e,t){void 0===t&&(t=!0),this.rotateXYZ(e.x,e.y,e.z,t)},n.rotateXYZ=function(e,n,i,r){void 0===r&&(r=!0);var a=o.degreeToRadFactor,s=t._tempQuat0;l.rotationEuler(e*a,n*a,i*a,s),this._rotateByQuat(s,r)},n.rotateByAxis=function(e,n,i){void 0===i&&(i=!0);var r=n*o.degreeToRadFactor;l.rotationAxisAngle(e,r,t._tempQuat0),this._rotateByQuat(t._tempQuat0,i)},n.lookAt=function(e,n){var i,r=this.worldPosition,a=o.zeroTolerance;if(!(Math.abs(r.x-e.x)<a&&Math.abs(r.y-e.y)<a&&Math.abs(r.z-e.z)<a)){var s=t._tempMat43,u=this._worldRotationQuaternion;n=null!=(i=n)?i:t._tempVec3.setValue(0,1,0),f.lookAt(r,e,n,s),s.getRotation(u).invert(),this.worldRotationQuaternion=u}},n.registerWorldChangeFlag=function(){var e=new qe(this._changeFlags);return this._changeFlags.push(e),e},n._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},n._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_FLAGS)){this._worldAssociatedChange(t._WM_WP_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateWorldPositionFlag()}}},n._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(t._WM_WE_WQ_FLAGS)){this._worldAssociatedChange(t._WM_WE_WQ_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateWorldPositionAndRotationFlag()}}},n._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WE_WQ_FLAGS)){this._worldAssociatedChange(t._WM_WP_WE_WQ_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateWorldPositionAndRotationFlag()}}},n._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(t._WM_WS_FLAGS)){this._worldAssociatedChange(t._WM_WS_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateWorldPositionAndScaleFlag()}}},n._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WS_FLAGS)){this._worldAssociatedChange(t._WM_WP_WS_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateWorldPositionAndScaleFlag()}}},n._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(t._WM_WP_WE_WQ_WS_FLAGS)){this._worldAssociatedChange(t._WM_WP_WE_WQ_WS_FLAGS);for(var e=this._entity._children,n=0,i=e.length;n<i;n++){var r;null==(r=e[n].transform)||r._updateAllWorldFlag()}}},n._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var n=t.transform;if(n){e=n;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},n._getScaleMatrix=function(){var e=t._tempQuat0,n=t._tempMat30,i=t._tempMat31,r=t._tempMat32;return i.setValueByMatrix(this.worldMatrix),l.invert(this.worldRotationQuaternion,e),c.rotationQuaternion(e,n),c.multiply(n,i,r),r},n._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._worldAssociatedChange=function(e){this._dirtyFlag|=e;for(var t=this._changeFlags.length-1;t>=0;t--)this._changeFlags[t].flag=!0},n._rotateByQuat=function(e,t){t?(l.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(l.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)},E(t,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag(t._WORLD_POSITION_FLAG)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse(t._WORLD_POSITION_FLAG)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var n=this._getParentTransform();n?(f.invert(n.worldMatrix,t._tempMat41),s.transformCoordinate(e,t._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse(t._WORLD_POSITION_FLAG)}},{key:"rotation",get:function(){return this._isContainDirtyFlag(t._LOCAL_EULER_FLAG)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(o.radToDegreeFactor),this._setDirtyFlagFalse(t._LOCAL_EULER_FLAG)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG|t._LOCAL_QUAT_FLAG),this._setDirtyFlagFalse(t._LOCAL_EULER_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag(t._WORLD_EULER_FLAG)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(o.radToDegreeFactor),this._setDirtyFlagFalse(t._WORLD_EULER_FLAG)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),l.rotationEuler(o.degreeToRadian(e.x),o.degreeToRadian(e.y),o.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse(t._WORLD_EULER_FLAG)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag(t._LOCAL_QUAT_FLAG)&&(l.rotationEuler(o.degreeToRadian(this._rotation.x),o.degreeToRadian(this._rotation.y),o.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse(t._LOCAL_QUAT_FLAG)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG|t._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(t._LOCAL_QUAT_FLAG),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag(t._WORLD_QUAT_FLAG)){var e=this._getParentTransform();null!=e?l.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse(t._WORLD_QUAT_FLAG)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var n=this._getParentTransform();n?(l.invert(n.worldRotationQuaternion,t._tempQuat0),l.multiply(e,t._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse(t._WORLD_QUAT_FLAG)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue(t._LOCAL_MATRIX_FLAG),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(t._WORLD_SCALE_FLAG)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.setValue(e[0],e[4],e[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(t._WORLD_SCALE_FLAG)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(t._LOCAL_MATRIX_FLAG)&&(f.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(t._LOCAL_MATRIX_FLAG)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(t._LOCAL_EULER_FLAG),this._setDirtyFlagFalse(t._LOCAL_MATRIX_FLAG),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(t._WORLD_MATRIX_FLAG)){var e=this._getParentTransform();e?f.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(t._WORLD_MATRIX_FLAG)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var n=this._getParentTransform();n?(f.invert(n.worldMatrix,t._tempMat42),f.multiply(e,t._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(t._WORLD_MATRIX_FLAG)}}]),t}(Xe);Ze._tempQuat0=new l,Ze._tempVec3=new s,Ze._tempMat30=new c,Ze._tempMat31=new c,Ze._tempMat32=new c,Ze._tempMat40=new f,Ze._tempMat41=new f,Ze._tempMat42=new f,Ze._tempMat43=new f,Ze._LOCAL_EULER_FLAG=1,Ze._LOCAL_QUAT_FLAG=2,Ze._WORLD_POSITION_FLAG=4,Ze._WORLD_EULER_FLAG=8,Ze._WORLD_QUAT_FLAG=16,Ze._WORLD_SCALE_FLAG=32,Ze._LOCAL_MATRIX_FLAG=64,Ze._WORLD_MATRIX_FLAG=128,Ze._WM_WP_FLAGS=132,Ze._WM_WE_WQ_FLAGS=152,Ze._WM_WP_WE_WQ_FLAGS=156,Ze._WM_WS_FLAGS=160,Ze._WM_WP_WS_FLAGS=164,Ze._WM_WP_WE_WQ_WS_FLAGS=188,Qe([k],Ze.prototype,"_position",2),Qe([k],Ze.prototype,"_rotation",2),Qe([k],Ze.prototype,"_rotationQuaternion",2),Qe([k],Ze.prototype,"_scale",2),Qe([k],Ze.prototype,"_worldPosition",2),Qe([k],Ze.prototype,"_worldRotation",2),Qe([k],Ze.prototype,"_worldRotationQuaternion",2),Qe([k],Ze.prototype,"_lossyWorldScale",2),Qe([k],Ze.prototype,"_localMatrix",2),Qe([k],Ze.prototype,"_worldMatrix",2),Qe([B],Ze.prototype,"_changeFlags",2),Qe([B],Ze.prototype,"_isParentDirty",2),Qe([B],Ze.prototype,"_parentTransformCache",2);var Je=function(e){function t(n,i){var r;return(r=e.call(this,n)||this).layer=ze.Layer0,r._isActiveInHierarchy=!1,r._components=[],r._children=[],r._isRoot=!1,r._isActive=!0,r._parent=null,r._invModelMatrix=new f,t._entitys.add(y(r)),r.name=i,r.transform=r.addComponent(Ze),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}A(t,e),t.findByName=function(e){for(var n=t._entitys,i=n._elements,r=n.length-1;r>=0;r--){var a=i[r];if(a.name===e)return a}return null},t.findByPath=function(e,t){return e.findEntityByPath(t)},t._findChildByName=function(e,t){for(var n=e._children,i=n.length-1;i>=0;i--){var r=n[i];if(r.name===t)return r}return null},t._traverseSetOwnerScene=function(e,t){e._scene=t;for(var n=e._children,i=e.childCount-1;i>=0;i--)this._traverseSetOwnerScene(n[i],t)};var n=t.prototype;return n.addComponent=function(e){Ge._addCheck(this,e);var t=new e(this);return this._components.push(t),this._isActiveInHierarchy&&t._setActive(!0),t},n.getComponent=function(e){for(var t=this._components.length-1;t>=0;t--){var n=this._components[t];if(n instanceof e)return n}},n.getComponents=function(e,t){t.length=0;for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}return t},n.getComponentsIncludeChildren=function(e,t){return t.length=0,this._getComponentsIncludeChildren(e,t),t},n.addChild=function(e){e.parent=this},n.removeChild=function(e){e.parent=null},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var n=this._children,i=t._findChildByName(this,e);if(i)return i;for(var r=n.length-1;r>=0;r--){var a=n[r].findByName(e);if(a)return a}return null},n.findByPath=function(e){for(var n=e.split("/"),i=this,r=0,a=n.length;r<a;++r){var o=n[r];if(o&&!(i=t._findChildByName(i,o)))return null}return i},n.createChild=function(e){var n=new t(this.engine,e);return n.layer=this.layer,n.parent=this,n},n.clearChildren=function(){for(var e=this._children,n=e.length-1;n>=0;n--){var i=e[n];i._parent=null,i._isActiveInHierarchy&&i._processInActive(),t._traverseSetOwnerScene(i,null)}e.length=0},n.clone=function(){var e=new t(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var n=this._children,i=0,r=this._children.length;i<r;i++){var a=n[i];e.addChild(a.clone())}for(var o=this._components,s=0,u=o.length;s<u;s++){var c=o[s];if(!(c instanceof Ze)){var l=e.addComponent(c.constructor);ke.cloneComponent(c,l)}}return e},n.destroy=function(){for(var e=this._components,n=e.length-1;n>=0;n--)e[n].destroy();this._components.length=0;for(var i=this._children,r=i.length-1;r>=0;r--)i[r].destroy();if(this._children.length=0,null!=this._parent){var a=this._parent._children;a.splice(a.indexOf(this),1)}this._parent=null,t._entitys.delete(this)},n._removeComponent=function(e){Ge._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)},n._removeFromParent=function(){var e=this._parent;if(null!=e){var t=e._children;t.splice(t.indexOf(this),1),this._parent=null}return e},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._getComponentsIncludeChildren=function(e,t){for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}for(var r=this._children.length-1;r>=0;r--)this._children[r]._getComponentsIncludeChildren(e,t)},n._setActiveComponents=function(e){for(var t=this._activeChangedComponents,n=0,i=t.length;n<i;++n)t[n]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var t=this._components,n=t.length-1;n>=0;n--)e.push(t[n]);for(var i=this._children,r=i.length-1;r>=0;r--){var a=i[r];a.isActive&&a._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(f.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},E(t,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var n=this._removeFromParent(),i=this._parent=e;if(i){i._children.push(this);var r=i._scene;this._scene!==r&&t._traverseSetOwnerScene(this,r),i._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),n&&t._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"engine",get:function(){return this._engine}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}]),t}(Y);Je._entitys=new Be;var $e=function(){function e(){this._features=[],this._objects=[]}var t=e.prototype;return t.registerFeature=function(e){for(var t=this._features,n=0,i=t.length;n<i;n++)if(t[n]===e)return;t.push(e);for(var r=this._objects,a=0,o=r.length;a<o;a++)r[a].features.push(new e)},t.addObject=function(e){e.features=[];for(var t=0,n=this._features.length;t<n;t++){var i;e.features.push(new this._features[t](null!=(i=e.engine)?i:e))}this._objects.push(e)},t.callFeatureMethod=function(e,t,n){for(var i=e.features,r=i.length,a=0;a<r;a++){var o=i[a];o[t]&&o[t].apply(o,n)}},t.findFeature=function(e,t){for(var n=e.features,i=n.length,r=0;r<i;r++){var a=n[r];if(a.constructor===t)return a}},e}(),et=function(){function e(){}return e.getFromPool=function(){var t=e._elementPoolIndex,n=e._elementPool;if(e._elementPoolIndex++,n.length===t){var i=new e;return n.push(i),i}return n[t]},e._restPool=function(){e._elementPoolIndex=0},e.prototype.setValue=function(e,t,n,i){this.component=e,this.primitive=t,this.subPrimitive=n,this.material=i},e}();et._elementPoolIndex=0,et._elementPool=[];var tt=function(e){function t(n,i){var r;return(r=e.call(this,n)||this).clipPlanes=[],r._activeCameras=[],r._isActiveInEngine=!1,r._destroyed=!1,r._rootEntities=[],r.features=[],r.name=i||"",t.sceneFeatureManager.addObject(y(r)),r}A(t,e);var n=t.prototype;return n.createRootEntity=function(e){var t=new Je(this._engine,e);return this.addRootEntity(t),t},n.addRootEntity=function(e){var t=e._isRoot;t||(e._isRoot=!0,e._removeFromParent());var n=e._scene;n!==this?(n&&t&&n._removeEntity(e),this._rootEntities.push(e),Je._traverseSetOwnerScene(e,this)):t||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},n.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),Je._traverseSetOwnerScene(e,null))},n.getRootEntity=function(e){return void 0===e&&(e=0),this._rootEntities[e]},n.findEntityByName=function(e){for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];if(i.name===e)return i}for(var r=t.length-1;r>=0;r--){var a=t[r].findByName(e);if(a)return a}return null},n.findEntityByPath=function(e){for(var t=e.split("/").filter(Boolean),n=0,i=this.rootEntitiesCount;n<i;n++){var r=this.getRootEntity(n);if(r.name==t[0]){for(var a=1,o=t.length;a<o&&(r=Je._findChildByName(r,t[a]));++a);return r}}return null},n.destroy=function(){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),t.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,n=this.rootEntitiesCount;e<n;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,t.sceneFeatureManager._objects=[],this._destroyed=!0},n.attachRenderCamera=function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):Ie("Camera already attached.")},n.detachRenderCamera=function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)},n._processActive=function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];i._isActive&&(e?i._processActive():i._processInActive())}},n._removeEntity=function(e){var t=this._rootEntities;t.splice(t.indexOf(e),1)},t.registerFeature=function(e){t.sceneFeatureManager.registerFeature(e)},n.findFeature=function(e){return t.sceneFeatureManager.findFeature(this,e)},n.raycast=function(e,t,n){},E(t,[{key:"engine",get:function(){return this._engine}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(Y);tt.sceneFeatureManager=new $e;var nt=function(){function e(e){this.engine=e}var t=e.prototype;return t.loadScene=function(e,t){var n=this;void 0===t&&(t=!0);var i=this.engine.resourceManager.load(e);return i.then((function(e){var i=n._activeScene;n.activeScene=e,i&&t&&i.destroy()})),i},t.mergeScenes=function(e,t){for(var n=e.rootEntities,i=0,r=n.length;i<r;i++)t.addRootEntity(n[i])},E(e,[{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),it=new $e,rt=function(e){function t(t,n){var i;return(i=e.call(this,null)||this)._componentsManager=new Ue,i._resourceManager=new F(y(i)),i._sceneManager=new nt(y(i)),i._vSyncCount=1,i._targetFrameRate=60,i._time=new De,i._isPaused=!0,i._loopCounter=0,i._targetFrameInterval=1e3/60,i._animate=function(){i._vSyncCount?(i._requestId=requestAnimationFrame(i._animate),i._loopCounter++%i._vSyncCount==0&&(i.update(),i._loopCounter=0)):(i._timeoutId=window.setTimeout(i._animate,i._targetFrameInterval),i.update())},i.features=[],i._hardwareRenderer=n,i._hardwareRenderer.init(t),i._canvas=t,it.addObject(y(i)),i._sceneManager.activeScene=new tt(y(i),"DefaultScene"),i}A(t,e);var n=t.prototype;return n.createEntity=function(e){return new Je(this,e)},n.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},n.resume=function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))},n.update=function(){var e=this._time,t=e.deltaTime;e.tick(),et._restPool(),it.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]),this._hardwareRenderer.beginFrame();var n=this._sceneManager._activeScene,i=this._componentsManager;n&&(i.callScriptOnStart(),i.callScriptOnUpdate(t),i.callAnimationUpdate(t),i.callScriptOnLateUpdate(t),this._render(n)),this._componentsManager.callComponentDestory(),this._hardwareRenderer.endFrame(),it.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},n.run=function(){it.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new V("run",this))},n.destroy=function(){this._sceneManager&&(this.trigger(new V("shutdown",this)),it.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._sceneManager=null,this._resourceManager.gc(),this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,it._objects=[])},n._render=function(e){var t=e._activeCameras,n=this._componentsManager,i=this.time.deltaTime;if(n.callRendererOnUpdate(i),t.length>0){t.sort((function(e,t){return e.priority-t.priority}));for(var r=0,a=t.length;r<a;r++){var o=t[r],s=o.entity;o.enabled&&s.isActiveInHierarchy&&(n.callCameraOnBeginRender(o),tt.sceneFeatureManager.callFeatureMethod(e,"preRender",[this,o]),o.render(),tt.sceneFeatureManager.callFeatureMethod(e,"postRender",[this,o]),n.callCameraOnEndRender(o))}}else Pe("NO active camera.")},n.findFeature=function(e){return it.findFeature(this,e)},t.registerFeature=function(e){it.registerFeature(e)},E(t,[{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"renderhardware",get:function(){return this._hardwareRenderer}}]),t}(Y),at=function(e){function t(){return e.apply(this,arguments)||this}return A(t,e),t}(X),ot=function(){},st=function(){function e(){}var t=e.prototype;return t.preUpdate=function(e){},t.postUpdate=function(e){},t.preRender=function(e,t){},t.postRender=function(e,t){},t.destroy=function(e){},e}(),ut=Object.defineProperty,ct=Object.getOwnPropertyDescriptor,lt=function(e,t,n,i){for(var r,a=i>1?void 0:i?ct(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ut(t,n,a),a},ft=function(e){function t(){var t;return(t=e.apply(this,arguments)||this)._started=!1,t._onStartIndex=-1,t._onUpdateIndex=-1,t._onLateUpdateIndex=-1,t._onPreRenderIndex=-1,t._onPostRenderIndex=-1,t}A(t,e);var n=t.prototype;return n.onAwake=function(){},n.onEnable=function(){},n.onStart=function(){},n.onUpdate=function(e){},n.onLateUpdate=function(e){},n.onBeginRender=function(e){},n.onEndRender=function(e){},n.onDisable=function(){},n.onDestroy=function(){},n._onAwake=function(){this.onAwake()},n._onEnable=function(){var e=this.engine._componentsManager,n=t.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==n.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==n.onLateUpdate&&e.addOnLateUpdateScript(this),this.onEnable()},n._onDisable=function(){var e=this.engine._componentsManager;-1!==this._onStartIndex&&e.removeOnStartScript(this),-1!==this._onUpdateIndex&&e.removeOnUpdateScript(this),-1!==this._onLateUpdateIndex&&e.removeOnLateUpdateScript(this),this.onDisable()},n._onDestroy=function(){this.engine._componentsManager.addDestoryComponent(this)},t}(Xe);lt([B],ft.prototype,"_started",2),lt([B],ft.prototype,"_onStartIndex",2),lt([B],ft.prototype,"_onUpdateIndex",2),lt([B],ft.prototype,"_onLateUpdateIndex",2),lt([B],ft.prototype,"_onPreRenderIndex",2),lt([B],ft.prototype,"_onPostRenderIndex",2);var ht=Object.defineProperty,dt=Object.getOwnPropertyDescriptor,_t=function(e,t,n,i){for(var r,a=i>1?void 0:i?dt(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ht(t,n,a),a},pt=function(e){function t(n){var i;(i=e.call(this,n)||this)._onUpdateIndex=-1,i._rendererIndex=-1,i._overrideUpdate=!1,i._bounds=new u(new s,new s);var r=t.prototype;return i._overrideUpdate=i.update!==r.update,i._transformChangeFlag=i.entity.transform.registerWorldChangeFlag(),i}A(t,e);var n=t.prototype;return n.destroy=function(){e.prototype.destroy.call(this);var t=this._transformChangeFlag;t&&(t.destroy(),this._transformChangeFlag=null)},n.update=function(e){},n._updateBounds=function(e){},n._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},n._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},n._render=function(e){var t=!1;if(this.cullDistanceSq>0){var n=s.distanceSquared(e._entity.transform.worldPosition,this.entity.transform.worldPosition);t=this.cullDistanceSq<n}t||this.render(e)},E(t,[{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),t}(Xe);_t([B],pt.prototype,"_onUpdateIndex",2),_t([B],pt.prototype,"_rendererIndex",2),_t([B],pt.prototype,"_overrideUpdate",2),_t([B],pt.prototype,"_transformChangeFlag",2),_t([k],pt.prototype,"_bounds",2);var mt=0,vt=function(){function e(e,t,n,i,r,a){void 0===e&&(e="RENDER_PASS"+mt++),void 0===t&&(t=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=new v(0,0,0,0)),this.name=e,this.enabled=!0,this.priority=t,this.renderTarget=n,this.replaceMaterial=i,this.mask=r||xe.EVERYTHING,this.renderOverride=!1,this.clearMode=J.SOLID_COLOR,this._clearParam=a}var t=e.prototype;return t.render=function(e,t,n){},t.preRender=function(e,t,n){},t.postRender=function(e,t,n){},E(e,[{key:"clearParam",get:function(){return this._clearParam},set:function(e){this._clearParam=e}}]),e}(),gt=function(){function e(){this.viewProjectMatrix=new f}return e._getRenderContext=function(t){var n=e._renderContext;return n.camera=t,n.viewport=t.viewport,n.cameraPosition=t.entity.transform.worldPosition,n.inverseViewMatrix=t.inverseViewMatrix,n.inverseProjectionMatrix=t.inverseProjectionMatrix,n.viewMatrix=t.viewMatrix,n.projectionMatrix=t.projectionMatrix,f.multiply(n.projectionMatrix,n.viewMatrix,n.viewProjectMatrix),this._renderContext},e}();gt._renderContext=new gt;var yt,xt,Tt=function(){function e(){this._items=[]}var t=e.prototype;return t.clear=function(){this._items=[]},t.pushPrimitive=function(e){this._items.push(e)},t.sortByDistance=function(e){var t=this._items;t.length>1&&(this._items=t.sort((function(t,n){if(t.component.renderPriority===n.component.renderPriority){var i=t.component.entity.transform.worldPosition,r=n.component.entity.transform.worldPosition;return s.distanceSquared(r,e)-s.distanceSquared(i,e)}return t.component.renderPriority-n.component.renderPriority})))},t.sortByTechnique=function(){var e=this._items;e.length>1&&(this._items=e.sort((function(e,t){if(e.component.renderPriority===t.component.renderPriority){var n=e.material.technique,i=t.material.technique;return n&&i?n.name.localeCompare(i.name):0}return e.component.renderPriority-t.component.renderPriority})))},t.pushSprite=function(e,t,n,i,r,a,o){var s={component:e,positionQuad:t,uvRect:n,tintColor:i,texture:r,renderMode:a,camera:o};this._items.push(s)},t.render=function(e,t,n){var i=e.scene.engine._hardwareRenderer,r=this._items;if(0!==r.length){this.updateMaxJointsNum(this._items,t);for(var a=gt._getRenderContext(e),o=e.cullingMask,s=0,u=r.length;s<u;s++){var c=r[s],l=c.component;if(o&l._entity.layer)if(l.renderPassFlag&n)if(this._isPrimitive(c)){var f=c;i.flushSprite();var h=t||f.material;null==h.preRender||h.preRender(f.component,f.primitive),h.prepareDrawing(a,f.component,f.primitive,f.material),i.drawPrimitive(f.primitive,f.subPrimitive,h),null==h.postRender||h.postRender(f.component,f.primitive)}else{var d=c;i.drawSprite(d.positionQuad,d.uvRect,d.tintColor,d.texture,d.renderMode,d.camera)}}i.flushSprite()}},t.updateMaxJointsNum=function(e,t){for(var n=0,i=e.length;n<i;n++){var r=e[n],a=r.component,o=r.material,s=t||o;a.jointNodes&&(s.maxJointsNum=Math.max(s.maxJointsNum,a.jointNodes.length))}},t._isPrimitive=function(e){return!!e.primitive},E(e,[{key:"items",get:function(){return this._items}}]),e}(),bt=function(e){function t(t,n){var i;return void 0===t&&(t="SeparateSprite"),void 0===n&&(n=10),(i=e.call(this,t,n)||this).clearMode=J.DONT_CLEAR,i.renderOverride=!0,i._spriteItems=[],i}A(t,e);var n=t.prototype;return n.preRender=function(){this.enabled=this.isUsed},n.render=function(e){var t=e.renderHardware;this._sortByDistance(e.eyePos);for(var n=this._spriteItems,i=0;i<n.length;i++){var r=n[i];t.drawSprite(r.positionQuad,r.uvRect,r.tintColor,r.texture,r.renderMode,r.camera)}n.length=0},n.postRender=function(e){this.enabled&&e.renderHardware.flushSprite()},n._sortByDistance=function(e){this._spriteItems.length>1&&(this._spriteItems=this._spriteItems.sort((function(t,n){if(t.component.renderPriority===n.component.renderPriority){var i=t.component.node.worldPosition,r=n.component.node.worldPosition;return s.distanceSquared(r,e)-s.distanceSquared(i,e)}return t.component.renderPriority-n.component.renderPriority})))},n.pushSprite=function(e,t,n,i,r,a,o){this._spriteItems.push({component:e,positionQuad:t,uvRect:n,tintColor:i,texture:r,renderMode:a,camera:o})},E(t,[{key:"isUsed",get:function(){return this._spriteItems.length>0}}]),t}(vt),Et=function(e){function t(t){var n;return(n=e.call(this)||this)._camera=t,n._opaqueQueue=new Tt,n._transparentQueue=new Tt,n._renderPassArray=[],n._defaultPass=new vt("default",0,null,null,0),n.addRenderPass(n._defaultPass),n}A(t,e);var n=t.prototype;return n.addRenderPass=function(e,t,n,i,r,a){if(void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=new v(0,0,0,0)),"string"==typeof e){var o=new vt(e,t,n,i,r,a);this._renderPassArray.push(o)}else e instanceof vt&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))},n.removeRenderPass=function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof vt&&(t=e),t){var n=this._renderPassArray.indexOf(t);this._renderPassArray.splice(n,1)}},n.getRenderPass=function(e){for(var t=0,n=this._renderPassArray.length;t<n;t++){var i=this._renderPassArray[t];if(i.name===e)return i}return null},n.destroy=function(){},n.render=function(){var e=this._camera,t=this._opaqueQueue,n=this._transparentQueue;t.clear(),n.clear(),e.engine._componentsManager.callRender(e),t.sortByTechnique(),n.sortByDistance(e.entity.transform.worldPosition),this._canvasDepthPass&&(this._canvasDepthPass.enabled=!1),this._separateSpritePass&&this._separateSpritePass.isUsed&&this._defaultPass.renderTarget&&(this._canvasDepthPass||(this._canvasDepthPass=new vt("CanvasDepthRenderPass",0,null,null,0),this._canvasDepthPass.clearMode=J.DONT_CLEAR,this.addRenderPass(this._canvasDepthPass)),this._canvasDepthPass.enabled=!0);for(var i=0,r=this._renderPassArray.length;i<r;i++)this._drawRenderPass(this._renderPassArray[i],e)},n._drawRenderPass=function(e,t){e.preRender(t,this.opaqueQueue,this.transparentQueue);var n=t.scene.engine._hardwareRenderer,i=t.renderTarget||e.renderTarget;n.activeRenderTarget(i,t),e.enabled&&(n.clearRenderTarget(e.clearMode,e.clearParam),e.renderOverride?e.render(t,this.opaqueQueue,this.transparentQueue):(this.opaqueQueue.render(t,e.replaceMaterial,e.mask),this.transparentQueue.render(t,e.replaceMaterial,e.mask))),n.blitRenderTarget(i),e.postRender(t,this.opaqueQueue,this.transparentQueue)},n.pushPrimitive=function(e){e.material.renderType===ee.TRANSPARENT?this._transparentQueue.pushPrimitive(e):this._opaqueQueue.pushPrimitive(e)},n.pushSprite=function(e,t,n,i,r,a,o){if(e.separateDraw)return this._separateSpritePass||(this._separateSpritePass=new bt,this.addRenderPass(this._separateSpritePass)),void this._separateSpritePass.pushSprite(e,t,n,i,r,a,o);this._transparentQueue.pushSprite(e,t,n,i,r,a,o)},E(t,[{key:"defaultRenderPass",get:function(){return this._defaultPass}},{key:"opaqueQueue",get:function(){return this._opaqueQueue}},{key:"transparentQueue",get:function(){return this._transparentQueue}}]),t}(ot),At=Object.defineProperty,Ot=Object.getOwnPropertyDescriptor,Ct=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ot(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&At(t,n,a),a},Rt=function(){};Rt.tempMat4=new f,Rt.tempVec4=new v,Rt.tempVec3=new s,(xt=yt||(yt={}))[xt.DepthSky=0]="DepthSky",xt[xt.DepthColor=1]="DepthColor",xt[xt.Depth=2]="Depth",xt[xt.None=3]="None";var St=function(e){function t(t){var n;return(n=e.call(this,t)||this).priority=0,n.cullingMask=ze.Everything,n._isOrthographic=!1,n._isProjMatSetting=!1,n._clearMode=J.SOLID_COLOR,n._nearClipPlane=.1,n._farClipPlane=100,n._fieldOfView=45,n._orthographicSize=10,n._isProjectionDirty=!0,n._isInvProjMatDirty=!0,n._customAspectRatio=void 0,n._renderTarget=null,n._projectionMatrix=new f,n._viewMatrix=new f,n._backgroundColor=new v,n._viewport=new v(0,0,1,1),n._inverseProjectionMatrix=new f,n._inverseViewMatrix=new f,n._lastAspectSize=new _(0,0),n._invViewProjMat=new f,n._transform=n.entity.transform,n._isViewMatrixDirty=n._transform.registerWorldChangeFlag(),n._isInvViewProjDirty=n._transform.registerWorldChangeFlag(),n._renderPipeline=new Et(y(n)),n.setClearMode(),n}A(t,e);var n=t.prototype;return n.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},n.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},n.worldToViewportPoint=function(e,t){f.multiply(this.projectionMatrix,this.viewMatrix,Rt.tempMat4),Rt.tempVec4.setValue(e.x,e.y,e.z,1),v.transform(Rt.tempVec4,Rt.tempMat4,Rt.tempVec4);var n=Rt.tempVec4.w,i=Rt.tempVec4.x/n,r=Rt.tempVec4.y/n,a=Rt.tempVec4.z/n;return t.x=.5*(i+1),t.y=.5*(1-r),t.z=a,t.w=n,t},n.viewportToWorldPoint=function(e,t){var n=this.invViewProjMat;return this._innerViewportToWorldPoint(e,n,t)},n.viewportPointToRay=function(e,t){var n=Rt.tempVec3;n.setValue(e.x,e.y,0);var i=this.viewportToWorldPoint(n,t.origin);n.z=1;var r=this._innerViewportToWorldPoint(n,this._invViewProjMat,n);return s.subtract(r,i,t.direction),t.direction.normalize(),t},n.screenToViewportPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(e.x/n.width-i.x)/i.z,t.y=(e.y/n.height-i.y)/i.w,t},n.viewportToScreenPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(i.x+e.x*i.z)*n.width,t.y=(i.y+e.y*i.w)*n.height,t},n.worldToScreenPoint=function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)},n.screenToWorldPoint=function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)},n.render=function(e){this._renderPipeline.render()},n._onActive=function(){this.entity.scene.attachRenderCamera(this)},n._onInActive=function(){this.entity.scene.detachRenderCamera(this)},n._onDestroy=function(){var e;null==(e=this._renderPipeline)||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy()},n._projMatChange=function(){this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},n._innerViewportToWorldPoint=function(e,t,n){var i=2*e.z-1,r=Rt.tempVec4;r.setValue(2*e.x-1,1-2*e.y,i,1),v.transform(r,t,r);var a=1/r.w;return n.x=r.x*a,n.y=r.y*a,n.z=r.z*a,n},n.setClearMode=function(e,t){void 0===e&&(e=J.SOLID_COLOR),void 0===t&&(t=new v(.25,.25,.25,1)),this._clearMode=e,this._backgroundColor=t,this._renderPipeline.defaultRenderPass.clearParam=t,this._renderPipeline.defaultRenderPass.clearMode=e},E(t,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!=(e=this._customAspectRatio)?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"clearFlags",get:function(){throw"not implemented"},set:function(e){throw"not implemented"}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this.setClearMode(this._clearMode,e)}},{key:"backgroundSky",get:function(){throw new Error("接口未实现")}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,f.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()},get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var n=this._orthographicSize*t,i=this._orthographicSize;f.ortho(-n,n,-i,i,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else f.perspective(o.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix}},{key:"enableHDR",get:function(){return console.log("not implemention"),!1},set:function(e){console.log("not implemention")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}},{key:"invViewProjMat",get:function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,f.multiply(this.inverseViewMatrix,this.inverseProjectionMatrix,this._invViewProjMat)),this._invViewProjMat}},{key:"inverseProjectionMatrix",get:function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,f.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix}},{key:"inverseViewMatrix",get:function(){return this._transform.worldMatrix.cloneTo(this._inverseViewMatrix),this._inverseViewMatrix}}]),t}(Xe);Ct([B],St.prototype,"_renderPipeline",2),Ct([B],St.prototype,"_transform",2),Ct([B],St.prototype,"_isViewMatrixDirty",2),Ct([B],St.prototype,"_isInvViewProjDirty",2),Ct([k],St.prototype,"_projectionMatrix",2),Ct([k],St.prototype,"_viewMatrix",2),Ct([k],St.prototype,"_backgroundColor",2),Ct([k],St.prototype,"_viewport",2),Ct([k],St.prototype,"_inverseProjectionMatrix",2),Ct([k],St.prototype,"_inverseViewMatrix",2),Ct([k],St.prototype,"_lastAspectSize",2),Ct([k],St.prototype,"_invViewProjMat",2),St=Ct([function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){t.forEach((function(t){return Ge.register(e,t)}))}}(Ze)],St);var wt={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function Mt(e,t){return void 0===t&&(t={}),new M((function(n,i,r){var a,o,s,u,c=null!=(a=t.retryCount)?a:4,l=null!=(o=t.retryInterval)?o:500;t.timeout=null!=(s=t.timeout)?s:15e3,t.type=null!=(u=t.type)?u:function(e){var t=e.substring(e.lastIndexOf(".")+1);return wt[t]}(e);var f,h="image"===t.type?Pt:Lt,d=new Nt((function(){return h(e,t).onProgress(r).then((function(e){n(e),d.stop()})).catch((function(e){return f=e}))}),c,l);d.start((function(){i(f)}))}))}function Pt(e,t){return new M((function(n,i){var r=t.timeout,a=new Image,o=function(){i(new Error("request "+e+" fail"))};a.onerror=o,a.onabort=o;var s,u=setTimeout((function(){i(new Error("request "+e+" timeout"))}),r);a.onload=(s=u,function(){n(a),clearTimeout(s)}),a.crossOrigin="anonymous",a.src=e}))}function Lt(e,t){return new M((function(n,i,r){var a,o=new XMLHttpRequest;o.timeout=t.timeout,t.method=null!=(a=t.method)?a:"get",o.onload=function(){var t;if(o.status<200||o.status>=300)i(new Error("request failed from: "+e));else{var r=null!=(t=o.response)?t:o.responseText;n(r)}},o.onerror=function(){i(new Error("request failed from: "+e))},o.ontimeout=function(){i(new Error("request timeout from: "+e))},o.onprogress=function(e){r(e.loaded/e.total)},o.open(t.method,e,!0),o.withCredentials="include"===t.credentials,o.responseType=t.type;var s=t.headers;s&&Object.keys(s).forEach((function(e){o.setRequestHeader(e,s[e])})),o.send(t.body)}))}var It,Ft,Nt=function(){function e(e,t,n){this.execFunc=e,this.totalCount=t,this.interval=n,this._timeoutId=-100,this._currentCount=0,this.exec=this.exec.bind(this)}var t=e.prototype;return t.start=function(e){this.done=e,this.exec()},t.stop=function(){clearTimeout(this._timeoutId)},t.exec=function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))},e}(),Dt=function(e){this.useCache=e,this.request=Mt};(Ft=It||(It={}))[Ft.Text=0]="Text",Ft[Ft.JSON=1]="JSON",Ft[Ft.Buffer=2]="Buffer",Ft[Ft.Texture2D=3]="Texture2D",Ft[Ft.TextureCube=4]="TextureCube",Ft[Ft.Material=5]="Material",Ft[Ft.Mesh=6]="Mesh",Ft[Ft.AnimationClip=7]="AnimationClip",Ft[Ft.Perfab=8]="Perfab",Ft[Ft.KTX=9]="KTX",Ft[Ft.KTXCube=10]="KTXCube";var zt=function(e){function t(t){var n;return(n=e.call(this,t)||this).isGCIgnored=!1,n._refCount=0,n._refChildren=[],n._refParent=null,n._destroyed=!1,t.resourceManager._addRefObject(n.instanceId,y(n)),n}A(t,e);var n=t.prototype;return n.destroy=function(e){if(void 0===e&&(e=!1),this._destroyed)return!0;if(!e&&0!==this._refCount)return!1;var t=this._engine.resourceManager;return t&&(t._deleteAsset(this),t._deleteRefObject(this.instanceId)),this._refParent&&L(this._refParent._refChildren,this),this._engine=null,this._onDestroy(),this._destroyed=!0,!0},n._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},n._addRefCount=function(e){this._refCount+=e;for(var t,n=x(this._refChildren);!(t=n()).done;){t.value._addRefCount(e)}},n._addRefChild=function(e){this._refChildren.push(e),e._refParent=this,e._addRefCount(this._refCount)},n._removeRefChild=function(e){L(this._refChildren,e)&&(e._refParent=null,e._addRefCount(-this._refCount))},E(t,[{key:"refCount",get:function(){return this._refCount}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(X),Vt=new s(0,1,0),Bt=function(e){function t(t){var n;return n=e.call(this,t)||this,t.addEventListener("removedFromScene",n._onDisable.bind(y(n))),n}A(t,e),t.getUniformDefine=function(e){return{}};var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(Xt).attachRenderLight(this)},n._onDisable=function(){this.scene.findFeature(Xt).detachRenderLight(this)},E(t,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new f),f.invert(this.inverseViewMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._modelMat||(this._modelMat=new f),f.rotateAxisAngle(this.entity.transform.worldMatrix,Vt,Math.PI,this._modelMat),this._modelMat}}]),t}(Xe),Ut=function(e){function t(t){var n;return(n=e.call(this,t)||this).color=new s(1,1,1),n.intensity=1,n._lightColor=new s,n}return A(t,e),t.getUniformDefine=function(e){var t;return(t={})[e+".color"]={name:e+".color",type:_e.FLOAT_VEC3},t[e+".lightColor"]={name:e+".lightColor",type:_e.FLOAT_VEC3},t[e+".intensity"]={name:e+".intensity",type:_e.FLOAT},t},t.prototype.bindMaterialValues=function(e,t){e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity)},E(t,[{key:"lightColor",get:function(){return s.scale(this.color,this.intensity,this._lightColor),this._lightColor}}]),t}(Bt),kt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._forward=new s,n.color=new s(1,1,1),n.intensity=1,n._lightColor=new s,n._reverseDirection=new s,n}return A(t,e),t.getUniformDefine=function(e){var t={};return t[e+".color"]={name:e+".color",type:_e.FLOAT_VEC3},t[e+".lightColor"]={name:e+".lightColor",type:_e.FLOAT_VEC3},t[e+".intensity"]={name:e+".intensity",type:_e.FLOAT},t[e+".direction"]={name:e+".direction",type:_e.FLOAT_VEC3},t},t.prototype.bindMaterialValues=function(e,t){e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".direction",this.direction)},E(t,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return s.scale(this.color,this.intensity,this._lightColor),this._lightColor}},{key:"reverseDirection",get:function(){return s.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),t}(Bt),Gt=new c,jt=function(e){function t(t){var n;return(n=e.call(this,t)||this).diffuse=new s(.3,.3,.3),n.specular=new s(.5,.5,.5),n.diffuseIntensity=1,n.specularIntensity=1,n}return A(t,e),t.getUniformDefine=function(e){var t={};return t.u_env_diffuseSampler={name:"u_env_diffuseSampler",type:_e.SAMPLER_CUBE},t.u_env_specularSampler={name:"u_env_specularSampler",type:_e.SAMPLER_CUBE},t[e+".diffuse"]={name:e+".diffuse",type:_e.FLOAT_VEC3},t[e+".specular"]={name:e+".specular",type:_e.FLOAT_VEC3},t[e+".mipMapLevel"]={name:e+".mipMapLevel",type:_e.FLOAT},t[e+".transformMatrix"]={name:e+".transformMatrix",type:_e.FLOAT_MAT3},t[e+".diffuseIntensity"]={name:e+".diffuseIntensity",type:_e.FLOAT},t[e+".specularIntensity"]={name:e+".specularIntensity",type:_e.FLOAT},t},t.prototype.bindMaterialValues=function(e,t){e.setValue(t+".diffuseIntensity",this.diffuseIntensity),e.setValue(t+".specularIntensity",this.specularIntensity),this.useDiffuseMap?e.setValue("u_env_diffuseSampler",this.diffuseMap):e.setValue(t+".diffuse",this.diffuse),this.useSpecularMap?(e.setValue("u_env_specularSampler",this.specularMap),e.setValue(t+".mipMapLevel",this.specularMap.mipmapCount)):e.setValue(t+".specular",this.specular);var n=this.entity.transform.worldMatrix;Gt.setValueByMatrix(n),e.setValue(t+".transformMatrix",Gt)},E(t,[{key:"useDiffuseMap",get:function(){return!!this.diffuseMap}},{key:"useSpecularMap",get:function(){return!!this.specularMap}}]),t}(Bt),Ht=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).color=new s(1,1,1),t.intensity=1,t.distance=0,t.decay=0,t._lightColor=new s,t}return A(t,e),t.getUniformDefine=function(e){var t={};return t[e+".position"]={name:e+".position",type:_e.FLOAT_VEC3},t[e+".color"]={name:e+".color",type:_e.FLOAT_VEC3},t[e+".lightColor"]={name:e+".lightColor",type:_e.FLOAT_VEC3},t[e+".intensity"]={name:e+".intensity",type:_e.FLOAT},t[e+".distance"]={name:e+".distance",type:_e.FLOAT},t[e+".decay"]={name:e+".decay",type:_e.FLOAT},t},t.prototype.bindMaterialValues=function(e,t){e.setValue(t+".position",this.position),e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".distance",this.distance),e.setValue(t+".decay",this.decay)},E(t,[{key:"position",get:function(){return this.entity.worldPosition}},{key:"lightColor",get:function(){return s.scale(this.color,this.intensity,this._lightColor),this._lightColor}}]),t}(Bt),Wt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._forward=new s,n.color=new s(1,1,1),n.penumbra=0,n.distance=0,n.intensity=1,n.decay=0,n.angle=Math.PI/6,n._lightColor=new s,n._inverseDirection=new s,n}return A(t,e),t.getUniformDefine=function(e){var t={};return t[e+".position"]={name:e+".position",type:_e.FLOAT_VEC3},t[e+".direction"]={name:e+".direction",type:_e.FLOAT_VEC3},t[e+".color"]={name:e+".color",type:_e.FLOAT_VEC3},t[e+".lightColor"]={name:e+".lightColor",type:_e.FLOAT_VEC3},t[e+".intensity"]={name:e+".intensity",type:_e.FLOAT},t[e+".distance"]={name:e+".distance",type:_e.FLOAT},t[e+".decay"]={name:e+".decay",type:_e.FLOAT},t[e+".angle"]={name:e+".angle",type:_e.FLOAT},t[e+".penumbra"]={name:e+".penumbra",type:_e.FLOAT},t[e+".coneCos"]={name:e+".coneCos",type:_e.FLOAT},t[e+".penumbraCos"]={name:e+".penumbraCos",type:_e.FLOAT},t},t.prototype.bindMaterialValues=function(e,t){e.setValue(t+".position",this.position),e.setValue(t+".direction",this.direction),e.setValue(t+".color",this.color),e.setValue(t+".lightColor",this.lightColor),e.setValue(t+".intensity",this.intensity),e.setValue(t+".distance",this.distance),e.setValue(t+".decay",this.decay),e.setValue(t+".angle",this.angle),e.setValue(t+".penumbra",this.penumbra),e.setValue(t+".coneCos",Math.cos(this.angle)),e.setValue(t+".penumbraCos",Math.cos(this.angle*(1-this.penumbra)))},E(t,[{key:"position",get:function(){return this.entity.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return s.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return s.scale(this.color,this.intensity,this._lightColor),this._lightColor}}]),t}(Bt);var Xt=function(e){function t(){var t;return(t=e.call(this)||this).visibleLights=[],t}A(t,e),E(t,[{key:"lightSortAmount",get:function(){for(var e=0,t=0,n=0,i=0,r=0,a=!1,o=!1,s=this.visibleLights,u=0,c=s.length;u<c;u++){var l=s[u];l instanceof Ut?e++:l instanceof kt?t++:l instanceof Ht?n++:l instanceof Wt?i++:l instanceof jt&&(r++,a=l.useDiffuseMap,o=l.useSpecularMap)}return{ambientLightCount:e,directLightCount:t,pointLightCount:n,spotLightCount:i,envMapLightCount:r,useDiffuseEnv:a,useSpecularEnv:o}}}]);var n=t.prototype;return n.attachRenderLight=function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):Ie("Light already attached.")},n.detachRenderLight=function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)},n.bindMaterialValues=function(e){for(var t=0,n=0,i=0,r=this.visibleLights,a=0,o=r.length;a<o;a++){var s=r[a];s instanceof Ut?s.bindMaterialValues(e,"u_ambientLight"):s instanceof kt?s.bindMaterialValues(e,"u_directLights["+t+++"]"):s instanceof Ht?s.bindMaterialValues(e,"u_pointLights["+n+++"]"):s instanceof Wt?s.bindMaterialValues(e,"u_spotLights["+i+++"]"):s instanceof jt&&s.bindMaterialValues(e,"u_envMapLight")}},n.getUniformDefine=function(){for(var e={},t=0,n=0,i=0,r=0,a=0,o=this.visibleLights,s=0,u=o.length;s<u;s++){var c=o[s];c instanceof Ut&&!t++?e=g({},e,Ut.getUniformDefine("u_ambientLight")):c instanceof kt?e=g({},e,kt.getUniformDefine("u_directLights["+n+++"]")):c instanceof Ht?e=g({},e,Ht.getUniformDefine("u_pointLights["+i+++"]")):c instanceof Wt?e=g({},e,Wt.getUniformDefine("u_spotLights["+r+++"]")):c instanceof jt&&!a++&&(e=g({},e,jt.getUniformDefine("u_envMapLight")))}return e},t}(st),qt=function(e){function t(){var t;return(t=e.call(this)||this).colliders=[],t}A(t,e);var n=t.prototype;return n.attachCollider=function(e){this.colliders.push(e)},n.detachCollider=function(e){var t=this.colliders.indexOf(e);-1!=t&&this.colliders.splice(t,1)},t}(st),Kt=function(e){function t(t){var n;return(n=e.call(this,t)||this).tag=xe.EVERYTHING,n}A(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(qt).attachCollider(this)},n._onDisable=function(){this.scene.findFeature(qt).detachCollider(this)},t}(Xe),Yt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._corners=[],n._cornerFlag=!1,n.boxMin=new s(-.5,-.5,-.5),n.boxMax=new s(.5,.5,.5),n}A(t,e);var n=t.prototype;return n.setBoxMinMax=function(e,t){this.boxMin=e,this.boxMax=t,this._cornerFlag=!0},n.setBoxCenterSize=function(e,n){var i=t._tempVec3;s.scale(n,.5,i),s.add(e,i,this.boxMax),s.subtract(e,i,this.boxMin),this._cornerFlag=!0},n.getCorners=function(){if(this._cornerFlag){var e=this.boxMin.x,t=this.boxMin.y,n=this.boxMin.z,i=this.boxMax.x-e,r=this.boxMax.y-t,a=this.boxMax.z-n;if(0===this._corners.length)for(var o=0;o<8;++o)this._corners.push(new s);this._corners[0].setValue(e+i,t+r,n+a),this._corners[1].setValue(e,t+r,n+a),this._corners[2].setValue(e,t,n+a),this._corners[3].setValue(e+i,t,n+a),this._corners[4].setValue(e+i,t+r,n),this._corners[5].setValue(e,t+r,n),this._corners[6].setValue(e,t,n),this._corners[7].setValue(e+i,t,n),this._cornerFlag=!1}return this._corners},t}(Kt);Yt._tempVec3=new s;var Qt=function(e){function t(t){var n;return(n=e.call(this,t)||this).center=new s,n.radius=1,n}A(t,e);var n=t.prototype;return n.raycast=function(e,t){},n.setSphere=function(e,t){this.center=e,this.radius=t},t}(Kt),Zt=function(e){function t(t){var n;return(n=e.call(this,t)||this).planePoint=new s,n.normal=new s(0,1,0),n}return A(t,e),t.prototype.setPlane=function(e,t){this.planePoint=e,this.normal=t},t}(Kt);function Jt(e,t,n,i,r){var a=t.getPoint(n);s.transformCoordinate(a,e.entity.transform.worldMatrix,a),i.distance=s.distance(r,a),i.collider=e,i.point=a}function $t(e,t){var n=e.entity.getInvModelMatrix(),i=new s;s.transformCoordinate(t.origin,n,i);var r,a,o,u,c,l,f,d=new s;return r=d,a=t.direction,o=n,u=a.x,c=a.y,l=a.z,f=o.elements,r.x=u*f[0]+c*f[4]+l*f[8],r.y=u*f[1]+c*f[5]+l*f[9],r.z=u*f[2]+c*f[6]+l*f[10],new h(i,d)}tt.prototype.raycast=function(e,t,n){void 0===n&&(n=xe.EVERYTHING);for(var i=new h(e.origin,e.direction),r=this.findFeature(qt).colliders,a=new d,o=0,s=r.length;o<s;o++){var u=r[o];if(u.entity.isActiveInHierarchy&&u.tag&n){var c=new d;u.raycast(i,c)&&c.distance<a.distance&&(a=c)}}return t&&a.collider&&a.point.cloneTo(t),a.collider},Yt.prototype.raycast=function(e,t){var n=$t(this,e),i=n.intersectAABB(this.boxMax,this.boxMin);return!!i&&(Jt(this,n,i,t,e.origin),!0)},Qt.prototype.raycast=function(e,t){var n=$t(this,e),i=n.intersectSphere(this.center,this.radius);return!!i&&(Jt(this,n,i,t,e.origin),!0)},Zt.prototype.raycast=function(e,t){var n=$t(this,e),i=n.intersectPlane(this.planePoint,this.normal);return!!i&&(Jt(this,n,i,t,e.origin),!0)};var en=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).primitives=[],i.groups=[],i.bounds=new u(new s,new s),i.name=n,i}A(t,e);var n=t.prototype;return n.updatePrimitiveWeightsIndices=function(e){},n.destroy=function(){this.primitives=null},t}(X),tn=function(e){function t(t){var n;return(n=e.call(this,null)||this).inverseBindMatrices=[],n.joints=[],n.skeleton="none",n}return A(t,e),t}(at),nn=Object.defineProperty,rn=Object.getOwnPropertyDescriptor,an=function(e,t,n,i){for(var r,a=i>1?void 0:i?rn(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&nn(t,n,a),a};function on(e,t){for(var n=e.primitives,i=0,r=n.length;i<r;i++)n[i]._addRefCount(t)}var sn,un,cn,ln,fn,hn,dn,_n,pn,mn,vn,gn,yn=function(e){function t(t){var n;return(n=e.call(this,t)||this)._instanceMaterials=[],n._sharedMaterials=[],n._mesh=null,n}A(t,e);var n=t.prototype;return n.setSharedMaterial=function(e,t){this._sharedMaterials[e]&&this._sharedMaterials[e]._addRefCount(-1),t._addRefCount(1),this._sharedMaterials[e]=t},n.setMaterial=function(e,t){this._instanceMaterials[e]&&this._instanceMaterials[e]._addRefCount(-1),t._addRefCount(1),this._instanceMaterials[e]=t},n.getInstanceMaterial=function(e){return this._instanceMaterials[e]},n.getSharedMaterial=function(e){return this._sharedMaterials[e]},n.render=function(e){var t=this._mesh;if(t)for(var n=e._renderPipeline,i=t.primitives,r=t.groups,a=0,o=i.length;a<o;a++){var s=i[a],u=this._instanceMaterials[a]||this._sharedMaterials[a];if(u){var c=et.getFromPool();c.setValue(this,s,r[a],u),n.pushPrimitive(c)}else Fe("Primitive has no material: "+s.name)}},n.destroy=function(){e.prototype.destroy.call(this),this._mesh=null,this._instanceMaterials=[],this._sharedMaterials=[];for(var t=0;t<this._instanceMaterials.length;t++)this._instanceMaterials[t]._addRefCount(-1);for(var n=0;n<this._sharedMaterials.length;n++)this._sharedMaterials[n]._addRefCount(-1);this._mesh&&on(this._mesh,-1)},n._updateBounds=function(e){var t=this.mesh.bounds,n=this._entity.transform.worldMatrix;s.transformCoordinate(t.min,n,e.min),s.transformCoordinate(t.max,n,e.max)},E(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh&&on(this._mesh,-1),on(e,1),this._mesh=e,this._sharedMaterials=[],this._instanceMaterials=[]}}]),t}(pt);an([B],yn.prototype,"_instanceMaterials",2),an([U],yn.prototype,"_sharedMaterials",2),(un=sn||(sn={}))[un.Point=0]="Point",un[un.Bilinear=1]="Bilinear",un[un.Trilinear=2]="Trilinear",(ln=cn||(cn={}))[ln.R8G8B8=0]="R8G8B8",ln[ln.R8G8B8A8=1]="R8G8B8A8",ln[ln.R4G4B4A4=2]="R4G4B4A4",ln[ln.R5G5B5A1=3]="R5G5B5A1",ln[ln.R5G6B5=4]="R5G6B5",ln[ln.Alpha8=5]="Alpha8",ln[ln.R32G32B32A32=6]="R32G32B32A32",ln[ln.DXT1=7]="DXT1",ln[ln.DXT5=8]="DXT5",ln[ln.ETC1_RGB=9]="ETC1_RGB",ln[ln.ETC2_RGB=10]="ETC2_RGB",ln[ln.ETC2_RGBA5=11]="ETC2_RGBA5",ln[ln.ETC2_RGBA8=12]="ETC2_RGBA8",ln[ln.PVRTC_RGB2=13]="PVRTC_RGB2",ln[ln.PVRTC_RGBA2=14]="PVRTC_RGBA2",ln[ln.PVRTC_RGB4=15]="PVRTC_RGB4",ln[ln.PVRTC_RGBA4=16]="PVRTC_RGBA4",ln[ln.ASTC_4x4=17]="ASTC_4x4",ln[ln.ASTC_5x5=18]="ASTC_5x5",ln[ln.ASTC_6x6=19]="ASTC_6x6",ln[ln.ASTC_8x8=20]="ASTC_8x8",ln[ln.ASTC_10x10=21]="ASTC_10x10",ln[ln.ASTC_12x12=22]="ASTC_12x12",(hn=fn||(fn={}))[hn.Clamp=0]="Clamp",hn[hn.Repeat=1]="Repeat",hn[hn.Mirror=2]="Mirror",(_n=dn||(dn={}))[_n.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",_n[_n.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",_n[_n.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",_n[_n.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",_n[_n.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",_n[_n.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",_n[_n.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",_n[_n.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",_n[_n.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",_n[_n.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",_n[_n.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",_n[_n.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",_n[_n.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",_n[_n.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",_n[_n.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",_n[_n.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",_n[_n.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",_n[_n.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",_n[_n.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",_n[_n.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",_n[_n.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",_n[_n.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",_n[_n.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",_n[_n.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",_n[_n.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",_n[_n.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",_n[_n.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",_n[_n.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",_n[_n.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",_n[_n.R11_EAC=37488]="R11_EAC",_n[_n.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",_n[_n.RG11_EAC=37490]="RG11_EAC",_n[_n.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",_n[_n.RGB8_ETC2=37492]="RGB8_ETC2",_n[_n.SRGB8_ETC2=37493]="SRGB8_ETC2",_n[_n.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",_n[_n.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",_n[_n.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",_n[_n.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",_n[_n.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",_n[_n.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",_n[_n.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",_n[_n.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",_n[_n.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",_n[_n.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",_n[_n.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",_n[_n.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT",(mn=pn||(pn={}))[mn.R8G8B8=0]="R8G8B8",mn[mn.R8G8B8A8=1]="R8G8B8A8",mn[mn.R4G4B4A4=2]="R4G4B4A4",mn[mn.R5G5B5A1=3]="R5G5B5A1",mn[mn.R5G6B5=4]="R5G6B5",mn[mn.Alpha8=5]="Alpha8",mn[mn.R16G16B16A16=6]="R16G16B16A16",mn[mn.R32G32B32A32=7]="R32G32B32A32",(gn=vn||(vn={}))[gn.Depth=0]="Depth",gn[gn.DepthStencil=1]="DepthStencil",gn[gn.Stencil=2]="Stencil",gn[gn.Depth16=3]="Depth16",gn[gn.Depth24=4]="Depth24",gn[gn.Depth32=5]="Depth32",gn[gn.Depth24Stencil8=6]="Depth24Stencil8",gn[gn.Depth32Stencil8=7]="Depth32Stencil8";var xn=function(e){function t(t){var n;return(n=e.call(this,t)||this)._anisoLevel=1,n}A(t,e),t._isPowerOf2=function(e){return 0==(e&e-1)},t._getFormatDetail=function(e,t,n){switch(e){case cn.R8G8B8:return{internalFormat:n?t.RGB8:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case cn.R8G8B8A8:return{internalFormat:n?t.RGBA8:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case cn.R4G4B4A4:return{internalFormat:n?t.RGBA4:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case cn.R5G5B5A1:return{internalFormat:n?t.RGB5_A1:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case cn.R5G6B5:return{internalFormat:n?t.RGB565:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case cn.Alpha8:return{internalFormat:t.ALPHA,baseFormat:t.ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case cn.R32G32B32A32:return{internalFormat:t.RGBA32F,baseFormat:t.RGBA,dataType:t.FLOAT,isCompressed:!1};case cn.DXT1:return{internalFormat:dn.RGB_S3TC_DXT1_EXT,isCompressed:!0};case cn.DXT5:return{internalFormat:dn.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case cn.ETC1_RGB:return{internalFormat:dn.RGB_ETC1_WEBGL,isCompressed:!0};case cn.ETC2_RGB:return{internalFormat:dn.RGB8_ETC2,isCompressed:!0};case cn.ETC2_RGBA5:return{internalFormat:dn.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case cn.ETC2_RGBA8:return{internalFormat:dn.RGBA8_ETC2_EAC,isCompressed:!0};case cn.PVRTC_RGB2:return{internalFormat:dn.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case cn.PVRTC_RGBA2:return{internalFormat:dn.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case cn.PVRTC_RGB4:return{internalFormat:dn.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case cn.PVRTC_RGBA4:return{internalFormat:dn.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case cn.ASTC_4x4:return{internalFormat:dn.RGBA_ASTC_4X4_KHR,isCompressed:!0};case cn.ASTC_5x5:return{internalFormat:dn.RGBA_ASTC_5X5_KHR,isCompressed:!0};case cn.ASTC_6x6:return{internalFormat:dn.RGBA_ASTC_6X6_KHR,isCompressed:!0};case cn.ASTC_8x8:return{internalFormat:dn.RGBA_ASTC_8X8_KHR,isCompressed:!0};case cn.ASTC_10x10:return{internalFormat:dn.RGBA_ASTC_10X10_KHR,isCompressed:!0};case cn.ASTC_12x12:return{internalFormat:dn.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+e)}},t._getRenderBufferColorFormatDetail=function(e,t,n){switch(e){case pn.R8G8B8:return{internalFormat:n?t.RGB8:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case pn.R8G8B8A8:return{internalFormat:n?t.RGBA8:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case pn.R4G4B4A4:return{internalFormat:n?t.RGBA4:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case pn.R5G5B5A1:return{internalFormat:n?t.RGB5_A1:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case pn.R5G6B5:return{internalFormat:n?t.RGB565:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case pn.Alpha8:return{internalFormat:t.ALPHA,baseFormat:t.ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case pn.R16G16B16A16:return{internalFormat:t.RGBA16F,baseFormat:t.RGBA,dataType:t.HALF_FLOAT,isCompressed:!1};case pn.R32G32B32A32:return{internalFormat:t.RGBA32F,baseFormat:t.RGBA,dataType:t.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: "+e)}},t._getRenderBufferDepthFormatDetail=function(e,t,n){switch(e){case vn.Depth:return{internalFormat:n?t.DEPTH_COMPONENT32F:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:n?t.FLOAT:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case vn.DepthStencil:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case vn.Stencil:return{internalFormat:t.STENCIL_INDEX8,baseFormat:t.STENCIL_ATTACHMENT,dataType:t.UNSIGNED_BYTE,isCompressed:!1,attachment:t.STENCIL_ATTACHMENT};case vn.Depth16:return{internalFormat:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case vn.Depth24:return{internalFormat:t.DEPTH_COMPONENT24,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case vn.Depth32:return{internalFormat:t.DEPTH_COMPONENT32F,baseFormat:t.DEPTH_COMPONENT,dataType:t.FLOAT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case vn.Depth24Stencil8:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case vn.Depth32Stencil8:return{internalFormat:t.DEPTH32F_STENCIL8,baseFormat:t.DEPTH_STENCIL,dataType:t.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: "+e)}},t._supportTextureFormat=function(e,t){var n=!0;switch(e){case cn.R32G32B32A32:t.canIUse(Ce.textureFloat)||(n=!1)}return n},t._supportRenderBufferColorFormat=function(e,t){var n=!0;switch(e){case pn.R32G32B32A32:t.canIUse(Ce.colorBufferFloat)&&t.canIUse(Ce.textureFloat)||(n=!1);break;case pn.R16G16B16A16:t.canIUse(Ce.colorBufferHalfFloat)&&t.canIUse(Ce.textureHalfFloat)||(n=!1)}return n},t._supportRenderBufferDepthFormat=function(e,t,n){var i=t.isWebGL2,r=!0;if(n&&!t.canIUse(Ce.depthTexture))return!1;switch(e){case vn.Stencil:r=!1;break;case vn.Depth24:case vn.Depth32:case vn.Depth32Stencil8:i||(r=!1)}return r};var n=t.prototype;return n.generateMipmaps=function(){if(this._mipmap){var e=this._rhi.gl;this._bind(),e.generateMipmap(this._target),this._unbind()}},n._onDestroy=function(){this._rhi.gl.deleteTexture(this._glTexture),this._glTexture=null,this._formatDetail=null,this._rhi=null},n._bind=function(){this._rhi.gl.bindTexture(this._target,this._glTexture)},n._unbind=function(){this._rhi.gl.bindTexture(this._target,null)},n._getPixelBuffer=function(e,n,i,r,a,o){var s=this._rhi.gl,u=this._formatDetail,c=u.baseFormat,l=u.dataType;t._readFrameBuffer||(t._readFrameBuffer=s.createFramebuffer()),s.bindFramebuffer(s.FRAMEBUFFER,t._readFrameBuffer),null!=e?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+e,this._glTexture,0):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,0),s.readPixels(n,i,r,a,c,l,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},n._initMipmap=function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=this._formatDetail,r=i.internalFormat,a=i.baseFormat,o=i.dataType;if(this._bind(),n)t.texStorage2D(this._target,this._mipmapCount,r,this._width,this._height);else if(a!==r&&(r=a),e)for(var s=0;s<this._mipmapCount;s++)for(var u=Math.max(1,this._width>>s),c=0;c<6;c++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+c,s,r,u,u,0,a,o,null);else for(var l=0;l<this._mipmapCount;l++){var f=Math.max(1,this._width>>l),h=Math.max(1,this._height>>l);t.texImage2D(this._target,l,r,f,h,0,a,o,null)}this._unbind()},n._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},n._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},n._setWrapMode=function(e,n){var i=this._rhi.gl;switch(this._rhi.isWebGL2||e===fn.Clamp||t._isPowerOf2(this._width)&&t._isPowerOf2(this._height)||(Ie("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),e=fn.Clamp),e){case fn.Clamp:i.texParameteri(this._target,n,i.CLAMP_TO_EDGE);break;case fn.Repeat:i.texParameteri(this._target,n,i.REPEAT);break;case fn.Mirror:i.texParameteri(this._target,n,i.MIRRORED_REPEAT)}},E(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){if(e!==this._wrapModeU){var t=this._rhi.gl;this._wrapModeU=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_S),this._unbind()}}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){if(e!==this._wrapModeV){var t=this._rhi.gl;this._wrapModeV=e,this._bind(),this._setWrapMode(e,t.TEXTURE_WRAP_T),this._unbind()}}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){if(e!==this._filterMode){var t=this._rhi.gl;switch(this._filterMode=e,this._bind(),e){case sn.Point:t.texParameteri(this._target,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(this._target,t.TEXTURE_MIN_FILTER,this._mipmap?t.NEAREST_MIPMAP_NEAREST:t.NEAREST);break;case sn.Bilinear:t.texParameteri(this._target,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(this._target,t.TEXTURE_MIN_FILTER,this._mipmap?t.LINEAR_MIPMAP_NEAREST:t.LINEAR);break;case sn.Trilinear:t.texParameteri(this._target,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(this._target,t.TEXTURE_MIN_FILTER,this._mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR)}this._unbind()}}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._rhi.capability.maxAnisoLevel;if(e>t&&(Ie("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+t),e=t),e<1&&(Ie("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel){var n=this._rhi.gl;this._anisoLevel=e,this._bind(),n.texParameterf(this._target,n.TEXTURE_MAX_ANISOTROPY_EXT,e),this._unbind()}}}]),t}(zt);xn._readFrameBuffer=null;var Tn=function(e){function t(t,n,i,r,a){var o;void 0===r&&(r=cn.R8G8B8A8),void 0===a&&(a=!0),(o=e.call(this,t)||this)._compressedMipFilled=0;var s=t._hardwareRenderer,u=s.gl,c=s.isWebGL2;if(!xn._supportTextureFormat(r,s))throw new Error("Texture format is not supported:"+cn[r]);!a||c||xn._isPowerOf2(n)&&xn._isPowerOf2(i)||(Ie("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),a=!1);var l=xn._getFormatDetail(r,u,c);return o._glTexture=u.createTexture(),o._formatDetail=l,o._rhi=s,o._target=u.TEXTURE_2D,o._mipmap=a,o._width=n,o._height=i,o._format=r,o._mipmapCount=o._getMipmapCount(),l.isCompressed&&!c||o._initMipmap(!1),o.filterMode=sn.Bilinear,o.wrapModeU=o.wrapModeV=fn.Repeat,o}A(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a){void 0===t&&(t=0);var o=this._rhi.gl,s=this._rhi.isWebGL2,u=this._formatDetail,c=u.internalFormat,l=u.baseFormat,f=u.dataType,h=u.isCompressed,d=Math.max(1,this._width>>t),_=Math.max(1,this._height>>t);if(n=n||0,i=i||0,r=r||d-n,a=a||_-i,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),h){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,n,i,r,a,c,e):(o.compressedTexImage2D(this._target,t,c,r,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,n,i,r,a,l,f,e);this._unbind()},n.setImageSource=function(e,t,n,i,r,a){void 0===t&&(t=0),void 0===n&&(n=!1),void 0===i&&(i=!1);var o=this._rhi.gl,s=this._formatDetail,u=s.baseFormat,c=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+n),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),o.texSubImage2D(this._target,t,r||0,a||0,u,c,e),this._unbind()},n.getPixelBuffer=function(t,n,i,r,a){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,null,t,n,i,r,a)},E(t,[{key:"format",get:function(){return this._format}}]),t}(xn),bn=Object.defineProperty,En=Object.getOwnPropertyDescriptor,An=function(e,t,n,i){for(var r,a=i>1?void 0:i?En(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&bn(t,n,a),a},On=function(e){function t(t){var n;return(n=e.call(this,t)||this)._hasInitJoints=!1,n.weightsIndices=[],n._useJointTexture=!1,n._mat=new f,n._weights=null,n._skin=null,n}A(t,e);var n=t.prototype;return n.setWeights=function(e){if(this._weights=e,e){for(var t=e.length,n=0;n<t;n++)this.weightsIndices[n]=n;for(var i=this.weightsIndices,r=0;r<t-1;r++)for(var a=r+1;a<t;a++)if(e[a]>e[r]){var o=e[r];e[r]=e[a],e[a]=o,o=i[r],i[r]=i[a],i[a]=o}this.mesh.updatePrimitiveWeightsIndices(i)}},n._initJoints=function(){if(this._skin){for(var e=this._skin.joints,t=[],n=e.length-1;n>=0;n--)t[n]=this.findByNodeName(this.entity,e[n]);this.matrixPalette=new Float32Array(16*t.length),this.jointNodes=t;var i=this.entity.engine._hardwareRenderer;if(i){var r=i.renderStates.getParameter(i.gl.MAX_VERTEX_UNIFORM_VECTORS),a=Math.floor((r-20)/4);e.length>a&&i.canIUseMoreJoints&&(this._useJointTexture=!0)}}},n.findByNodeName=function(e,t){if(!e)return null;var n=e.findByName(t);return n||this.findByNodeName(e.parent,t)},n._findParent=function(e,t){if(e){var n=e.parent;if(!n)return null;if(n.name===t)return n;var i=n.findByName(t);return i||this._findParent(n,t)}return null},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,n=this.matrixPalette,i=this.entity.getInvModelMatrix(),r=this._mat,a=e.length-1;a>=0;a--)r.identity(),e[a]?f.multiply(e[a].transform.worldMatrix,t[a],r):t[a].cloneTo(r),f.multiply(i,r,r),n.set(r.elements,16*a);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var e=this.engine;if(!e._hardwareRenderer)return;this.jointTexture=new Tn(e,4,this.jointNodes.length,cn.R32G32B32A32,!1),this.jointTexture.filterMode=sn.Point}this.jointTexture.setPixelBuffer(this.matrixPalette)},E(t,[{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}},{key:"weights",get:function(){return this._weights}}]),t}(yn);An([B],On.prototype,"matrixPalette",2),An([B],On.prototype,"jointNodes",2),An([B],On.prototype,"jointTexture",2),An([B],On.prototype,"_hasInitJoints",2),An([B],On.prototype,"_mat",2),An([B],On.prototype,"_weights",2),An([B],On.prototype,"weightsIndices",2),An([B],On.prototype,"_useJointTexture",2);var Cn,Rn,Sn,wn,Mn,Pn,Ln=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=n,i.renderType=ee.OPAQUE,i.useFog=!0,i.maxJointsNum=0,i._technique=null,i._values={},i}A(t,e);var n=t.prototype;return n.clone=function(e,t){void 0===e&&(e=this.name),void 0===t&&(t=!1);var n=new this.constructor(e);for(var i in n.renderType=this.renderType,n.useFog=this.useFog,this._values)if(this._values.hasOwnProperty(i)){var r=this._values[i];r instanceof xn?n.setValue(i,r):n.setValue(i,P.clone(r))}return n},n.setValue=function(e,t){var n=this.getValue(e),i=n instanceof xn,r=t instanceof xn;i&&this._removeRefChild(n),r&&this._addRefChild(t),this._generateTechnique&&i!==r&&(this._technique=null),null!=t?this._values[e]=t:this.delValue(e)},n.delValue=function(e){delete this._values[e]},n.getValue=function(e){return this._values[e]},n.prepareDrawing=function(e,t,n,i){var r=e.camera,a=this._technique.uniforms;for(var o in a){var s=a[o];this._updateValueBySemantic(s,e,t)}var u=r.scene;u.hasFogFeature&&u.bindFogToMaterial(this),this._technique.compile(r,t,n,this)},n.preCompile=function(e){},n.postCompile=function(e){},n.preRender=function(e,t){},n.postRender=function(e,t){},n._updateValueBySemantic=function(e,t,n){var i,r=this._values;switch(e.semantic){case me.LOCAL:r[e.name]=n._entity.transform.localMatrix;break;case me.MODEL:r[e.name]=n._entity.transform.worldMatrix;break;case me.VIEW:r[e.name]=t.viewMatrix;break;case me.PROJECTION:r[e.name]=t.projectionMatrix;break;case me.MODELVIEW:var a=t.viewMatrix,o=n._entity.transform.worldMatrix,s=r[e.name];s||(s=new f),f.multiply(a,o,s),r[e.name]=s;break;case me.VIEWPROJECTION:var u=t.viewProjectMatrix;r[e.name]=u;break;case me.MODELVIEWPROJECTION:var l=t.viewProjectMatrix,h=n._entity.transform.worldMatrix,d=r[e.name];d||(d=new f),f.multiply(l,h,d),r[e.name]=d;break;case me.MODELINVERSE:r[e.name]=n.invModelMatrixs;break;case me.VIEWINVERSE:r[e.name]=t.inverseViewMatrix;break;case me.PROJECTIONINVERSE:r[e.name]=t.inverseProjectionMatrix;break;case me.MODELVIEWINVERSE:var _=t.viewMatrix,p=n._entity.transform.worldMatrix,m=r[e.name];m||(m=new f),f.multiply(_,p,m),f.invert(m,m),r[e.name]=m;break;case me.MODELVIEWPROJECTIONINVERSE:var v=t.viewProjectMatrix,g=n._entity.transform.worldMatrix,y=r[e.name];y||(y=new f),f.multiply(v,g,y),f.invert(y,y),r[e.name]=y;break;case me.MODELINVERSETRANSPOSE:var x=r[e.name];x||(x=new c),c.normalMatrix(n._entity.transform.worldMatrix,x),r[e.name]=x;break;case me.MODELVIEWINVERSETRANSPOSE:var T=r[e.name];T||(T=new f),f.multiply(t.viewMatrix,n._entity.transform.worldMatrix,T),f.invert(T,T),f.transpose(T,T),r[e.name]=T;break;case me.VIEWPORT:r[e.name]=t.viewport;break;case me.JOINTMATRIX:r[e.name]=n.matrixPalette;break;case me.JOINTTEXTURE:r[e.name]=n.jointTexture;break;case me.JOINTCOUNT:r[e.name]=null==(i=n.jointNodes)?void 0:i.length;break;case me.MORPHWEIGHTS:r[e.name]=n.weights;break;case me.EYEPOS:r[e.name]=t.cameraPosition;break;case me.TIME:r[e.name]=.001*n.engine.time.timeSinceStartup}},n._onDestroy=function(){if(this._technique){for(var e=I(this._values),t=0,n=e.length;t<n;t++){var i=e[t];i instanceof xn&&i._addRefCount(-1)}this._technique._finalize(),this._technique=null}},E(t,[{key:"transparent",get:function(){return this.renderType===ee.TRANSPARENT},set:function(e){this.renderType=e?ee.TRANSPARENT:ee.OPAQUE}},{key:"technique",get:function(){return this._technique},set:function(e){this._technique=e,this._values={}}}]),t}(zt),In=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this)._techniquePool={},i}A(t,e);var n=t.prototype;return n.prepareDrawing=function(t,n,i){var r=t.camera,a=this._requireTechnique(r,n,i);a&&(this._technique=a,e.prototype.prepareDrawing.call(this,t,n,i))},n.clearTechniques=function(){this._techniquePool={}},n._requireTechnique=function(e,t,n){var i=this._getTechniqueKey(e,t,n),r=this._techniquePool[i];return r||(r=this._generateTechnique(e,t,n),this._techniquePool[i]=r),r},n._generateTechnique=function(e,t,n){},n._getTechniqueKey=function(e,t,n){var i=null!=t.skin,r=i?t.skin.joints.length:0,a=i?"skin_":"static_";return i&&(a+="jont"+r),a},t}(Ln);(Rn=Cn||(Cn={}))[Rn.Static=0]="Static",Rn[Rn.Dynamic=1]="Dynamic",Rn[Rn.Stream=2]="Stream",(wn=Sn||(Sn={}))[wn.Float=0]="Float",wn[wn.Vector2=1]="Vector2",wn[wn.Vector3=2]="Vector3",wn[wn.Vector4=3]="Vector4",wn[wn.Byte4=4]="Byte4",wn[wn.UByte4=5]="UByte4",wn[wn.NormalizedByte4=6]="NormalizedByte4",wn[wn.NormalizedUByte4=7]="NormalizedUByte4",wn[wn.Short2=8]="Short2",wn[wn.UShort2=9]="UShort2",wn[wn.NormalizedShort2=10]="NormalizedShort2",wn[wn.NormalizedUShort2=11]="NormalizedUShort2",wn[wn.Short4=12]="Short4",wn[wn.UShort4=13]="UShort4",wn[wn.NormalizedShort4=14]="NormalizedShort4",wn[wn.NormalizedUShort4=15]="NormalizedUShort4",(Pn=Mn||(Mn={}))[Pn.UInt8=0]="UInt8",Pn[Pn.UInt16=1]="UInt16",Pn[Pn.UInt32=2]="UInt32";var Fn,Nn,Dn,zn,Vn=function(){function e(){}return e._getGLBufferUsage=function(e,t){switch(t){case Cn.Static:return e.STATIC_DRAW;case Cn.Dynamic:return e.DYNAMIC_DRAW;case Cn.Stream:return e.STREAM_DRAW}},e._getGLIndexType=function(e){switch(e){case Mn.UInt8:return _e.UNSIGNED_BYTE;case Mn.UInt16:return _e.UNSIGNED_SHORT;case Mn.UInt32:return _e.UNSIGNED_INT}},e._getElementInfo=function(e){var t,n;switch(e){case Sn.Float:t=1,n=_e.FLOAT;break;case Sn.Vector2:t=2,n=_e.FLOAT;break;case Sn.Vector3:t=3,n=_e.FLOAT;break;case Sn.Vector4:t=4,n=_e.FLOAT;break;case Sn.Byte4:t=4,n=_e.UNSIGNED_BYTE;break;case Sn.Short2:t=2,n=_e.SHORT;break;case Sn.Short4:t=4,n=_e.SHORT;break;case Sn.UShort2:t=2,n=_e.UNSIGNED_SHORT;break;case Sn.UShort4:t=4,n=_e.UNSIGNED_SHORT}return{size:t,type:n}},e}();(Nn=Fn||(Fn={}))[Nn.VertexBuffer=0]="VertexBuffer",Nn[Nn.IndexBuffer=1]="IndexBuffer",(zn=Dn||(Dn={}))[zn.None=0]="None",zn[zn.Discard=1]="Discard";var Bn,Un,kn=function(e){function t(t,n,i,r){var a;void 0===r&&(r=Cn.Static),(a=e.call(this,t)||this)._engine=t,a._type=n,a._bufferUsage=r;var o=t._hardwareRenderer,s=o.gl,u=Vn._getGLBufferUsage(s,r),c=n===Fn.VertexBuffer?s.ARRAY_BUFFER:s.ELEMENT_ARRAY_BUFFER;return a._nativeBuffer=s.createBuffer(),a._hardwareRenderer=o,a._glBufferUsage=u,a._glBindTarget=c,a.bind(),"number"==typeof i?(a._byteLength=i,s.bufferData(c,i,u)):(a._byteLength=i.byteLength,s.bufferData(c,i,u)),s.bindBuffer(c,null),a}A(t,e),E(t,[{key:"engine",get:function(){return this._engine}},{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]);var n=t.prototype;return n.bind=function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(e,t,n,i,r){void 0===t&&(t=0),void 0===n&&(n=0),void 0===r&&(r=Dn.None);var a=this._hardwareRenderer.gl,o=this._hardwareRenderer.isWebGL2,s=this._glBindTarget;this.bind(),r===Dn.Discard&&a.bufferData(s,this._byteLength,this._glBufferUsage);var u=e.BYTES_PER_ELEMENT||1,c=i?u*i:e.byteLength;if(0!==n||c<e.byteLength){var l=void 0!==e.byteOffset;if(o&&l)a.bufferSubData(s,t,e,n,c/u);else{var f=new Uint8Array(l?e.buffer:e,n*u,c);a.bufferSubData(s,t,f)}}else a.bufferSubData(s,t,e);a.bindBuffer(s,null)},n.getData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),!this._hardwareRenderer.isWebGL2)throw"Buffer is write-only on WebGL1.0 platforms.";var r=this._hardwareRenderer.gl;this.bind(),r.getBufferSubData(this._glBindTarget,t,e,n,i)},n._onDestroy=function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},t}(zt);(Un=Bn||(Bn={}))[Un.Points=0]="Points",Un[Un.Lines=1]="Lines",Un[Un.LineLoop=2]="LineLoop",Un[Un.LineStrip=3]="LineStrip",Un[Un.Triangles=4]="Triangles",Un[Un.TriangleStrip=5]="TriangleStrip",Un[Un.TriangleFan=6]="TriangleFan";var Gn=function(){function e(e,t){this._buffer=e,this._format=t}return E(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),jn=function(){function e(e,t){this._buffer=e,this._stride=t}return E(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}(),Hn=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).instanceCount=0,i._vertexElementMap={},i._vertexBufferBindings=[],i._indexBufferBinding=null,i._vertexElements=[],i.targets=[],i.boundingBox=null,i.boundingSphere=null,i.isInFrustum=!0,i.name=n,i._platformPrimitive=i._engine._hardwareRenderer.createPlatformPrimitive(y(i)),i}A(t,e);var n=t.prototype;return n.setVertexBufferBinding=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=0);var i=e,r=void 0!==i.buffer;r||(i=new jn(e,t));var a=this._vertexBufferBindings;a.length<=n&&(a.length=n+1),this._setVertexBufferBinding(r?t:n,i)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0);var n=this._vertexBufferBindings,i=e,r=i.length,a=t+r;n.length<a&&(n.length=a);for(var o=0;o<r;o++)this._setVertexBufferBinding(t+o,i[o])},n.setIndexBufferBinding=function(e,t){var n=e;void 0!==n.buffer||(n=new Gn(e,t)),this._indexBufferBinding=n,this._glIndexType=Vn._getGLIndexType(n.format)},n.setVertexElements=function(e){this._clearVertexElements();for(var t=0,n=e.length;t<n;t++)this._addVertexElement(e[t])},n.draw=function(e,t){this._platformPrimitive.draw(e,t)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t]},n._addVertexElement=function(e){this._vertexElementMap[e.semantic]=e,this._vertexElements.push(e)},n._setVertexBufferBinding=function(e,t){var n=this._vertexBufferBindings[e];n&&this._removeRefChild(n._buffer),this._addRefChild(t._buffer),this._vertexBufferBindings[e]=t},E(t,[{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"vertexElements",get:function(){return this._vertexElements}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}}]),t}(zt),Wn=function(){function e(e,t,n,i,r){void 0===r&&(r=0),this.normalized=!1,this._semantic=e,this._offset=t,this._format=n,this._bindingIndex=i,this._glElementInfo=Vn._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return E(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}},{key:"elementInfo",get:function(){return this._glElementInfo}}]),e}(),Xn=function(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=Bn.Triangles),this.start=e,this.count=t,this.topology=n},qn=g({common:"#define PI 3.14159265359\n#define LOG2 1.442695\n\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\n\n// nosie common\n#include <noise_common>\n",common_vert:"attribute vec3 a_position;\n\n#ifdef O3_HAS_UV\n\nattribute vec2 a_uv;\n\n#endif\n\n#ifdef O3_HAS_NORMAL\n\nattribute vec3 a_normal;\n\n#endif\n\n#ifdef O3_HAS_TANGENT\n\nattribute vec4 a_tangent;\n\n#endif\n\n#ifdef O3_HAS_VERTEXCOLOR\n\nattribute vec4 a_color;\n\n#endif\n\n#if defined( O3_HAS_SKIN ) && ( defined( O3_JOINTS_NUM ) || defined( O3_USE_JOINT_TEXTURE ) )\n    attribute vec4 a_joint;\n    attribute vec4 a_weight;\n\n    #ifdef O3_USE_JOINT_TEXTURE\n        uniform sampler2D u_jointSampler;\n        uniform float u_jointCount;\n\n        mat4 getJointMatrix(sampler2D smp, float index)\n        {\n            float base = index / u_jointCount;\n            float hf = 0.5 / u_jointCount;\n            float v = base + hf;\n\n            vec4 m0 = texture2D(smp, vec2(0.125, v ));\n            vec4 m1 = texture2D(smp, vec2(0.375, v ));\n            vec4 m2 = texture2D(smp, vec2(0.625, v ));\n            vec4 m3 = texture2D(smp, vec2(0.875, v ));\n\n            return mat4(m0, m1, m2, m3);\n\n        }\n\n    #elif defined( O3_JOINTS_NUM )\n        uniform mat4 u_jointMatrix[ O3_JOINTS_NUM ];\n    #endif\n#endif\n\nuniform mat4 u_localMat;\nuniform mat4 u_modelMat;\nuniform mat4 u_viewMat;\nuniform mat4 u_projMat;\nuniform mat4 u_MVMat;\nuniform mat4 u_MVPMat;\nuniform mat3 u_normalMat;\nuniform vec3 u_cameraPos;\nuniform float u_time;\n",common_frag:"uniform O3_VERTEX_PRECISION mat4 u_localMat;\nuniform O3_VERTEX_PRECISION mat4 u_modelMat;\nuniform O3_VERTEX_PRECISION mat4 u_viewMat;\nuniform O3_VERTEX_PRECISION mat4 u_projMat;\nuniform O3_VERTEX_PRECISION mat4 u_MVMat;\nuniform O3_VERTEX_PRECISION mat4 u_MVPMat;\nuniform O3_VERTEX_PRECISION mat3 u_normalMat;\nuniform O3_VERTEX_PRECISION vec3 u_cameraPos;\nuniform O3_VERTEX_PRECISION float u_time;\n",color_share:"#ifdef O3_HAS_VERTEXCOLOR\n\nvarying vec4 v_color;\n\n#endif\n",normal_share:"#ifdef O3_HAS_NORMAL\n\n    #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n    varying mat3 v_TBN;\n\n    #else\n\n    varying vec3 v_normal;\n\n    #endif\n\n#endif\n",uv_share:"varying vec2 v_uv;\n",worldpos_share:"#if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\n\nvarying vec3 v_pos;\n\n#endif\n",shadow_share:"#ifdef O3_GENERATE_SHADOW_MAP\n\nuniform mat4 u_viewMatFromLight;\nuniform mat4 u_projMatFromLight;\n\n#endif\n\n#ifdef O3_SHADOW_MAP_COUNT\n\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];\nuniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];\nvarying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n\n#endif\n",fog_share:"#ifdef O3_HAS_FOG\n\nvarying vec3 v_fogDepth;\n\nuniform O3_VERTEX_PRECISION vec3 u_fogColor;\n\n    #ifdef O3_FOG_EXP2\n\n        uniform O3_VERTEX_PRECISION float u_fogDensity;\n\n    #else\n\n        uniform O3_VERTEX_PRECISION float u_fogNear;\n        uniform O3_VERTEX_PRECISION float u_fogFar;\n\n    #endif\n\n#endif\n",begin_normal_vert:"    #ifdef O3_HAS_NORMAL\n\n    vec3 normal = vec3( a_normal );\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec4 tangent = vec4( a_tangent );\n\n        #endif\n\n    #endif\n",begin_position_vert:"    vec4 position = vec4( a_position , 1.0 );\n",morph_target_vert:"#ifdef O3_HAS_MORPH\n\n    uniform float u_morphWeights[ O3_MORPH_NUM ];\n\n    #ifdef O3_MORPH_POSITION\n\n    attribute vec3 a_position0;\n\n    #endif\n\n    #ifdef O3_MORPH_NORMAL\n\n    attribute vec3 a_normal0;\n\n    #endif\n\n    #ifdef O3_MORPH_TANGENT\n\n    attribute vec3 a_tangent0;\n\n    #endif\n\n    #if O3_MORPH_NUM > 1\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position1;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal1;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent1;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 2\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position2;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal2;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent2;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 3\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position3;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal3;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent3;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 4\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position4;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal4;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent4;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 5\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position5;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal5;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent5;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 6\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position6;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal6;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent6;\n\n        #endif\n\n    #endif\n\n    #if O3_MORPH_NUM > 7\n\n        #ifdef O3_MORPH_POSITION\n\n        attribute vec3 a_position7;\n\n        #endif\n\n        #ifdef O3_MORPH_NORMAL\n\n        attribute vec3 a_normal7;\n\n        #endif\n\n        #ifdef O3_MORPH_TANGENT\n\n        attribute vec3 a_tangent7;\n\n        #endif\n\n    #endif\n\n#endif\n",position_vert:"    #ifndef O3_GENERATE_SHADOW_MAP\n\n    gl_Position = u_MVPMat * position;\n\n    #endif\n",color_vert:"    #ifdef O3_HAS_VERTEXCOLOR\n\n    v_color = a_color;\n\n    #endif\n",normal_vert:"    #ifdef O3_HAS_NORMAL\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec3 normalW = normalize( u_normalMat * normal.xyz );\n        vec3 tangentW = normalize( u_normalMat * tangent.xyz );\n        vec3 bitangentW = cross( normalW, tangentW ) * tangent.w;\n        v_TBN = mat3( tangentW, bitangentW, normalW );\n\n        #else\n\n        v_normal = normalize( u_normalMat * normal );\n\n        #endif\n\n    #endif\n",skinning_vert:"#if defined( O3_HAS_SKIN ) && ( defined( O3_JOINTS_NUM ) || defined( O3_USE_JOINT_TEXTURE ) )\n\n        #ifdef O3_USE_JOINT_TEXTURE\n            mat4 skinMatrix =\n                a_weight.x * getJointMatrix(u_jointSampler, a_joint.x ) +\n                a_weight.y * getJointMatrix(u_jointSampler, a_joint.y ) +\n                a_weight.z * getJointMatrix(u_jointSampler, a_joint.z ) +\n                a_weight.w * getJointMatrix(u_jointSampler, a_joint.w );\n\n        #elif defined( O3_JOINTS_NUM )\n            mat4 skinMatrix =\n                a_weight.x * u_jointMatrix[ int( a_joint.x ) ] +\n                a_weight.y * u_jointMatrix[ int( a_joint.y ) ] +\n                a_weight.z * u_jointMatrix[ int( a_joint.z ) ] +\n                a_weight.w * u_jointMatrix[ int( a_joint.w ) ];\n        #endif\n\n        position = skinMatrix * position;\n\n        #ifdef O3_HAS_NORMAL\n            normal = vec4( skinMatrix * vec4( normal, 0.0 ) ).xyz;\n            #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n                tangent.xyz = vec4( skinMatrix * vec4( tangent.xyz, 0.0 ) ).xyz;\n            #endif\n\n        #endif\n\n#endif\n",uv_vert:"    #ifdef O3_HAS_UV\n\n    v_uv = a_uv;\n\n    #else\n\n    // may need this calculate normal\n    v_uv = vec2( 0., 0. );\n\n    #endif\n",worldpos_vert:"    #if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP ) || defined(O3_CLIPPLANE_NUM)\n\n    vec4 temp_pos = u_modelMat * position;\n    v_pos = temp_pos.xyz / temp_pos.w;\n\n    #endif\n",shadow_vert:"    #ifdef O3_GENERATE_SHADOW_MAP\n\n    gl_Position = u_projMatFromLight * u_viewMatFromLight * u_modelMat * position;\n\n    #endif\n\n    #ifdef O3_SHADOW_MAP_COUNT\n\n    for (int i = 0; i < O3_SHADOW_MAP_COUNT; i++) {\n\n        v_PositionFromLight[i] = u_projMatFromLight[i] * u_viewMatFromLight[i] * u_modelMat * vec4( a_position, 1.0 );\n\n    }\n\n    #endif\n",morph_vert:"    #ifdef O3_HAS_MORPH\n\n        #if defined( O3_MORPH_POSITION )\n\n        position.xyz += u_morphWeights[ 0 ] * a_position0;\n\n            #if O3_MORPH_NUM > 1\n\n            position.xyz += u_morphWeights[ 1 ] * a_position1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            position.xyz += u_morphWeights[ 2 ] * a_position2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            position.xyz += u_morphWeights[ 3 ] * a_position3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            position.xyz += u_morphWeights[ 4 ] * a_position4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            position.xyz += u_morphWeights[ 5 ] * a_position5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            position.xyz += u_morphWeights[ 6 ] * a_position6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            position.xyz += u_morphWeights[ 7 ] * a_position7;\n\n            #endif\n\n        #endif\n\n        #if defined( O3_HAS_NORMAL ) && defined( O3_MORPH_NORMAL )\n\n        normal.xyz += u_morphWeights[ 0 ] * a_normal0;\n\n            #if O3_MORPH_NUM > 1\n\n            normal.xyz += u_morphWeights[ 1 ] * a_normal1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            normal.xyz += u_morphWeights[ 2 ] * a_normal2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            normal.xyz += u_morphWeights[ 3 ] * a_normal3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            normal.xyz += u_morphWeights[ 4 ] * a_normal4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            normal.xyz += u_morphWeights[ 5 ] * a_normal5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            normal.xyz += u_morphWeights[ 6 ] * a_normal6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            normal.xyz += u_morphWeights[ 7 ] * a_normal7;\n\n            #endif\n\n        #endif\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_MORPH_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        tangent.xyz += u_morphWeights[ 0 ] * a_tangent0;\n\n            #if O3_MORPH_NUM > 1\n\n            tangent.xyz += u_morphWeights[ 1 ] * a_tangent1;\n\n            #endif\n\n            #if O3_MORPH_NUM > 2\n\n            tangent.xyz += u_morphWeights[ 2 ] * a_tangent2;\n\n            #endif\n\n            #if O3_MORPH_NUM > 3\n\n            tangent.xyz += u_morphWeights[ 3 ] * a_tangent3;\n\n            #endif\n\n            #if O3_MORPH_NUM > 4\n\n            tangent.xyz += u_morphWeights[ 4 ] * a_tangent4;\n\n            #endif\n\n            #if O3_MORPH_NUM > 5\n\n            tangent.xyz += u_morphWeights[ 5 ] * a_tangent5;\n\n            #endif\n\n            #if O3_MORPH_NUM > 6\n\n            tangent.xyz += u_morphWeights[ 6 ] * a_tangent6;\n\n            #endif\n\n            #if O3_MORPH_NUM > 7\n\n            tangent.xyz += u_morphWeights[ 7 ] * a_tangent7;\n\n            #endif\n\n        #endif\n\n    #endif\n",fog_vert:"    #ifdef O3_HAS_FOG\n\n    v_fogDepth = ( u_MVMat * position ).xyz;\n\n    #endif\n",ambient_light_frag:"#ifdef O3_HAS_AMBIENT_LIGHT\n\nstruct AmbientLight {\n    vec3 color;\n    vec3 lightColor;\n    float intensity;\n};\nuniform AmbientLight u_ambientLight;\n\n#endif\n",direct_light_frag:"#ifdef O3_DIRECT_LIGHT_COUNT\n\nstruct DirectLight {\n    vec3 color;\n    vec3 lightColor;\n    float intensity;\n    vec3 direction;\n};\nuniform DirectLight u_directLights[ O3_DIRECT_LIGHT_COUNT ];\n\n#endif\n",point_light_frag:"#ifdef O3_POINT_LIGHT_COUNT\n\nstruct PointLight {\n    vec3 color;\n    vec3 lightColor;\n    vec3 position;\n    float intensity;\n    float distance;\n    float decay;\n};\nuniform PointLight u_pointLights[ O3_POINT_LIGHT_COUNT ];\n\n#endif\n",spot_light_frag:"#ifdef O3_SPOT_LIGHT_COUNT\n\nstruct SpotLight {\n    vec3 color;\n    vec3 lightColor;\n    vec3 position;\n    vec3 direction;\n    float intensity;\n    float distance;\n    float decay;\n    float angle;\n    float penumbra;\n    float coneCos;\n    float penumbraCos;\n};\nuniform SpotLight u_spotLights[ O3_SPOT_LIGHT_COUNT ];\n\n#endif\n",mobile_material_frag:"uniform float u_shininess;\n\n#ifdef O3_EMISSION_TEXTURE\n\nuniform sampler2D u_emission;\n\n#else\n\nuniform vec4 u_emission;\n\n#endif\n\n#ifdef O3_AMBIENT_TEXTURE\n\nuniform sampler2D u_ambient;\n\n#else\n\nuniform vec4 u_ambient;\n\n#endif\n\n#ifdef O3_DIFFUSE_TEXTURE\n\nuniform sampler2D u_diffuse;\n\n#else\n\nuniform vec4 u_diffuse;\n\n#endif\n\n#ifdef O3_SPECULAR_TEXTURE\n\nuniform sampler2D u_specular;\n\n#else\n\nuniform vec4 u_specular;\n\n#endif\n",fog_frag:"    #ifdef O3_HAS_FOG\n\n    float fogDepth = length( v_fogDepth );\n\n        #ifdef O3_FOG_EXP2\n\n            float fogFactor = whiteCompliment( exp2( - u_fogDensity * u_fogDensity * fogDepth * fogDepth * LOG2 ) );\n\n        #else\n\n            float fogFactor = smoothstep( u_fogNear, u_fogFar, fogDepth );\n\n        #endif\n\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, u_fogColor, fogFactor );\n\n    #endif\n",begin_mobile_frag:"    #ifdef O3_EMISSION_TEXTURE\n\n    vec4 emission = texture2D(u_emission, v_uv);\n\n    #else\n\n    vec4 emission = u_emission;\n\n    #endif\n\n    vec4 ambient = vec4(0);\n    #ifdef O3_HAS_AMBIENT_LIGHT\n        #ifdef O3_AMBIENT_TEXTURE\n            ambient = texture2D(u_ambient, v_uv) * vec4(u_ambientLight.lightColor, 1.0);\n         #else\n            ambient = u_ambient * vec4(u_ambientLight.lightColor, 1.0);\n         #endif\n    #endif\n\n    #ifdef O3_DIFFUSE_TEXTURE\n\n    vec4 diffuse = texture2D(u_diffuse, v_uv);\n\n    #else\n\n    vec4 diffuse = u_diffuse;\n\n    #endif\n\n    #ifdef O3_SPECULAR_TEXTURE\n\n    vec4 specular = texture2D(u_specular, v_uv);\n\n    #else\n\n    vec4 specular = u_specular;\n\n    #endif\n",begin_normal_frag:"    #ifdef O3_HAS_NORMAL\n\n        #if defined( O3_HAS_TANGENT ) && defined( O3_HAS_NORMALMAP )\n\n        vec3 N = normalize( v_TBN[ 2 ] );\n\n        #else\n\n        vec3 N = normalize( v_normal );\n\n        #endif\n\n    #endif\n",begin_viewdir_frag:"    #if defined( O3_NEED_WORLDPOS ) || defined( O3_HAS_ENVMAP ) || defined( O3_HAS_LIGHTMAP )\n\n    vec3 V =  normalize( u_cameraPos - v_pos );\n\n    #endif\n",mobile_blinnphong_frag:"    #ifdef O3_HAS_NORMAL\n         N *= float( gl_FrontFacing ) * 2.0 - 1.0;\n    #else\n         vec3 N = vec3(0, 0, 1);\n    #endif\n\n\n    vec3 lightDiffuse = vec3( 0.0, 0.0, 0.0 );\n    vec3 lightSpecular = vec3( 0.0, 0.0, 0.0 );\n\n    #ifdef O3_DIRECT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i++ ) {\n        DirectLight lgt = u_directLights[ i ];\n\n        float d = max(dot(N, -lgt.direction), 0.0)*lgt.intensity;\n        lightDiffuse += lgt.color*d;\n\n        vec3 halfDir = normalize( V - lgt.direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity;\n        lightSpecular += lgt.color * s;\n    }\n\n    #endif\n\n    #ifdef O3_POINT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_POINT_LIGHT_COUNT; i++ ) {\n        PointLight lgt = u_pointLights[ i ];\n        vec3 direction = v_pos - lgt.position;\n        float dist = length( direction );\n        direction /= dist;\n        float decay = pow( max( 0.0, 1.0-dist/lgt.distance ), 2.0 );\n\n        float d =  max( dot( N, -direction ), 0.0 )*lgt.intensity*decay;\n        lightDiffuse += lgt.color*d;\n\n        vec3 halfDir = normalize( V - direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity * decay;\n        lightSpecular += lgt.color * s;\n\n    }\n\n    #endif\n\n    #ifdef O3_SPOT_LIGHT_COUNT\n\n    for( int i = 0; i < O3_SPOT_LIGHT_COUNT; i++) {\n        SpotLight lgt = u_spotLights[ i ];\n        vec3 direction = v_pos - lgt.position;\n        float angle = acos( dot( normalize( direction ), normalize( lgt.direction ) ) );\n        float dist = length( direction );\n        direction /= dist;\n        float decay = pow( max( 0.0, 1.0 - dist / lgt.distance ), 2.0 );\n\n        float hasLight = step( angle, lgt.angle );\n        float hasPenumbra = step( lgt.angle, angle ) * step( angle, lgt.angle * ( 1.0 + lgt.penumbra ) );\n        float penumbra = hasPenumbra * ( 1.0 - ( angle - lgt.angle ) / ( lgt.angle * lgt.penumbra ) );\n        float d = max( dot( N, -direction ), 0.0 ) * lgt.intensity * decay * ( penumbra + hasLight );\n        lightDiffuse += lgt.color * d;\n\n        vec3 halfDir = normalize( V - direction );\n        float s = pow( clamp( dot( N, halfDir ), 0.0, 1.0 ), u_shininess ) * lgt.intensity * decay * ( penumbra + hasLight );\n        lightSpecular += lgt.color * s;\n\n    }\n\n    #endif\n\n    diffuse *= vec4( lightDiffuse, 1.0 );\n    specular *= vec4( lightSpecular, 1.0 );\n",mobile_lambert_frag:"    vec3 totalLight = vec3(0.0, 0.0, 0.0);\n    #ifdef O3_DIRECT_LIGHT_COUNT\n    for( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i++ ){\n        vec3 lightColor = u_directLights[ i ].color * u_directLights[ i ].intensity;\n        lightColor *= max( dot( N, -u_directLights[ i ].direction ), 0.0 );\n\n        totalLight += lightColor;\n    }\n    #endif\n    diffuse *= vec4( totalLight, 1.0 );\n",noise_common:"// Modulo 289 without a division (only multiplications)\nvec4 mod289( vec4 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nvec3 mod289( vec3 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nvec2 mod289( vec2 x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\nfloat mod289( float x ) {\n\n    return x - floor( x * ( 1.0 / 289.0 ) ) * 289.0;\n\n}\n\n// Modulo 7 without a division\nvec4 mod7( vec4 x ) {\n\n    return x - floor( x * ( 1.0 / 7.0 ) ) * 7.0;\n\n}\n\nvec3 mod7( vec3 x ) {\n\n    return x - floor( x * ( 1.0 / 7.0 ) ) * 7.0;\n\n}\n\n// Permutation polynomial: (34x^2 + x) mod 289\nvec4 permute( vec4 x ) {\n\n    return mod289( ( 34.0 * x + 1.0 ) * x);\n\n}\n\nvec3 permute( vec3 x ) {\n\n    return mod289( ( 34.0 * x + 1.0 ) * x );\n\n}\n\nfloat permute( float x ) {\n\n  return mod289( ( ( x * 34.0 ) + 1.0 ) * x );\n\n}\n\nvec4 taylorInvSqrt( vec4 r ) {\n\n    return 1.79284291400159 - 0.85373472095314 * r;\n\n}\n\nfloat taylorInvSqrt( float r ) {\n\n    return 1.79284291400159 - 0.85373472095314 * r;\n\n}\n\nvec4 fade( vec4 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\nvec3 fade( vec3 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\nvec2 fade( vec2 t ) {\n\n    return t * t * t * ( t * ( t * 6.0 - 15.0 ) + 10.0 );\n\n}\n\n#define K 0.142857142857 // 1/7\n#define Ko 0.428571428571 // 1/2-K/2\n#define K2 0.020408163265306 // 1/(7*7)\n#define Kd2 0.0714285714285 // K/2\n#define Kz 0.166666666667 // 1/6\n#define Kzo 0.416666666667 // 1/2-1/6*2\n#define jitter 1.0 // smaller jitter gives more regular pattern\n#define jitter1 0.8 // smaller jitter gives less errors in F1 F2\n",noise_cellular_2D:'\n// Cellular noise ("Worley noise") in 2D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Standard 3x3 search window for good F1 and F2 values\nvec2 cellular( vec2 P ) {\n\n\tvec2 Pi = mod289( floor( P ) );\n \tvec2 Pf = fract( P );\n\tvec3 oi = vec3( -1.0, 0.0, 1.0);\n\tvec3 of = vec3( -0.5, 0.5, 1.5);\n\tvec3 px = permute( Pi.x + oi );\n\tvec3 p = permute( px.x + Pi.y + oi ); // p11, p12, p13\n\tvec3 ox = fract( p * K ) - Ko;\n\tvec3 oy = mod7( floor( p * K ) ) * K - Ko;\n\tvec3 dx = Pf.x + 0.5 + jitter * ox;\n\tvec3 dy = Pf.y - of + jitter * oy;\n\tvec3 d1 = dx * dx + dy * dy; // d11, d12 and d13, squared\n\tp = permute( px.y + Pi.y + oi ); // p21, p22, p23\n\tox = fract( p * K ) - Ko;\n\toy = mod7( floor( p * K ) ) * K - Ko;\n\tdx = Pf.x - 0.5 + jitter * ox;\n\tdy = Pf.y - of + jitter * oy;\n\tvec3 d2 = dx * dx + dy * dy; // d21, d22 and d23, squared\n\tp = permute( px.z + Pi.y + oi ); // p31, p32, p33\n\tox = fract( p * K ) - Ko;\n\toy = mod7( floor( p * K ) ) * K - Ko;\n\tdx = Pf.x - 1.5 + jitter * ox;\n\tdy = Pf.y - of + jitter * oy;\n\tvec3 d3 = dx * dx + dy * dy; // d31, d32 and d33, squared\n\t// Sort out the two smallest distances (F1, F2)\n\tvec3 d1a = min( d1, d2 );\n\td2 = max( d1, d2 ); // Swap to keep candidates for F2\n\td2 = min( d2, d3 ); // neither F1 nor F2 are now in d3\n\td1 = min( d1a, d2 ); // F1 is now in d1\n\td2 = max( d1a, d2 ); // Swap to keep candidates for F2\n\td1.xy = ( d1.x < d1.y ) ? d1.xy : d1.yx; // Swap if smaller\n\td1.xz = ( d1.x < d1.z ) ? d1.xz : d1.zx; // F1 is in d1.x\n\td1.yz = min( d1.yz, d2.yz ); // F2 is now not in d2.yz\n\td1.y = min( d1.y, d1.z ); // nor in  d1.z\n\td1.y = min( d1.y, d2.x ); // F2 is in d1.y, we\'re done.\n\treturn sqrt( d1.xy );\n\n}\n',noise_cellular_2x2:'\n// Cellular noise ("Worley noise") in 2D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Speeded up by using 2x2 search window instead of 3x3,\n// at the expense of some strong pattern artifacts.\n// F2 is often wrong and has sharp discontinuities.\n// If you need a smooth F2, use the slower 3x3 version.\n// F1 is sometimes wrong, too, but OK for most purposes.\nvec2 cellular2x2( vec2 P ) {\n\n\tvec2 Pi = mod289( floor( P ) );\n \tvec2 Pf = fract( P );\n\tvec4 Pfx = Pf.x + vec4( -0.5, -1.5, -0.5, -1.5 );\n\tvec4 Pfy = Pf.y + vec4( -0.5, -0.5, -1.5, -1.5 );\n\tvec4 p = permute( Pi.x + vec4( 0.0, 1.0, 0.0, 1.0 ) );\n\tp = permute( p + Pi.y + vec4( 0.0, 0.0, 1.0, 1.0 ) );\n\tvec4 ox = mod7( p ) * K + Kd2;\n\tvec4 oy = mod7( floor( p * K ) ) * K + Kd2;\n\tvec4 dx = Pfx + jitter1 * ox;\n\tvec4 dy = Pfy + jitter1 * oy;\n\tvec4 d = dx * dx + dy * dy; // d11, d12, d21 and d22, squared\n\n\t// Do it right and find both F1 and F2\n\td.xy = ( d.x < d.y ) ? d.xy : d.yx; // Swap if smaller\n\td.xz = ( d.x < d.z ) ? d.xz : d.zx;\n\td.xw = ( d.x < d.w ) ? d.xw : d.wx;\n\td.y = min( d.y, d.z );\n\td.y = min( d.y, d.w );\n\treturn sqrt( d.xy );\n\n}\n',noise_cellular_2x2x2:'\n// Cellular noise ("Worley noise") in 3D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// Speeded up by using 2x2x2 search window instead of 3x3x3,\n// at the expense of some pattern artifacts.\n// F2 is often wrong and has sharp discontinuities.\n// If you need a good F2, use the slower 3x3x3 version.\nvec2 cellular2x2x2(vec3 P) {\n\n\tvec3 Pi = mod289( floor( P ) );\n \tvec3 Pf = fract( P );\n\tvec4 Pfx = Pf.x + vec4( 0.0, -1.0, 0.0, -1.0 );\n\tvec4 Pfy = Pf.y + vec4( 0.0, 0.0, -1.0, -1.0 );\n\tvec4 p = permute( Pi.x + vec4( 0.0, 1.0, 0.0, 1.0 ) );\n\tp = permute( p + Pi.y + vec4( 0.0, 0.0, 1.0, 1.0 ) );\n\tvec4 p1 = permute( p + Pi.z ); // z+0\n\tvec4 p2 = permute( p + Pi.z + vec4( 1.0 ) ); // z+1\n\tvec4 ox1 = fract( p1 * K ) - Ko;\n\tvec4 oy1 = mod7( floor( p1 * K ) ) * K - Ko;\n\tvec4 oz1 = floor( p1 * K2 ) * Kz - Kzo; // p1 < 289 guaranteed\n\tvec4 ox2 = fract( p2 * K ) - Ko;\n\tvec4 oy2 = mod7( floor( p2 * K ) ) * K - Ko;\n\tvec4 oz2 = floor( p2 * K2 ) * Kz - Kzo;\n\tvec4 dx1 = Pfx + jitter1 * ox1;\n\tvec4 dy1 = Pfy + jitter1 * oy1;\n\tvec4 dz1 = Pf.z + jitter1 * oz1;\n\tvec4 dx2 = Pfx + jitter1 * ox2;\n\tvec4 dy2 = Pfy + jitter1 * oy2;\n\tvec4 dz2 = Pf.z - 1.0 + jitter1 * oz2;\n\tvec4 d1 = dx1 * dx1 + dy1 * dy1 + dz1 * dz1; // z+0\n\tvec4 d2 = dx2 * dx2 + dy2 * dy2 + dz2 * dz2; // z+1\n\n\t// Do it right and sort out both F1 and F2\n\tvec4 d = min( d1, d2 ); // F1 is now in d\n\td2 = max( d1, d2 ); // Make sure we keep all candidates for F2\n\td.xy = ( d.x < d.y ) ? d.xy : d.yx; // Swap smallest to d.x\n\td.xz = ( d.x < d.z ) ? d.xz : d.zx;\n\td.xw = ( d.x < d.w ) ? d.xw : d.wx; // F1 is now in d.x\n\td.yzw = min( d.yzw, d2.yzw ); // F2 now not in d2.yzw\n\td.y = min( d.y, d.z ); // nor in d.z\n\td.y = min( d.y, d.w ); // nor in d.w\n\td.y = min( d.y, d2.x ); // F2 is now in d.y\n\treturn sqrt( d.xy ); // F1 and F2\n\n}\n',noise_cellular_3D:'\n// Cellular noise ("Worley noise") in 3D in GLSL.\n// Copyright (c) Stefan Gustavson 2011-04-19. All rights reserved.\n// This code is released under the conditions of the MIT license.\n// See LICENSE file for details.\n// https://github.com/stegu/webgl-noise\n\n// Cellular noise, returning F1 and F2 in a vec2.\n// 3x3x3 search region for good F2 everywhere, but a lot\n// slower than the 2x2x2 version.\n// The code below is a bit scary even to its author,\n// but it has at least half decent performance on a\n// modern GPU. In any case, it beats any software\n// implementation of Worley noise hands down.\n\nvec2 cellular( vec3 P ) {\n\n\tvec3 Pi = mod289( floor( P ) );\n \tvec3 Pf = fract( P ) - 0.5;\n\n\tvec3 Pfx = Pf.x + vec3( 1.0, 0.0, -1.0 );\n\tvec3 Pfy = Pf.y + vec3( 1.0, 0.0, -1.0 );\n\tvec3 Pfz = Pf.z + vec3( 1.0, 0.0, -1.0 );\n\n\tvec3 p = permute( Pi.x + vec3( -1.0, 0.0, 1.0 ) );\n\tvec3 p1 = permute( p + Pi.y - 1.0 );\n\tvec3 p2 = permute( p + Pi.y );\n\tvec3 p3 = permute( p + Pi.y + 1.0 );\n\n\tvec3 p11 = permute( p1 + Pi.z - 1.0 );\n\tvec3 p12 = permute( p1 + Pi.z );\n\tvec3 p13 = permute( p1 + Pi.z + 1.0 );\n\n\tvec3 p21 = permute( p2 + Pi.z - 1.0 );\n\tvec3 p22 = permute( p2 + Pi.z );\n\tvec3 p23 = permute( p2 + Pi.z + 1.0 );\n\n\tvec3 p31 = permute( p3 + Pi.z - 1.0 );\n\tvec3 p32 = permute( p3 + Pi.z );\n\tvec3 p33 = permute( p3 + Pi.z + 1.0 );\n\n\tvec3 ox11 = fract( p11 * K ) - Ko;\n\tvec3 oy11 = mod7( floor( p11 * K ) ) * K - Ko;\n\tvec3 oz11 = floor( p11 * K2 ) * Kz - Kzo; // p11 < 289 guaranteed\n\n\tvec3 ox12 = fract( p12 * K ) - Ko;\n\tvec3 oy12 = mod7( floor( p12 * K ) ) * K - Ko;\n\tvec3 oz12 = floor( p12 * K2 ) * Kz - Kzo;\n\n\tvec3 ox13 = fract( p13 * K ) - Ko;\n\tvec3 oy13 = mod7( floor( p13 * K ) ) * K - Ko;\n\tvec3 oz13 = floor( p13 * K2 ) * Kz - Kzo;\n\n\tvec3 ox21 = fract( p21 * K ) - Ko;\n\tvec3 oy21 = mod7( floor( p21 * K ) ) * K - Ko;\n\tvec3 oz21 = floor( p21 * K2 ) * Kz - Kzo;\n\n\tvec3 ox22 = fract( p22 * K ) - Ko;\n\tvec3 oy22 = mod7( floor( p22 * K ) ) * K - Ko;\n\tvec3 oz22 = floor( p22 * K2 ) * Kz - Kzo;\n\n\tvec3 ox23 = fract( p23 * K ) - Ko;\n\tvec3 oy23 = mod7( floor( p23 * K ) ) * K - Ko;\n\tvec3 oz23 = floor( p23 * K2 ) * Kz - Kzo;\n\n\tvec3 ox31 = fract( p31 * K ) - Ko;\n\tvec3 oy31 = mod7( floor( p31 * K ) ) * K - Ko;\n\tvec3 oz31 = floor( p31 * K2 ) * Kz - Kzo;\n\n\tvec3 ox32 = fract( p32 * K ) - Ko;\n\tvec3 oy32 = mod7( floor( p32 * K ) ) * K - Ko;\n\tvec3 oz32 = floor( p32 * K2 ) * Kz - Kzo;\n\n\tvec3 ox33 = fract( p33 * K ) - Ko;\n\tvec3 oy33 = mod7( floor( p33 * K ) ) * K - Ko;\n\tvec3 oz33 = floor( p33 * K2 ) * Kz - Kzo;\n\n\tvec3 dx11 = Pfx + jitter * ox11;\n\tvec3 dy11 = Pfy.x + jitter * oy11;\n\tvec3 dz11 = Pfz.x + jitter * oz11;\n\n\tvec3 dx12 = Pfx + jitter * ox12;\n\tvec3 dy12 = Pfy.x + jitter * oy12;\n\tvec3 dz12 = Pfz.y + jitter * oz12;\n\n\tvec3 dx13 = Pfx + jitter * ox13;\n\tvec3 dy13 = Pfy.x + jitter * oy13;\n\tvec3 dz13 = Pfz.z + jitter * oz13;\n\n\tvec3 dx21 = Pfx + jitter * ox21;\n\tvec3 dy21 = Pfy.y + jitter * oy21;\n\tvec3 dz21 = Pfz.x + jitter * oz21;\n\n\tvec3 dx22 = Pfx + jitter * ox22;\n\tvec3 dy22 = Pfy.y + jitter * oy22;\n\tvec3 dz22 = Pfz.y + jitter * oz22;\n\n\tvec3 dx23 = Pfx + jitter * ox23;\n\tvec3 dy23 = Pfy.y + jitter * oy23;\n\tvec3 dz23 = Pfz.z + jitter * oz23;\n\n\tvec3 dx31 = Pfx + jitter * ox31;\n\tvec3 dy31 = Pfy.z + jitter * oy31;\n\tvec3 dz31 = Pfz.x + jitter * oz31;\n\n\tvec3 dx32 = Pfx + jitter * ox32;\n\tvec3 dy32 = Pfy.z + jitter * oy32;\n\tvec3 dz32 = Pfz.y + jitter * oz32;\n\n\tvec3 dx33 = Pfx + jitter * ox33;\n\tvec3 dy33 = Pfy.z + jitter * oy33;\n\tvec3 dz33 = Pfz.z + jitter * oz33;\n\n\tvec3 d11 = dx11 * dx11 + dy11 * dy11 + dz11 * dz11;\n\tvec3 d12 = dx12 * dx12 + dy12 * dy12 + dz12 * dz12;\n\tvec3 d13 = dx13 * dx13 + dy13 * dy13 + dz13 * dz13;\n\tvec3 d21 = dx21 * dx21 + dy21 * dy21 + dz21 * dz21;\n\tvec3 d22 = dx22 * dx22 + dy22 * dy22 + dz22 * dz22;\n\tvec3 d23 = dx23 * dx23 + dy23 * dy23 + dz23 * dz23;\n\tvec3 d31 = dx31 * dx31 + dy31 * dy31 + dz31 * dz31;\n\tvec3 d32 = dx32 * dx32 + dy32 * dy32 + dz32 * dz32;\n\tvec3 d33 = dx33 * dx33 + dy33 * dy33 + dz33 * dz33;\n\n\t// Do it right and sort out both F1 and F2\n\tvec3 d1a = min( d11, d12 );\n\td12 = max( d11, d12 );\n\td11 = min( d1a, d13 ); // Smallest now not in d12 or d13\n\td13 = max( d1a, d13 );\n\td12 = min( d12, d13 ); // 2nd smallest now not in d13\n\tvec3 d2a = min( d21, d22 );\n\td22 = max( d21, d22 );\n\td21 = min( d2a, d23 ); // Smallest now not in d22 or d23\n\td23 = max( d2a, d23 );\n\td22 = min( d22, d23 ); // 2nd smallest now not in d23\n\tvec3 d3a = min( d31, d32 );\n\td32 = max( d31, d32 );\n\td31 = min( d3a, d33 ); // Smallest now not in d32 or d33\n\td33 = max( d3a, d33 );\n\td32 = min( d32, d33 ); // 2nd smallest now not in d33\n\tvec3 da = min( d11, d21 );\n\td21 = max( d11, d21 );\n\td11 = min( da, d31 ); // Smallest now in d11\n\td31 = max( da, d31 ); // 2nd smallest now not in d31\n\td11.xy = ( d11.x < d11.y ) ? d11.xy : d11.yx;\n\td11.xz = ( d11.x < d11.z ) ? d11.xz : d11.zx; // d11.x now smallest\n\td12 = min( d12, d21 ); // 2nd smallest now not in d21\n\td12 = min( d12, d22 ); // nor in d22\n\td12 = min( d12, d31 ); // nor in d31\n\td12 = min( d12, d32 ); // nor in d32\n\td11.yz = min( d11.yz, d12.xy ); // nor in d12.yz\n\td11.y = min( d11.y, d12.z ); // Only two more to go\n\td11.y = min( d11.y, d11.z ); // Done! (Phew! )\n\treturn sqrt( d11.xy ); // F1, F2\n\n}\n',noise_cellular:"#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:'//\n// GLSL textureless classic 2D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-08-22\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec2 P ) {\n\n    vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n    vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n    Pi = mod289(Pi); // To avoid truncation effects in permutation\n    vec4 ix = Pi.xzxz;\n    vec4 iy = Pi.yyww;\n    vec4 fx = Pf.xzxz;\n    vec4 fy = Pf.yyww;\n\n    vec4 i = permute(permute(ix) + iy);\n\n    vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n    vec4 gy = abs(gx) - 0.5 ;\n    vec4 tx = floor(gx + 0.5);\n    gx = gx - tx;\n\n    vec2 g00 = vec2(gx.x,gy.x);\n    vec2 g10 = vec2(gx.y,gy.y);\n    vec2 g01 = vec2(gx.z,gy.z);\n    vec2 g11 = vec2(gx.w,gy.w);\n\n    vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n    g00 *= norm.x;\n    g01 *= norm.y;\n    g10 *= norm.z;\n    g11 *= norm.w;\n\n    float n00 = dot(g00, vec2(fx.x, fy.x));\n    float n10 = dot(g10, vec2(fx.y, fy.y));\n    float n01 = dot(g01, vec2(fx.z, fy.z));\n    float n11 = dot(g11, vec2(fx.w, fy.w));\n\n    vec2 fade_xy = fade(Pf.xy);\n    vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n    float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n    return 2.3 * n_xy;\n\n}\n\n// Classic Perlin noise, periodic variant\nfloat perlin( vec2 P, vec2 rep ) {\n\n    vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n    vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n    Pi = mod(Pi, rep.xyxy); // To create noise with explicit period\n    Pi = mod289(Pi);        // To avoid truncation effects in permutation\n    vec4 ix = Pi.xzxz;\n    vec4 iy = Pi.yyww;\n    vec4 fx = Pf.xzxz;\n    vec4 fy = Pf.yyww;\n\n    vec4 i = permute(permute(ix) + iy);\n\n    vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n    vec4 gy = abs(gx) - 0.5 ;\n    vec4 tx = floor(gx + 0.5);\n    gx = gx - tx;\n\n    vec2 g00 = vec2(gx.x,gy.x);\n    vec2 g10 = vec2(gx.y,gy.y);\n    vec2 g01 = vec2(gx.z,gy.z);\n    vec2 g11 = vec2(gx.w,gy.w);\n\n    vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n    g00 *= norm.x;\n    g01 *= norm.y;\n    g10 *= norm.z;\n    g11 *= norm.w;\n\n    float n00 = dot(g00, vec2(fx.x, fy.x));\n    float n10 = dot(g10, vec2(fx.y, fy.y));\n    float n01 = dot(g01, vec2(fx.z, fy.z));\n    float n11 = dot(g11, vec2(fx.w, fy.w));\n\n    vec2 fade_xy = fade(Pf.xy);\n    vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n    float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n    return 2.3 * n_xy;\n\n}\n',noise_perlin_3D:'//\n// GLSL textureless classic 3D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-10-11\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec3 P ) {\n\n    vec3 Pi0 = floor(P); // Integer part for indexing\n    vec3 Pi1 = Pi0 + vec3(1.0); // Integer part + 1\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec3 Pf0 = fract(P); // Fractional part for interpolation\n    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = Pi0.zzzz;\n    vec4 iz1 = Pi1.zzzz;\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n\n    vec4 gx0 = ixy0 * (1.0 / 7.0);\n    vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n    gx0 = fract(gx0);\n    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n    vec4 sz0 = step(gz0, vec4(0.0));\n    gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n    gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n    vec4 gx1 = ixy1 * (1.0 / 7.0);\n    vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n    gx1 = fract(gx1);\n    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n    vec4 sz1 = step(gz1, vec4(0.0));\n    gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n    gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n    vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n    vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n    vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n    vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n    vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n    vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n    vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n    vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n    g000 *= norm0.x;\n    g010 *= norm0.y;\n    g100 *= norm0.z;\n    g110 *= norm0.w;\n    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n    g001 *= norm1.x;\n    g011 *= norm1.y;\n    g101 *= norm1.z;\n    g111 *= norm1.w;\n\n    float n000 = dot(g000, Pf0);\n    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n    float n111 = dot(g111, Pf1);\n\n    vec3 fade_xyz = fade(Pf0);\n    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n    return 2.2 * n_xyz;\n\n}\n\n// Classic Perlin noise, periodic variant\nfloat perlin( vec3 P, vec3 rep ) {\n\n    vec3 Pi0 = mod(floor(P), rep); // Integer part, modulo period\n    vec3 Pi1 = mod(Pi0 + vec3(1.0), rep); // Integer part + 1, mod period\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec3 Pf0 = fract(P); // Fractional part for interpolation\n    vec3 Pf1 = Pf0 - vec3(1.0); // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = Pi0.zzzz;\n    vec4 iz1 = Pi1.zzzz;\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n\n    vec4 gx0 = ixy0 * (1.0 / 7.0);\n    vec4 gy0 = fract(floor(gx0) * (1.0 / 7.0)) - 0.5;\n    gx0 = fract(gx0);\n    vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n    vec4 sz0 = step(gz0, vec4(0.0));\n    gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n    gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\n    vec4 gx1 = ixy1 * (1.0 / 7.0);\n    vec4 gy1 = fract(floor(gx1) * (1.0 / 7.0)) - 0.5;\n    gx1 = fract(gx1);\n    vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n    vec4 sz1 = step(gz1, vec4(0.0));\n    gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n    gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\n    vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n    vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n    vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n    vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n    vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n    vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n    vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n    vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\n    vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n    g000 *= norm0.x;\n    g010 *= norm0.y;\n    g100 *= norm0.z;\n    g110 *= norm0.w;\n    vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n    g001 *= norm1.x;\n    g011 *= norm1.y;\n    g101 *= norm1.z;\n    g111 *= norm1.w;\n\n    float n000 = dot(g000, Pf0);\n    float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n    float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n    float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n    float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n    float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n    float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n    float n111 = dot(g111, Pf1);\n\n    vec3 fade_xyz = fade(Pf0);\n    vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n    vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n    float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x);\n    return 2.2 * n_xyz;\n\n}\n',noise_perlin_4D:'//\n// GLSL textureless classic 4D noise "cnoise",\n// with an RSL-style periodic variant "pnoise".\n// Author:  Stefan Gustavson (stefan.gustavson@liu.se)\n// Version: 2011-08-22\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// ideas for permutation and gradient selection.\n//\n// Copyright (c) 2011 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Classic Perlin noise\nfloat perlin( vec4 P ) {\n\n    vec4 Pi0 = floor(P); // Integer part for indexing\n    vec4 Pi1 = Pi0 + 1.0; // Integer part + 1\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec4 Pf0 = fract(P); // Fractional part for interpolation\n    vec4 Pf1 = Pf0 - 1.0; // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = vec4(Pi0.zzzz);\n    vec4 iz1 = vec4(Pi1.zzzz);\n    vec4 iw0 = vec4(Pi0.wwww);\n    vec4 iw1 = vec4(Pi1.wwww);\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n    vec4 ixy00 = permute(ixy0 + iw0);\n    vec4 ixy01 = permute(ixy0 + iw1);\n    vec4 ixy10 = permute(ixy1 + iw0);\n    vec4 ixy11 = permute(ixy1 + iw1);\n\n    vec4 gx00 = ixy00 * (1.0 / 7.0);\n    vec4 gy00 = floor(gx00) * (1.0 / 7.0);\n    vec4 gz00 = floor(gy00) * (1.0 / 6.0);\n    gx00 = fract(gx00) - 0.5;\n    gy00 = fract(gy00) - 0.5;\n    gz00 = fract(gz00) - 0.5;\n    vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n    vec4 sw00 = step(gw00, vec4(0.0));\n    gx00 -= sw00 * (step(0.0, gx00) - 0.5);\n    gy00 -= sw00 * (step(0.0, gy00) - 0.5);\n\n    vec4 gx01 = ixy01 * (1.0 / 7.0);\n    vec4 gy01 = floor(gx01) * (1.0 / 7.0);\n    vec4 gz01 = floor(gy01) * (1.0 / 6.0);\n    gx01 = fract(gx01) - 0.5;\n    gy01 = fract(gy01) - 0.5;\n    gz01 = fract(gz01) - 0.5;\n    vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n    vec4 sw01 = step(gw01, vec4(0.0));\n    gx01 -= sw01 * (step(0.0, gx01) - 0.5);\n    gy01 -= sw01 * (step(0.0, gy01) - 0.5);\n\n    vec4 gx10 = ixy10 * (1.0 / 7.0);\n    vec4 gy10 = floor(gx10) * (1.0 / 7.0);\n    vec4 gz10 = floor(gy10) * (1.0 / 6.0);\n    gx10 = fract(gx10) - 0.5;\n    gy10 = fract(gy10) - 0.5;\n    gz10 = fract(gz10) - 0.5;\n    vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n    vec4 sw10 = step(gw10, vec4(0.0));\n    gx10 -= sw10 * (step(0.0, gx10) - 0.5);\n    gy10 -= sw10 * (step(0.0, gy10) - 0.5);\n\n    vec4 gx11 = ixy11 * (1.0 / 7.0);\n    vec4 gy11 = floor(gx11) * (1.0 / 7.0);\n    vec4 gz11 = floor(gy11) * (1.0 / 6.0);\n    gx11 = fract(gx11) - 0.5;\n    gy11 = fract(gy11) - 0.5;\n    gz11 = fract(gz11) - 0.5;\n    vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n    vec4 sw11 = step(gw11, vec4(0.0));\n    gx11 -= sw11 * (step(0.0, gx11) - 0.5);\n    gy11 -= sw11 * (step(0.0, gy11) - 0.5);\n\n    vec4 g0000 = vec4(gx00.x,gy00.x,gz00.x,gw00.x);\n    vec4 g1000 = vec4(gx00.y,gy00.y,gz00.y,gw00.y);\n    vec4 g0100 = vec4(gx00.z,gy00.z,gz00.z,gw00.z);\n    vec4 g1100 = vec4(gx00.w,gy00.w,gz00.w,gw00.w);\n    vec4 g0010 = vec4(gx10.x,gy10.x,gz10.x,gw10.x);\n    vec4 g1010 = vec4(gx10.y,gy10.y,gz10.y,gw10.y);\n    vec4 g0110 = vec4(gx10.z,gy10.z,gz10.z,gw10.z);\n    vec4 g1110 = vec4(gx10.w,gy10.w,gz10.w,gw10.w);\n    vec4 g0001 = vec4(gx01.x,gy01.x,gz01.x,gw01.x);\n    vec4 g1001 = vec4(gx01.y,gy01.y,gz01.y,gw01.y);\n    vec4 g0101 = vec4(gx01.z,gy01.z,gz01.z,gw01.z);\n    vec4 g1101 = vec4(gx01.w,gy01.w,gz01.w,gw01.w);\n    vec4 g0011 = vec4(gx11.x,gy11.x,gz11.x,gw11.x);\n    vec4 g1011 = vec4(gx11.y,gy11.y,gz11.y,gw11.y);\n    vec4 g0111 = vec4(gx11.z,gy11.z,gz11.z,gw11.z);\n    vec4 g1111 = vec4(gx11.w,gy11.w,gz11.w,gw11.w);\n\n    vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n    g0000 *= norm00.x;\n    g0100 *= norm00.y;\n    g1000 *= norm00.z;\n    g1100 *= norm00.w;\n\n    vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n    g0001 *= norm01.x;\n    g0101 *= norm01.y;\n    g1001 *= norm01.z;\n    g1101 *= norm01.w;\n\n    vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n    g0010 *= norm10.x;\n    g0110 *= norm10.y;\n    g1010 *= norm10.z;\n    g1110 *= norm10.w;\n\n    vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n    g0011 *= norm11.x;\n    g0111 *= norm11.y;\n    g1011 *= norm11.z;\n    g1111 *= norm11.w;\n\n    float n0000 = dot(g0000, Pf0);\n    float n1000 = dot(g1000, vec4(Pf1.x, Pf0.yzw));\n    float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.zw));\n    float n1100 = dot(g1100, vec4(Pf1.xy, Pf0.zw));\n    float n0010 = dot(g0010, vec4(Pf0.xy, Pf1.z, Pf0.w));\n    float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n    float n0110 = dot(g0110, vec4(Pf0.x, Pf1.yz, Pf0.w));\n    float n1110 = dot(g1110, vec4(Pf1.xyz, Pf0.w));\n    float n0001 = dot(g0001, vec4(Pf0.xyz, Pf1.w));\n    float n1001 = dot(g1001, vec4(Pf1.x, Pf0.yz, Pf1.w));\n    float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n    float n1101 = dot(g1101, vec4(Pf1.xy, Pf0.z, Pf1.w));\n    float n0011 = dot(g0011, vec4(Pf0.xy, Pf1.zw));\n    float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.zw));\n    float n0111 = dot(g0111, vec4(Pf0.x, Pf1.yzw));\n    float n1111 = dot(g1111, Pf1);\n\n    vec4 fade_xyzw = fade(Pf0);\n    vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n    vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n    vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n    vec2 n_yzw = mix(n_zw.xy, n_zw.zw, fade_xyzw.y);\n    float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n    return 2.2 * n_xyzw;\n\n}\n\n// Classic Perlin noise, periodic version\nfloat perlin( vec4 P, vec4 rep ) {\n\n    vec4 Pi0 = mod(floor(P), rep); // Integer part modulo rep\n    vec4 Pi1 = mod(Pi0 + 1.0, rep); // Integer part + 1 mod rep\n    Pi0 = mod289(Pi0);\n    Pi1 = mod289(Pi1);\n    vec4 Pf0 = fract(P); // Fractional part for interpolation\n    vec4 Pf1 = Pf0 - 1.0; // Fractional part - 1.0\n    vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n    vec4 iy = vec4(Pi0.yy, Pi1.yy);\n    vec4 iz0 = vec4(Pi0.zzzz);\n    vec4 iz1 = vec4(Pi1.zzzz);\n    vec4 iw0 = vec4(Pi0.wwww);\n    vec4 iw1 = vec4(Pi1.wwww);\n\n    vec4 ixy = permute(permute(ix) + iy);\n    vec4 ixy0 = permute(ixy + iz0);\n    vec4 ixy1 = permute(ixy + iz1);\n    vec4 ixy00 = permute(ixy0 + iw0);\n    vec4 ixy01 = permute(ixy0 + iw1);\n    vec4 ixy10 = permute(ixy1 + iw0);\n    vec4 ixy11 = permute(ixy1 + iw1);\n\n    vec4 gx00 = ixy00 * (1.0 / 7.0);\n    vec4 gy00 = floor(gx00) * (1.0 / 7.0);\n    vec4 gz00 = floor(gy00) * (1.0 / 6.0);\n    gx00 = fract(gx00) - 0.5;\n    gy00 = fract(gy00) - 0.5;\n    gz00 = fract(gz00) - 0.5;\n    vec4 gw00 = vec4(0.75) - abs(gx00) - abs(gy00) - abs(gz00);\n    vec4 sw00 = step(gw00, vec4(0.0));\n    gx00 -= sw00 * (step(0.0, gx00) - 0.5);\n    gy00 -= sw00 * (step(0.0, gy00) - 0.5);\n\n    vec4 gx01 = ixy01 * (1.0 / 7.0);\n    vec4 gy01 = floor(gx01) * (1.0 / 7.0);\n    vec4 gz01 = floor(gy01) * (1.0 / 6.0);\n    gx01 = fract(gx01) - 0.5;\n    gy01 = fract(gy01) - 0.5;\n    gz01 = fract(gz01) - 0.5;\n    vec4 gw01 = vec4(0.75) - abs(gx01) - abs(gy01) - abs(gz01);\n    vec4 sw01 = step(gw01, vec4(0.0));\n    gx01 -= sw01 * (step(0.0, gx01) - 0.5);\n    gy01 -= sw01 * (step(0.0, gy01) - 0.5);\n\n    vec4 gx10 = ixy10 * (1.0 / 7.0);\n    vec4 gy10 = floor(gx10) * (1.0 / 7.0);\n    vec4 gz10 = floor(gy10) * (1.0 / 6.0);\n    gx10 = fract(gx10) - 0.5;\n    gy10 = fract(gy10) - 0.5;\n    gz10 = fract(gz10) - 0.5;\n    vec4 gw10 = vec4(0.75) - abs(gx10) - abs(gy10) - abs(gz10);\n    vec4 sw10 = step(gw10, vec4(0.0));\n    gx10 -= sw10 * (step(0.0, gx10) - 0.5);\n    gy10 -= sw10 * (step(0.0, gy10) - 0.5);\n\n    vec4 gx11 = ixy11 * (1.0 / 7.0);\n    vec4 gy11 = floor(gx11) * (1.0 / 7.0);\n    vec4 gz11 = floor(gy11) * (1.0 / 6.0);\n    gx11 = fract(gx11) - 0.5;\n    gy11 = fract(gy11) - 0.5;\n    gz11 = fract(gz11) - 0.5;\n    vec4 gw11 = vec4(0.75) - abs(gx11) - abs(gy11) - abs(gz11);\n    vec4 sw11 = step(gw11, vec4(0.0));\n    gx11 -= sw11 * (step(0.0, gx11) - 0.5);\n    gy11 -= sw11 * (step(0.0, gy11) - 0.5);\n\n    vec4 g0000 = vec4(gx00.x,gy00.x,gz00.x,gw00.x);\n    vec4 g1000 = vec4(gx00.y,gy00.y,gz00.y,gw00.y);\n    vec4 g0100 = vec4(gx00.z,gy00.z,gz00.z,gw00.z);\n    vec4 g1100 = vec4(gx00.w,gy00.w,gz00.w,gw00.w);\n    vec4 g0010 = vec4(gx10.x,gy10.x,gz10.x,gw10.x);\n    vec4 g1010 = vec4(gx10.y,gy10.y,gz10.y,gw10.y);\n    vec4 g0110 = vec4(gx10.z,gy10.z,gz10.z,gw10.z);\n    vec4 g1110 = vec4(gx10.w,gy10.w,gz10.w,gw10.w);\n    vec4 g0001 = vec4(gx01.x,gy01.x,gz01.x,gw01.x);\n    vec4 g1001 = vec4(gx01.y,gy01.y,gz01.y,gw01.y);\n    vec4 g0101 = vec4(gx01.z,gy01.z,gz01.z,gw01.z);\n    vec4 g1101 = vec4(gx01.w,gy01.w,gz01.w,gw01.w);\n    vec4 g0011 = vec4(gx11.x,gy11.x,gz11.x,gw11.x);\n    vec4 g1011 = vec4(gx11.y,gy11.y,gz11.y,gw11.y);\n    vec4 g0111 = vec4(gx11.z,gy11.z,gz11.z,gw11.z);\n    vec4 g1111 = vec4(gx11.w,gy11.w,gz11.w,gw11.w);\n\n    vec4 norm00 = taylorInvSqrt(vec4(dot(g0000, g0000), dot(g0100, g0100), dot(g1000, g1000), dot(g1100, g1100)));\n    g0000 *= norm00.x;\n    g0100 *= norm00.y;\n    g1000 *= norm00.z;\n    g1100 *= norm00.w;\n\n    vec4 norm01 = taylorInvSqrt(vec4(dot(g0001, g0001), dot(g0101, g0101), dot(g1001, g1001), dot(g1101, g1101)));\n    g0001 *= norm01.x;\n    g0101 *= norm01.y;\n    g1001 *= norm01.z;\n    g1101 *= norm01.w;\n\n    vec4 norm10 = taylorInvSqrt(vec4(dot(g0010, g0010), dot(g0110, g0110), dot(g1010, g1010), dot(g1110, g1110)));\n    g0010 *= norm10.x;\n    g0110 *= norm10.y;\n    g1010 *= norm10.z;\n    g1110 *= norm10.w;\n\n    vec4 norm11 = taylorInvSqrt(vec4(dot(g0011, g0011), dot(g0111, g0111), dot(g1011, g1011), dot(g1111, g1111)));\n    g0011 *= norm11.x;\n    g0111 *= norm11.y;\n    g1011 *= norm11.z;\n    g1111 *= norm11.w;\n\n    float n0000 = dot(g0000, Pf0);\n    float n1000 = dot(g1000, vec4(Pf1.x, Pf0.yzw));\n    float n0100 = dot(g0100, vec4(Pf0.x, Pf1.y, Pf0.zw));\n    float n1100 = dot(g1100, vec4(Pf1.xy, Pf0.zw));\n    float n0010 = dot(g0010, vec4(Pf0.xy, Pf1.z, Pf0.w));\n    float n1010 = dot(g1010, vec4(Pf1.x, Pf0.y, Pf1.z, Pf0.w));\n    float n0110 = dot(g0110, vec4(Pf0.x, Pf1.yz, Pf0.w));\n    float n1110 = dot(g1110, vec4(Pf1.xyz, Pf0.w));\n    float n0001 = dot(g0001, vec4(Pf0.xyz, Pf1.w));\n    float n1001 = dot(g1001, vec4(Pf1.x, Pf0.yz, Pf1.w));\n    float n0101 = dot(g0101, vec4(Pf0.x, Pf1.y, Pf0.z, Pf1.w));\n    float n1101 = dot(g1101, vec4(Pf1.xy, Pf0.z, Pf1.w));\n    float n0011 = dot(g0011, vec4(Pf0.xy, Pf1.zw));\n    float n1011 = dot(g1011, vec4(Pf1.x, Pf0.y, Pf1.zw));\n    float n0111 = dot(g0111, vec4(Pf0.x, Pf1.yzw));\n    float n1111 = dot(g1111, Pf1);\n\n    vec4 fade_xyzw = fade(Pf0);\n    vec4 n_0w = mix(vec4(n0000, n1000, n0100, n1100), vec4(n0001, n1001, n0101, n1101), fade_xyzw.w);\n    vec4 n_1w = mix(vec4(n0010, n1010, n0110, n1110), vec4(n0011, n1011, n0111, n1111), fade_xyzw.w);\n    vec4 n_zw = mix(n_0w, n_1w, fade_xyzw.z);\n    vec2 n_yzw = mix(n_zw.xy, n_zw.zw, fade_xyzw.y);\n    float n_xyzw = mix(n_yzw.x, n_yzw.y, fade_xyzw.x);\n    return 2.2 * n_xyzw;\n\n}\n',noise_perlin:"#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:'// Periodic (tiling) 2-D simplex noise (hexagonal lattice gradient noise)\n// with rotating gradients and analytic derivatives.\n// Variants also without the derivative (no "d" in the name), without\n// the tiling property (no "p" in the name) and without the rotating\n// gradients (no "r" in the name).\n//\n// This is (yet) another variation on simplex noise. It\'s similar to the\n// version presented by Ken Perlin, but the grid is axis-aligned and\n// slightly stretched in the y direction to permit rectangular tiling.\n//\n// The noise can be made to tile seamlessly to any integer period in x and\n// any even integer period in y. Odd periods may be specified for y, but\n// then the actual tiling period will be twice that number.\n//\n// The rotating gradients give the appearance of a swirling motion, and can\n// serve a similar purpose for animation as motion along z in 3-D noise.\n// The rotating gradients in conjunction with the analytic derivatives\n// can make "flow noise" effects as presented by Perlin and Neyret.\n//\n// vec3 {p}s{r}dnoise(vec2 pos {, vec2 per} {, float rot})\n// "pos" is the input (x,y) coordinate\n// "per" is the x and y period, where per.x is a positive integer\n//    and per.y is a positive even integer\n// "rot" is the angle to rotate the gradients (any float value,\n//    where 0.0 is no rotation and 1.0 is one full turn)\n// The first component of the 3-element return vector is the noise value.\n// The second and third components are the x and y partial derivatives.\n//\n// float {p}s{r}noise(vec2 pos {, vec2 per} {, float rot})\n// "pos" is the input (x,y) coordinate\n// "per" is the x and y period, where per.x is a positive integer\n//    and per.y is a positive even integer\n// "rot" is the angle to rotate the gradients (any float value,\n//    where 0.0 is no rotation and 1.0 is one full turn)\n// The return value is the noise value.\n// Partial derivatives are not computed, making these functions faster.\n//\n// Author: Stefan Gustavson (stefan.gustavson@gmail.com)\n// Version 2016-05-10.\n//\n// Many thanks to Ian McEwan of Ashima Arts for the\n// idea of using a permutation polynomial.\n//\n// Copyright (c) 2016 Stefan Gustavson. All rights reserved.\n// Distributed under the MIT license. See LICENSE file.\n// https://github.com/stegu/webgl-noise\n//\n\n// Hashed 2-D gradients with an extra rotation.\n// (The constant 0.0243902439 is 1/41)\nvec2 rgrad2( vec2 p, float rot ) {\n\n    // For more isotropic gradients, sin/cos can be used instead.\n    float u = permute( permute( p.x ) + p.y ) * 0.0243902439 + rot; // Rotate by shift\n    u = fract( u ) * 6.28318530718; // 2*pi\n    return vec2( cos( u ), sin( u ));\n\n}\n\n//\n// 2-D tiling simplex noise with rotating gradients and analytical derivative.\n// The first component of the 3-element return vector is the noise value,\n// and the second and third components are the x and y partial derivatives.\n//\nvec3 psrdnoise(vec2 pos, vec2 per, float rot) {\n  // Hack: offset y slightly to hide some rare artifacts\n  pos.y += 0.01;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 xw = mod(vec3(p0.x, p1.x, p2.x), per.x);\n  vec3 yw = mod(vec3(p0.y, p1.y, p2.y), per.y);\n  vec3 iuw = xw + 0.5 * yw;\n  vec3 ivw = yw;\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Partial derivatives for analytical gradient computation\n  vec3 dtdx = -2.0 * vec3(d0.x, d1.x, d2.x);\n  vec3 dtdy = -2.0 * vec3(d0.y, d1.y, d2.y);\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  if (t.x < 0.0) {\n    dtdx.x = 0.0;\n    dtdy.x = 0.0;\n\tt.x = 0.0;\n  }\n  if (t.y < 0.0) {\n    dtdx.y = 0.0;\n    dtdy.y = 0.0;\n\tt.y = 0.0;\n  }\n  if (t.z < 0.0) {\n    dtdx.z = 0.0;\n    dtdy.z = 0.0;\n\tt.z = 0.0;\n  }\n\n  // Fourth power of t (and third power for derivative)\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n  vec3 t3 = t2 * t;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Final analytical derivative (gradient of a sum of scalar products)\n  vec2 dt0 = vec2(dtdx.x, dtdy.x) * 4.0 * t3.x;\n  vec2 dn0 = t4.x * g0 + dt0 * w.x;\n  vec2 dt1 = vec2(dtdx.y, dtdy.y) * 4.0 * t3.y;\n  vec2 dn1 = t4.y * g1 + dt1 * w.y;\n  vec2 dt2 = vec2(dtdx.z, dtdy.z) * 4.0 * t3.z;\n  vec2 dn2 = t4.z * g2 + dt2 * w.z;\n\n  return 11.0*vec3(n, dn0 + dn1 + dn2);\n}\n\n//\n// 2-D tiling simplex noise with fixed gradients\n// and analytical derivative.\n// This function is implemented as a wrapper to "psrdnoise",\n// at the minimal cost of three extra additions.\n//\nvec3 psdnoise(vec2 pos, vec2 per) {\n  return psrdnoise(pos, per, 0.0);\n}\n\n//\n// 2-D tiling simplex noise with rotating gradients,\n// but without the analytical derivative.\n//\nfloat psrnoise(vec2 pos, vec2 per, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 xw = mod(vec3(p0.x, p1.x, p2.x), per.x);\n  vec3 yw = mod(vec3(p0.y, p1.y, p2.y), per.y);\n  vec3 iuw = xw + 0.5 * yw;\n  vec3 ivw = yw;\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  t = max(t, 0.0);\n\n  // Fourth power of t\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Rescale to cover the range [-1,1] reasonably well\n  return 11.0*n;\n}\n\n//\n// 2-D tiling simplex noise with fixed gradients,\n// without the analytical derivative.\n// This function is implemented as a wrapper to "psrnoise",\n// at the minimal cost of three extra additions.\n//\nfloat psnoise(vec2 pos, vec2 per) {\n  return psrnoise(pos, per, 0.0);\n}\n\n//\n// 2-D non-tiling simplex noise with rotating gradients and analytical derivative.\n// The first component of the 3-element return vector is the noise value,\n// and the second and third components are the x and y partial derivatives.\n//\nvec3 srdnoise(vec2 pos, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  vec3 x = vec3(p0.x, p1.x, p2.x);\n  vec3 y = vec3(p0.y, p1.y, p2.y);\n  vec3 iuw = x + 0.5 * y;\n  vec3 ivw = y;\n\n  // Avoid precision issues in permutation\n  iuw = mod289(iuw);\n  ivw = mod289(ivw);\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Partial derivatives for analytical gradient computation\n  vec3 dtdx = -2.0 * vec3(d0.x, d1.x, d2.x);\n  vec3 dtdy = -2.0 * vec3(d0.y, d1.y, d2.y);\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  if (t.x < 0.0) {\n    dtdx.x = 0.0;\n    dtdy.x = 0.0;\n\tt.x = 0.0;\n  }\n  if (t.y < 0.0) {\n    dtdx.y = 0.0;\n    dtdy.y = 0.0;\n\tt.y = 0.0;\n  }\n  if (t.z < 0.0) {\n    dtdx.z = 0.0;\n    dtdy.z = 0.0;\n\tt.z = 0.0;\n  }\n\n  // Fourth power of t (and third power for derivative)\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n  vec3 t3 = t2 * t;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Final analytical derivative (gradient of a sum of scalar products)\n  vec2 dt0 = vec2(dtdx.x, dtdy.x) * 4.0 * t3.x;\n  vec2 dn0 = t4.x * g0 + dt0 * w.x;\n  vec2 dt1 = vec2(dtdx.y, dtdy.y) * 4.0 * t3.y;\n  vec2 dn1 = t4.y * g1 + dt1 * w.y;\n  vec2 dt2 = vec2(dtdx.z, dtdy.z) * 4.0 * t3.z;\n  vec2 dn2 = t4.z * g2 + dt2 * w.z;\n\n  return 11.0*vec3(n, dn0 + dn1 + dn2);\n}\n\n//\n// 2-D non-tiling simplex noise with fixed gradients and analytical derivative.\n// This function is implemented as a wrapper to "srdnoise",\n// at the minimal cost of three extra additions.\n//\nvec3 sdnoise(vec2 pos) {\n  return srdnoise(pos, 0.0);\n}\n\n//\n// 2-D non-tiling simplex noise with rotating gradients,\n// without the analytical derivative.\n//\nfloat srnoise(vec2 pos, float rot) {\n  // Offset y slightly to hide some rare artifacts\n  pos.y += 0.001;\n  // Skew to hexagonal grid\n  vec2 uv = vec2(pos.x + pos.y*0.5, pos.y);\n\n  vec2 i0 = floor(uv);\n  vec2 f0 = fract(uv);\n  // Traversal order\n  vec2 i1 = (f0.x > f0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n\n  // Unskewed grid points in (x,y) space\n  vec2 p0 = vec2(i0.x - i0.y * 0.5, i0.y);\n  vec2 p1 = vec2(p0.x + i1.x - i1.y * 0.5, p0.y + i1.y);\n  vec2 p2 = vec2(p0.x + 0.5, p0.y + 1.0);\n\n  // Integer grid point indices in (u,v) space\n  i1 = i0 + i1;\n  vec2 i2 = i0 + vec2(1.0, 1.0);\n\n  // Vectors in unskewed (x,y) coordinates from\n  // each of the simplex corners to the evaluation point\n  vec2 d0 = pos - p0;\n  vec2 d1 = pos - p1;\n  vec2 d2 = pos - p2;\n\n  // Wrap i0, i1 and i2 to the desired period before gradient hashing:\n  // wrap points in (x,y), map to (u,v)\n  vec3 x = vec3(p0.x, p1.x, p2.x);\n  vec3 y = vec3(p0.y, p1.y, p2.y);\n  vec3 iuw = x + 0.5 * y;\n  vec3 ivw = y;\n\n  // Avoid precision issues in permutation\n  iuw = mod289(iuw);\n  ivw = mod289(ivw);\n\n  // Create gradients from indices\n  vec2 g0 = rgrad2(vec2(iuw.x, ivw.x), rot);\n  vec2 g1 = rgrad2(vec2(iuw.y, ivw.y), rot);\n  vec2 g2 = rgrad2(vec2(iuw.z, ivw.z), rot);\n\n  // Gradients dot vectors to corresponding corners\n  // (The derivatives of this are simply the gradients)\n  vec3 w = vec3(dot(g0, d0), dot(g1, d1), dot(g2, d2));\n\n  // Radial weights from corners\n  // 0.8 is the square of 2/sqrt(5), the distance from\n  // a grid point to the nearest simplex boundary\n  vec3 t = 0.8 - vec3(dot(d0, d0), dot(d1, d1), dot(d2, d2));\n\n  // Set influence of each surflet to zero outside radius sqrt(0.8)\n  t = max(t, 0.0);\n\n  // Fourth power of t\n  vec3 t2 = t * t;\n  vec3 t4 = t2 * t2;\n\n  // Final noise value is:\n  // sum of ((radial weights) times (gradient dot vector from corner))\n  float n = dot(t4, w);\n\n  // Rescale to cover the range [-1,1] reasonably well\n  return 11.0*n;\n}\n\n//\n// 2-D non-tiling simplex noise with fixed gradients,\n// without the analytical derivative.\n// This function is implemented as a wrapper to "srnoise",\n// at the minimal cost of three extra additions.\n// Note: if this kind of noise is all you want, there are faster\n// GLSL implementations of non-tiling simplex noise out there.\n// This one is included mainly for completeness and compatibility\n// with the other functions in the file.\n//\nfloat snoise(vec2 pos) {\n  return srnoise(pos, 0.0);\n}\n',noise_simplex_2D:"//\n// Description : Array and textureless GLSL 2D simplex noise function.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec2 v ) {\n\n    const vec4 C = vec4( 0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                        0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                        -0.577350269189626,  // -1.0 + 2.0 * C.x\n                        0.024390243902439 ); // 1.0 / 41.0\n    // First corner\n    vec2 i  = floor( v + dot( v, C.yy ) );\n    vec2 x0 = v - i + dot( i, C.xx );\n\n    // Other corners\n    vec2 i1;\n    //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0\n    //i1.y = 1.0 - i1.x;\n    i1 = ( x0.x > x0.y ) ? vec2( 1.0, 0.0 ) : vec2( 0.0, 1.0 );\n    // x0 = x0 - 0.0 + 0.0 * C.xx ;\n    // x1 = x0 - i1 + 1.0 * C.xx ;\n    // x2 = x0 - 1.0 + 2.0 * C.xx ;\n    vec4 x12 = x0.xyxy + C.xxzz;\n    x12.xy -= i1;\n\n    // Permutations\n    i = mod289( i ); // Avoid truncation effects in permutation\n    vec3 p = permute( permute( i.y + vec3( 0.0, i1.y, 1.0 ) )\n        + i.x + vec3( 0.0, i1.x, 1.0 ) );\n\n    vec3 m = max( 0.5 - vec3( dot( x0, x0 ), dot( x12.xy, x12.xy ), dot( x12.zw, x12.zw ) ), 0.0 );\n    m = m*m ;\n    m = m*m ;\n\n    // Gradients: 41 points uniformly over a line, mapped onto a diamond.\n    // The ring size 17*17 = 289 is close to a multiple of 41 (41*7 = 287)\n\n    vec3 x = 2.0 * fract( p * C.www ) - 1.0;\n    vec3 h = abs( x ) - 0.5;\n    vec3 ox = floor( x + 0.5 );\n    vec3 a0 = x - ox;\n\n    // Normalise gradients implicitly by scaling m\n    // Approximation of: m *= inversesqrt( a0*a0 + h*h );\n    m *= 1.79284291400159 - 0.85373472095314 * ( a0 * a0 + h * h );\n\n    // Compute final noise value at P\n    vec3 g;\n    g.x  = a0.x * x0.x + h.x * x0.y;\n    g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n    return 130.0 * dot( m, g );\n\n}\n",noise_simplex_3D_grad:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20150104 (JcBernack)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec3 v, out vec3 gradient ) {\n\n    const vec2  C = vec2( 1.0 / 6.0, 1.0 / 3.0 );\n    const vec4  D = vec4( 0.0, 0.5, 1.0, 2.0 );\n\n    // First corner\n    vec3 i  = floor( v + dot( v, C.yyy ) );\n    vec3 x0 = v - i + dot( i, C.xxx ) ;\n\n    // Other corners\n    vec3 g = step( x0.yzx, x0.xyz );\n    vec3 l = 1.0 - g;\n    vec3 i1 = min( g.xyz, l.zxy );\n    vec3 i2 = max( g.xyz, l.zxy );\n\n    vec3 x1 = x0 - i1 + C.xxx;\n    vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n    vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n    // Permutations\n    i = mod289( i );\n    vec4 p = permute( permute( permute(\n                i.z + vec4( 0.0, i1.z, i2.z, 1.0 ) )\n            + i.y + vec4( 0.0, i1.y, i2.y, 1.0 ) )\n            + i.x + vec4( 0.0, i1.x, i2.x, 1.0 ) );\n\n    // Gradients: 7x7 points over a square, mapped onto an octahedron.\n    // The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n    float n_ = 0.142857142857; // 1.0/7.0\n    vec3 ns = n_ * D.wyz - D.xzx;\n\n    vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)\n\n    vec4 x_ = floor(j * ns.z);\n    vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n    vec4 x = x_ * ns.x + ns.yyyy;\n    vec4 y = y_ * ns.x + ns.yyyy;\n    vec4 h = 1.0 - abs( x ) - abs( y );\n\n    vec4 b0 = vec4( x.xy, y.xy );\n    vec4 b1 = vec4( x.zw, y.zw );\n\n    vec4 s0 = floor( b0 ) * 2.0 + 1.0;\n    vec4 s1 = floor( b1 ) * 2.0 + 1.0;\n    vec4 sh = - step( h, vec4( 0.0 ) );\n\n    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy ;\n    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww ;\n\n    vec3 p0 = vec3( a0.xy, h.x );\n    vec3 p1 = vec3( a0.zw, h.y );\n    vec3 p2 = vec3( a1.xy, h.z );\n    vec3 p3 = vec3( a1.zw, h.w );\n\n    //Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n\n    // Mix final noise value\n    vec4 m = max( 0.6 - vec4( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ), dot( x3, x3 ) ), 0.0 );\n    vec4 m2 = m * m;\n    vec4 m4 = m2 * m2;\n    vec4 pdotx = vec4( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 ), dot( p3, x3 ) );\n\n    // Determine noise gradient\n    vec4 temp = m2 * m * pdotx;\n    gradient = - 8.0 * ( temp.x * x0 + temp.y * x1 + temp.z * x2 + temp.w * x3 );\n    gradient += m4.x * p0 + m4.y * p1 + m4.z * p2 + m4.w * p3;\n    gradient *= 42.0;\n\n    return 42.0 * dot( m4, pdotx );\n\n}\n",noise_simplex_3D:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nfloat simplex( vec3 v ) {\n\n    const vec2 C = vec2( 1.0 / 6.0, 1.0 / 3.0 );\n    const vec4 D = vec4( 0.0, 0.5, 1.0, 2.0 );\n\n    // First corner\n    vec3 i  = floor( v + dot( v, C.yyy ) );\n    vec3 x0 = v - i + dot( i, C.xxx );\n\n    // Other corners\n    vec3 g = step( x0.yzx, x0.xyz );\n    vec3 l = 1.0 - g;\n    vec3 i1 = min( g.xyz, l.zxy );\n    vec3 i2 = max( g.xyz, l.zxy );\n\n    vec3 x1 = x0 - i1 + C.xxx;\n    vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y\n    vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y\n\n    // Permutations\n    i = mod289( i );\n    vec4 p = permute( permute( permute(\n                i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n            + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))\n            + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n    // Gradients: 7x7 points over a square, mapped onto an octahedron.\n    // The ring size 17*17 = 289 is close to a multiple of 49 (49*6 = 294)\n    float n_ = 0.142857142857; // 1.0/7.0\n    vec3 ns = n_ * D.wyz - D.xzx;\n\n    vec4 j = p - 49.0 * floor( p * ns.z * ns.z );  //  mod(p,7*7)\n\n    vec4 x_ = floor(j * ns.z);\n    vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n    vec4 x = x_ *ns.x + ns.yyyy;\n    vec4 y = y_ *ns.x + ns.yyyy;\n    vec4 h = 1.0 - abs( x ) - abs( y );\n\n    vec4 b0 = vec4( x.xy, y.xy );\n    vec4 b1 = vec4( x.zw, y.zw );\n\n    vec4 s0 = floor( b0 ) * 2.0 + 1.0;\n    vec4 s1 = floor( b1 ) * 2.0 + 1.0;\n    vec4 sh = - step( h, vec4( 0.0 ) );\n\n    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy ;\n    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww ;\n\n    vec3 p0 = vec3( a0.xy, h.x );\n    vec3 p1 = vec3( a0.zw, h.y );\n    vec3 p2 = vec3( a1.xy, h.z );\n    vec3 p3 = vec3( a1.zw, h.w );\n\n    //Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n\n    // Mix final noise value\n    vec4 m = max( 0.6 - vec4( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ), dot( x3, x3 ) ), 0.0 );\n    m = m * m;\n    return 42.0 * dot( m*m, vec4( dot( p0, x0 ), dot( p1, x1 ),\n                                dot( p2, x2 ), dot( p3, x3 ) ) );\n\n}\n",noise_simplex_4D:"//\n// Description : Array and textureless GLSL 2D/3D/4D simplex\n//               noise functions.\n//      Author : Ian McEwan, Ashima Arts.\n//  Maintainer : stegu\n//     Lastmod : 20110822 (ijm)\n//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.\n//               Distributed under the MIT License. See LICENSE file.\n//               https://github.com/ashima/webgl-noise\n//               https://github.com/stegu/webgl-noise\n//\n\nvec4 grad4( float j, vec4 ip ) {\n\n    const vec4 ones = vec4( 1.0, 1.0, 1.0, -1.0 );\n    vec4 p, s;\n\n    p.xyz = floor( fract( vec3( j ) * ip.xyz ) * 7.0 ) * ip.z - 1.0;\n    p.w = 1.5 - dot( abs( p.xyz ), ones.xyz );\n    s = vec4( lessThan( p, vec4( 0.0 ) ) );\n    p.xyz = p.xyz + ( s.xyz * 2.0 - 1.0 ) * s.www;\n\n    return p;\n\n}\n\n// (sqrt(5) - 1)/4 = F4, used once below\n#define F4 0.309016994374947451\n\nfloat simplex(vec4 v) {\n\n    const vec4 C = vec4( 0.138196601125011,  // (5 - sqrt(5))/20  G4\n                        0.276393202250021,  // 2 * G4\n                        0.414589803375032,  // 3 * G4\n                        -0.447213595499958); // -1 + 4 * G4\n\n    // First corner\n    vec4 i  = floor( v + dot( v, vec4( F4 ) ) );\n    vec4 x0 = v - i + dot( i, C.xxxx );\n\n    // Other corners\n\n    // Rank sorting originally contributed by Bill Licea-Kane, AMD (formerly ATI)\n    vec4 i0;\n    vec3 isX = step( x0.yzw, x0.xxx );\n    vec3 isYZ = step( x0.zww, x0.yyz );\n    i0.x = isX.x + isX.y + isX.z;\n    i0.yzw = 1.0 - isX;\n    i0.y += isYZ.x + isYZ.y;\n    i0.zw += 1.0 - isYZ.xy;\n    i0.z += isYZ.z;\n    i0.w += 1.0 - isYZ.z;\n\n    vec4 i3 = clamp( i0, 0.0, 1.0 );\n    vec4 i2 = clamp( i0 - 1.0, 0.0, 1.0 );\n    vec4 i1 = clamp( i0 - 2.0, 0.0, 1.0 );\n\n    vec4 x1 = x0 - i1 + C.xxxx;\n    vec4 x2 = x0 - i2 + C.yyyy;\n    vec4 x3 = x0 - i3 + C.zzzz;\n    vec4 x4 = x0 + C.wwww;\n\n    // Permutations\n    i = mod289( i );\n    float j0 = permute( permute( permute( permute( i.w ) + i.z ) + i.y ) + i.x );\n    vec4 j1 = permute( permute( permute( permute (\n                i.w + vec4(i1.w, i2.w, i3.w, 1.0 ))\n            + i.z + vec4(i1.z, i2.z, i3.z, 1.0 ))\n            + i.y + vec4(i1.y, i2.y, i3.y, 1.0 ))\n            + i.x + vec4(i1.x, i2.x, i3.x, 1.0 ));\n\n    // Gradients: 7x7x6 points over a cube, mapped onto a 4-cross polytope\n    // 7*7*6 = 294, which is close to the ring size 17*17 = 289.\n    vec4 ip = vec4( 1.0 / 294.0, 1.0 / 49.0, 1.0 / 7.0, 0.0 );\n\n    vec4 p0 = grad4(j0,   ip);\n    vec4 p1 = grad4(j1.x, ip);\n    vec4 p2 = grad4(j1.y, ip);\n    vec4 p3 = grad4(j1.z, ip);\n    vec4 p4 = grad4(j1.w, ip);\n\n    // Normalise gradients\n    vec4 norm = taylorInvSqrt( vec4( dot( p0, p0 ), dot( p1, p1 ), dot( p2, p2 ), dot( p3, p3 ) ) );\n    p0 *= norm.x;\n    p1 *= norm.y;\n    p2 *= norm.z;\n    p3 *= norm.w;\n    p4 *= taylorInvSqrt( dot( p4, p4 ) );\n\n    // Mix contributions from the five corners\n    vec3 m0 = max( 0.6 - vec3( dot( x0, x0 ), dot( x1, x1 ), dot( x2, x2 ) ), 0.0 );\n    vec2 m1 = max( 0.6 - vec2( dot( x3, x3 ), dot( x4, x4 ) ), 0.0 );\n    m0 = m0 * m0;\n    m1 = m1 * m1;\n    return 49.0 * ( dot(m0*m0, vec3( dot( p0, x0 ), dot( p1, x1 ), dot( p2, x2 )))\n                + dot(m1*m1, vec2( dot( p3, x3 ), dot( p4, x4 ) ) ) ) ;\n\n}\n",noise_simplex:"#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n",perturbation_share:"#ifdef HAS_PERTURBATIONMAP\n  uniform sampler2D u_perturbationSampler;\n  uniform float u_perturbationUOffset;\n  uniform float u_perturbationVOffset;\n#endif\n",perturbation_frag:"#ifdef HAS_PERTURBATIONMAP\n  vec2 getScreenUv(){\n    return gl_FragCoord.xy / u_resolution;\n  }\n\n  vec4 screenColor = texture2D(u_perturbationSampler, getScreenUv() + normalize(u_viewMat * vec4(normal, 1.)).xy * vec2(u_perturbationUOffset, u_perturbationVOffset));\n  gl_FragColor = mix(screenColor, gl_FragColor, gl_FragColor.a);\n\n#endif\n",refraction_share:"#ifdef HAS_REFRACTIONMAP\n\n    uniform sampler2D u_refractionSampler;\n    uniform mat4 u_PTMMatrix;\n    uniform float u_refractionDepth;\n\n#endif\n",refraction_frag:"#ifdef HAS_REFRACTIONMAP\n  vec4 refractionColor = vec4(0.);\n  vec3 refractDir = normalize(refract(-geometry.viewDir, geometry.normal, u_refractionRatio));\n  vec3 newPos = v_pos + refractDir * u_refractionDepth;\n  vec4 projectionPos = u_PTMMatrix * u_projMat * u_viewMat * vec4(newPos, 1.0);\n  vec2 projectionUv = projectionPos.xy / projectionPos.w;\n  refractionColor = texture2D(u_refractionSampler, projectionUv);\n  gl_FragColor = mix(refractionColor, gl_FragColor, gl_FragColor.a);\n\n#endif\n",clipPlane_vert_define:"#ifdef O3_CLIPPLANE_NUM\n    uniform vec4 u_clipPlanes[O3_CLIPPLANE_NUM];\n    varying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_vert:"#ifdef O3_CLIPPLANE_NUM\n    for(int i = 0; i < O3_CLIPPLANE_NUM; i++){\n        v_clipDistances[i] = dot(vec4(v_pos,1.0), u_clipPlanes[i]);\n    }\n#endif\n",clipPlane_frag_define:"#ifdef O3_CLIPPLANE_NUM\n    varying float v_clipDistances[O3_CLIPPLANE_NUM];\n#endif\n",clipPlane_frag:"#ifdef O3_CLIPPLANE_NUM\n    for(int i = 0; i < O3_CLIPPLANE_NUM; i++){\n        if(v_clipDistances[i] < 0.0){\n            discard;\n        }\n    }\n#endif\n",gamma_frag:"#ifdef GAMMA\n    float gamma = 2.2;\n    gl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(1.0 / gamma));\n#endif\n",oit_frag:"#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\n    if(gl_FragCoord.z > texture2D(u_depthSampler, gl_FragCoord.xy / u_resolution).r){\n        discard;\n    }\n    vec4 oitColor = gl_FragColor;\n\n    // Bavoil and Myers’ Method\n    gl_FragData[0]= vec4(oitColor.rgb * oitColor.a, oitColor.a);\n    gl_FragData[1]= vec4(1)/ 255.0; // 兼容非浮点输出\n\n\n    // Depth Weights Improve Occlusion\n//    float w = weight(gl_FragCoord.z, oitColor.a);\n//    gl_FragData[0] = vec4(oitColor.rgb * oitColor.a * w, oitColor.a);\n//    gl_FragData[1].r =oitColor.a * w;\n#endif\n",oit_frag_define:"#if defined(ALPHA_BLEND) && defined(OIT_ENABLE)\n\n    uniform sampler2D u_depthSampler;\n\n    float weight(float z, float a) {\n        return a * clamp(3e3 * pow(1.0 - z, 3.0), 1e-2, 3e3);\n//          return pow(z,-5.0);\n    }\n#endif\n"},{pbr_common_frag_define:"#ifndef EPSILON\n#define EPSILON 1e-6\n#endif\n\n#ifndef RECIPROCAL_PI\n    #define RECIPROCAL_PI 0.31830988618\n#endif\n\n\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\n\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n",pbr_util_frag_define:"vec4 SRGBtoLINEAR(vec4 srgbIn)\n{\n    #ifdef MANUAL_SRGB\n\n        #ifdef SRGB_FAST_APPROXIMATION\n\n            vec3 linOut = pow(srgbIn.xyz, vec3(2.2));\n        #else\n\n         vec3 bLess = step(vec3(0.04045), srgbIn.xyz);\n         vec3 linOut = mix(srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055), vec3(2.4)), bLess);\n\n        #endif\n\n    return vec4(linOut, srgbIn.w);;\n\n    #else\n\n    return srgbIn;\n\n    #endif\n}\n\nfloat pow2( const in float x ) {\n    return x * x;\n}\n\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n    return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\n\n// todo: enhance\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\n    if( decayExponent > 0.0 ) {\n\n        #if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\n        // based upon Frostbite 3 Moving to Physically-based Rendering\n        // page 32, equation 26: E[window1]\n        // https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\n        // this is intended to be used on spot and point lights who are represented as luminous intensity\n        // but who must be converted to luminous irradiance for surface lighting calculation\n        float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n        float maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n        return distanceFalloff * maxDistanceCutoffFactor;\n\n        #else\n\n        return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\n        #endif\n\n    }\n\n    return 1.0;\n\n}\n\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\n\treturn RECIPROCAL_PI * diffuseColor;\n\n}\n\n// source: http://simonstechblog.blogspot.ca/2011/12/microfacet-brdf.html\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n    return ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\n\n\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\n    return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n\n}\n\n// 亮度值\nfloat getLuminance(vec3 color)\n{\n    return dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\n",pbr_envmap_light_frag_define:"#ifdef O3_HAS_ENVMAP_LIGHT\n\nstruct EnvMapLight {\n    vec3 diffuse;\n    vec3 specular;\n    float mipMapLevel;\n    float diffuseIntensity;\n    float specularIntensity;\n    mat3 transformMatrix;\n};\n\n\nuniform EnvMapLight u_envMapLight;\n\n#ifdef O3_USE_DIFFUSE_ENV\n    uniform samplerCube u_env_diffuseSampler;\n#endif\n\n#ifdef O3_USE_SPECULAR_ENV\n    uniform samplerCube u_env_specularSampler;\n#endif\n\n#endif\n",pbr_base_frag_define:"#ifdef ALPHA_MASK\nuniform float u_alphaCutoff;\n#endif\n\nuniform vec4 u_baseColorFactor;\nuniform vec2 u_metallicRoughnessValue;\nuniform vec3 u_specularFactor;\nuniform float u_glossinessFactor;\n\nuniform float u_envMapIntensity;\nuniform float u_refractionRatio;\n\nuniform vec2 u_resolution;\n\n// todo: delete\nuniform float u_normalScale;\nuniform float u_occlusionStrength;\n\n",pbr_texture_frag_define:"#ifdef HAS_BASECOLORMAP\n\nuniform sampler2D u_baseColorSampler;\n\n#endif\n\n#ifdef O3_HAS_NORMALMAP\n\nuniform sampler2D u_normalSampler;\n\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n\nuniform sampler2D u_emissiveSampler;\nuniform vec3 u_emissiveFactor;\n\n#endif\n\n#ifdef HAS_METALMAP\n\nuniform sampler2D u_metallicSampler;\n\n#endif\n\n#ifdef HAS_ROUGHNESSMAP\n\nuniform sampler2D u_roughnessSampler;\n\n#endif\n\n#ifdef HAS_METALROUGHNESSMAP\n\nuniform sampler2D u_metallicRoughnessSampler;\n\n#endif\n\n\n#ifdef HAS_SPECULARGLOSSINESSMAP\n\nuniform sampler2D u_specularGlossinessSampler;\n\n#endif\n\n#ifdef HAS_OCCLUSIONMAP\n\nuniform sampler2D u_occlusionSampler;\n\n#endif\n\n#ifdef HAS_OPACITYMAP\n\nuniform sampler2D u_opacitySampler;\n\n#endif\n\n#ifdef HAS_REFLECTIONMAP\n\nuniform samplerCube u_reflectionSampler;\n\n#endif\n",pbr_runtime_frag_define:"struct IncidentLight {\n    vec3 color;\n    vec3 direction;\n    bool visible;\n};\nstruct ReflectedLight {\n    vec3 directDiffuse;\n    vec3 directSpecular;\n    vec3 indirectDiffuse;\n    vec3 indirectSpecular;\n};\nstruct GeometricContext {\n    vec3 position;\n    vec3 normal;\n    vec3 viewDir;\n};\nstruct PhysicalMaterial {\n    vec3    diffuseColor;\n    float   specularRoughness;\n    vec3    specularColor;\n};\n",pbr_normal_frag_define:"vec3 getNormal()\n{\n  #ifdef O3_HAS_NORMALMAP\n    #ifndef O3_HAS_TANGENT\n        #ifdef HAS_DERIVATIVES\n            vec3 pos_dx = dFdx(v_pos);\n            vec3 pos_dy = dFdy(v_pos);\n            vec3 tex_dx = dFdx(vec3(v_uv, 0.0));\n            vec3 tex_dy = dFdy(vec3(v_uv, 0.0));\n            vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);\n            #ifdef O3_HAS_NORMAL\n                vec3 ng = normalize(v_normal);\n            #else\n                vec3 ng = normalize( cross(pos_dx, pos_dy) );\n            #endif\n            t = normalize(t - ng * dot(ng, t));\n            vec3 b = normalize(cross(ng, t));\n            mat3 tbn = mat3(t, b, ng);\n        #else\n            #ifdef O3_HAS_NORMAL\n                vec3 ng = normalize(v_normal);\n            #else\n                vec3 ng = vec3(0.0, 0.0, 1.0);\n            #endif\n            mat3 tbn = mat3(vec3(0.0), vec3(0.0), ng);\n        #endif\n    #else\n        mat3 tbn = v_TBN;\n    #endif\n        vec3 n = texture2D(u_normalSampler, v_uv ).rgb;\n        n = normalize(tbn * ((2.0 * n - 1.0) * vec3(u_normalScale, u_normalScale, 1.0)));\n  #else\n    #ifdef O3_HAS_NORMAL\n        vec3 n = normalize(v_normal);\n    #elif defined(HAS_DERIVATIVES)\n        vec3 pos_dx = dFdx(v_pos);\n        vec3 pos_dy = dFdy(v_pos);\n        vec3 n = normalize( cross(pos_dx, pos_dy) );\n    #else\n        vec3 n= vec3(0.0,0.0,1.0);\n    #endif\n  #endif\n\n  n *= float( gl_FrontFacing ) * 2.0 - 1.0;\n\n  return n;\n}\n",pbr_brdf_cook_torrance_frag_define:"vec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\n\t// Original approximation by Christophe Schlick '94\n\t// float fresnel = pow( 1.0 - dotLH, 5.0 );\n\n\t// Optimized variant (presented by Epic at SIGGRAPH '13)\n\t// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n\n} // validated\n\n// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2\n// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\n\tfloat a2 = pow2( alpha );\n\n\t// dotNL and dotNV are explicitly swapped. This is not a mistake.\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\n\treturn 0.5 / max( gv + gl, EPSILON );\n\n}\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is \"roughness squared\" in Disney’s reparameterization\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\n\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n\n}\n\n// GGX Distribution, Schlick Fresnel, GGX-Smith Visibility\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n\tfloat alpha = pow2( roughness ); // UE4's roughness\n\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\n\tfloat D = D_GGX( alpha, dotNH );\n\n\treturn F * ( G * D );\n\n} // validated\n",pbr_direct_irradiance_frag_define:"void RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    float dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\n    vec3 irradiance = dotNL * directLight.color;\n\n    #ifndef PHYSICALLY_CORRECT_LIGHTS\n\n        irradiance *= PI; // punctual light\n\n    #endif\n\n\n\n    reflectedLight.directSpecular += irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\n    reflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n}\n\n\n\n#ifdef O3_DIRECT_LIGHT_COUNT\n\n    void getDirectionalDirectLightIrradiance( const in DirectLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n        directLight.color = directionalLight.lightColor;\n        directLight.direction = -directionalLight.direction;\n        directLight.visible = true;\n    }\n\n#endif\n\n#ifdef O3_POINT_LIGHT_COUNT\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\n\t\tdirectLight.color = pointLight.lightColor;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\n\t}\n\n#endif\n\n#ifdef O3_SPOT_LIGHT_COUNT\n\n\t// directLight is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\n\t\tif ( angleCos > spotLight.coneCos ) {\n\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\n\t\t\tdirectLight.color = spotLight.lightColor;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\n\t\t} else {\n\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\n\t\t}\n\t}\n\n\n#endif\n",pbr_ibl_specular_frag_define:"// ref: https://www.unrealengine.com/blog/physically-based-shading-on-mobile - environmentBRDF for GGX on mobile\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\n    float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n    const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\n    const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\n    vec4 r = roughness * c0 + c1;\n\n    float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\n    vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\n    return specularColor * AB.x + AB.y;\n\n} // validated\n\n\n// taken from here: http://casual-effects.blogspot.ca/2011/08/plausible-environment-lighting-in-two.html\nfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n    //float envMapWidth = pow( 2.0, maxMIPLevelScalar );\n    //float desiredMIPLevel = log2( envMapWidth * sqrt( 3.0 ) ) - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n    float maxMIPLevelScalar = float( maxMIPLevel );\n    float desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\n    // clamp to allowable LOD ranges.\n    return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\n}\n\n#ifdef O3_HAS_ENVMAP_LIGHT\n\nvec3 getLightProbeIndirectRadiance( /*const in SpecularLightProbe specularLightProbe,*/ const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\n    #if !defined(O3_USE_SPECULAR_ENV) && !defined(HAS_REFLECTIONMAP)\n\n        return u_envMapLight.specular * u_envMapLight.specularIntensity * u_envMapIntensity;\n\n    #else\n\n    #ifdef ENVMAPMODE_REFRACT\n\n        vec3 reflectVec = refract( -geometry.viewDir, geometry.normal, u_refractionRatio );\n\n    #else\n\n        vec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\n    #endif\n//        reflectVec = inverseTransformDirection( reflectVec, u_viewMat );\n\n        reflectVec =  u_envMapLight.transformMatrix * reflectVec;\n\n        float specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\n        #ifdef HAS_TEX_LOD\n            #ifdef HAS_REFLECTIONMAP\n                 vec4 envMapColor = textureCubeLodEXT( u_reflectionSampler, reflectVec, specularMIPLevel );\n            #else\n                vec4 envMapColor = textureCubeLodEXT( u_env_specularSampler, reflectVec, specularMIPLevel );\n            #endif\n\n        #else\n            #ifdef HAS_REFLECTIONMAP\n                 vec4 envMapColor = textureCube( u_reflectionSampler, reflectVec, specularMIPLevel );\n            #else\n                 vec4 envMapColor = textureCube( u_env_specularSampler, reflectVec, specularMIPLevel );\n            #endif\n        #endif\n\n        envMapColor.rgb = SRGBtoLINEAR( envMapColor * u_envMapLight.specularIntensity * u_envMapIntensity).rgb;\n\n        return envMapColor.rgb;\n\n    #endif\n\n}\n#endif\n\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n    float dotNL = dotNV;\n\n\treflectedLight.indirectSpecular += radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\n}\n",pbr_ibl_diffuse_frag_define:"void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\n}\n\n#ifdef O3_HAS_AMBIENT_LIGHT\n\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\n    vec3 irradiance = ambientLightColor;\n\n    #ifndef PHYSICALLY_CORRECT_LIGHTS\n\n        irradiance *= PI;\n\n    #endif\n\n    return irradiance;\n\n}\n\n#endif\n",pbr_begin_frag:"    vec3 normal = getNormal();\n    vec4 diffuseColor = u_baseColorFactor;\n    vec3 totalEmissiveRadiance = vec3(0.0);\n    float metalnessFactor = u_metallicRoughnessValue.r;\n    float roughnessFactor = u_metallicRoughnessValue.g;\n    vec3 specularFactor = u_specularFactor;\n    float glossinessFactor = u_glossinessFactor;\n\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    PhysicalMaterial material;\n    GeometricContext geometry;\n    IncidentLight directLight;\n\n    #ifdef HAS_BASECOLORMAP\n\n        vec4 baseMapColor = texture2D( u_baseColorSampler, v_uv );\n        baseMapColor = SRGBtoLINEAR( baseMapColor );\n        diffuseColor *= baseMapColor;\n\n    #endif\n\n    #ifdef O3_HAS_VERTEXCOLOR\n\n        diffuseColor.rgb *= v_color.rgb;\n\n        #ifdef O3_HAS_VERTEXALPHA\n\n            diffuseColor.a *= v_color.a;\n\n        #endif\n\n    #endif\n\n    #ifdef ALPHA_MASK\n\n        if( diffuseColor.a < u_alphaCutoff ) {\n            discard;\n        }\n\n    #endif\n\n\n    #if defined(ALPHA_BLEND) && defined(HAS_OPACITYMAP)\n\n        #ifdef GETOPACITYFROMRGB\n            diffuseColor.a *= getLuminance(texture2D( u_opacitySampler, v_opacityTexture ).rgb);\n        #else\n            diffuseColor.a *= texture2D( u_opacitySampler, v_opacityTexture ).a;\n        #endif\n\n    #endif\n\n    #ifdef UNLIT\n\n        gl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n    #else\n\n\n\n        #ifdef HAS_METALROUGHNESSMAP\n\n            vec4 metalRoughMapColor = texture2D( u_metallicRoughnessSampler, v_uv );\n            metalnessFactor *= metalRoughMapColor.b;\n            roughnessFactor *= metalRoughMapColor.g;\n\n        #else\n            #ifdef HAS_METALMAP\n\n            vec4 metalMapColor = texture2D( u_metallicSampler, v_uv );\n            metalnessFactor *= metalMapColor.b;\n\n            #endif\n\n            #ifdef HAS_ROUGHNESSMAP\n\n            vec4 roughMapColor = texture2D( u_roughnessSampler, v_uv );\n            roughnessFactor *= roughMapColor.g;\n\n            #endif\n        #endif\n\n        #ifdef HAS_SPECULARGLOSSINESSMAP\n\n            vec4 specularGlossinessColor = texture2D(u_specularGlossinessSampler, v_uv );\n            specularFactor *= specularGlossinessColor.rgb;\n            glossinessFactor *= specularGlossinessColor.a;\n\n        #endif\n\n\n        #ifdef IS_METALLIC_WORKFLOW\n            material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\n            material.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n//          material.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n            material.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT /* pow2( reflectivity )*/ ), diffuseColor.rgb, metalnessFactor );\n        #else\n            float specularStrength = max( max( specularFactor.r, specularFactor.g ), specularFactor.b );\n            material.diffuseColor = diffuseColor.rgb * ( 1.0 - specularStrength );\n            material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );\n            material.specularColor = specularFactor;\n        #endif\n\n        geometry.position = v_pos;\n        geometry.normal = normal;\n        geometry.viewDir = normalize( u_cameraPos - v_pos );\n",pbr_direct_irradiance_frag:"        #if defined( O3_DIRECT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            DirectLight directionalLight;\n\n            for ( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i ++ ) {\n\n                directionalLight = u_directLights[ i ];\n\n                getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n\n        #if defined( O3_POINT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            PointLight pointLight;\n\n            for ( int i = 0; i < O3_POINT_LIGHT_COUNT; i ++ ) {\n\n                pointLight = u_pointLights[ i ];\n\n                getPointDirectLightIrradiance( pointLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n\n        #if defined( O3_SPOT_LIGHT_COUNT ) && defined( RE_Direct )\n\n            SpotLight spotLight;\n\n            for ( int i = 0; i < O3_SPOT_LIGHT_COUNT; i ++ ) {\n\n                spotLight = u_spotLights[ i ];\n\n                getSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\n                RE_Direct( directLight, geometry, material, reflectedLight );\n\n            }\n\n        #endif\n",pbr_ibl_diffuse_frag:"#if defined(RE_IndirectDiffuse)\n\n    vec3 irradiance = vec3(0);\n\n    #if defined(O3_HAS_AMBIENT_LIGHT)\n        irradiance += getAmbientLightIrradiance(u_ambientLight.lightColor);\n    #endif\n\n    #if defined(O3_HAS_ENVMAP_LIGHT)\n\n        #ifdef O3_USE_DIFFUSE_ENV\n            vec3 lightMapIrradiance = textureCube(u_env_diffuseSampler, geometry.normal).rgb * u_envMapLight.diffuseIntensity;\n        #else\n            vec3 lightMapIrradiance = u_envMapLight.diffuse * u_envMapLight.diffuseIntensity;\n        #endif\n\n        #ifndef PHYSICALLY_CORRECT_LIGHTS\n            lightMapIrradiance *= PI;\n        #endif\n\n        irradiance += lightMapIrradiance;\n\n    #endif\n\n    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n\n#endif\n\n\n",pbr_ibl_specular_frag:"#if defined( RE_IndirectSpecular )\n\n    vec3 radiance = vec3( 0.0 );\n\n#endif\n\n\n\n#if defined( O3_HAS_ENVMAP_LIGHT ) && defined( RE_IndirectSpecular )\n\n    radiance += getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), int(u_envMapLight.mipMapLevel) );\n\n#endif\n\n\n#if defined( RE_IndirectSpecular )\n\n    RE_IndirectSpecular( radiance, geometry, material, reflectedLight );\n\n#endif\n",pbr_end_frag:"#ifdef HAS_OCCLUSIONMAP\n\n    float ambientOcclusion = (texture2D(u_occlusionSampler, v_uv).r - 1.0) * u_occlusionStrength + 1.0;\n    reflectedLight.indirectDiffuse *= ambientOcclusion;\n\n    #if defined(O3_USE_SPECULAR_ENV)\n\n        float dotNV = saturate(dot(geometry.normal, geometry.viewDir));\n        reflectedLight.indirectSpecular *= computeSpecularOcclusion(dotNV, ambientOcclusion, material.specularRoughness);\n\n    #endif\n\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n\n    vec4 emissiveMapColor = texture2D(u_emissiveSampler, v_uv);\n    emissiveMapColor = SRGBtoLINEAR(emissiveMapColor);\n    totalEmissiveRadiance += u_emissiveFactor * emissiveMapColor.rgb;\n\n#endif\n\nvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\ngl_FragColor = vec4(outgoingLight, diffuseColor.a);\n\n#endif\n"});var Kn,Yn,Qn=function(){function e(){}return e.parseVersion=function(e){return void 0===e&&(e="100"),"#version "+e+"\n"},e.parsePrecision=function(e,t,n){return"\n        #ifdef GL_FRAGMENT_PRECISION_HIGH\n          precision "+(n?e:t)+" float;\n          precision "+(n?e:t)+" int;\n\n          #define O3_VERTEX_PRECISION "+e+"\n          #define O3_FRAGMENT_PRECISION "+t+"\n        #else\n          precision mediump float;\n          precision mediump int;\n\n          #define O3_VERTEX_PRECISION mediump\n          #define O3_FRAGMENT_PRECISION mediump\n        #endif\n      "},e.parseShaderName=function(e){return"#define O3_SHADER_NAME "+e+"\n"},e.parseAttributeMacros=function(e){return"#define O3_ATTRIBUTE_MACROS_START\n"+e.map((function(e){return"#define "+e+"\n"})).join("")+"#define O3_ATTRIBUTE_MACROS_END\n"},e.parseCustomMacros=function(e){return"#define O3_CUSTOM_MACROS_START\n"+e.map((function(e){return"#define "+e+"\n"})).join("")+"#define O3_CUSTOM_MACROS_END\n"},e.parseShader=function(t){return e.parseIncludes(t)},e.parseIncludes=function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,n){var i=qn[n];return void 0===i?(Fe('Shader slice "'+t.trim()+'" not founded.'),""):e.parseIncludes(i)}))},e.InjectShaderSlices=function(e){var t;t=e,Object.assign(qn,t)},e.parseExtension=function(e){return"#define O3_EXTENSION_START\n"+e.map((function(e){return"#extension "+e+" : enable\n"})).join("")+"#define O3_EXTENSION_END\n"},e.convertTo300=function(e,t){if(e.includes("#version 300 es"))return e;if(e=(e=(e=(e=(e=e.replace(/#version 100/,"#version 300 es")).replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\s*\(/g,"texture(")).replace(/\btexture(2D|Cube)LodEXT\s*\(/g,"textureLod("),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var n=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this.replaceMRTShader(e,n)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e},e.getMaxDrawBuffers=function(e){for(var t=new Set,n=e.match(/\bgl_FragData\[.+?\]/g)||[],i=0;i<n.length;i++){var r=n[i].match(/\bgl_FragData\[(.+?)\]/);t.add(r[1])}return t.size},e.compatible=function(e){return/\bgl_FragData\[.+?\]/g.test(e)&&(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")),e},e.replaceMRTShader=function(e,t){for(var n="",i=new Set,r=0;r<t.length;r++){var a=t[r].match(/\bgl_FragData\[(.+?)\]/);i.add(a[1])}return i.forEach((function(e){n+="layout(location="+e+") out vec4 fragOutColor"+e+";\n"})),n+="void main(",e=(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,n)},e}(),Zn=function(e){function t(n){var i;return(i=e.call(this,null)||this).name=n,i.isValid=!1,i._uniforms=t.commonUniforms,i._attributes=t.commonAttributes,i.states=null,i.vertexShader="",i.fragmentShader="",i.version="100",i.autoConvert=!0,i.vertexPrecision="highp",i.fragmentPrecision="mediump",i.customMacros=[],i.shaderExtension100=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"],i.shaderExtension300=[],i._needCompile=!0,i}A(t,e);var n=t.prototype;return n.compile=function(e,t,n,i){if(this.parseFog(e),this._needCompile){var r=e.engine._hardwareRenderer,a=null==r?void 0:r.isWebGL2;null==i.preCompile||i.preCompile(this);var o=this.getAttributeDefines(e,t,n,i);if(this._recreateHeader&&(this.attributes=this.attributes,this.uniforms=this.uniforms),this._vsHeader&&!this._recreateHeader||(this._vsHeader=Qn.parseVersion(this.version)+Qn.parseShaderName((this.name||"VOID").toUpperCase()+"_VERT")+"\n"+Qn.parsePrecision(this.vertexPrecision,this.fragmentPrecision,!0)+"\n"+Qn.parseAttributeMacros(o)+"\n"+Qn.parseCustomMacros(this.customMacros)+"\n"),this._vsCode||(this._vsCode=Qn.parseShader(this.vertexShader)),this.vertexShader=this._vsHeader+this._vsCode,this._fsHeader&&!this._recreateHeader||(this._fsHeader=Qn.parseVersion(this.version)+Qn.parseShaderName((this.name||"VOID").toUpperCase()+"_FRAG")+"\n"+Qn.parseExtension(a?this.shaderExtension300:this.shaderExtension100)+Qn.parsePrecision(this.vertexPrecision,this.fragmentPrecision)+"\n"+Qn.parseAttributeMacros(o)+"\n"+Qn.parseCustomMacros(this.customMacros)+"\n"),this._fsCode||(this._fsCode=Qn.parseShader(this.fragmentShader)),this.fragmentShader=this._fsHeader+this._fsCode,this.autoConvert&&a&&"300 es"!==this.version){var s=r.capability.maxDrawBuffers;Qn.getMaxDrawBuffers(this.fragmentShader)<=s&&(this.vertexShader=Qn.convertTo300(this.vertexShader),this.fragmentShader=Qn.convertTo300(this.fragmentShader,!0))}else a||"300es"===this.version||(this.fragmentShader=Qn.compatible(this.fragmentShader));this._needCompile=!1,this._recreateHeader=!1,null==i.postCompile||i.postCompile(this)}},n.getAttributeDefines=function(e,t,n,i){var r=e.scene.engine._hardwareRenderer,a=r.gl,o=[];if(!n)return o;var s,u=Object.keys(n._vertexElementMap);if((u.indexOf("TEXCOORD_0")>-1&&o.push("O3_HAS_UV"),u.indexOf("NORMAL")>-1&&o.push("O3_HAS_NORMAL"),u.indexOf("TANGENT")>-1&&o.push("O3_HAS_TANGENT"),u.indexOf("JOINTS_0")>-1)&&(o.push("O3_HAS_SKIN"),null!=(s=t.jointNodes)&&s.length)){var c=r.renderStates.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),l=Math.floor((c-20)/4),f=t.jointNodes.length;f>l?r.canIUseMoreJoints?o.push("O3_USE_JOINT_TEXTURE"):Fe("component's joints count("+f+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+c+", suggest joint count less than "+l+".",t):i.maxJointsNum>0&&o.push("O3_JOINTS_NUM "+i.maxJointsNum)}u.indexOf("COLOR_0")>-1&&(o.push("O3_HAS_VERTEXCOLOR"),n._vertexElementMap.COLOR_0.format===Sn.Vector4&&o.push("O3_HAS_VERTEXALPHA"));var h=e.scene;return h.hasFogFeature&&o.push.apply(o,h.getFogMacro()),o},n.parseFog=function(e){var t=e.scene;if(t.hasFogFeature){var n=t.getFogMacro();this._fogMacro!==n&&(this._needCompile=!0,this._recreateHeader=!0,this._fogMacro=n)}},n.createMorphConfig=function(e,t){for(var n=Object.keys(e._vertexElementMap),i={},r=0;r<t;r++)n.indexOf("POSITION_"+r)>-1&&(i["a_position"+r]={name:"a_position"+r,semantic:"POSITION_"+r,type:_e.FLOAT_VEC3}),n.indexOf("NORMAL_"+r)>-1&&(i["a_normal"+r]={name:"a_normal"+r,semantic:"NORMAL_"+r,type:_e.FLOAT_VEC3}),n.indexOf("TANGENT_"+r)>-1&&(i["a_tangent"+r]={name:"a_tangent"+r,semantic:"TANGENT_"+r,type:_e.FLOAT_VEC3});return i},n._finalize=function(){this._glTechnique&&(this._glTechnique.finalize(!0),this._glTechnique=null)},E(t,[{key:"attributes",get:function(){return this._attributes},set:function(e){this._attributes=Object.assign({},t.commonAttributes,e)}},{key:"uniforms",get:function(){return this._uniforms},set:function(e){this._uniforms=Object.assign({},t.commonUniforms,e)}}]),t}(at);Zn.commonAttributes={a_position:{name:"a_position",semantic:"POSITION",type:_e.FLOAT_VEC3},a_uv:{name:"a_uv",semantic:"TEXCOORD_0",type:_e.FLOAT_VEC2},a_normal:{name:"a_noraml",semantic:"NORMAL",type:_e.FLOAT_VEC3},a_tangent:{name:"a_tangent",semantic:"TANGENT",type:_e.FLOAT_VEC4},a_color:{name:"a_color",semantic:"COLOR_0",type:_e.FLOAT_VEC4},a_joint:{name:"a_joint",semantic:"JOINTS_0",type:_e.FLOAT_VEC4},a_weight:{name:"a_weight",semantic:"WEIGHTS_0",type:_e.FLOAT_VEC4}},Zn.commonUniforms={u_localMat:{name:"u_localMat",semantic:me.LOCAL,type:_e.FLOAT_MAT4},u_modelMat:{name:"u_modelMat",semantic:me.MODEL,type:_e.FLOAT_MAT4},u_viewMat:{name:"u_viewMat",semantic:me.VIEW,type:_e.FLOAT_MAT4},u_projMat:{name:"u_projMat",semantic:me.PROJECTION,type:_e.FLOAT_MAT4},u_MVMat:{name:"u_MVMat",semantic:me.MODELVIEW,type:_e.FLOAT_MAT4},u_MVPMat:{name:"u_MVPMat",semantic:me.MODELVIEWPROJECTION,type:_e.FLOAT_MAT4},u_normalMat:{name:"u_normalMat",semantic:me.MODELINVERSETRANSPOSE,type:_e.FLOAT_MAT3},u_cameraPos:{name:"u_cameraPos",type:_e.FLOAT_VEC3,semantic:me.EYEPOS},u_time:{name:"u_time",type:_e.FLOAT,semantic:me.TIME},u_jointMatrix:{name:"u_jointMatrix",semantic:me.JOINTMATRIX,type:_e.FLOAT_MAT4_ARRAY},u_jointSampler:{name:"u_jointSampler",semantic:me.JOINTTEXTURE,type:_e.SAMPLER_2D},u_jointCount:{name:"u_jointCount",semantic:me.JOINTCOUNT,type:_e.FLOAT},u_fogColor:{name:"u_fogColor",type:_e.FLOAT_VEC3},u_fogDensity:{name:"u_fogDensity",type:_e.FLOAT},u_fogNear:{name:"u_fogNear",type:_e.FLOAT},u_fogFar:{name:"u_fogFar",type:_e.FLOAT}},(Yn=Kn||(Kn={}))[Yn.PositiveX=0]="PositiveX",Yn[Yn.NegativeX=1]="NegativeX",Yn[Yn.PositiveY=2]="PositiveY",Yn[Yn.NegativeY=3]="NegativeY",Yn[Yn.PositiveZ=4]="PositiveZ",Yn[Yn.NegativeZ=5]="NegativeZ";var Jn,$n,ei,ti,ni,ii,ri,ai,oi=function(e){function t(t,n,i,r){var a;void 0===i&&(i=cn.R8G8B8A8),void 0===r&&(r=!0),(a=e.call(this,t)||this)._compressedFaceFilled=[0,0,0,0,0,0];var o=t._hardwareRenderer,s=o.gl,u=o.isWebGL2;if(!xn._supportTextureFormat(i,o))throw new Error("Texture format is not supported:"+cn[i]);!r||u||xn._isPowerOf2(n)||(Ie("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),r=!1);var c=xn._getFormatDetail(i,s,u);return a._glTexture=s.createTexture(),a._formatDetail=c,a._rhi=o,a._target=s.TEXTURE_CUBE_MAP,a._mipmap=r,a._width=n,a._height=n,a._format=i,a._mipmapCount=a._getMipmapCount(),c.isCompressed&&!u||a._initMipmap(!0),a.filterMode=sn.Bilinear,a.wrapModeU=a.wrapModeV=fn.Clamp,a}A(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o){void 0===n&&(n=0);var s=this._rhi.gl,u=this._rhi.isWebGL2,c=this._formatDetail,l=c.internalFormat,f=c.baseFormat,h=c.dataType,d=c.isCompressed,_=Math.max(1,this._width>>n);if(i=i||0,r=r||0,a=a||_-i,o=o||_-r,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),d){var p=1<<n;u||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,l,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,l,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,f,h,t);this._unbind()},n.setImageSource=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=!1),void 0===r&&(r=!1);var s=this._rhi.gl,u=this._formatDetail,c=u.baseFormat,l=u.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+i),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+r),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,a||0,o||0,c,l,t),this._unbind()},n.getPixelBuffer=function(t,n,i,r,a,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,t,n,i,r,a,o)},E(t,[{key:"format",get:function(){return this._format}}]),t}(xn),si=function(e){function t(t,n,i,r,a,o){var s;void 0===r&&(r=vn.Depth),void 0===a&&(a=!1),void 0===o&&(o=!1),(s=e.call(this,t)||this)._isCube=!1,s._autoMipmap=!1;var u=t._hardwareRenderer,c=u.gl,l=u.isWebGL2;if(!xn._supportRenderBufferDepthFormat(r,u,!0))throw new Error("RenderBufferDepthFormat is not supported:"+vn[r]);if(o&&n!==i)throw new Error("The cube texture must have the same width and height");return!a||l||xn._isPowerOf2(n)&&xn._isPowerOf2(i)||(Ie("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),a=!1),s._glTexture=c.createTexture(),s._formatDetail=xn._getRenderBufferDepthFormatDetail(r,c,l),s._isCube=o,s._rhi=u,s._target=o?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D,s._mipmap=a,s._width=n,s._height=i,s._format=r,s._mipmapCount=s._getMipmapCount(),s._initMipmap(o),s.filterMode=sn.Bilinear,s.wrapModeU=s.wrapModeV=fn.Clamp,s}return A(t,e),E(t,[{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),t}(xn),ui=function(e){function t(t,n,i,r,a,o){var s;void 0===a&&(a=vn.Depth),void 0===o&&(o=1),(s=e.call(this,t)||this)._MSAAColorRenderBuffers=[];var u=t._hardwareRenderer,c=u.gl;if(!(a instanceof si||xn._supportRenderBufferDepthFormat(a,u,!1)))throw new Error("RenderBufferDepthFormat is not supported:"+vn[a]);if((null==r?void 0:r.length)>1&&!u.canIUse(Ce.drawBuffers))throw new Error("MRT is not supported");if(s._colorTextures=r?r instanceof Array?r.slice():[r]:[],s._colorTextures.some((function(e){return e.width!==n||e.height!==i})))throw new Error("RenderColorTexture's size must as same as RenderTarget");if(a instanceof si&&(a.width!==n||a.height!==i))throw new Error("RenderDepthTexture's size must as same as RenderTarget");if(s._colorTextures.length>1&&s._colorTextures.some((function(e){return e._isCube})))throw new Error("MRT+Cube+[,MSAA] is not supported");var l=u.capability.maxAntiAliasing;return o>l&&(Ie("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+l),o=l),s._rhi=u,s._width=n,s._height=i,s._frameBuffer=c.createFramebuffer(),s._antiAliasing=o,a instanceof si&&(s._depthTexture=a),s._bindMainFBO(a),o>1&&(s._MSAAFrameBuffer=c.createFramebuffer(),s._bindMSAAFBO(a)),s}A(t,e);var n=t.prototype;return n.getColorTexture=function(e){return void 0===e&&(e=0),this._colorTextures[e]},n.destroy=function(){var e=this._rhi.gl;e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._colorTextures.length;t++)this._colorTextures[t].destroy();for(var n=0;n<this._MSAAColorRenderBuffers.length;n++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[n]);this._depthTexture&&this._depthTexture.destroy(),this._frameBuffer=null,this._colorTextures.length=0,this._depthTexture=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},n._activeRenderTarget=function(){var e=this._rhi.gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)},n._setRenderTargetFace=function(e){var t=this._rhi.gl,n=this._colorTextures[0],i=this._depthTexture;t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer),null!=n&&n._isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n._glTexture,0),null!=i&&i._isCube&&t.framebufferTexture2D(t.FRAMEBUFFER,i._formatDetail.attachment,t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i._glTexture,0),this._activeRenderTarget()},n._blitRenderTarget=function(){var e=this._rhi.gl,t=e.COLOR_BUFFER_BIT|(this._depthTexture?e.DEPTH_BUFFER_BIT:0),n=this._colorTextures.length;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var i=0;i<n;i++){var r=e.COLOR_ATTACHMENT0+i;this._blitDrawBuffers[i]=r,e.readBuffer(r),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,this._width,this._height,0,0,this._width,this._height,t,e.NEAREST),this._blitDrawBuffers[i]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)},n._bindMainFBO=function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=this._colorTextures.length,r=new Array(i);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var a=0;a<i;a++){var o=this._colorTextures[a],s=t.COLOR_ATTACHMENT0+a;r[a]=s,o._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,o._glTexture,0)}if(i>1&&t.drawBuffers(r),this._oriDrawBuffers=r,null!==e)if(e instanceof si)e._isCube||t.framebufferTexture2D(t.FRAMEBUFFER,e._formatDetail.attachment,t.TEXTURE_2D,e._glTexture,0);else if(this._antiAliasing<=1){var u=xn._getRenderBufferDepthFormatDetail(e,t,n),c=u.internalFormat,l=u.attachment,f=t.createRenderbuffer();this._depthRenderBuffer=f,t.bindRenderbuffer(t.RENDERBUFFER,f),t.renderbufferStorage(t.RENDERBUFFER,c,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,l,t.RENDERBUFFER,f)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},n._bindMSAAFBO=function(e){var t=this._rhi.gl,n=this._rhi.isWebGL2,i=t.createRenderbuffer(),r=this._colorTextures.length;this._blitDrawBuffers=new Array(r),this._MSAADepthRenderBuffer=i,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var a=0;a<r;a++){var o=t.createRenderbuffer();this._MSAAColorRenderBuffers[a]=o,this._blitDrawBuffers[a]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,this._colorTextures[a]._formatDetail.internalFormat,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+a,t.RENDERBUFFER,o)}if(t.drawBuffers(this._oriDrawBuffers),null!==e){var s=e instanceof si?e._formatDetail:xn._getRenderBufferDepthFormatDetail(e,t,n),u=s.internalFormat,c=s.attachment;t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorageMultisample(t.RENDERBUFFER,this._antiAliasing,u,this._width,this._height),t.framebufferRenderbuffer(t.FRAMEBUFFER,c,t.RENDERBUFFER,i)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},n._checkFrameBuffer=function(){var e=this._rhi.gl,t=this._rhi.isWebGL2,n=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(n){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&n===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},E(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),t}(X),ci=function(e){function t(t,n,i,r,a,o){var s;void 0===r&&(r=pn.R8G8B8A8),void 0===a&&(a=!1),void 0===o&&(o=!1),(s=e.call(this,t)||this)._isCube=!1,s._autoMipmap=!1;var u=t._hardwareRenderer,c=u.gl,l=u.isWebGL2;if(!xn._supportRenderBufferColorFormat(r,u))throw new Error("RenderBufferColorFormat is not supported:"+pn[r]);if(o&&n!==i)throw new Error("The cube texture must have the same width and height");return!a||l||xn._isPowerOf2(n)&&xn._isPowerOf2(i)||(Ie("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),a=!1),s._glTexture=c.createTexture(),s._formatDetail=xn._getRenderBufferColorFormatDetail(r,c,l),s._isCube=o,s._rhi=u,s._target=o?c.TEXTURE_CUBE_MAP:c.TEXTURE_2D,s._mipmap=a,s._width=n,s._height=i,s._format=r,s._mipmapCount=s._getMipmapCount(),s._initMipmap(o),s.filterMode=sn.Bilinear,s.wrapModeU=s.wrapModeV=fn.Clamp,s}return A(t,e),t.prototype.getPixelBuffer=function(t,n,i,r,a,o){e.prototype._getPixelBuffer.call(this,t,n,i,r,a,o)},E(t,[{key:"format",get:function(){return this._format}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),t}(xn),li=function(e){function t(t){var n;return(n=e.call(this,t)||this)._worldSize=[],n._rotationAngle=0,n.renderMode="2D",n.tintColor=new v(1,1,1,1),n._worldSizeFactor=100,n.setTexture(void 0),n.setRect(void 0),n.setAnchor(void 0),n.setUvRect(),n.setWorldSize(),n._positionQuad={leftTop:new s,leftBottom:new s,rightTop:new s,rightBottom:new s},n}A(t,e);var n=t.prototype;return n.setTexture=function(e){e&&e.asset&&(e=e.asset),this._texture=e},n.setRect=function(e){var t,n,i,r;try{e&&JSON.parse(e)}catch(e){Ie("Rect is not valid JSON format")}this._rect=e||{x:0,y:0,width:null!=(t=null==(n=this._texture)?void 0:n.width)?t:0,height:null!=(i=null==(r=this._texture)?void 0:r.height)?i:0}},n.setAnchor=function(e){this._anchor=e||[.5,.5]},n.setWorldSize=function(){var e=this._worldSizeFactor;this._worldSize=[this._rect.width/e,this._rect.height/e]},n.setUvRect=function(){var e,t;this._texture?(e=this._texture.width,t=this._texture.height):(e=this._rect.width,t=this._rect.height),this._uvRect={u:this._rect.x/e,v:this._rect.y/t,width:this._rect.width/e,height:this._rect.height/t}},n.render=function(e){this._updatePositionQuad(e),this._transformByMatrix(),e._renderPipeline.pushSprite(this,this._positionQuad,this._uvRect,this.tintColor,this.texture,this.renderMode,e)},n._transformByMatrix=function(){if(this.transformMatrix){var e=this.transformMatrix,n=this._positionQuad.leftTop,i=t._tempVec40;i.setValue(n.x,n.y,n.z,1),n=this._positionQuad.leftBottom;var r=t._tempVec41;r.setValue(n.x,n.y,n.z,1),n=this._positionQuad.rightTop;var a=t._tempVec42;a.setValue(n.x,n.y,n.z,1),n=this._positionQuad.rightBottom;var o=t._tempVec43;o.setValue(n.x,n.y,n.z,1),v.transform(i,e,i),v.transform(r,e,r),v.transform(a,e,a),v.transform(o,e,o),this._positionQuad.leftTop.setValue(i.x,i.y,i.z),this._positionQuad.leftBottom.setValue(r.x,r.y,r.z),this._positionQuad.rightTop.setValue(a.x,a.y,a.z),this._positionQuad.rightBottom.setValue(o.x,o.y,o.z)}},n._updatePositionQuad=function(e){if("2D"===this.renderMode){var t=e.viewMatrix.elements,n=new s(t[0],t[4],t[8]),i=new s(t[1],t[5],t[9]),r=this.entity.worldPosition.clone(),a=this._worldSize,o=this.entity.scale;if(n.scale(a[0]*o.x),i.scale(a[1]*o.y),0!==this._rotationAngle){var u=new s(t[2],t[6],t[10]),c=new l;l.rotationAxisAngle(u,this._rotationAngle,c),s.transformByQuat(n,c,n),s.transformByQuat(i,c,i)}var f=new s,h=new s;s.scale(n,2*(this.anchor[0]-.5),f),s.scale(i,2*(this.anchor[1]-.5),h),r.subtract(f).add(h);var d=this._positionQuad.leftTop;s.subtract(r,n,d),d.add(i);var _=this._positionQuad.leftBottom;s.subtract(r,n,_),_.subtract(i);var p=this._positionQuad.rightBottom;s.add(r,n,p),p.subtract(i);var m=this._positionQuad.rightTop;s.add(r,n,m),m.add(i)}},E(t,[{key:"texture",set:function(e){this.setTexture(e),this.setRect(),this.setUvRect(),this.setWorldSize()},get:function(){return this._texture}},{key:"anchor",set:function(e){this._anchor=e||[.5,.5]},get:function(){return this._anchor}},{key:"rect",set:function(e){this.setRect(e),this.setUvRect(),this.setWorldSize()},get:function(){return this._rect}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(e){this._rotationAngle=e}}]),t}(pt);li._tempVec40=new v,li._tempVec41=new v,li._tempVec42=new v,li._tempVec43=new v,($n=Jn||(Jn={}))[$n.ONCE=0]="ONCE",$n[$n.LOOP=1]="LOOP",(ti=ei||(ei={}))[ti.FINISHED=0]="FINISHED",ti[ti.LOOP_END=1]="LOOP_END",ti[ti.FRAME_EVENT=2]="FRAME_EVENT",(ii=ni||(ni={}))[ii.LINEAR=0]="LINEAR",ii[ii.CUBICSPLINE=1]="CUBICSPLINE",ii[ii.STEP=2]="STEP",(ai=ri||(ri={}))[ai.position=0]="position",ai[ai.rotation=1]="rotation",ai[ai.scale=2]="scale",ai[ai.other=3]="other";var fi=function(e){function t(t){var n;return(n=e.call(this,null)||this).name=t,n.samplers=[],n.channels=[],n}A(t,e);var n=t.prototype;return n.addSampler=function(e,t,n,i){void 0===i&&(i=ni.LINEAR),i===ni.CUBICSPLINE&&(n<=4?i=ni.LINEAR:n/=3);var r={input:e,output:t,outputSize:n,interpolation:i};this.samplers.push(r)},n.addChannel=function(e,n,i){var r=this.samplers[e],a=t._tagetTypeMap[i],o={sampler:r,target:{id:n,path:i,pathType:null!=a?a:3}};this.channels.push(o)},n.getChannelCount=function(){return this.channels.length},n.getChannelObject=function(e){return this.channels[e]},n.getFrameCount=function(e){return this.channels[e].sampler.input.length},n.getFrameTime=function(e,t){return this.channels[e].sampler.input[t]},n.getChannelTimeLength=function(e){var t=this.channels[e].sampler,n=t.input.length;return t.input[n-1]},n.createChannelValue=function(e){var t=this.channels[e].sampler;return new Float32Array(t.outputSize)},n.evaluate=function(e,t,n,i,r){var a=this.channels[t],o=a.sampler.output,s=a.sampler.outputSize;switch(a.sampler.interpolation){case ni.CUBICSPLINE:this.evaluateCubicSpline(e,o,s,n,i,r);break;case ni.LINEAR:this.evaluateLinear(e,o,s,n,i,r)}return e},n.evaluateCubicSpline=function(e,t,n,i,r,a){for(var o=a*a,s=a*o,u=2*s-3*o+1,c=-2*s+3*o,l=s-2*o+a,f=s-o,h=n;h>=0;h--){var d=t[i*n*3+h],_=t[i*n*3+n+h],p=t[i*n*3+2*n+h],m=t[r*n*3+n+h];e[h]=_*u+m*c+d*l+p*f}},n.evaluateLinear=function(e,t,n,i,r,a){switch(n){case 1:e[0]=t[i]*(1-a)+t[r]*a;break;case 4:this._quaSlerp(e,t,i*n,t,r*n,a);break;default:for(var o=n;o>=0;o--)e[o]=t[i*n+o]*(1-a)+t[r*n+o]*a}},n._quaSlerp=function(e,t,n,i,r,a){var o,s,u,c,l,f=t[0+n],h=t[1+n],d=t[2+n],_=t[3+n],p=i[0+r],m=i[1+r],v=i[2+r],g=i[3+r];return(s=f*p+h*m+d*v+_*g)<0&&(s=-s,p=-p,m=-m,v=-v,g=-g),1-s>1e-6?(o=Math.acos(s),u=Math.sin(o),c=Math.sin((1-a)*o)/u,l=Math.sin(a*o)/u):(c=1-a,l=a),e[0]=c*f+l*p,e[1]=c*h+l*m,e[2]=c*d+l*v,e[3]=c*_+l*g,e},t}(at);fi._tagetTypeMap={position:0,rotation:1,scale:2};var hi=function(e){function t(){var t;return(t=e.call(this,null)||this).layerWeight=1,t._activedEvents=[],t}A(t,e),E(t,[{key:"isPlaying",get:function(){return this._animClip&&this._isPlaying}}]);var n=t.prototype;return n.canMix=function(e,t){if(!this._animClip||!this._isPlaying||this.isMixLayer||this.isFading)return!1;if(this._animClip.getChannelCount()!==e.getChannelCount())return!1;for(var n=this._animClip.getChannelCount()-1;n>=0;n--){var i=this._animClip.getChannelObject(n),r=this._findChannelTarget(t,i.target),a=e.getChannelObject(n);if(r!==this._findChannelTarget(t,a.target))return!1}return!0},n.mix=function(e,t,n,i,r){if(void 0===r&&(r={}),this._isPlaying=t.isPlaying,this._animClip=e,this._wrapMode=void 0!==r.wrapMode?r.wrapMode:t._wrapMode,this._addEvents(r),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var a=t._channelStates,o=this._animClip.getChannelCount()-1;o>=0;o--){var s=this._animClip.getChannelObject(o),u=this._findChannelTarget(i,s.target);this._channelStates[o]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(o),mixWeight:u?1:0},a[o].mixWeight=void 0===a[o].mixWeight?1:a[o].mixWeight,1===a[o].mixWeight&&(a[o].mixWeight=u?0:1);var c=this._animClip.getChannelTimeLength(o);this._animClipLength=this._animClipLength>c?this._animClipLength:c}return!0}return!1},n.removeMixWeight=function(){for(var e=this._channelStates.length-1;e>=0;e--)1===this._channelStates[e].mixWeight&&(this.mixTagetLayer._channelStates[e].mixWeight=1)},n.play=function(e,t,n){if(void 0===n&&(n={wrapMode:Jn.LOOP}),this._isPlaying=!!e,this._animClip=e,this._wrapMode=void 0!==n.wrapMode?n.wrapMode:Jn.LOOP,this._addEvents(n),this._channelStates=[],this._animClipLength=0,this._isPlaying){for(var i=[],r=this._animClip.getChannelCount()-1;r>=0;r--){var a=this._animClip.getChannelObject(r),o=this._findChannelTarget(t,a.target);o||Ie("Can not find channel target:"+a.target.id),this._channelStates[r]={frameTime:0,currentFrame:0,currentValue:this._animClip.createChannelValue(r)},i[r]={targetObject:o,path:a.target.path,pathType:a.target.pathType,outputSize:a.sampler.outputSize};var s=this._animClip.getChannelTimeLength(r);this._animClipLength=this._animClipLength>s?this._animClipLength:s}return i}return!1},n.stop=function(e){this._animClip&&this._isPlaying&&(e?this._isPlaying=!1:this._wrapMode=Jn.ONCE)},n.updateState=function(e){if(this._animClip&&this._isPlaying){this.isFading?(this.fadeDeltaTime+=e,this.layerWeight=1-this.fadeDeltaTime/this.fadeDuration,this.layerWeight<=0&&(this._isPlaying=!1)):this.crossFadeDuration&&(this.crossFadeDeltaTime+=e,this.layerWeight=this.crossFadeDeltaTime/this.crossFadeDuration,this.layerWeight>=1&&(this.layerWeight=1,delete this.crossFadeDuration)),e/=1e3,this._activeEvents(e);for(var t=0,n=this._animClip.getChannelCount()-1;n>=0;n--)this._updateChannelState(e,n)&&t++;0===t&&(this._isPlaying=!1,this.isMixLayer&&this.removeMixWeight())}},n.getChannelLayerWeight=function(e){return(this.hasMixLayer||this.isMixLayer)&&e<this._channelStates.length?this._channelStates[e].mixWeight*(this.isMixLayer?this.mixTagetLayer.layerWeight:this.layerWeight):this.layerWeight},n.getChannelValue=function(e){return this._channelStates[e].currentValue},n.triggerEvents=function(){var e=this;this._activedEvents&&this._activedEvents.forEach((function(t){e.trigger(t)})),this._activedEvents.length=0},n.jumpToFrame=function(e){for(var t=this._animClip.getChannelCount()-1;t>=0;t--){this._channelStates[t].frameTime=0,this._updateChannelState(e,t)}},n._updateChannelState=function(e,t){var n=this._animClip,i=this._channelStates[t],r=n.getChannelTimeLength(t);if(i.frameTime+=e,i.frameTime>r)switch(this._wrapMode){case Jn.ONCE:i.frameTime=r;break;case Jn.LOOP:i.frameTime=i.frameTime%this._animClipLength;break;default:Fe("Unknown Anim wrap Mode: "+this._wrapMode)}if(i.mixWeight&&0===i.mixWeight)return!0;var a=Math.min(i.frameTime,r),o=this._getKeyAndAlpha(n.getChannelObject(t),a);return i.currentValue=n.evaluate(i.currentValue,t,o.currentKey,o.nextKey,o.alpha),!(this._wrapMode===Jn.ONCE&&i.frameTime>=r)},n._addEvents=function(e){var t=this;if(this.removeAllEventListeners(),this._frameEvents=[],e.events)for(var n=0,i=function(i){var r=e.events[i],a=r.type;r.type===ei.FRAME_EVENT&&(a="frameEvent"+n,n++,t._frameEvents.push({eventType:a,triggerTime:r.triggerTime,triggered:!1})),t.addEventListener(a,(function(e){r.callback()}))},r=e.events.length-1;r>=0;r--)i(r)},n._activeEvents=function(e){var t=this._animClip.durationIndex;if(this._frameEvents.length>0&&this._channelStates.length>0)for(var n=this._channelStates[t].frameTime+e,i=this._frameEvents.length-1;i>=0;i--){var r=this._frameEvents[i];!r.triggered&&n>r.triggerTime&&(this._activedEvents.push(new V(r.eventType,this)),r.triggered=!0)}if(this._channelStates.length>0&&this._channelStates[t].frameTime+e>=this._animClip.duration)if(this._wrapMode===Jn.LOOP){if(this._frameEvents.length>0)for(var a=this._frameEvents.length-1;a>=0;a--)this._frameEvents[a].triggered=!1;this.hasEvent(ei.LOOP_END)&&this._activedEvents.push(new V(ei.LOOP_END,this))}else this.hasEvent(ei.FINISHED)&&this._activedEvents.push(new V(ei.FINISHED,this))},n._findChannelTarget=function(e,t){var n=t.id,i=null;return i=e.name===n?e:e.findByName(n),"weights"===t.path?i.getComponent(On):i},n._getKeyAndAlpha=function(e,t){for(var n=0,i=0,r=0,a=e.sampler.input,o=a.length,s=o-1;s>=0;s--)if(t>a[s]){n=t-a[s],i=s;break}if((r=i+1)>=o)switch(this._wrapMode){case Jn.ONCE:r=o-1;break;case Jn.LOOP:r=0}var u=a[r]-a[i];return{currentKey:i,nextKey:r,alpha:r===i||u<1e-5?1:n/u}},t}(Y),di=Object.defineProperty,_i=Object.getOwnPropertyDescriptor,pi=function(e,t,n,i){for(var r,a=i>1?void 0:i?_i(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&di(t,n,a),a},mi=function(e){function t(t){var n;return(n=e.call(this,t)||this)._onUpdateIndex=-1,n._animSet={},n._animLayers=[new hi],n._timeScale=1,n}A(t,e),t.lerp=function(e,t,n,i,r){switch(r){case 1:e=t*(1-i)+n*i;break;case 4:var a=C(l,t),o=C(l,n),s=new l;l.slerp(a,o,i,s),e[0]=s.x,e[1]=s.y,e[2]=s.z,e[3]=s.w;break;default:for(var u=r;u>=0;u--)e[u]=t[u]*(1-i)+n[u]*i}return e};var n=t.prototype;return n.update=function(e){if(this.isPlaying()){e*=this._timeScale;for(var t=this._animLayers.length-1;t>=0;t--){this._animLayers[t].updateState(e)}this._updateValues();for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.triggerEvents(),i.isPlaying||!i.isFading&&!i.isMixLayer||(this._animLayers.splice(n,1),this._removeRefMixLayers(i))}}},n.addAnimationClip=function(e,t){this._animSet[t]=e},n.removeAnimationClip=function(e){this._animSet[e]&&delete this._animSet[e]},n.getAnimationClipLength=function(e){var t=this._animSet[e];return t?t.getChannelTimeLength(0):0},n.getAnimationClip=function(e){return this._animSet[e]||null},n.isPlaying=function(){for(var e=this._animLayers.length-1;e>=0;e--)if(this._animLayers[e].isPlaying)return!0;return!1},n.playAnimationClip=function(e,t){var n=this._animSet[e];if(n){for(var i=null,r=this._animLayers.length-1;r>=0;r--)if(!this._animLayers[r].isFading&&!this._animLayers[r].isMixLayer){i=this._animLayers[r];break}i||(i=new hi,this._animLayers.push(i)),this._removeRefMixLayers(i),this._channelTargets=i.play(n,this.entity,t)}else Fe("can not find anim clip: "+e)},n.crossFade=function(e,t,n){var i=this._animSet[e];if(i)if(!t||t<0)Fe("crossFadeDuration can not less than 0!");else{for(var r=null,a=this._animLayers.length-1;a>=0;a--)if(this._animLayers[a].canMix(i,this.entity)){r=this._animLayers[a];break}if(r){for(var o=this._animLayers.length-1;o>=0;o--)this._animLayers[o].isFading&&this._animLayers.splice(o,1);r.isFading=!0,r.fadeDuration=t,r.fadeDeltaTime=0;var s=new hi;s.crossFadeDuration=t,s.crossFadeDeltaTime=0,s.play(i,this.entity,n),this._animLayers.push(s)}else this.playAnimationClip(e,n)}else Fe("can not find anim clip: "+e)},n.mix=function(e,t,n){var i=this._animSet[e];if(i){var r=this.entity.findByName(t);if(r){for(var a=null,o=this._animLayers.length-1;o>=0;o--)if(this._animLayers[o].canMix(i,this.entity)){a=this._animLayers[o];break}if(a){this._removeRefMixLayers(null,r),a.hasMixLayer=!0;var s=new hi;s.isMixLayer=!0,s.mixTagetLayer=a,s.mixEntity=r,s.mix(i,a,this.entity,r,n),this._animLayers.push(s)}}else Fe("can not find mix bone!")}else Fe("can not find anim clip: "+e)},n.stop=function(e){for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].isFading?this._animLayers.splice(t,1):this._animLayers[t].stop(e)},n.jumpToFrame=function(e){e/=1e3;for(var t=this._animLayers.length-1;t>=0;t--)this._animLayers[t].jumpToFrame(e);this._updateValues()},n._removeRefMixLayers=function(e,t){if(e&&e.hasMixLayer)for(var n=this._animLayers.length-1;n>=0;n--){var i=this._animLayers[n];i.isMixLayer&&i.mixTagetLayer===e&&(i.removeMixWeight(),this._animLayers.splice(n,1))}if(t)for(var r=this._animLayers.length-1;r>=0;r--){var a=this._animLayers[r];a.isMixLayer&&(a.mixEntity===t||a.mixEntity.findByName(t)||t.findByName(a.mixEntity))&&(a.removeMixWeight(),this._animLayers.splice(r,1))}},n._updateValues=function(){if(0!==this._animLayers.length&&this._channelTargets)for(var e=this._channelTargets.length-1;e>=0;e--){var t=this._channelTargets[e],n=this._getChannelValue(e,t.outputSize),i=t.targetObject,r=t.path;if("weights"===r)i.setWeights(n);else{var a=n,o=i.transform;switch(t.pathType){case ri.position:var s=o.position;s.setValue(a[0],a[1],a[2]),o.position=s;break;case ri.rotation:var u=o.rotationQuaternion;u.setValue(a[0],a[1],a[2],a[3]),o.rotationQuaternion=u;break;case ri.scale:var c=o.scale;c.setValue(a[0],a[1],a[2]),o.scale=c;break;default:i[r]=n}}}},n._getChannelValue=function(e,n){for(var i=[],r=[],a=this._animLayers.length-1;a>=0;a--){var o=this._animLayers[a].getChannelLayerWeight(e);o>0&&(i.push(o),r.push(this._animLayers[a].getChannelValue(e)))}return 1===r.length?r[0]:2===r.length?t.lerp(r[0],r[0],r[1],i[1],n):(Fe("Can not get channel value!"),!1)},n._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},n._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},E(t,[{key:"timeScale",get:function(){return this._timeScale},set:function(e){e>0&&(this._timeScale=e)}}]),t}(Xe);pi([B],mi.prototype,"_onUpdateIndex",2),pi([U],mi.prototype,"_animSet",2),pi([B],mi.prototype,"_animLayers",2),pi([B],mi.prototype,"_timeScale",2),pi([B],mi.prototype,"_channelTargets",2);var vi=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).renderStates={enable:[],disable:[],functions:{}},i.emission=new v(0,0,0,1),i.ambient=new v(0,0,0,1),i.renderStates={},i}A(t,e);var n=t.prototype;return n.prepareDrawing=function(t,n,i){var r=t.camera,a=r.scene.findFeature(Xt);a.bindMaterialValues(this);var o=a.lightSortAmount.ambientLightCount;this._technique&&this._ambientLightCount===o||(this._ambientLightCount=o,this._generateTechnique(),this.bindLightUniformDefine(r)),e.prototype.prepareDrawing.call(this,t,n,i)},n.bindLightUniformDefine=function(e){var t=e.scene.findFeature(Xt);this._technique.uniforms=g({},t.getUniformDefine(),this._technique.uniforms)},n._internalGenerate=function(e,t){var n=this._generateMacros(),i=this._generateFragmentUniform(),r=new Zn(e);r.isValid=!0,r.uniforms=i,r.attributes={},r.states=this.renderStates,r.customMacros=n,r.vertexShader="#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <morph_target_vert>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n\n    #include <morph_vert>\n    #include <skinning_vert>\n    #include <uv_vert>\n    #include <normal_vert>\n    #include <worldpos_vert>\n    #include <shadow_vert>\n    #include <position_vert>\n\n    #include <fog_vert>\n\n}\n",r.fragmentShader=t,this._technique=r},n._generateMacros=function(){var e=[];return this.emission instanceof Tn&&e.push("O3_EMISSION_TEXTURE"),this.ambient instanceof Tn&&e.push("O3_AMBIENT_TEXTURE"),this._ambientLightCount&&e.push("O3_HAS_AMBIENT_LIGHT"),e},n._generateFragmentUniform=function(){var e={u_emission:{name:"u_emission",type:_e.FLOAT_VEC4},u_ambient:{name:"u_ambient",type:_e.FLOAT_VEC4}};return this.emission instanceof Tn&&(e.u_emission.type=_e.SAMPLER_2D),this.ambient instanceof Tn&&(e.u_ambient.type=_e.SAMPLER_2D),e},E(t,[{key:"emission",get:function(){return this.getValue("u_emission")},set:function(e){this.setValue("u_emission",e)}},{key:"ambient",get:function(){return this.getValue("u_ambient")},set:function(e){this.setValue("u_ambient",e)}}]),t}(Ln),gi=function(e){function t(){return e.apply(this,arguments)||this}return A(t,e),t.prototype._generateTechnique=function(){this._internalGenerate("ConstantMaterial","#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <mobile_material_frag>\n\n#include <fog_share>\n#include <ambient_light_frag>\n\nvoid main() {\n\n    #include <begin_mobile_frag>\n\n    gl_FragColor = emission + ambient;\n\n    #include <fog_frag>\n\n}\n")},t}(vi),yi=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this)._directLightCount=0,i._pointLightCount=0,i._spotLightCount=0,i.diffuse=new v(1,1,1,1),i.specular=new v(1,1,1,1),i.shininess=16,i}A(t,e);var n=t.prototype;return n._generateTechnique=function(){this._internalGenerate("BlinnPhongMaterial","#include <common>\n#include <common_frag>\n\n#include <uv_share>\n#include <normal_share>\n#include <worldpos_share>\n\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <mobile_material_frag>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_mobile_frag>\n    #include <begin_normal_frag>\n    #include <begin_viewdir_frag>\n    #include <mobile_blinnphong_frag>\n\n    gl_FragColor = emission + ambient + diffuse + specular;\n\n    #include <fog_frag>\n\n}\n")},n._generateMacros=function(){var t=e.prototype._generateMacros.call(this);return t.push("O3_NEED_WORLDPOS"),this.diffuse instanceof Tn&&t.push("O3_DIFFUSE_TEXTURE"),this.specular instanceof Tn&&t.push("O3_SPECULAR_TEXTURE"),this._directLightCount>0&&t.push("O3_DIRECT_LIGHT_COUNT "+this._directLightCount),this._pointLightCount>0&&t.push("O3_POINT_LIGHT_COUNT "+this._pointLightCount),this._spotLightCount>0&&t.push("O3_SPOT_LIGHT_COUNT "+this._spotLightCount),t},n.prepareDrawing=function(t,n,i){var r=t.camera,a=r.scene.findFeature(Xt).lightSortAmount,o=a.directLightCount,s=a.pointLightCount,u=a.spotLightCount;null!==this._technique&&this._directLightCount==o&&this._pointLightCount==s&&this._spotLightCount==u||(this._directLightCount=o,this._pointLightCount=s,this._spotLightCount=u,this._generateTechnique(),this.bindLightUniformDefine(r)),e.prototype.prepareDrawing.call(this,t,n,i)},n._generateFragmentUniform=function(){var t={};this.diffuse instanceof Tn?t.u_diffuse={name:"u_diffuse",type:_e.SAMPLER_2D}:t.u_diffuse={name:"u_diffuse",type:_e.FLOAT_VEC4},this.specular instanceof Tn?t.u_specular={name:"u_specular",type:_e.SAMPLER_2D}:t.u_specular={name:"u_specular",type:_e.FLOAT_VEC4},t.u_shininess={name:"u_shininess",type:_e.FLOAT};var n=e.prototype._generateFragmentUniform.call(this);return Object.assign(n,t)},E(t,[{key:"diffuse",get:function(){return this.getValue("u_diffuse")},set:function(e){this.setValue("u_diffuse",e)}},{key:"specular",get:function(){return this.getValue("u_specular")},set:function(e){this.setValue("u_specular",e)}},{key:"shininess",get:function(){return this.getValue("u_shininess")},set:function(e){this.setValue("u_shininess",e)}}]),t}(vi),xi="#include <common>\n#include <common_frag>\n\nuniform sampler2D u_diffuse;\nvarying vec3 v_pos;\nuniform vec4 u_tintColor;\nuniform float u_opacity;\n\nvoid main()\n{\n  #ifdef O3_DIFFUSE_TEXTURE\n    gl_FragColor = texture2D(u_diffuse, v_uv);\n  #else\n    gl_FragColor = vec4(1);\n  #endif\n}\n";(function(e){function t(t,n){return e.call(this,t,n||"TextureMaterial")||this}A(t,e);var n=t.prototype;return n._generateTechnique=function(){this._internalGenerate("Texture",xi)},n.setValue=function(t,n){"doubleSided"===t&&this._setDoubleSidedDisplay(n),e.prototype.setValue.call(this,t,n)},n._generateFragmentUniform=function(){var t={};return this.texture instanceof Tn&&(t.u_diffuse={name:"u_diffuse",paramName:"_MainTex",type:_e.SAMPLER_2D}),g({},e.prototype._generateFragmentUniform.call(this),t)},n._generateMacros=function(){var t=e.prototype._generateMacros.call(this);return this.texture instanceof Tn&&t.push("O3_DIFFUSE_TEXTURE"),t},n._setDoubleSidedDisplay=function(e){this._technique.states.disable=[],e&&this._technique.states.disable.push(ne.CULL_FACE)},E(t,[{key:"texture",set:function(e){this.setValue("u_diffuse",e)},get:function(){return this.getValue("u_diffuse")}},{key:"doubleSided",set:function(e){this.setValue("doubleSided",e)},get:function(){return this.getValue("doubleSided")}}]),t}(vi)).TECH_NAME="Texture",(function(e){function t(t,n){return e.call(this,t,n||"TransparentMaterial")||this}A(t,e);var n=t.prototype;return n._generateTechnique=function(){this.renderStates={enable:[ne.BLEND],disable:[ne.CULL_FACE],functions:{blendFunc:[ge.SRC_ALPHA,ge.ONE_MINUS_SRC_ALPHA],depthMask:[!1]}},this.renderType=ee.TRANSPARENT,this._internalGenerate("Transparent",xi)},n._generateFragmentUniform=function(){var t={};return this.texture instanceof Tn&&(t.u_diffuse={name:"u_diffuse",paramName:"_MainTex",type:_e.SAMPLER_2D}),g({},e.prototype._generateFragmentUniform.call(this),t)},n._generateMacros=function(){var t=e.prototype._generateMacros.call(this);return this.texture instanceof Tn&&t.push("O3_DIFFUSE_TEXTURE"),t},E(t,[{key:"texture",set:function(e){this.setValue("u_diffuse",e)},get:function(){return this.getValue("u_diffuse")}}]),t}(vi)).TECH_NAME="Transparent";var Ti=function(e){function t(n,i){var r;return(r=e.call(this,n,i)||this).vertexShader="",r.fragmentShader="",r.isValid=!0,r.attributes={},r._uniforms=t.commonUniforms,r._renderStates={enable:[],disable:[],functions:{}},r._enableConfig=[],r._disableConfig=[],r._functionsConfig={blendFunc:[ge.SRC_ALPHA,ge.ONE_MINUS_SRC_ALPHA]},r}A(t,e);var n=t.prototype;return n.prepareDrawing=function(t,n,i){var r=t.camera;if(!this._technique){var a=this._generateTechnique(r,n,i);this._technique=a}e.prototype.prepareDrawing.call(this,t,n,i)},n.updateTechnique=function(){this._technique=null},n._generateTechnique=function(e,t,n){var i=new Zn("ShaderMaterial");return i.isValid=this.isValid,i.uniforms=this.uniforms,i.attributes=this.attributes,i.states=this.renderStates,i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i},n.addState=function(e,t){this.renderStates[e]=bi(this.renderStates[e],t)},n.removeState=function(e,t){this.renderStates[e]=this.renderStates[e].filter((function(e){return e!==t}))},E(t,[{key:"renderStates",get:function(){return this._renderStates},set:function(e){var n=e.enable,i=void 0===n?[]:n,r=e.disable,a=void 0===r?[]:r,o=e.functions,s=void 0===o?{}:o,u=i.filter((function(e){return t.commonEnable.indexOf(e)<0})),c=a.filter((function(e){return t.commonDisable.indexOf(e)<0}));this._renderStates.enable=bi(u,this._enableConfig),this._renderStates.disable=bi(c,this._disableConfig),this._renderStates.functions=Object.assign({},s,this._functionsConfig)}},{key:"uniforms",get:function(){return this._uniforms},set:function(e){this._uniforms=Object.assign({},t.commonUniforms,e)}},{key:"blend",set:function(e){e?this._enableConfig=bi(this._enableConfig,[ne.BLEND]):(this._enableConfig=this._enableConfig.filter((function(e){return e!==ne.BLEND})),this.removeState("enable",ne.BLEND)),this.renderStates=this._renderStates}},{key:"blendSrcFactor",set:function(e){this._functionsConfig.blendFunc[0]=e,this.renderStates=this._renderStates}},{key:"blendDstFactor",set:function(e){this._functionsConfig.blendFunc[1]=e,this.renderStates=this._renderStates}},{key:"doubleSide",set:function(e){e?this._disableConfig=bi(this._disableConfig,[ne.CULL_FACE]):(this._disableConfig=this._disableConfig.filter((function(e){return e!==ne.CULL_FACE})),this.removeState("disable",ne.CULL_FACE)),this.renderStates=this._renderStates}},{key:"depthTest",set:function(e){e?(this._disableConfig=this._disableConfig.filter((function(e){return e!==ne.DEPTH_TEST})),this.removeState("disable",ne.DEPTH_TEST)):this._disableConfig=bi(this._disableConfig,[ne.DEPTH_TEST]),this.renderStates=this._renderStates}}]),t}(Ln);function bi(e,t){return e.concat(t.filter((function(t){return!(e.indexOf(t)>-1)})))}Ti.commonUniforms={matModelViewProjection:{name:"matModelViewProjection",semantic:me.MODELVIEWPROJECTION,type:_e.FLOAT_MAT4},matModelView:{name:"matModelView",semantic:me.MODELVIEW,type:_e.FLOAT_MAT4}},Ti.commonEnable=[ne.BLEND],Ti.commonDisable=[ne.CULL_FACE,ne.DEPTH_TEST];var Ei,Ai,Oi=function(e){function t(t,n){var i;return(i=e.call(this,t)||this)._subGeometries=[],i._primitive=new Hn(t),i.name=n,i}A(t,e);var n=t.prototype;return n.setVertexBufferBinding=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=0),this._primitive.setVertexBufferBinding(e,t,n)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0),this._primitive.setVertexBufferBindings(e,t)},n.setIndexBufferBinding=function(e,t){this._primitive.setIndexBufferBinding(e,t)},n.setVertexElements=function(e){this._primitive.setVertexElements(e)},n.addSubGeometry=function(e,t,n){void 0===n&&(n=Bn.Triangles);var i=new Xn(e,t,n);return this._subGeometries.push(i),i},n.removeSubGeometry=function(e){var t=this._subGeometries,n=t.indexOf(e);-1!==n&&t.splice(n,1)},n.clearSubGeometry=function(){this._subGeometries.length=0},n.destroy=function(){this._primitive&&(this._primitive.destroy(),this._primitive=null)},E(t,[{key:"vertexBufferBindings",get:function(){return this._primitive.vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._primitive.indexBufferBinding}},{key:"vertexElements",get:function(){return this._primitive.vertexElements}},{key:"subGeometry",get:function(){return this._subGeometries[0]||null}},{key:"subGeometries",get:function(){return this._subGeometries}},{key:"instanceCount",get:function(){return this._primitive.instanceCount},set:function(e){this._primitive.instanceCount=e}},{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds=e}}]),t}(X),Ci=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n.render=function(e){var t=this.geometry;if(t){for(var n=t.subGeometries,i=e._renderPipeline,r=this._material,a=0,o=n.length;a<o;a++)if(r){var s=et.getFromPool();s.setValue(this,t._primitive,n[a],r),i.pushPrimitive(s)}}else Fe("geometry is null.")},n._updateBounds=function(e){var t=this._geometry.bounds;if(t){var n=this._entity.transform.worldMatrix;s.transformCoordinate(t.min,n,e.min),s.transformCoordinate(t.max,n,e.max)}else e.min.setValue(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),e.max.setValue(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)},E(t,[{key:"geometry",set:function(e){this._geometry&&this._geometry._primitive._addRefCount(-1),e._primitive._addRefCount(1),this._geometry=e},get:function(){return this._geometry}},{key:"material",set:function(e){this._material&&this._material._addRefCount(-1),e._addRefCount(1),this._material=e},get:function(){return this._material}}]),t}(pt),Ri=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n._initialize=function(e,t,n){var i=[new Wn("POSITION",0,Sn.Vector3,0),new Wn("NORMAL",12,Sn.Vector3,0),new Wn("TEXCOORD_0",24,Sn.Vector2,0)];this._initBuffer(e,t,n,32,i)},n._initBuffer=function(e,t,n,i,r){var a=r[0],o=new kn(e,Fn.VertexBuffer,t,Cn.Static),s=new kn(e,Fn.IndexBuffer,n,Cn.Static);this.setVertexBufferBinding(o,i),this.setIndexBufferBinding(s,Mn.UInt16),this.setVertexElements(r),this.addSubGeometry(0,n.length),this._computeBounds(a,t)},n._computeBounds=function(e,t){var n=e,i=n.bindingIndex,r=this._primitive.vertexBufferBindings[i],a=r.stride,o=n.offset,u=r.buffer.byteLength/a,c=t;c instanceof ArrayBuffer||(c=c.buffer);for(var l=new DataView(c,o),f=new s(1/0,1/0,1/0),h=new s(-1/0,-1/0,-1/0),d=0;d<u;d++){var _=o+a*d,p=new s(l.getFloat32(_,!0),l.getFloat32(_+4,!0),l.getFloat32(_+8,!0));s.min(f,p,f),s.max(h,p,h)}var m=this.bounds;m?(f.cloneTo(m.min),h.cloneTo(m.max)):(m={min:f,max:h},this.bounds=m)},t}(Oi),Si=function(e){function t(t,n,i,r){var a;void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),a=e.call(this,t)||this;var o=n/2,s=i/2,u=r/2,c=new Float32Array([-o,s,-u,0,1,0,0,0,o,s,-u,0,1,0,1,0,o,s,u,0,1,0,1,1,-o,s,u,0,1,0,0,1,-o,-s,-u,0,-1,0,0,1,o,-s,-u,0,-1,0,1,1,o,-s,u,0,-1,0,1,0,-o,-s,u,0,-1,0,0,0,-o,s,-u,-1,0,0,0,0,-o,s,u,-1,0,0,1,0,-o,-s,u,-1,0,0,1,1,-o,-s,-u,-1,0,0,0,1,o,s,-u,1,0,0,1,0,o,s,u,1,0,0,0,0,o,-s,u,1,0,0,0,1,o,-s,-u,1,0,0,1,1,-o,s,u,0,0,1,0,0,o,s,u,0,0,1,1,0,o,-s,u,0,0,1,1,1,-o,-s,u,0,0,1,0,1,-o,s,-u,0,0,-1,1,0,o,s,-u,0,0,-1,0,0,o,-s,-u,0,0,-1,0,1,-o,-s,-u,0,0,-1,1,1]),l=new Uint16Array([0,2,1,2,0,3,4,6,7,6,4,5,8,10,9,10,8,11,12,14,15,14,12,13,16,18,17,18,16,19,20,22,23,22,20,21]);return a._initialize(t,c,l),a}return A(t,e),t}(Ri),wi=function(e){function t(t,n,i,r,a,o,s,u){var c;return void 0===n&&(n=1),void 0===i&&(i=8),void 0===r&&(r=6),void 0===a&&(a=0),void 0===o&&(o=2*Math.PI),void 0===s&&(s=0),void 0===u&&(u=Math.PI),(c=e.call(this,t)||this)._parameters={radius:n||1,horizontalSegments:Math.max(3,Math.floor(i)),verticalSegments:Math.max(2,Math.floor(r)),alphaStart:a,alphaRange:o,thetaStart:s,thetaRange:u},c._thetaEnd=c._parameters.thetaStart+c._parameters.thetaRange,c.initialize(t),c}return A(t,e),t.prototype.initialize=function(e){for(var t=this._parameters,n=t.verticalSegments,i=t.horizontalSegments,r=0,a=[],o=new Float32Array((n+1)*(i+1)*8),s=[],u=0;u<=n;u++){for(var c=[],l=u/n,f=0;f<=i;f++){var h=f/i,d=-this._parameters.radius*Math.cos(this._parameters.alphaStart+h*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+l*this._parameters.thetaRange),_=this._parameters.radius*Math.cos(this._parameters.thetaStart+l*this._parameters.thetaRange),p=this._parameters.radius*Math.sin(this._parameters.alphaStart+h*this._parameters.alphaRange)*Math.sin(this._parameters.thetaStart+l*this._parameters.thetaRange);d=Math.abs(d)<1e-6?0:d,_=Math.abs(_)<1e-6?0:_,p=Math.abs(p)<1e-6?0:p;var m=8*r;o[m]=d,o[m+1]=_,o[m+2]=p,o[m+3]=d,o[m+4]=_,o[m+5]=p,o[m+6]=h,o[m+7]=1-l,c.push(r++)}a.push(c)}for(var v=0;v<n;v++)for(var g=0;g<i;g++){var y=a[v][g+1],x=a[v][g],T=a[v+1][g],b=a[v+1][g+1];(0!==v||this._parameters.thetaStart>0)&&s.push(y,x,b),(v!==n-1||this._thetaEnd<Math.PI)&&s.push(x,T,b)}this._initialize(e,o,Uint16Array.from(s))},t}(Ri),Mi=function(e){function t(t,n,i,r,a){var o;return void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),(o=e.call(this,t)||this)._parameters={width:n,height:i,horizontalSegments:Math.floor(r),verticalSegments:Math.floor(a)},o.halfWidth=o._parameters.width/2,o.halfHeight=o._parameters.height/2,o.initialize(t),o}return A(t,e),t.prototype.initialize=function(e){for(var t=this._parameters,n=t.verticalSegments,i=t.horizontalSegments,r=0,a=0,o=[],s=new Float32Array((n+1)*(i+1)*8),u=new Uint16Array(n*i*6),c=0;c<=n;c++){for(var l=[],f=c/n,h=0;h<=i;h++){var d=h/i,_=d*this._parameters.width-this.halfWidth,p=f*this._parameters.height-this.halfHeight;s[a++]=_,s[a++]=p,s[a++]=0,s[a++]=0,s[a++]=0,s[a++]=1,s[a++]=d,s[a++]=1-f,l.push(r++)}o.push(l)}r=0;for(var m=0;m<n;m++)for(var v=0;v<i;v++){var g=o[m][v+1],y=o[m][v],x=o[m+1][v],T=o[m+1][v+1];u[r++]=g,u[r++]=x,u[r++]=y,u[r++]=g,u[r++]=T,u[r++]=x}this._initialize(e,s,u)},t}(Ri),Pi=function(e){function t(t,n,i,r,a,o,s,u,c,l){var f;return void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=8),void 0===o&&(o=1),void 0===s&&(s=!1),void 0===u&&(u=0),void 0===c&&(c=2*Math.PI),void 0===l&&(l=re.CCW),(f=e.call(this,t)||this).FrontFace=l,f._parameters={radiusTop:n,radiusBottom:i,height:r,radialSegments:a,heightSegments:o,openEnded:s,thetaStart:u,thetaLength:c},f._vertices=[],f._indices=[],f.index=0,f.indexArray=[],f.halfHeight=f._parameters.height/2,f.generateTorso(),!1===f._parameters.openEnded&&(f._parameters.radiusTop>0&&f.generateCap(!0),f._parameters.radiusBottom>0&&f.generateCap(!1)),f._initialize(t,Float32Array.from(f._vertices),Uint16Array.from(f._indices)),f}A(t,e);var n=t.prototype;return n.generateTorso=function(){var e,t,n=this._parameters,i=n.radialSegments,r=n.heightSegments,a=n.radiusBottom,o=n.radiusTop,u=n.height,c=new s,l=(a-o)/u;for(t=0;t<=r;t++){var f=[],h=t/r,d=h*(a-o)+o;for(e=0;e<=i;e++){var _=e/i,p=_*this._parameters.thetaLength+this._parameters.thetaStart,m=Math.sin(p),v=Math.cos(p),g=d*m,y=-h*u+this.halfHeight,x=d*v;this._vertices.push(g,y,x),c.setValue(m,l,v),c.normalize(),this._vertices.push(c.x,c.y,c.z),this.FrontFace===re.CCW?this._vertices.push(_,h):this._vertices.push(1-_,h),f.push(this.index++)}this.indexArray.push(f)}for(e=0;e<i;e++)for(t=0;t<r;t++){var T=this.indexArray[t][e],b=this.indexArray[t+1][e],E=this.indexArray[t+1][e+1],A=this.indexArray[t][e+1];this._indices.push(T,b,A),this._indices.push(b,E,A)}},n.generateCap=function(e){var t,n=this._parameters.radialSegments,i=!0===e?this._parameters.radiusTop:this._parameters.radiusBottom,r=!0===e?1:-1,a=this.index;for(t=1;t<=n;t++)this._vertices.push(0,this.halfHeight*r,0),this._vertices.push(0,r,0),this._vertices.push(.5,.5),this.index++;var o=this.index;for(t=0;t<=n;t++){var s=t/n*this._parameters.thetaLength+this._parameters.thetaStart,u=Math.cos(s),c=Math.sin(s),l=i*c,f=this.halfHeight*r,h=i*u;this._vertices.push(l,f,h),this._vertices.push(0,r,0);var d=.5*u+.5,_=.5*c*r+.5;this._vertices.push(d,_),this.index++}for(t=0;t<n;t++){var p=a+t,m=o+t;!0===e?this._indices.push(m,m+1,p):this._indices.push(m+1,m,p)}},t}(Ri),Li=function(e){function t(t){return e.call(this,t)||this}A(t,e),E(t,[{key:"geometryType",set:function(e){switch(e){case"Sphere":var t=this._props,n=t.sphereRadius,i=t.sphereHorizontalSegments,r=t.sphereVerticalSegments,a=t.sphereAlphaStart,o=t.sphereAlphaRange,s=t.sphereThetaStart,u=t.sphereThetaRange;this.geometry=new wi(this.engine,n,i,r,a,o,s,u);break;case"Cylinder":var c=this._props,l=c.cylinderRadiusTop,f=c.cylinderRadiusBottom,h=c.cylinderHeight,d=c.cylinderRadialSegments,_=c.cylinderHeightSegments,p=c.cylinderOpenEnded;this.geometry=new Pi(this.engine,l,f,h,d,_,p,void 0,void 0,void 0);break;case"Plane":var m=this._props,v=m.planeWidth,g=m.planeHeight,y=m.planeHorizontalSegments,x=m.planeVerticalSegments;this.geometry=new Mi(this.engine,v,g,y,x);break;case"Box":var T=this._props,b=T.boxWidth,E=T.boxHeight,A=T.boxDepth;this.geometry=new Si(this.engine,b,E,A)}this._geometryType=e},get:function(){return this._geometryType}}]);var n=t.prototype;return n.init=function(e){this._props=e;var t=e.geometryType,n=void 0===t?Ei.Box:t;this.material=e.material,this.geometryType=n},n.setProp=function(e,t){this._props[e]=t,"material"===e?this.material=t:this.geometryType=this._props.geometryType},E(t,[{key:"material",get:function(){return this._material},set:function(e){this._material=e||new yi(this.engine,"mtl")}}]),t}(Ci);(Ai=Ei||(Ei={})).Box="Box",Ai.Cylinder="Cylinder",Ai.Plane="Plane",Ai.Sphere="Sphere";var Ii=function(e){function t(n,i){return void 0===i&&(i=t.defaultName),e.call(this,n,i)||this}A(t,e);var n=t.prototype;return n.setModel=function(e){this.modelMatrix=e},n.prepareDrawing=function(t,n){null===this._technique&&this._generateTechnique(),this._cacheMat1||(this._cacheMat1=new f,this._cacheMat2=new f);var i=t.viewMatrix,r=t.projectionMatrix;f.multiply(i,this.modelMatrix,this._cacheMat1);var a=this._cacheMat1.elements;a[12]=a[13]=a[14]=0,f.multiply(r,this._cacheMat1,this._cacheMat2),this.setValue("u_mvpNoscale",this._cacheMat2),e.prototype.prepareDrawing.call(this,t,n,void 0)},n._generateTechnique=function(){var e=new Zn(t.techniqueName);e.isValid=!0,e.uniforms=t.techniqueConfig.uniforms,e.attributes=t.techniqueConfig.attributes,e.states=t.techniqueConfig.states,e.vertexShader=t.vertexShader,e.fragmentShader=t.fragmentShader,this._technique=e},t}(Ln);Ii.defaultName="SKY_BOX_MATERIAL",Ii.techniqueName="SKY_BOX_TECHNIQUE",Ii.vertexShader="#include <common_vert>\n\nuniform mat4 u_mvpNoscale;\n\nvarying vec3 v_cubeUV;\n\nvoid main() {\n\n    v_cubeUV = a_position.xyz;\n    gl_Position = u_mvpNoscale * vec4( a_position, 1.0 );\n    gl_Position.z = gl_Position.w;\n\n}\n",Ii.fragmentShader="uniform samplerCube u_cube;\n\nvarying vec3 v_cubeUV;\n\nvoid main() {\n\n    gl_FragColor = textureCube( u_cube, v_cubeUV );\n\n}\n",Ii.techniqueConfig={attributes:{},uniforms:{u_mvpNoscale:{name:"u_mvpNoscale",type:_e.FLOAT_MAT4},u_cube:{name:"u_cube",type:_e.SAMPLER_CUBE}},states:{disable:[ne.CULL_FACE],functions:{depthFunc:le.LEQUAL}}};var Fi=function(e){function t(t){var n;return(n=e.call(this,t)||this).geometry=new Si(n.engine,2,2,2),n.material=new Ii(n.engine),n}A(t,e);var n=t.prototype;return n.update=function(){this.material.setModel(this.entity.transform.worldMatrix)},n.render=function(t){this._skyBoxMap&&e.prototype.render.call(this,t)},E(t,[{key:"skyBoxMap",get:function(){return this._skyBoxMap},set:function(e){this._skyBoxMap=e,this.material.setValue("u_cube",e)}}]),t}(Ci),Ni=function(e){function t(n,i,r){var a;return void 0===i&&(i=t.MATERIAL_NAME),void 0===r&&(r={}),(a=e.call(this,n,i)||this).createDefaulteValues(),a.setUniforms(r),a.setStates(r),a}A(t,e);var n=t.prototype;return n.createDefaulteValues=function(){var e=this;this._uniformObj={baseColorFactor:new v(1,1,1,1),metallicFactor:1,roughnessFactor:1,metallicRoughness:new _(1,1),normalScale:1,emissiveFactor:new s(0,0,0),occlusionStrength:1,alphaCutoff:.5,specularFactor:new s(1,1,1),glossinessFactor:0,envMapIntensity:1,refractionRatio:1/1.33,refractionDepth:1,perturbationUOffset:0,perturbationVOffset:0},this._stateObj={alphaMode:"OPAQUE",doubleSided:!1,side:ue.FRONT,unlit:!1,srgb:!1,srgbFast:!1,gamma:!1,blendFunc:[],blendFuncSeparate:[ge.SRC_ALPHA,ge.ONE_MINUS_SRC_ALPHA,ge.ONE,ge.ONE],depthMask:[!1],getOpacityFromRGB:!1,isMetallicWorkflow:!0,envMapModeRefract:!1},Object.keys(this._uniformObj).forEach((function(t){return e.setValueByParamName(t,e._uniformObj[t])}))},n.setUniforms=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"baseColorFactor":t.baseColorFactor=e[n];break;case"opacity":t.opacity=e[n];break;case"opacityTexture":t.opacityTexture=e[n];break;case"baseColorTexture":t.baseColorTexture=e[n];break;case"metallicFactor":t.metallicFactor=e[n];break;case"roughnessFactor":t.roughnessFactor=e[n];break;case"metallicTexture":t.metallicTexture=e[n];break;case"roughnessTexture":t.roughnessTexture=e[n];break;case"metallicRoughnessTexture":t.metallicRoughnessTexture=e[n];break;case"normalTexture":t.normalTexture=e[n];break;case"normalScale":t.normalScale=e[n];break;case"emissiveTexture":t.emissiveTexture=e[n];break;case"emissiveFactor":t.emissiveFactor=e[n];break;case"occlusionTexture":t.occlusionTexture=e[n];break;case"occlusionStrength":t.occlusionStrength=e[n];break;case"alphaCutoff":t.alphaCutoff=e[n];break;case"specularFactor":t.specularFactor=e[n];break;case"glossinessFactor":t.glossinessFactor=e[n];break;case"specularGlossinessTexture":t.specularGlossinessTexture=e[n];break;case"reflectionTexture":t.reflectionTexture=e[n];break;case"envMapIntensity":t.envMapIntensity=e[n];break;case"refractionRatio":t.refractionRatio=e[n];break;case"refractionDepth":t.refractionDepth=e[n];break;case"refractionTexture":t.refractionTexture=e[n];break;case"perturbationTexture":t.perturbationTexture=e[n];break;case"perturbationUOffset":t.perturbationUOffset=e[n];break;case"perturbationVOffset":t.perturbationVOffset=e[n]}}))},n.setStates=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case"doubleSided":t.doubleSided=e[n];break;case"side":t.side=e[n];break;case"alphaMode":t.alphaMode=e[n];break;case"unlit":t.unlit=e[n];break;case"srgb":t.srgb=e[n];break;case"srgbFast":t.srgbFast=e[n];break;case"gamma":t.gamma=e[n];break;case"blendFunc":t.blendFunc=e[n];break;case"blendFuncSeparate":t.blendFuncSeparate=e[n];break;case"depthMask":t.depthMask=e[n];break;case"getOpacityFromRGB":t.getOpacityFromRGB=e[n];break;case"isMetallicWorkflow":t.isMetallicWorkflow=e[n];break;case"envMapModeRefract":t.envMapModeRefract=e[n]}}))},n.setValueByParamName=function(e,n){var i=t.TECH_CONFIG.uniforms,r=Object.keys(i).find((function(t){return i[t].paramName===e}));r&&this.setValue(r,n)},n.updateTechnique=function(e,t){var n;if(this[e]!==t){this._stateObj[e]=t;var i=null==(n=this.technique)?void 0:n.states;if(i)switch(e){case"doubleSided":case"side":if(this.doubleSided)i.disable.push(ne.CULL_FACE);else{var r=i.disable.indexOf(ne.CULL_FACE);switch(r>-1&&i.disable.splice(r,1),this.side){case ue.FRONT:i.functions.cullFace=[oe.BACK];break;case ue.BACK:i.functions.cullFace=[oe.FRONT];break;case ue.NONE:i.functions.cullFace=[oe.FRONT_AND_BACK];break;default:delete i.functions.cullFace}}break;case"blendFunc":case"blendFuncSeparate":this.blendFunc.length?i.functions.blendFunc=this.blendFunc:i.functions.blendFuncSeparate=this.blendFuncSeparate;break;case"depthMask":i.functions.depthMask=t;break;default:this._technique=null}}},n.prepareDrawing=function(t,n,i){var r,a=t.camera,o=a.scene,s=o.engine.canvas,u=o.findFeature(Xt),c=a._renderPipeline.canOIT;u.bindMaterialValues(this),this.setValue("u_resolution",new _(s.width,s.height));for(var l=0;l<this._clipPlaneCount;l++)this.setValue("u_clipPlanes["+l+"]",o.clipPlanes[l]);c&&this.setValue("u_depthSampler",a._renderPipeline.depthTexture);var f,h=u.lightSortAmount,d=h.ambientLightCount,p=h.directLightCount,m=h.pointLightCount,v=h.spotLightCount,g=h.envMapLightCount,y=h.useDiffuseEnv,x=h.useSpecularEnv;this._technique&&this._ambientLightCount===d&&this._envMapLightCount===g&&this._useDiffuseEnv===y&&this._useSpecularEnv===x&&this._directLightCount===p&&this._pointLightCount===m&&this._spotLightCount===v&&this._clipPlaneCount===(null==(r=o.clipPlanes)?void 0:r.length)&&this._useOIT===c||(this._ambientLightCount=d,this._envMapLightCount=g,this._useDiffuseEnv=y,this._useSpecularEnv=x,this._directLightCount=p,this._pointLightCount=m,this._spotLightCount=v,this._clipPlaneCount=null==(f=o.clipPlanes)?void 0:f.length,this._useOIT=c,this._generateTechnique(a,n,i));e.prototype.prepareDrawing.call(this,t,n,i)},n._generateTechnique=function(e,n,i){var r=this._generateShaderMacros(e,n,i),a=t.TECHNIQUE_NAME,o=t.STATIC_VERTEX_SHADER,s=t.STATIC_FRAGMENT_SHADER,u=this._generateConfig(),c=e.scene.findFeature(Xt),l=new Zn(a);return l.isValid=!0,l.uniforms=g({},c.getUniformDefine(),u.uniforms),l.attributes=u.attributes,l.fragmentPrecision="highp",l.customMacros=r,l.states=u.states,l.vertexShader=o,l.fragmentShader=s,this._technique=l,l},n._generateShaderMacros=function(e,t,n){var i=e.scene.engine._hardwareRenderer,r=["O3_NEED_WORLDPOS"];n._vertexElementMap.NORMAL&&n._vertexElementMap.TANGENT||i.canIUse(Ce.standardDerivatives)&&r.push("HAS_DERIVATIVES");var a=Object.keys(this._values);return a.indexOf("u_baseColorSampler")>-1&&r.push("HAS_BASECOLORMAP"),a.indexOf("u_normalSampler")>-1&&r.push("O3_HAS_NORMALMAP"),a.indexOf("u_metallicSampler")>-1&&r.push("HAS_METALMAP"),a.indexOf("u_roughnessSampler")>-1&&r.push("HAS_ROUGHNESSMAP"),a.indexOf("u_metallicRoughnessSampler")>-1&&r.push("HAS_METALROUGHNESSMAP"),a.indexOf("u_emissiveSampler")>-1&&r.push("HAS_EMISSIVEMAP"),a.indexOf("u_occlusionSampler")>-1&&r.push("HAS_OCCLUSIONMAP"),a.indexOf("u_specularGlossinessSampler")>-1&&r.push("HAS_SPECULARGLOSSINESSMAP"),a.indexOf("u_perturbationSampler")>-1&&r.push("HAS_PERTURBATIONMAP"),a.indexOf("u_reflectionSampler")>-1&&r.push("HAS_REFLECTIONMAP"),a.indexOf("u_refractionSampler")>-1&&(this.setValueByParamName("PTMMatrix",new f(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1)),r.push("HAS_REFRACTIONMAP")),"MASK"===this.alphaMode?r.push("ALPHA_MASK"):"BLEND"!==this.alphaMode||this.refractionTexture||(r.push("ALPHA_BLEND"),a.indexOf("u_opacitySampler")>-1&&(r.push("HAS_OPACITYMAP"),this.getOpacityFromRGB&&r.push("GETOPACITYFROMRGB"))),this._envMapLightCount&&(r.push("O3_HAS_ENVMAP_LIGHT"),this._useDiffuseEnv&&r.push("O3_USE_DIFFUSE_ENV"),this._useSpecularEnv&&r.push("O3_USE_SPECULAR_ENV"),i.canIUse(Ce.shaderTextureLod)&&r.push("HAS_TEX_LOD")),this._ambientLightCount&&r.push("O3_HAS_AMBIENT_LIGHT"),this._directLightCount&&r.push("O3_DIRECT_LIGHT_COUNT "+this._directLightCount),this._pointLightCount&&r.push("O3_POINT_LIGHT_COUNT "+this._pointLightCount),this._spotLightCount&&r.push("O3_SPOT_LIGHT_COUNT "+this._spotLightCount),this._clipPlaneCount&&r.push("O3_CLIPPLANE_NUM "+this._clipPlaneCount),this._stateObj.unlit&&r.push("UNLIT"),this._stateObj.srgb&&r.push("MANUAL_SRGB"),this._stateObj.srgbFast&&r.push("SRGB_FAST_APPROXIMATION"),this._stateObj.gamma&&r.push("GAMMA"),this._stateObj.isMetallicWorkflow&&r.push("IS_METALLIC_WORKFLOW"),this._stateObj.envMapModeRefract&&r.push("ENVMAPMODE_REFRACT"),e._renderPipeline.canOIT&&r.push("OIT_ENABLE"),r},n._generateConfig=function(){var e=t.TECH_CONFIG.states,n={disable:e.disable.slice(),enable:e.enable.slice(),functions:Object.assign({},e.functions)};if(this.doubleSided)n.disable.push(ne.CULL_FACE);else switch(this.side){case ue.FRONT:n.functions.cullFace=[oe.BACK];break;case ue.BACK:n.functions.cullFace=[oe.FRONT];break;case ue.NONE:n.functions.cullFace=[oe.FRONT_AND_BACK];break;default:delete n.functions.cullFace}"BLEND"!==this.alphaMode||this.refractionTexture?this.renderType=ee.OPAQUE:(n.enable.push(ne.BLEND),this.blendFunc.length?n.functions.blendFunc=this._stateObj.blendFunc:n.functions.blendFuncSeparate=this._stateObj.blendFuncSeparate,n.functions.depthMask=this._stateObj.depthMask,this.renderType=ee.TRANSPARENT);for(var i={},r=0;r<this._clipPlaneCount;r++)i["u_clipPlanes["+r+"]"]={name:"u_clipPlanes["+r+"]",type:_e.FLOAT_VEC4};return t.TECH_CONFIG.uniforms=Object.assign({},t.TECH_CONFIG.uniforms,i),Object.assign({},t.TECH_CONFIG,{states:n})},n.clone=function(e){var n=new t(this._engine,e||this.name);for(var i in n.renderType=this.renderType,n.useFog=this.useFog,this._uniformObj){var r=this._uniformObj[i];n[i]=r instanceof xn?r:P.clone(r)}return this._stateObj&&(n._stateObj=P.clone(this._stateObj)),n},E(t,[{key:"baseColorFactor",get:function(){return this._uniformObj.baseColorFactor},set:function(e){this._uniformObj.baseColorFactor=e,this.setValueByParamName("baseColorFactor",e)}},{key:"opacity",get:function(){return this.baseColorFactor[3]},set:function(e){this.baseColorFactor[3]=e}},{key:"baseColorTexture",get:function(){return this._uniformObj.baseColorTexture},set:function(e){this.setValueByParamName("baseColorTexture",e),this._uniformObj.baseColorTexture=e}},{key:"opacityTexture",get:function(){return this._uniformObj.opacityTexture},set:function(e){this.setValueByParamName("opacityTexture",e),this._uniformObj.opacityTexture=e}},{key:"metallicFactor",get:function(){return this._uniformObj.metallicFactor},set:function(e){this._uniformObj.metallicFactor=e,this._uniformObj.metallicRoughness.x=e,this.setValueByParamName("metallicRoughness",this._uniformObj.metallicRoughness)}},{key:"roughnessFactor",get:function(){return this._uniformObj.roughnessFactor},set:function(e){this._uniformObj.roughnessFactor=e,this._uniformObj.metallicRoughness.y=e,this.setValueByParamName("metallicRoughness",this._uniformObj.metallicRoughness)}},{key:"metallicTexture",get:function(){return this._uniformObj.metallicTexture},set:function(e){this.setValueByParamName("metallicTexture",e),this._uniformObj.metallicTexture=e}},{key:"roughnessTexture",get:function(){return this._uniformObj.roughnessTexture},set:function(e){this.setValueByParamName("roughnessTexture",e),this._uniformObj.roughnessTexture=e}},{key:"metallicRoughnessTexture",get:function(){return this._uniformObj.metallicRoughnessTexture},set:function(e){this.setValueByParamName("metallicRoughnessTexture",e),this._uniformObj.metallicRoughnessTexture=e}},{key:"normalTexture",get:function(){return this._uniformObj.normalTexture},set:function(e){this.setValueByParamName("normalTexture",e),this._uniformObj.normalTexture=e}},{key:"normalScale",get:function(){return this._uniformObj.normalScale},set:function(e){this._uniformObj.normalScale=e,this.setValueByParamName("normalScale",e)}},{key:"emissiveTexture",get:function(){return this._uniformObj.emissiveTexture},set:function(e){this.setValueByParamName("emissiveTexture",e),this._uniformObj.emissiveTexture=e}},{key:"emissiveFactor",get:function(){return this._uniformObj.emissiveFactor},set:function(e){this._uniformObj.emissiveFactor=e,this.setValueByParamName("emissiveFactor",e)}},{key:"occlusionTexture",get:function(){return this._uniformObj.occlusionTexture},set:function(e){this.setValueByParamName("occlusionTexture",e),this._uniformObj.occlusionTexture=e}},{key:"occlusionStrength",get:function(){return this._uniformObj.occlusionStrength},set:function(e){this._uniformObj.occlusionStrength=e,this.setValueByParamName("occlusionStrength",e)}},{key:"alphaCutoff",get:function(){return this._uniformObj.alphaCutoff},set:function(e){this._uniformObj.alphaCutoff=e,this.setValueByParamName("alphaCutoff",e)}},{key:"specularFactor",get:function(){return this._uniformObj.specularFactor},set:function(e){this.setValueByParamName("specularFactor",e),this._uniformObj.specularFactor=e}},{key:"glossinessFactor",get:function(){return this._uniformObj.glossinessFactor},set:function(e){this.setValueByParamName("glossinessFactor",e),this._uniformObj.glossinessFactor=e}},{key:"specularGlossinessTexture",get:function(){return this._uniformObj.specularGlossinessTexture},set:function(e){this.setValueByParamName("specularGlossinessTexture",e),this._uniformObj.specularGlossinessTexture=e}},{key:"reflectionTexture",get:function(){return this._uniformObj.reflectionTexture},set:function(e){this.setValueByParamName("reflectionTexture",e),this._uniformObj.reflectionTexture=e}},{key:"envMapIntensity",get:function(){return this._uniformObj.envMapIntensity},set:function(e){this.setValueByParamName("envMapIntensity",e),this._uniformObj.envMapIntensity=e}},{key:"refractionRatio",get:function(){return this._uniformObj.refractionRatio},set:function(e){this.setValueByParamName("refractionRatio",e),this._uniformObj.refractionRatio=e}},{key:"refractionDepth",get:function(){return this._uniformObj.refractionDepth},set:function(e){this.setValueByParamName("refractionDepth",e),this._uniformObj.refractionDepth=e}},{key:"refractionTexture",get:function(){return this._uniformObj.refractionTexture},set:function(e){this.setValueByParamName("refractionTexture",e),this._uniformObj.refractionTexture=e}},{key:"perturbationTexture",get:function(){return this._uniformObj.perturbationTexture},set:function(e){this.setValueByParamName("perturbationTexture",e),this._uniformObj.perturbationTexture=e}},{key:"perturbationUOffset",get:function(){return this._uniformObj.perturbationUOffset},set:function(e){this.setValueByParamName("perturbationUOffset",e),this._uniformObj.perturbationUOffset=e}},{key:"perturbationVOffset",get:function(){return this._uniformObj.perturbationVOffset},set:function(e){this.setValueByParamName("perturbationVOffset",e),this._uniformObj.perturbationVOffset=e}},{key:"alphaMode",get:function(){return this._stateObj.alphaMode},set:function(e){this.updateTechnique("alphaMode",e)}},{key:"doubleSided",get:function(){return this._stateObj.doubleSided},set:function(e){e?this._stateObj.side=ue.DOUBLE:this._stateObj.side===ue.DOUBLE&&(this._stateObj.side=ue.FRONT),this.updateTechnique("doubleSided",e)}},{key:"side",get:function(){return this._stateObj.side},set:function(e){e===ue.DOUBLE?this._stateObj.doubleSided=!0:this._stateObj.doubleSided=!1,this.updateTechnique("side",e)}},{key:"unlit",get:function(){return this._stateObj.unlit},set:function(e){this.updateTechnique("unlit",e)}},{key:"srgb",get:function(){return this._stateObj.srgb},set:function(e){this.updateTechnique("srgb",e)}},{key:"srgbFast",get:function(){return this._stateObj.srgbFast},set:function(e){this.updateTechnique("srgbFast",e)}},{key:"gamma",get:function(){return this._stateObj.gamma},set:function(e){this.updateTechnique("gamma",e)}},{key:"blendFunc",get:function(){return this._stateObj.blendFunc},set:function(e){this.updateTechnique("blendFunc",e)}},{key:"blendFuncSeparate",get:function(){return this._stateObj.blendFuncSeparate},set:function(e){this.updateTechnique("blendFuncSeparate",e)}},{key:"depthMask",get:function(){return this._stateObj.depthMask},set:function(e){this.updateTechnique("depthMask",e)}},{key:"getOpacityFromRGB",get:function(){return this._stateObj.getOpacityFromRGB},set:function(e){this.updateTechnique("getOpacityFromRGB",e)}},{key:"isMetallicWorkflow",get:function(){return this._stateObj.isMetallicWorkflow},set:function(e){this.updateTechnique("isMetallicWorkflow",e)}},{key:"envMapModeRefract",get:function(){return this._stateObj.envMapModeRefract},set:function(e){this.updateTechnique("envMapModeRefract",e)}}]),t}(Ln);Ni.MATERIAL_NAME="PBR_MATERIAL",Ni.TECHNIQUE_NAME="PBR_TECHNIQUE",Ni.STATIC_VERTEX_SHADER="#include <common>\n#include <common_vert>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <clipPlane_vert_define>\n#include <morph_target_vert>\n\n#include <fog_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n\n    #include <morph_vert>\n    #include <skinning_vert>\n    #include <uv_vert>\n    #include <color_vert>\n    #include <normal_vert>\n    #include <worldpos_vert>\n    #include <clipPlane_vert>\n    #include <position_vert>\n\n    #include <fog_vert>\n}\n",Ni.STATIC_FRAGMENT_SHADER="#include <common>\n#include <common_frag>\n#include <pbr_common_frag_define>\n#include <pbr_util_frag_define>\n\n#include <fog_share>\n\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <refraction_share>\n#include <perturbation_share>\n#include <clipPlane_frag_define>\n\n// light\n#include <ambient_light_frag>\n#include <direct_light_frag>\n#include <point_light_frag>\n#include <spot_light_frag>\n#include <pbr_envmap_light_frag_define>\n\n// prop & texture\n#include <pbr_base_frag_define>\n#include <pbr_texture_frag_define>\n\n// runtime context\n#include <pbr_runtime_frag_define>\n\n// todo: generalize\n#include <pbr_normal_frag_define>\n\n\n// todo: BxDF\n#include <pbr_brdf_cook_torrance_frag_define>\n\n\n// direct + indirect\n#include <pbr_direct_irradiance_frag_define>\n#include <pbr_ibl_diffuse_frag_define>\n#include <pbr_ibl_specular_frag_define>\n\n#include <oit_frag_define>\n\n\nvoid main() {\n    #include <clipPlane_frag>\n\n    #include <pbr_begin_frag>\n    #include <pbr_direct_irradiance_frag>\n    #include <pbr_ibl_diffuse_frag>\n    #include <pbr_ibl_specular_frag>\n    // todo: generalize texture logic\n    #include <pbr_end_frag>\n    #include <gamma_frag>\n    #include <refraction_frag>\n    #include <perturbation_frag>\n    #include <fog_frag>\n\n    #include <oit_frag>\n\n    // gl_FragColor = texture2D( u_baseColorSampler, v_uv );\n}\n",Ni.attribUniformVec4=12,Ni.TECH_CONFIG={attributes:{},uniforms:Object.assign({u_baseColorSampler:{name:"u_baseColorSampler",paramName:"baseColorTexture",type:_e.SAMPLER_2D},u_baseColorFactor:{name:"u_baseColorFactor",paramName:"baseColorFactor",type:_e.FLOAT_VEC4},u_normalSampler:{name:"u_normalSampler",paramName:"normalTexture",type:_e.SAMPLER_2D},u_normalScale:{name:"u_normalScale",paramName:"normalScale",type:_e.FLOAT},u_lightDirection:{name:"u_lightDirection",type:_e.FLOAT_VEC3},u_lightColor:{name:"u_lightColor",type:_e.FLOAT_VEC3},u_metallicRoughnessValue:{name:"u_metallicRoughnessValue",paramName:"metallicRoughness",type:_e.FLOAT_VEC2},u_metallicSampler:{name:"u_metallicSampler",paramName:"metallicTexture",type:_e.SAMPLER_2D},u_roughnessSampler:{name:"u_roughnessSampler",paramName:"roughnessTexture",type:_e.SAMPLER_2D},u_metallicRoughnessSampler:{name:"u_metallicRoughnessSampler",paramName:"metallicRoughnessTexture",type:_e.SAMPLER_2D},u_emissiveFactor:{name:"u_emissiveFactor",paramName:"emissiveFactor",type:_e.FLOAT_VEC3},u_emissiveSampler:{name:"u_emissiveSampler",paramName:"emissiveTexture",type:_e.SAMPLER_2D},u_occlusionSampler:{name:"u_occlusionSampler",paramName:"occlusionTexture",type:_e.SAMPLER_2D},u_occlusionStrength:{name:"u_occlusionStrength",paramName:"occlusionStrength",type:_e.FLOAT},u_alphaCutoff:{name:"u_alphaCutoff",paramName:"alphaCutoff",type:_e.FLOAT},u_opacitySampler:{name:"u_opacitySampler",paramName:"opacityTexture",type:_e.SAMPLER_2D},u_specularFactor:{name:"u_specularFactor",paramName:"specularFactor",type:_e.FLOAT_VEC3},u_glossinessFactor:{name:"u_glossinessFactor",paramName:"glossinessFactor",type:_e.FLOAT},u_specularGlossinessSampler:{name:"u_specularGlossinessSampler",paramName:"specularGlossinessTexture",type:_e.SAMPLER_2D},u_reflectionSampler:{name:"u_reflectionSampler",paramName:"reflectionTexture",type:_e.SAMPLER_CUBE},u_PTMMatrix:{name:"u_PTMMatrix",paramName:"PTMMatrix",type:_e.FLOAT_MAT4},u_envMapIntensity:{name:"u_envMapIntensity",paramName:"envMapIntensity",type:_e.FLOAT},u_refractionRatio:{name:"u_refractionRatio",paramName:"refractionRatio",type:_e.FLOAT},u_refractionDepth:{name:"u_refractionDepth",paramName:"refractionDepth",type:_e.FLOAT},u_refractionSampler:{name:"u_refractionSampler",paramName:"refractionTexture",type:_e.SAMPLER_2D},u_resolution:{name:"u_resolution",paramName:"resolution",type:_e.FLOAT_VEC2},u_perturbationSampler:{name:"u_perturbationSampler",paramName:"perturbationTexture",type:_e.SAMPLER_2D},u_perturbationUOffset:{name:"u_perturbationUOffset",paramName:"perturbationUOffset",type:_e.FLOAT},u_perturbationVOffset:{name:"u_perturbationVOffset",paramName:"perturbationVOffset",type:_e.FLOAT},u_depthSampler:{name:"u_depthSampler",type:_e.SAMPLER_2D}}),states:{disable:[],enable:[],functions:{}}};var Di=function(e){function t(t){return e.call(this,t)||this}A(t,e);var n=t.prototype;return n.init=function(e){if(this._options={position:e.__position,positionRandomness:e.__positionRandomness,velocity:e.__velocity,velocityRandomness:e.__velocityRandomness,acceleration:e.__acceleration,accelerationRandomness:e.__accelerationRandomness,color:e.__color,colorRandomness:e.__colorRandomness,lifetime:e.__lifetime,size:e.__size,sizeRandomness:e.__sizeRandomness,startAngle:e.__startAngle,startAngleRandomness:e.__startAngleRandomness,rotateRate:e.__rotateRate,rotateRateRandomness:e.__rotateRateRandomness,scaleFactor:e.__scaleFactor,alpha:e.__alpha,alphaRandomness:e.__alphaRandomness,startTimeRandomness:e.__startTimeRandomness},this._config={maxCount:e.__maxCount,once:e.__once,rotateToVelocity:e.__rotateToVelocity,isScaleByLifetime:e.__isScaleByLifetime,fadeIn:e.__fadeIn,fadeOut:e.__fadeOut,texture:e.__texture?e.__texture:null,maskTexture:e.__maskTexture?e.__maskTexture:null,useOriginColor:e.__useOriginColor,is2d:e.__is2d,options:this._options},e.__spriteSheet)if("object"==typeof e.__spriteSheet&&e.__spriteSheet.length)this._config.spriteSheet=e.__spriteSheet;else if("string"==typeof e.__spriteSheet)try{var t=JSON.parse(e.__spriteSheet);t.length&&(this._config.spriteSheet=t)}catch(e){}if(e.__positionArray)if("object"==typeof e.__positionArray&&e.__positionArray.length)this._options.positionArray=e.__positionArray;else if("string"==typeof e.__positionArray)try{var n=JSON.parse(e.__positionArray);n.length&&(this._options.positionArray=n)}catch(e){}e.__separate?this._config.blendFuncSeparate=[ge[e.__srcRGB||"SRC_ALPHA"],ge[e.__dstRGB||"ONE_MINUS_SRC_ALPHA"],ge[e.__srcAlpha||"SRC_ALPHA"],ge[e.__dstAlpha||"ONE_MINUS_SRC_ALPHA"]]:e.__src&&e.__dst&&(this._config.blendFunc=[ge[e.__src],ge[e.__dst]]),this.initialize(this._config),!0!==e.__defaultStart&&void 0!==e.__defaultStart||this.start()},n.updateOption=function(e,t){var n;this._options=g({},this._options,((n={})[e]=t,n)),this._config=g({},this._config,{options:g({},this._options)}),this.initialize(this._config),this.start()},n.updateConfig=function(e,t){var n;this._config=g({},this._config,((n={})[e]=t,n)),this.initialize(this._config),this.start()},E(t,[{key:"__position",set:function(e){this.updateOption("position",e)}},{key:"__positionRandomness",set:function(e){this.updateOption("positionRandomness",e)}},{key:"__velocity",set:function(e){this.updateOption("velocity",e)}},{key:"__velocityRandomness",set:function(e){this.updateOption("velocityRandomness",e)}},{key:"__acceleration",set:function(e){this.updateOption("acceleration",e)}},{key:"__accelerationRandomness",set:function(e){this.updateOption("accelerationRandomness",e)}},{key:"__color",set:function(e){this.updateOption("color",e)}},{key:"__colorRandomness",set:function(e){this.updateOption("colorRandomness",e)}},{key:"__lifetime",set:function(e){this.updateOption("lifetime",e)}},{key:"__size",set:function(e){this.updateOption("size",e)}},{key:"__sizeRandomness",set:function(e){this.updateOption("sizeRandomness",e)}},{key:"__startAngle",set:function(e){this.updateOption("startAngle",e)}},{key:"__startAngleRandomness",set:function(e){this.updateOption("startAngleRandomness",e)}},{key:"__rotateRate",set:function(e){this.updateOption("rotateRate",e)}},{key:"__rotateRateRandomness",set:function(e){this.updateOption("rotateRateRandomness",e)}},{key:"__scaleFactor",set:function(e){this.updateOption("scaleFactor",e)}},{key:"__alpha",set:function(e){this.updateOption("alpha",e)}},{key:"__alphaRandomness",set:function(e){this.updateOption("alphaRandomness",e)}},{key:"__startTimeRandomness",set:function(e){this.updateOption("startTimeRandomness",e)}},{key:"__positionArray",set:function(e){if("object"==typeof e&&e.length)this.updateOption("positionArray",e);else if("string"==typeof e)try{var t=JSON.parse(e);t.length?this.updateOption("positionArray",t):this.updateOption("positionArray",null)}catch(e){this.updateOption("positionArray",null)}else this.updateOption("positionArray",null)}},{key:"__maxCount",set:function(e){this.updateConfig("maxCount",e)}},{key:"__useOriginColor",set:function(e){this.updateConfig("useOriginColor",e)}},{key:"__once",set:function(e){this.updateConfig("once",e)}},{key:"__rotateToVelocity",set:function(e){this.updateConfig("rotateToVelocity",e)}},{key:"__isScaleByLifetime",set:function(e){this.updateConfig("isScaleByLifetime",e)}},{key:"__fadeIn",set:function(e){this.updateConfig("fadeIn",e)}},{key:"__fadeOut",set:function(e){this.updateConfig("fadeOut",e)}},{key:"__texture",set:function(e){this.updateConfig("texture",e)}},{key:"__maskTexture",set:function(e){this.updateConfig("maskTexture",e)}},{key:"__spriteSheet",set:function(e){if("object"==typeof e&&e.length)this.updateConfig("spriteSheet",e);else if("string"==typeof e)try{var t=JSON.parse(e);t.length?this.updateConfig("spriteSheet",t):this.updateConfig("spriteSheet",null)}catch(e){this.updateConfig("spriteSheet",null)}else this.updateConfig("spriteSheet",null)}},{key:"__is2d",set:function(e){this.updateConfig("is2d",e)}}]),t}(function(e){function t(t){var n;return(n=e.call(this,t)||this)._time=0,n._isInit=!1,n._isStart=!1,n}A(t,e);var n=t.prototype;return n.initialize=function(e){this.maxCount=void 0!==e.maxCount?e.maxCount:1e3,this.once=e.once||!1,this.options=e.options||{},this.getOptions=e.getOptions,this.rotateToVelocity=e.rotateToVelocity||!1,e.blendFuncSeparate&&(this.blendFuncSeparate=e.blendFuncSeparate),this.blendFunc=e.blendFunc||[ge.SRC_ALPHA,ge.ONE_MINUS_SRC_ALPHA],this.useOriginColor=void 0===e.useOriginColor||e.useOriginColor,this.fragmentShader=e.fragmentShader||null,this.vertexShader=e.vertexShader||null,this.particleTex=e.texture||null,this.fadeIn=e.fadeIn||!1,this.fadeOut=void 0===e.fadeOut||e.fadeOut,this.particleMaskTex=e.maskTexture||null,this.isScaleByLifetime=e.isScaleByLifetime||!1,this.scaleFactor=e.scaleFactor||1,this.spriteSheet=e.spriteSheet||null,this.is2d=void 0===e.is2d||e.is2d,this.interleaved=e.spriteSheet||!0,this.setMaterial(),this.geometry=this._createGeometry(),this._isInit=!0;for(var t=this.getOptions?this.getOptions(this._time):this.options,n=0;n<this.maxCount;n++)this._spawnParticle(t,n);return this._vertexBuffer.setData(this._vertices),this},n.update=function(e){this._isInit&&this._isStart&&(this._time+=e/1e3,this.material.setValue("uTime",this._time))},n.setOptions=function(e){return void 0!==e&&(this.options=g({},this.options,e)),this},n.start=function(){this._isStart=!0,this._time=0,this.material.setValue("uActive",1)},n.stop=function(){this.material.setValue("uActive",0)},n.destroy=function(){e.prototype.destroy.call(this),this.options=null,this.particleTex&&(this.particleTex=null),this.particleMaskTex&&(this.particleMaskTex=null)},n.setMaterial=function(){var e=this._createTechnique(),t=new Ln(this.engine,"particleMaterial");t.technique=e,t.renderType=ee.TRANSPARENT,t.setValue("uOnce",this.once?1:0),t.setValue("uTime",this._time),this.particleTex&&(this.particleTex.wrapModeU=this.particleTex.wrapModeV=fn.Clamp,t.setValue("particleTex",this.particleTex)),this.particleMaskTex&&(this.particleMaskTex.wrapModeU=this.particleTex.wrapModeV=fn.Clamp,t.setValue("particleMaskTex",this.particleMaskTex)),this.material=t},n._createTechnique=function(){var e={attributes:{positionStart:{name:"positionStart",semantic:"POSITIONSTART",type:_e.FLOAT_VEC3},color:{name:"color",semantic:"COLOR",type:_e.FLOAT_VEC3},alpha:{name:"alpha",semantic:"ALPHA",type:_e.FLOAT},acceleration:{name:"acceleration",semantic:"ACCELERATION",type:_e.FLOAT_VEC3},velocity:{name:"velocity",semantic:"VELOCITY",type:_e.FLOAT_VEC3},startAngle:{name:"startAngle",semantic:"STARTANGLE",type:_e.FLOAT},lifeTime:{name:"lifeTime",semantic:"LIFETIME",type:_e.FLOAT},startTime:{name:"startTime",semantic:"STARTTIME",type:_e.FLOAT},size:{name:"size",semantic:"SIZE",type:_e.FLOAT},rotateRate:{name:"rotateRate",semantic:"ROTATERATE",type:_e.FLOAT},scaleFactor:{name:"scaleFactor",semantic:"SCALEFACTOR",type:_e.FLOAT},uv:{name:"uv",semantic:"UV",type:_e.FLOAT_VEC3},normalizedUv:{name:"normalizedUv",semantic:"NORMALIZED_UV",type:_e.FLOAT_VEC2}},uniforms:{uOnce:{name:"uOnce",type:_e.FLOAT},uActive:{name:"uActive",type:_e.FLOAT},uTime:{name:"uTime",type:_e.FLOAT},matModelViewProjection:{name:"matModelViewProjection",semantic:me.MODELVIEWPROJECTION,type:_e.FLOAT_MAT4},matModelView:{name:"matModelView",semantic:me.MODELVIEW,type:_e.FLOAT_MAT4}},states:{enable:[ne.BLEND],functions:{depthMask:[!1]}}};this.is2d?(e.uniforms.matViewInverse={name:"matViewInverse",semantic:me.VIEWINVERSE,type:_e.FLOAT_MAT4},e.uniforms.matProjection={name:"matProjection",semantic:me.PROJECTION,type:_e.FLOAT_MAT4},e.uniforms.matView={name:"matView",semantic:me.VIEW,type:_e.FLOAT_MAT4},e.uniforms.matWorld={name:"matWorld",semantic:me.MODEL,type:_e.FLOAT_MAT4}):e.states.disable=[ne.CULL_FACE],this.blendFuncSeparate?e.states.functions.blendFuncSeparate=this.blendFuncSeparate:e.states.functions.blendFunc=this.blendFunc,this.particleTex&&(e.uniforms.particleTex={name:"particleTex",type:_e.SAMPLER_2D}),this.particleMaskTex&&(e.uniforms.particleMaskTex={name:"particleMaskTex",type:_e.SAMPLER_2D});var t=new Zn("particleTech");return t.isValid=!0,t.uniforms=e.uniforms,t.attributes=e.attributes,t.states=e.states,t.vertexShader=this._createVertexShader(),t.fragmentShader=this._createFragmentShader(),t},n._createGeometry=function(){for(var e=new Oi(this._entity.engine,"particleGeometry"),t=4*this.maxCount*96,n=new Float32Array(t),i=new Uint16Array(6*this.maxCount),r=0,a=0;r<this.maxCount;++r){var o=4*r;i[a++]=o+0,i[a++]=o+1,i[a++]=o+2,i[a++]=o+0,i[a++]=o+2,i[a++]=o+3}var s=[new Wn("POSITIONSTART",0,Sn.Vector3,0),new Wn("VELOCITY",12,Sn.Vector3,0),new Wn("ACCELERATION",24,Sn.Vector3,0),new Wn("COLOR",36,Sn.Vector3,0),new Wn("ALPHA",48,Sn.Float,0),new Wn("SIZE",52,Sn.Float,0),new Wn("ROTATERATE",56,Sn.Float,0),new Wn("STARTTIME",60,Sn.Float,0),new Wn("LIFETIME",64,Sn.Float,0),new Wn("STARTANGLE",68,Sn.Float,0),new Wn("SCALEFACTOR",72,Sn.Float,0),new Wn("UV",76,Sn.Vector3,0),new Wn("NORMALIZED_UV",88,Sn.Vector2,0)],u=new kn(this.engine,Fn.VertexBuffer,4*t,Cn.Dynamic),c=new kn(this.engine,Fn.IndexBuffer,i,Cn.Dynamic);return e.setVertexBufferBinding(u,96),e.setIndexBufferBinding(c,Mn.UInt16),e.setVertexElements(s),e.addSubGeometry(0,i.length),this._vertexBuffer=u,this._vertexStride=96,this._vertices=n,e},n._spawnParticle=function(e,t){var n=void 0!==e.position?e.position.clone():new s,i=void 0!==e.positionRandomness?e.positionRandomness.clone():new s,r=e.positionArray,a=void 0!==e.velocity?e.velocity.clone():new s,u=void 0!==e.velocityRandomness?e.velocityRandomness.clone():new s,c=void 0!==e.color?e.color.clone():new s(1,1,1),l=void 0!==e.colorRandomness?e.colorRandomness:1,f=void 0!==e.alpha?e.alpha:1,h=void 0!==e.alphaRandomness?e.alphaRandomness:0,d=void 0!==e.lifetime?e.lifetime:5,_=void 0!==e.size?e.size:1,p=void 0!==e.sizeRandomness?e.sizeRandomness:0,m=void 0!==e.smoothPosition&&e.smoothPosition,v=void 0!==e.startTimeRandomness?e.startTimeRandomness:0,g=void 0!==e.acceleration?e.acceleration.clone():new s,y=void 0!==e.accelerationRandomness?e.accelerationRandomness.clone():new s,x=void 0!==e.startAngle?e.startAngle:0,T=void 0!==e.startAngleRandomness?e.startAngleRandomness:0,b=void 0!==e.rotateRate?e.rotateRate:0,E=void 0!==e.rotateRateRandomness?e.rotateRateRandomness:0,A=void 0!==e.scaleFactor?e.scaleFactor:1,O=n.x,C=n.y,R=n.z;if(r){if(r.length!==this.maxCount)throw Error("The length of positionArray must be equal to maxCount.");O+=r[t].x,C+=r[t].y,R+=r[t].z}else O+=this._getRandom()*i.x,C+=this._getRandom()*i.y,R+=this._getRandom()*i.z;!0===m&&(O+=-a.x*this._getRandom(),C+=-a.y*this._getRandom(),R+=-a.z*this._getRandom());var S=a.x+this._getRandom()*u.x,w=a.y+this._getRandom()*u.y,M=a.z+this._getRandom()*u.z,P=g.x+this._getRandom()*y.x,L=g.y+this._getRandom()*y.y,I=g.z+this._getRandom()*y.z;c.x=o.clamp(c.x+this._getRandom()*l,0,1),c.y=o.clamp(c.y+this._getRandom()*l,0,1),c.z=o.clamp(c.z+this._getRandom()*l,0,1),_=Math.max(_+this._getRandom()*p*_*2,0);for(var F=d+this._getRandom()*d,N=x+this._getRandom()*Math.PI*T*2,D=b+this._getRandom()*E,z=o.clamp(f+this._getRandom()*h,0,1),V=Math.random()*v,B=this._vertices,U=0;U<4;U++){var k=(4*t+U)*this._vertexStride/4;B[k]=O,B[k+1]=C,B[k+2]=R,B[k+3]=S,B[k+4]=w,B[k+5]=M,B[k+6]=P,B[k+7]=L,B[k+8]=I,B[k+9]=c[0],B[k+10]=c[1],B[k+11]=c[2],B[k+12]=z,B[k+13]=_,B[k+14]=D,B[k+15]=V,B[k+16]=F,B[k+17]=N,B[k+18]=A,this._setUvs(t,U,k)}},n._setUvs=function(e,t,n){var i,r=this.spriteSheet,a=this.particleTex;if(a){var o=a.image?a.image.width:a.width,s=a.image?a.image.height:a.height;if(r){var u=r[e%r.length],c=u.x,l=u.y,f=u.w,h=u.h,d=c/o,_=l/s,p=d+f/o,m=_+h/s;i=[[d,m,h/f],[p,m,h/f],[p,_,h/f],[d,_,h/f]]}else i=[[0,0,s/o],[1,0,s/o],[1,1,s/o],[0,1,s/o]]}else i=[[0,0,1],[1,0,1],[1,1,1],[0,1,1]];var v=this._vertices,g=i[t];v[n+19]=g[0],v[n+20]=g[1],v[n+21]=g[2];var y=[[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]][t];v[n+22]=y[0],v[n+23]=y[1]},n._getRandom=function(){return Math.random()-.5},n._getShader=function(){return{vertexShader:"\n        precision highp float;\n        precision highp int;\n\n        attribute float lifeTime;\n        attribute float startTime;\n        attribute float size;\n        attribute float rotateRate;\n        attribute vec3 velocity;\n        attribute vec3 acceleration;\n        attribute vec3 positionStart;\n        attribute vec3 color;\n        attribute float alpha;\n        attribute float startAngle;\n        attribute float scaleFactor;\n        attribute vec3 uv;\n        attribute vec2 normalizedUv;\n        \n        uniform float uTime;\n        uniform float uOnce;\n        uniform float uActive;\n        uniform mat4 matModelViewProjection;\n        uniform mat4 matModelView;\n        uniform mat4 matViewInverse;\n        uniform mat4 matView;\n        uniform mat4 matProjection;\n        uniform mat4 matWorld;\n\n        varying vec3 v_color;\n        varying float v_alpha;\n        varying float lifeLeft;\n        varying mat2 vTextureMat;\n        varying vec2 v_uv;\n\n        mat2 rotation2d(float angle) {\n          float s = sin(angle);\n          float c = cos(angle);\n        \n          return mat2(\n            c, -s,\n            s, c\n          );\n        }\n\n        void main()\n        {\n          v_color = color;\n          v_uv = uv.xy;\n          v_alpha = alpha;\n          \n          // float deltaTime = max(mod(uTime, lifeTime), 0.0);\n          // 真实的生命周期\n          float life = lifeTime + startTime;\n          // 当前已过去的时间\n          float deltaTime = max(mod(uTime, life) - startTime, 0.0);\n\n          bool isDying = false;\n\n          if (uOnce == 1.0 || uActive == 0.0) {\n            isDying = true;\n          }\n\n          if ((isDying && uTime > life)) {\n            deltaTime = life;\n          }\n\n          // 没出生就代表死亡，否则没出生就显示了\n          if (deltaTime == 0.0) {\n            deltaTime = life;\n          }\n\n          lifeLeft = 1.0 - deltaTime / lifeTime;\n          float scale = size;\n          vec3 position = positionStart + (velocity + acceleration * deltaTime * 0.5) * deltaTime;\n      ",postionShader:"\n        gl_Position = matModelViewProjection * vec4(position, 1.0 );\n      ",sizeVertexShader:"\n          scale *= pow(scaleFactor, deltaTime);\n      ",isScaleByLifetimeVertexShader:"\n          scale *= lifeLeft;\n      ",rotateToVelocityVertexShader:"\n        vec3 v = velocity + acceleration * deltaTime;\n        float angle = atan(v.z, v.x) * 2.0;\n        float s = sin(angle);\n        float c = cos(angle);\n      ",rotationVertexShader:"\n        float deltaAngle = deltaTime * rotateRate;\n        float angle = startAngle + deltaAngle;\n        float s = sin(angle);\n        float c = cos(angle);\n\n      ",rotation2dShader:"\n        vec2 rotatedPoint = rotation2d(angle) * vec2(normalizedUv.x, normalizedUv.y * uv.z);\n\n        vec3 basisX = matViewInverse[0].xyz;\n        vec3 basisZ = matViewInverse[1].xyz;\n\n        vec3 localPosition = vec3(basisX * rotatedPoint.x + \n                    basisZ * rotatedPoint.y) * scale + position;\n\n        gl_Position = matProjection * matView * vec4(localPosition + matWorld[3].xyz, 1.);\n      ",rotation3dShader:"\n        vec4 rotatedPoint = vec4((normalizedUv.x * c + normalizedUv.y * uv.z * s) * scale , 0., \n                                 (normalizedUv.x * s - normalizedUv.y * uv.z * c) * scale, 1.);\n      \n        vec4 orientation = vec4(0, 0, 0, 1);\n        vec4 q2 = orientation + orientation;\n        vec4 qx = orientation.xxxw * q2.xyzx;\n        vec4 qy = orientation.xyyw * q2.xyzy;\n        vec4 qz = orientation.xxzw * q2.xxzz;\n      \n        mat4 localMatrix = mat4(\n            (1.0 - qy.y) - qz.z, \n            qx.y + qz.w, \n            qx.z - qy.w,\n            0,\n      \n            qx.y - qz.w, \n            (1.0 - qx.x) - qz.z, \n            qy.z + qx.w,\n            0,\n      \n            qx.z + qy.w, \n            qy.z - qx.w, \n            (1.0 - qx.x) - qy.y,\n            0,\n      \n            position.x, position.y, position.z, 1);\n\n        rotatedPoint = localMatrix * rotatedPoint;\n\n        gl_Position = matModelViewProjection * rotatedPoint;\n      ",fragmentShader:"\n        precision mediump float;\n        precision mediump int;\n\n        varying vec3 v_color;\n        varying float v_alpha;\n        varying float lifeLeft;\n        varying vec2 v_uv;\n        uniform sampler2D particleTex;\n        uniform sampler2D particleMaskTex;\n\n        void main()\n        {\n          float alphaFactor = 1.0;\n      ",fadeInFragmentShader:"\n        float fadeInFactor = step(0.5, lifeLeft);\n        alphaFactor = 2.0 * fadeInFactor * (1.0 - lifeLeft) + (1.0 - fadeInFactor);\n      ",fadeOutFragmentShader:"\n        float fadeOutFactor = step(0.5, lifeLeft);\n        alphaFactor = alphaFactor * 2.0 * (1.0 - fadeOutFactor) * lifeLeft + alphaFactor * fadeOutFactor;\n      ",noImgFragmentShader:" \n        gl_FragColor = vec4( v_color, alphaFactor * v_alpha);\n      ",imgFragmentShader:"\n        vec4 tex = texture2D(particleTex, v_uv);\n      ",originColorFragmentShader:"\n        gl_FragColor = vec4(tex.rgb, alphaFactor * tex.a * v_alpha);\n      ",createColorFragmentShader:"\n        gl_FragColor = vec4(v_color * tex.rgb, alphaFactor * tex.a * v_alpha);\n      ",createColorWithMaskFragmentShader:"\n        vec4 maskTex = texture2D( particleMaskTex, v_uv);\n        gl_FragColor = vec4(v_color * tex.rgb + maskTex.a, alphaFactor * tex.a * v_alpha);\n      "}},n._createVertexShader=function(){var e=this._getShader(),t="";return this.vertexShader?t=this.vertexShader:(t=e.vertexShader,this.isScaleByLifetime?t+=e.isScaleByLifetimeVertexShader:t+=e.sizeVertexShader,this.rotateToVelocity?t+=e.rotateToVelocityVertexShader:t+=e.rotationVertexShader,this.is2d?t+=e.rotation2dShader:t+=e.rotation3dShader,t+="}"),t},n._createFragmentShader=function(){var e=this._getShader(),t="";return this.fragmentShader?t=this.fragmentShader:(t=e.fragmentShader,this.fadeIn&&(t+=e.fadeInFragmentShader),this.fadeOut&&(t+=e.fadeOutFragmentShader),this.particleTex?(t+=e.imgFragmentShader,this.useOriginColor?t+=e.originColorFragmentShader:this.particleMaskTex?t+=e.createColorWithMaskFragmentShader:t+=e.createColorFragmentShader):t+=e.noImgFragmentShader,t+="}"),t},t}(Ci)),zi=(new s,function(e){function t(t){var n;return(n=e.call(this,t)||this)._center=new s,n._size=new s,n.isShowCollider=!0,n.center=n.center,n.size=n.size,n.isShowCollider=n.isShowCollider,n}return A(t,e),E(t,[{key:"center",get:function(){return this._center},set:function(e){this._center=e,this.setBoxCenterSize(this._center,this._size)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this.setBoxCenterSize(this._center,this._size)}}]),t}(Yt)),Vi=function(e){function t(t){var n;return(n=e.call(this,t)||this).__center=new s,n.__radius=1,n.isShowCollider=!0,n._center=n._center,n._radius=n._radius,n.isShowCollider=n.isShowCollider,n}return A(t,e),E(t,[{key:"_center",get:function(){return this.__center},set:function(e){this.__center=e,this.setSphere(this.__center,this.__radius)}},{key:"_radius",get:function(){return this.__radius},set:function(e){this.__radius=e,this.setSphere(this.__center,this.__radius)}}]),t}(Qt);function Bi(e,t){var n=e.center,i=new s(Math.max(t.min.x,Math.min(n.x,t.max.x)),Math.max(t.min.y,Math.min(n.y,t.max.y)),Math.max(t.min.z,Math.min(n.z,t.max.z)));return s.distance(n,i)<e.radius}tt.registerFeature(qt),(function(e){function t(t){var n;return(n=e.call(this,t)||this)._colliderManager=null,n._myCollider=null,n._overlopCollider=null,n}A(t,e);var n=t.prototype;return n.onUpdate=function(t){e.prototype.onUpdate.call(this,t);var n=null;if(this._colliderManager&&this._myCollider){var i=this._colliderManager.colliders;if(this._myCollider instanceof Yt){this._box=this._getWorldBox(this._myCollider);for(var r=0,a=i.length;r<a;r++){var o=i[r];o!=this._myCollider&&this._boxCollision(o)&&(n=o,this.trigger(new V("collision",this,{collider:o})))}}else if(this._myCollider instanceof Qt){this._sphere=this._getWorldSphere(this._myCollider);for(var s=0,u=i.length;s<u;s++){var c=i[s];c!=this._myCollider&&this._sphereCollision(c)&&(n=c,this.trigger(new V("collision",this,{collider:c})))}}}if(null!=n&&this._overlopCollider!=n&&this.trigger(new V("begin_overlop",this,{collider:n})),null!=this._overlopCollider&&this._overlopCollider!=n){var l=this._overlopCollider;this.trigger(new V("end_overlop",this,{collider:l}))}this._overlopCollider=n},n._getWorldBox=function(e){var n=e.entity.transform.worldMatrix,i=new s,r=new s;s.transformCoordinate(e.boxMax,n,i),s.transformCoordinate(e.boxMin,n,r);for(var a=t._tempVec3,o=e.getCorners(),u=0;u<8;u++)s.transformCoordinate(o[u],n,a),a.x>i.x&&(i.x=a.x),a.y>i.y&&(i.y=a.y),a.z>i.z&&(i.z=a.z),a.x<r.x&&(r.x=a.x),a.y<r.y&&(r.y=a.y),a.z<r.z&&(r.z=a.z);return{min:r,max:i}},n._getWorldSphere=function(e){var t=new s;return s.transformCoordinate(e.center,e.entity.transform.worldMatrix,t),{radius:e.radius,center:t}},n._boxCollision=function(e){if(e instanceof Yt){var t=this._getWorldBox(e);return n=t,i=this._box,n.min.x<=i.max.x&&n.max.x>=i.min.x&&n.min.y<=i.max.y&&n.max.y>=i.min.y&&n.min.z<=i.max.z&&n.max.z>=i.min.z}var n,i;return e instanceof Qt&&Bi(this._getWorldSphere(e),this._box)},n._sphereCollision=function(e){if(e instanceof Yt){var t=this._getWorldBox(e);return Bi(this._sphere,t)}if(e instanceof Qt){var n=this._getWorldSphere(e);return i=n,r=this._sphere,s.distance(i.center,r.center)<i.radius+i.radius}var i,r;return!1},n.onAwake=function(){this._colliderManager=this.scene.findFeature(qt),this._myCollider=this.entity.getComponent(Kt)},E(t,[{key:"overlopCollider",get:function(){return this._overlopCollider}}]),t}(ft))._tempVec3=new s;var Ui=function(e){function t(t){var n;return(n=e.call(this,t)||this).color=new s(1,0,0),n}A(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(Gi).fog=this},n._onDisable=function(){this.scene.findFeature(Gi).fog=null},n.bindMaterialValues=function(e){},t}(Xe),ki=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).density=.0025,t}return A(t,e),t.prototype.bindMaterialValues=function(e){e.setValue("u_fogColor",this.color),e.setValue("u_fogDensity",this.density)},t}(Ui);var Gi=function(e){function t(){var t;return(t=e.call(this)||this)._fog=null,t._macros=[],t}return A(t,e),t.prototype.bindFogToMaterial=function(e){return this.fog&&e.useFog&&this.fog.bindMaterialValues(e),this},E(t,[{key:"fog",get:function(){return this._fog},set:function(e){if(e!==this._fog){this._fog=e;var t=[];e instanceof Ui&&(t.push("O3_HAS_FOG"),e instanceof ki&&t.push("O3_FOG_EXP2")),this._macros.length!==t.length&&(this._macros=t)}}},{key:"macro",get:function(){return this._macros}}]),t}(st);tt.registerFeature(Gi),tt.prototype.hasFogFeature=function(){return!0},tt.prototype.getFogMacro=function(){return this.findFeature(Gi).macro},tt.prototype.bindFogToMaterial=function(e){this.findFeature(Gi).bindFogToMaterial(e)};var ji=0,Hi=function(e){function t(t){var n;return(n=e.call(this,t)||this).cacheId=ji++,n.renderPass=new vt("_renderPass"+n.cacheId,-10),n.renderPass.renderOverride=!0,n.renderPass.preRender=n.preRender.bind(y(n)),n.renderPass.render=n.render.bind(y(n)),n.renderPass.postRender=n.postRender.bind(y(n)),n.addEventListener("enabled",(function(){n.renderPass.enabled=!0})),n.addEventListener("disabled",(function(){n.renderPass.enabled=!1})),n}A(t,e),E(t,[{key:"camera",set:function(e){e!==this._camera&&(this._camera&&this.renderPipeline.removeRenderPass(this.renderPass),this._camera=e,e&&this.renderPipeline.addRenderPass(this.renderPass))},get:function(){return this._camera}},{key:"texture",get:function(){var e;return null==(e=this.renderPass.renderTarget)?void 0:e.getColorTexture()}},{key:"depthTexture",get:function(){var e;return null==(e=this.renderPass.renderTarget)?void 0:e.depthTexture}},{key:"cubeTexture",get:function(){var e;return null==(e=this.renderPass.renderTarget)?void 0:e.getColorTexture()}},{key:"renderPipeline",get:function(){return this.camera._renderPipeline}},{key:"rhi",get:function(){return this.camera.scene.engine._hardwareRenderer}},{key:"renderItems",get:function(){var e=this,t=this.renderPipeline.opaqueQueue,n=this.renderPipeline.transparentQueue;return t.items.concat(n.items).filter((function(t){return!!t.primitive&&(!e.excludeRenderList.includes(t.material)&&(!!e.renderAll||(!!e.renderList.includes(t.material)||void 0)))}))}},{key:"samples",get:function(){return this.renderTarget.antiAliasing}}]);var n=t.prototype;return n.init=function(e){void 0===e&&(e={}),this.isCube=!!e.isCube,this.camera=e.camera||this.scene._activeCameras[0],this.excludeRenderList=e.excludeRenderList||[],this.renderAll=!!e.renderAll,this.renderList=e.renderList||[],this.clipPlanes=e.clipPlanes||[];var t=e.width||1024,n=e.height||1024,i=e.samples||1;this.renderTarget=new ui(this.engine,t,n,new ci(this.engine,t,n,void 0,!1,this.isCube),vn.Depth,i),this.renderTargetSwap=new ui(this.engine,t,n,new ci(this.engine,t,n,void 0,!1,this.isCube),vn.Depth,i),this.renderPass.renderTarget=this.renderTarget},n.preRender=function(){this.oriClipPlane=this.scene.clipPlanes,this.scene.clipPlanes=this.clipPlanes},n.render=function(){var e=this,t=gt._getRenderContext(this.camera);this.renderItems.forEach((function(n){var i=n.component,r=n.primitive,a=n.subPrimitive,o=n.material;i.renderPassFlag&e.renderPassFlag&&(o.prepareDrawing(t,i,r),e.rhi.drawPrimitive(r,a,o))}))},n.postRender=function(){this.scene.clipPlanes=this.oriClipPlane,this.renderPass.enabled&&(this.onTextureChange&&(this.isCube?this.onTextureChange(this.cubeTexture):this.onTextureChange(this.texture,this.depthTexture)),this.renderPass.renderTarget===this.renderTarget?this.renderPass.renderTarget=this.renderTargetSwap:this.renderPass.renderTarget=this.renderTarget)},n.destroy=function(){this.enabled=!1,this.renderPipeline.removeRenderPass(this.renderPass),e.prototype.destroy.call(this),this.renderTarget.destroy(),this.renderTargetSwap.destroy()},n.onTextureChange=function(e,t){},t}(Xe),Wi=function(e){function t(t){return e.call(this,t)||this}A(t,e);var n=t.prototype;return n.init=function(t){void 0===t&&(t={}),e.prototype.init.call(this,t)},n.storeMaterial=function(){this.renderItems.forEach((function(e){var t=e.material;e.initialSide=t.side,t.side=ue.BACK}))},n.restoreMaterial=function(){this.renderItems.forEach((function(e){e.material.side=e.initialSide,delete e.initialSide}))},n.preRender=function(){e.prototype.preRender.call(this),this.storeMaterial()},n.postRender=function(){e.prototype.postRender.call(this),this.restoreMaterial()},t}(Hi),Xi=(new s,new s,new s,Math.PI,function(){function e(e){void 0===e&&(e={engine:null,width:512,height:512}),this._mapSize=new _(e.width,e.height),this._renderTarget=new ui(e.engine,e.width,e.height,new ci(e.engine,e.width,e.height)),this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new f}var t=e.prototype;return t.initShadowProjectionMatrix=function(e){if(e instanceof kt&&f.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof Ht&&f.perspective(o.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof Wt){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));f.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}},t.bindShadowValues=function(e,t,n){e.setValue("u_viewMatFromLight["+t+"]",n.viewMatrix),e.setValue("u_projMatFromLight["+t+"]",this.projectionMatrix);var i="u_shadows["+t+"]";e.setValue(i+".bias",this.bias),e.setValue(i+".intensity",this.intensity),e.setValue(i+".radius",this.radius),e.setValue(i+".mapSize",this._mapSize),e.setValue("u_shadowMaps["+t+"]",this.map)},e.getUniformDefine=function(e){var t={};t["u_viewMatFromLight["+e+"]"]={name:"u_viewMatFromLight["+e+"]",type:_e.FLOAT_MAT4},t["u_projMatFromLight["+e+"]"]={name:"u_projMatFromLight["+e+"]",type:_e.FLOAT_MAT4};var n="u_shadows["+e+"]";return t[n+".bias"]={name:n+".bias",type:_e.FLOAT},t[n+".intensity"]={name:n+".intensity",type:_e.FLOAT},t[n+".radius"]={name:n+".radius",type:_e.FLOAT},t[n+".mapSize"]={name:n+".mapSize",type:_e.FLOAT_VEC2},t["u_shadowMaps["+e+"]"]={name:"u_shadowMaps["+e+"]",type:_e.SAMPLER_2D},t},E(e,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),e}());Object.defineProperty(Bt.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof Ut)return void Ie("Has no shadow!");this.shadow=this.shadow||new Xi({engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Xe.prototype,"recieveShadow",{get:function(){return this._recieveShadow},set:function(e){this._recieveShadow=e}}),Object.defineProperty(Xe.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var qi="#include <common_vert>\n#include <normal_share>\n#include <shadow_share>\n\nvoid main() {\n\n    #include <begin_position_vert>\n    #include <begin_normal_vert>\n    #include <skinning_vert>\n    #include <shadow_vert>\n    #include <position_vert>\n\n}\n",Ki=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n._generateTechnique=function(e,t){var n=this._generateMacros(),i=this._generateFragmentUniform(),r=new Zn(this.name);return r.isValid=!0,r.uniforms=i,r.attributes={},r.states={},r.customMacros=n,r.vertexShader=qi,r.fragmentShader="precision mediump float;\n\n/**\n * 分解保存深度值\n*/\nvec4 pack (float depth) {\n\n  // 使用rgba 4字节共32位来存储z值,1个字节精度为1/256\n  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);\n\n  vec4 rgbaDepth = fract(depth * bitShift); //计算每个点的z值\n\n  // Cut off the value which do not fit in 8 bits\n  rgbaDepth -= rgbaDepth.gbaa * bitMask;\n\n  return rgbaDepth;\n}\n\nvoid main() {\n\n  // 将z值分开存储到rgba分量中,阴影颜色的同时也是深度值z\n  gl_FragColor = pack(gl_FragCoord.z);\n\n}",r},n._generateFragmentUniform=function(){return{u_viewMatFromLight:{name:"u_viewMatFromLight",type:_e.FLOAT_MAT4},u_projMatFromLight:{name:"u_projMatFromLight",type:_e.FLOAT_MAT4}}},n._generateMacros=function(){var e=[];return e.push("O3_GENERATE_SHADOW_MAP"),e},t}(In),Yi=function(e){function t(t,n,i,r,a,o){var s;return(s=e.call(this,t,n,i,r,a)||this).light=o,s}return A(t,e),t.prototype.preRender=function(e,t,n){this.replaceMaterial.setValue("u_viewMatFromLight",this.light.viewMatrix),this.replaceMaterial.setValue("u_projMatFromLight",this.light.shadow.projectionMatrix)},t}(vt),Qi=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n._generateTechnique=function(e,t){var n=this._generateMacros(),i=this._generateFragmentUniform(),r=new Zn(this.name);return r.autoConvert=!1,r.isValid=!0,r.uniforms=i,r.attributes={},r.states={},r.customMacros=n,r.vertexShader=qi,r.fragmentShader="varying vec2 v_uv;\n\nuniform vec4 u_ambientLight;\n\n#ifdef O3_SHADOW_MAP_COUNT\n\nstruct Shadow {\n  float     bias;\n  float     intensity;\n  vec2      mapSize;\n  float     radius;\n};\n\nuniform Shadow u_shadows[O3_SHADOW_MAP_COUNT];\n\nuniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];\n\nvarying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n\nconst vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0*256.0), 1.0/(256.0*256.0*256.0));\n\n/**\n* 释出深度值\n*/\nfloat unpack(const in vec4 rgbaDepth) {\n  return dot(rgbaDepth, bitShift);\n}\n\n/**\n* 判断是否需要显示阴影\n*/\nfloat getVisibility(vec4 positionFromLight, const in sampler2D shadowMap, vec2 mapSize, float intensity, float bias, float radius) {\n\n    vec3 shadowCoord = (positionFromLight.xyz/positionFromLight.w)/2.0 + 0.5;\n    float filterX = step(0.0, shadowCoord.x) * (1.0 - step(1.0, shadowCoord.x));\n    float filterY = step(0.0, shadowCoord.y) * (1.0 - step(1.0, shadowCoord.y));\n\n    shadowCoord.z -= bias;\n    vec2 texelSize = vec2( 1.0 ) / mapSize;\n\n    float visibility = 0.0;\n    for (float y = -1.0 ; y <=1.0 ; y+=1.0) {\n      for (float x = -1.0 ; x <=1.0 ; x+=1.0) {\n        vec2 uv = shadowCoord.xy + texelSize * vec2(x, y) * radius;\n        vec4 rgbaDepth = texture2D(shadowMap, uv);\n        float depth = unpack(rgbaDepth);\n        visibility += step(depth, shadowCoord.z) * intensity;\n      }\n    }\n\n    visibility *= ( 1.0 / 9.0 );\n    return visibility * filterX * filterY;\n\n}\n\n#endif\n\nvoid main() {\n\n  vec4 shadowColor = vec4(1.0, 1.0, 1.0, 1.0);\n\n#ifdef O3_SHADOW_MAP_COUNT\n\n  float visibility = 1.0;\n\n  for(int i = 0; i < O3_SHADOW_MAP_COUNT; i++) {\n\n   visibility -= getVisibility(v_PositionFromLight[i], u_shadowMaps[i], u_shadows[i].mapSize, u_shadows[i].intensity, u_shadows[i].bias, u_shadows[i].radius);\n\n  }\n\n  visibility = clamp(visibility, 0.0, 1.0);\n  shadowColor = vec4(visibility, visibility, visibility, 1.0);\n\n#endif\n\n  gl_FragColor = shadowColor;\n}",r.states={enable:[ne.BLEND],functions:{depthFunc:[le.LEQUAL],blendFunc:[ge.DST_COLOR,ge.ZERO]}},r},n._generateFragmentUniform=function(){for(var e={},t=0;t<this.shadowMapCount;t++){e=g({},e,Xi.getUniformDefine(t))}return e},n._generateMacros=function(){var e=[];return this.shadowMapCount>0&&e.push("O3_SHADOW_MAP_COUNT "+this.shadowMapCount),e},t}(In),Zi=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).clearMode=J.DONT_CLEAR,t}return A(t,e),t.prototype.preRender=function(e,t,n){this.enabled=!1;var i=e.scene.findFeature(Xt);if(i){var r=e._renderPipeline.defaultRenderPass;this.renderTarget=r.renderTarget;for(var a=i.visibleLights,o=0,s=0,u=a.length;s<u;s++){var c=a[s];c.enableShadow&&(c.shadow.bindShadowValues(this.replaceMaterial,o,c),o++)}o!==this.replaceMaterial.shadowMapCount&&(this.replaceMaterial.shadowMapCount=o,this.replaceMaterial.clearTechniques()),o&&(this.enabled=!0)}},t}(vt),Ji=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n.preRender=function(e,t){var n=t.scene.findFeature(Xt);if(n&&n.visibleLights.length>0){this._shadowPass||this.addShadowPass(t);for(var i=n.visibleLights,r=0,a=i.length;r<a;r++){var o=i[r];if(o.enableShadow&&!o.shadowMapPass)o.shadowMapPass=this.addShadowMapPass(t,o);else if(!o.enableShadow&&o.shadowMapPass){t._renderPipeline.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null}}this.updatePassRenderFlag(t._renderPipeline.opaqueQueue),this.updatePassRenderFlag(t._renderPipeline.transparentQueue)}},n.addShadowPass=function(e){var t=new Qi(e.engine,"shadowMaterial");this._shadowPass=new Zi("ShadowPass",1,null,t,xe.SHADOW),e._renderPipeline.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(e,t){this._shadowMapMaterial=this._shadowMapMaterial||new Ki(e.engine,"shadowMapMaterial");var n=new Yi("ShadowMapPass",-1,t.shadow.renderTarget,this._shadowMapMaterial,xe.SHADOW_MAP,t);return e._renderPipeline.addRenderPass(n),n},n.updatePassRenderFlag=function(e){for(var t=e.items,n=0,i=t.length;n<i;n++){var r=t[n].component,a=r.recieveShadow,o=r.castShadow;!0===a?r.addPassMasks(xe.SHADOW):!1===a&&r.removePassMasks(xe.SHADOW),!0===o?r.addPassMasks(xe.SHADOW_MAP):!1===o&&r.removePassMasks(xe.SHADOW_MAP)}},t}(st);function $i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}tt.registerFeature(Ji),tt.registerFeature(Xt),tt.prototype.hasLight=function(){return this.findFeature(Xt).visibleLights.length>0};var er=function(){function e(e,t){var n=this;this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(e),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":n._callbacks[t.id].resolve(t.geometry);break;case"error":n._callbacks[t.id].reject(t);break;default:Fe('DRACOWorker: Unexpected message, "'+t.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var t,n,i,r=e.prototype;return r.setCosts=function(e,t){this._costs[e]=t},r.addCurrentLoad=function(e){this._currentLoad+=e},r.setCallback=function(e,t,n){this._callbacks[e]={resolve:t,reject:n}},r.decode=function(e,t,n){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:n},[n])},r.releaseTask=function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]},t=e,(n=[{key:"currentLoad",get:function(){return this._currentLoad}}])&&$i(t.prototype,n),i&&$i(t,i),e}(),tr='let decoderPending;\nlet decoderConfig;\n\nonmessage = function(e) {\n  const message = e.data;\n\n  switch (message.type) {\n    case "init":\n      decoderConfig = message.decoderConfig;\n      decoderPending = new Promise(function(resolve /*, reject*/) {\n        decoderConfig.onModuleLoaded = function(draco) {\n          // Module is Promise-like. Wrap before resolving to avoid loop.\n          resolve({ draco: draco });\n        };\n        DracoDecoderModule(decoderConfig);\n      });\n      break;\n\n    case "decode":\n      const buffer = message.buffer;\n      const taskConfig = message.taskConfig;\n      decoderPending.then(module => {\n        const draco = module.draco;\n        const decoder = new draco.Decoder();\n        const decoderBuffer = new draco.DecoderBuffer();\n        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);\n        try {\n          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);\n          const buffers = geometry.attributes.map(attr => attr.array.buffer);\n          if (geometry.index) buffers.push(geometry.index.array.buffer);\n          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);\n        } catch (error) {\n          console.error(error);\n          self.postMessage({ type: "error", id: message.id, error: error.message });\n        } finally {\n          draco.destroy(decoderBuffer);\n          draco.destroy(decoder);\n        }\n      });\n      break;\n  }\n};\n\nfunction decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {\n  const attributeIDs = taskConfig.attributeIDs;\n  const attributeTypes = taskConfig.attributeTypes;\n\n  let dracoGeometry;\n  let decodingStatus;\n\n  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    dracoGeometry = new draco.Mesh();\n    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);\n  } else {\n    throw new Error("DRACODecoder worker: Unexpected geometry type.");\n  }\n\n  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {\n    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());\n  }\n\n  const geometry = { index: null, attributes: [] };\n\n  // Gather all vertex attributes.\n  for (let attributeName in attributeIDs) {\n    const attributeType = self[attributeTypes[attributeName]];\n\n    let attribute;\n    let attributeID;\n\n    // A Draco file may be created with default vertex attributes, whose attribute IDs\n    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n    // a Draco file may contain a custom set of attributes, identified by known unique\n    // IDs. glTF files always do the latter, and `.drc` files typically do the former.\n    if (taskConfig.useUniqueIDs) {\n      attributeID = attributeIDs[attributeName];\n      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);\n    } else {\n      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);\n      if (attributeID === -1) continue;\n      attribute = decoder.GetAttribute(dracoGeometry, attributeID);\n    }\n    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));\n  }\n  // Add index.\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    // Generate mesh faces.\n    const numFaces = dracoGeometry.num_faces();\n    const numIndices = numFaces * 3;\n    let dataSize;\n    let ptr;\n    let index;\n    const indexType = self[taskConfig.indexType];\n\n    switch (indexType) {\n      case Uint16Array:\n        dataSize = numIndices * 2;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);\n        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      case Uint32Array:\n        dataSize = numIndices * 4;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);\n        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n      default:\n        throw new Error("DRACODecoder: Unexpected index type.");\n    }\n    geometry.index = { array: index, itemSize: 1 };\n  }\n  draco.destroy(dracoGeometry);\n  return geometry;\n}\n\nfunction decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {\n  const numComponents = attribute.num_components();\n  const numPoints = dracoGeometry.num_points();\n  const numValues = numPoints * numComponents;\n  let ptr;\n  let array;\n  let dataSize;\n  switch (attributeType) {\n    case Float32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);\n      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);\n      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);\n      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);\n      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);\n      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);\n      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);\n      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    default:\n      throw new Error("DRACODecoder: Unexpected attribute type.");\n  }\n\n  return {\n    name: attributeName,\n    array: array,\n    itemSize: numComponents\n  };\n}\n',nr="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",ir=function(){function e(e){var t;(void 0===e&&(e={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.currentTaskId=1,this.taskCache=new WeakMap,e.workerLimit>this.workerLimit)?Ie("DRACOWorkerPool: Can not initialize worker pool with limit:"+e.workerLimit):this.workerLimit=null!=(t=e.workerLimit)?t:4;this.useJS="object"!=typeof WebAssembly||"js"===e.type,this.loadLibPromise=this.preloadLib()}var t=e.prototype;return t.preloadLib=function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,n){e.useJS?Mt(nr+"draco_decoder_gltf.js",{type:"text"}).then((function(e){var n=[e,tr].join("\n"),i=URL.createObjectURL(new Blob([n]));t({workerSourceURL:i,decoderWASMBinary:null})})).catch((function(e){n(e)})):Promise.all([Mt(nr+"draco_wasm_wrapper_gltf.js",{type:"text"}),Mt(nr+"draco_decoder_gltf.r3bin",{type:"arraybuffer"})]).then((function(e){var n=e[0],i=e[1],r=[n,tr].join("\n"),a=URL.createObjectURL(new Blob([r]));t({workerSourceURL:a,decoderWASMBinary:i})})).catch((function(e){n(e)}))}))},t.getWorker=function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var n=new er(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(n)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))},t.decode=function(e,t){var n=this,i=JSON.stringify(t);if(this.taskCache.has(e)){var r=this.taskCache.get(e);if(r.key===i)return r.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,u=new Promise((function(i,r){n.getWorker().then((function(n){a=n,n.setCosts(o,s),n.addCurrentLoad(s),n.setCallback(o,i,r),n.decode(o,t,e)})).catch((function(e){r(e)}))}));return u.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:i,promise:u}),u},e}();function rr(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ar(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return or(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return or(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function or(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function sr(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ur(e,t,n){return t&&sr(e.prototype,t),n&&sr(e,n),e}function cr(e,t,n){return(cr=lr()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&fr(r,n.prototype),r}).apply(null,arguments)}function lr(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function fr(e,t){return(fr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hr(){return(hr=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function dr(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var _r=Object.defineProperty,pr=Object.getOwnPropertyDescriptor;var mr=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new M((function(e){var n=t.slice(13+RegExp.$1.length);e(Uint8Array.from(atob(n),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,hr({},e,{type:"arraybuffer"}))},t}(Dt);mr=function(e,t,n,i){for(var r,a=i>1?void 0:i?pr(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&_r(t,n,a),a}([N(It.Buffer,["bin","r3bin"],!1)],mr);var vr,gr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function yr(e){return{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}[e]}function xr(e){return gr[e]}function Tr(e,t,n){var i,r,a=e.bufferViews[t.bufferView],o=n[a.buffer],s=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=a.hasOwnProperty("byteOffset")?a.byteOffset:0,c=s+u,l=yr(t.type),f=l*t.count,h=null!=(i=a.byteStride)?i:0,d=xr(t.componentType);if(h){r=new Uint8Array(f*d.BYTES_PER_ELEMENT);for(var _=new Uint8Array(o,u,a.byteLength),p=0,m=l*d.BYTES_PER_ELEMENT,v=0;v<t.count;v++){p=v*h+s;for(var g=0;g<m;g++)r[v*m+g]=_[p+g]}}else r=new Uint8Array(o,c,f*d.BYTES_PER_ELEMENT),r=new Uint8Array(r);return new d(r.buffer)}function br(e,t){var n=t[e.buffer],i=e.byteOffset||0;return n.slice(i,i+e.byteLength)}function Er(e){return yr(e.type)*xr(e.componentType).BYTES_PER_ELEMENT}function Ar(e,t,n,i){var r=yr(n.type);return new Wn(t,0,function(e,t){if(e==_e.FLOAT)switch(t){case 1:return Sn.Float;case 2:return Sn.Vector2;case 3:return Sn.Vector3;case 4:return Sn.Vector4}if(e==_e.UNSIGNED_SHORT)switch(t){case 2:return Sn.UShort2;case 4:return Sn.UShort4}}(n.componentType,r),i)}function Or(e,t){return new Promise((function(n,i){var r=new window.Blob([e],{type:t}),a=new Image;a.src=URL.createObjectURL(r),a.crossOrigin="anonymous",a.onerror=function(){i(new Error("Failed to load image buffer"))},a.onload=function(){n(a)}}))}function Cr(e,t){return/^(?:http|blob|data:|\/)/.test(t)?t:e.substring(0,e.lastIndexOf("/")+1)+t}var Rr={init:function(){vr||(vr=new ir)},parse:function(e,t,n,i){var r=n.bufferViews,a=n.accessors,o=e.bufferView,s=e.attributes,u={},c={};for(var l in s)u[l]=s[l];for(var f in t.attributes)if(void 0!==s[f]){var h=a[t.attributes[f]];c[f]=xr(h.componentType).name}var d={attributeIDs:u,attributeTypes:c,useUniqueIDs:!0,indexType:xr(a[t.indices].componentType).name},_=br(r[o],i);return vr.decode(_,d).then((function(e){return e}))}},Sr={translation:"position",rotation:"rotation",scale:"scale",weights:"weights"},wr=0,Mr=function(e){var t=new gi(e,"default");return t.emission=new v(.749,.749,.749,1),t},Pr="KHR_draco_mesh_compression",Lr=null,Ir={KHR_lights:Lr,KHR_materials_unlit:Ni,KHR_materials_pbrSpecularGlossiness:Ni,KHR_techniques_webgl:Ln,KHR_draco_mesh_compression:Rr};var Fr=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t}(X);function Nr(e,t){var n={engine:t,gltf:e.gltf,buffers:e.buffers,asset:new Fr(t)};return n.asset.textures=e.textures,n.asset.meta=e.gltf,n.gltf.asset&&n.gltf.asset.version&&(n.gltf.version=Number(n.gltf.asset.version),n.gltf.isGltf2=n.gltf.version>=2&&n.gltf.version<=3),function(e){var t=e.gltf,n=e.asset,i=t.extensions,r=t.extensionsUsed,a=t.extensionsRequired;if(r){Le("extensionsUsed: ",r);for(var o=0;o<r.length;o++)Object.keys(Ir).indexOf(r[o])>-1?Ir[r[o]]||Ie("extension "+r[o]+" is used, you can add this extension into gltf"):Ie("extensionsUsed has unsupported extension "+r[o])}if(a){Le("extensionsRequired: "+a);for(var s=0;s<a.length;s++)(Object.keys(Ir).indexOf(a[s])<0||!Ir[a[s]])&&Fe("model has not supported required extension "+a[s]),a[s]===Pr&&Ir.KHR_draco_mesh_compression.init()}i&&Lr&&i.KHR_lights&&(n.lights=Lr.parseLights(i.KHR_lights.lights))}(n),Dr(n,"materials",zr).then((function(){return Dr(n,"meshes",Ur)})).then((function(){return Dr(n,"nodes",Gr)})).then((function(){return Dr(n,"scenes",jr)})).then((function(){return Dr(n,"skins",Vr)})).then((function(){return Dr(n,"animations",kr)})).then((function(){return function(e){var t,n=e.asset,i=e.gltf,r=i.nodes||[],a=i.meshes;n.defaultScene=Hr("scenes",null!=(t=i.scene)?t:0,e);for(var o=r.length-1;o>=0;o--){var s=r[o],u=Hr("nodes",o,e);if(s.hasOwnProperty("children"))for(var c=s.children||[],l=c.length-1;l>=0;l--){var f=Hr("nodes",c[l],e);u.addChild(f)}if(s.hasOwnProperty("mesh")){var h=s.mesh;u.meshIndex=h;var d=a[h].primitives,_=Hr("meshes",h,e),p=void 0;if(s.hasOwnProperty("skin")||_.hasOwnProperty("weights")){var m=Hr("skins",s.skin,e),v=_.weights,g=u.addComponent(On);g.mesh=_,g.skin=m,g.setWeights(v),p=g}else(p=u.addComponent(yn)).mesh=_;for(var y=0,x=d.length;y<x;y++){var T=d[y].material;_.primitives[y].materialIndex=T;var b=void 0!==T?Hr("materials",T,e):Mr(u.engine);p.setSharedMaterial(y,b)}}}var E=n.defaultScene.nodes;if(1===E.length)n.defaultSceneRoot=E[0];else{for(var A=new Je(e.engine),O=0;O<E.length;O++)A.addChild(E[O]);n.defaultSceneRoot=A}var C=n.defaultSceneRoot.addComponent(mi),R=n.animations;R&&R.forEach((function(e){C.addAnimationClip(e,e.name)}));return e.asset}(n)}))}function Dr(e,t,n){var i=e.gltf,r=e.asset;if(r[t]||(r[t]=[]),i.hasOwnProperty(t)){var a=i[t]||[];Pe(t+":",a);for(var o=[],s=a.length-1;s>=0;s--)o.push(n(a[s],e));return Promise.all(o).then((function(e){for(var n=0;n<e.length;n++)r[t].push(e[n])}))}return Promise.resolve()}function zr(e,t){var n,i=t.gltf;t.asset;if(i.isGltf2&&void 0===e.technique){var r={},a={},o=e.pbrMetallicRoughness,u=e.normalTexture,c=e.emissiveTexture,l=(e.emissiveFactor,e.occlusionTexture),f=e.alphaMode,h=e.alphaCutoff,d=e.doubleSided,_=e.extensions;if(o){var p=o.baseColorFactor,m=o.baseColorTexture,g=o.metallicFactor,y=o.roughnessFactor,x=o.metallicRoughnessTexture;m&&(r.baseColorTexture=Hr("textures",m.index||0,t,!1)),p&&(r.baseColorFactor=cr(v,p)),r.metallicFactor=void 0!==g?g:1,r.roughnessFactor=void 0!==y?y:1,x&&(r.metallicRoughnessTexture=Hr("textures",x.index||0,t,!1))}if(u){var T=u.index,b=(u.texCoord,u.scale);r.normalTexture=Hr("textures",T||0,t,!1),void 0!==typeof b&&(r.normalScale=b)}if(c&&(r.emissiveTexture=Hr("textures",c.index||0,t,!1)),l&&(r.occlusionTexture=Hr("textures",l.index||0,t,!1),void 0!==l.strength&&(r.occlusionStrength=l.strength)),a.doubleSided=!!d,a.alphaMode=f||"OPAQUE","MASK"===f&&(r.alphaCutoff=void 0===h?.5:h),_&&(_.KHR_materials_unlit&&(a.unlit=!0),_.KHR_materials_pbrSpecularGlossiness)){var E=_.KHR_materials_pbrSpecularGlossiness,A=E.diffuseFactor,O=E.diffuseTexture,C=E.specularFactor,R=E.glossinessFactor,S=E.specularGlossinessTexture;a.isMetallicWorkflow=!1,A&&(r.baseColorFactor=cr(v,A)),O&&(r.baseColorTexture=Hr("textures",O.index||0,t,!1)),C&&(r.specularFactor=cr(s,C)),void 0!==R&&(r.glossinessFactor=R),S&&(r.specularGlossinessTexture=Hr("textures",S.index||0,t,!1))}var w=e.unlit,M=e.srgb,P=e.gamma,L=e.blendFunc,I=e.depthMask;w&&(a.unlit=!0),M&&(a.srgb=!0),P&&(a.gamma=!0),L&&(a.blendFunc=L),void 0!==I&&(a.depthMask=I),n=new Ni(t.engine,e.name||Ni.MATERIAL_NAME,Object.assign({},r,a))}else{var F=e.technique;if(Ie("Deprecated: Please use a model that meets the glTF 2.0 specification"),"Texture"===F){(n=new Ni(t.engine,e.name||Ni.MATERIAL_NAME)).unlit=!0;var N=e.values._MainTex[0];n.baseColorTexture=Hr("textures",N||0,t,!1)}}return Promise.resolve(n)}function Vr(e,t){for(var n=t.gltf,i=t.buffers,r=e.joints.length,a=new tn(e.name),o=Tr(n,n.accessors[e.inverseBindMatrices],i),s=0;s<r;s++){var u=16*s,c=u+16;a.inverseBindMatrices[s]=cr(f,o.subarray(u,c))}for(var l=0;l<r;l++){var h=Hr("nodes",e.joints[l],t);a.joints[l]=h.name}var d=Hr("nodes",null==e.skeleton?e.joints[0]:e.skeleton,t);return a.skeleton=d.name,Promise.resolve(a)}function Br(e,t,n,i,r,a,o,u){var c=0,l=[];for(var f in i.attributes){var h=i.attributes[f],d=r.accessors[h],_=Er(d),p=Ar(0,f,d,c);l.push(p);var m=a(f),v=new kn(u,Fn.VertexBuffer,m.byteLength,Cn.Static);if(v.setData(m),t.setVertexBufferBinding(v,_,c++),"POSITION"==p.semantic)for(var g=new s,y=m.length/3,x=e.bounds,T=x.min,b=x.max,E=0;E<y;E++){var A=3*E;g.setValue(m[A],m[A+1],m[A+2]),s.min(T,g,T),s.max(b,g,b)}}t.setVertexElements(l);var O=r.accessors[i.indices],C=o(),R=O.count,S=function(e){switch(e){case _e.UNSIGNED_BYTE:return Mn.UInt8;case _e.UNSIGNED_SHORT:return Mn.UInt16;case _e.UNSIGNED_INT:return Mn.UInt32}}(O.componentType),w=S==Mn.UInt32?4:S==Mn.UInt16?2:1,M=new kn(u,Fn.IndexBuffer,R*w,Cn.Static);return M.setData(C),t.setIndexBufferBinding(new Gn(M,S)),n.start=0,n.count=R,Promise.resolve(t)}function Ur(e,t){for(var n=t.gltf,i=t.buffers,r=t.engine,a=new en(e.name),o=[],s=[],u=function(u){o.push(new Promise((function(o,c){var l,f=e.primitives[u],h=new Hn(r,f.name||e.name||u),d=new Xn;if(s.push(d),d.topology=null==f.mode?Bn.Triangles:f.mode,f.hasOwnProperty("targets")&&(h.targets=[],a.weights=e.weights||new Array(f.targets.length).fill(0)),f.extensions&&f.extensions[Pr]){var _=Ir.KHR_draco_mesh_compression,p=f.extensions[Pr];l=_.parse(p,f,n,i).then((function(e){return Br(a,h,d,f,n,(function(t){for(var n=0;n<e.attributes.length;n++)if(e.attributes[n].name===t)return e.attributes[n].array;return null}),(function(){return e.index.array}),t.engine)}))}else l=Br(a,h,d,f,n,(function(e){var t=f.attributes[e],r=n.accessors[t];return Tr(n,r,i)}),(function(){var e=n.accessors[f.indices];return Tr(n,e,i)}),t.engine);l.then((function(e){o(e)})).catch((function(e){c(e)}))})))},c=0;c<e.primitives.length;c++)u(c);return Promise.all(o).then((function(e){for(var t=0;t<e.length;t++)a.primitives.push(e[t]),a.groups.push(s[t]);return a}))}function kr(e,t){for(var n=t.gltf,i=t.buffers,r=e.samplers||[],a=e.channels||[],o=n.animations.indexOf(e),s=new fi(e.name||"Animation"+o),u=-1,c=-1,l=0;l<r.length;l++){var f=r[l],h=n.accessors[f.input],d=n.accessors[f.output],_=Tr(n,h,i),p=Tr(n,d,i),m=yr(d.type);m*_.length!==p.length&&(m=p.length/_.length);var v=ni.LINEAR;switch(f.interpolation){case"CUBICSPLINE":v=ni.CUBICSPLINE;break;case"STEP":v=ni.STEP}var g=_[_.length-1];g>u&&(u=g,c=l),s.addSampler(_,p,m,v)}s.durationIndex=c,s.duration=u;for(var y=0;y<a.length;y++){var x=a[y],T=x.target,b=x.sampler,E=Hr("nodes",T.node,t),A=Sr[T.path];s.addChannel(b,E.name,A)}return Promise.resolve(s)}function Gr(e,t){var n=new Je(t.engine,e.name||"GLTF_NODE_"+wr++);if(e.hasOwnProperty("matrix")){var i=e.matrix,r=new f;r.setValueByArray(i);var a=new s,o=new s(1,1,1),u=new l;r.decompose(a,u,o),n.transform.position=a,n.transform.rotationQuaternion=u,n.transform.scale=o}else for(var c in Sr)if(e.hasOwnProperty(c)){var h=Sr[c];if("weights"===h)n[h]=e[c];else{var d=e[c],_=d.length,p=n[h];2===_?p.setValue(d[0],d[1]):3===_?p.setValue(d[0],d[1],d[2]):4===_&&p.setValue(d[0],d[1],d[2],d[3]),n[h]=p}}if(void 0!==e.camera){var m=t.gltf.cameras[e.camera],v=n.addComponent(St);if("orthographic"===m.type){v.isOrthographic=!0;var g=m.orthographic,y=g.ymag,x=g.xmag,T=g.zfar,b=g.znear;void 0!==b&&(v.nearClipPlane=b),void 0!==T&&(v.farClipPlane=T),y&&x&&(v.orthographicSize=Math.max(y,x)/2),void 0!==y&&x&&(v.orthographicSize=x/2),void 0!==x&&y&&(v.orthographicSize=y/2)}else{var E=m.perspective,A=(E.aspectRatio,E.yfov),O=E.zfar,C=E.znear;void 0!==A&&(v.fieldOfView=A),void 0!==O&&(v.farClipPlane=O),void 0!==C&&(v.nearClipPlane=C)}}if(e.extensions&&Lr&&e.extensions.KHR_lights){var R=e.extensions.KHR_lights.light;if(void 0!==R){var S=Hr("lights",R,t);if(S){var w=n.addComponent(S.ability);Object.assign(w,S.props)}}}return Promise.resolve(n)}function jr(e,t){for(var n=[],i=0;i<e.nodes.length;i++){var r=Hr("nodes",e.nodes[i],t);n.push(r)}if(e.extensions&&Lr&&e.extensions.KHR_lights){var a=e.extensions.KHR_lights.light;if(void 0!==a){var o=Hr("lights",a,t);o&&n[0].addComponent(o.ability,o.props)}}return Promise.resolve({nodes:n})}function Hr(e,t,n,i){void 0===i&&(i=!0);var r=n.asset,a=i?r[e].length-t-1:t;return r[e][a]}function Wr(e){var t=1313821514,n=5130562,i=new DataView(e),r={magic:i.getUint32(0,!0),version:i.getUint32(4,!0),length:i.getUint32(8,!0)};if(1179937895!==r.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+r.magic.toString(16)),null;var a=i.getUint32(12,!0),o=i.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;for(var s=new Uint8Array(e,20,a),u=JSON.parse(function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",n=0,i=e.length;n<i;n++)t+=String.fromCharCode(e[n]);return decodeURIComponent(encodeURIComponent(t))}(s)),c=[],l=20+a;l<r.length;){if(a=i.getUint32(l,!0),(o=i.getUint32(l+4,!0))!==n)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;var f=l+8,h=e.slice(f,f+a);c.push(h),l+=a+8}return{gltf:u,buffers:c}}var Xr=Object.defineProperty,qr=Object.getOwnPropertyDescriptor,Kr=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).requestGLTF=function(e,n){return t.request(e.url,hr({},e,{type:"json"})).then((function(i){return t._loadGLTFResources(e,i,n)}))},t.requestGLB=function(e,n){return t.request(e.url,hr({},e,{type:"arraybuffer"})).then(Wr).then((function(t){return hr({},t,{baseUrl:e.url,resourceManager:n})})).then(t._loadImages)},t._loadImages=function(e){var t=e.gltf,n=e.buffers,i=e.baseUrl,r=e.resourceManager;return t.images?Promise.all(t.images.map((function(e){var a=e.uri,o=e.bufferView,s=e.mimeType;return a?r.load({url:Cr(i,a),type:It.Texture2D}):Or(br(t.bufferViews[o],n),s).then((function(e){var t=new Tn(r.engine,e.width,e.height);return t.setImageSource(e),t.generateMipmaps(),t}))}))).then((function(e){return{gltf:t,buffers:n,textures:e}})):Promise.resolve({gltf:t,buffers:n})},t}dr(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new M((function(i,r){(n.isGLB(e.url)?n.requestGLB:n.requestGLTF)(e,t).then((function(e){Nr(e,t.engine).then((function(e){i(e)}))})).catch((function(t){console.error(t),r("Error loading glTF JSON from "+e.url)}))}))},n.isGLB=function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)},n._loadGLTFResources=function(e,t,n){return this._loadBuffers(e.url,t,n).then(this._loadImages)},n._loadBuffers=function(e,t,n){return t.buffers?Promise.all(t.buffers.map((function(t){return t instanceof ArrayBuffer?Promise.resolve(t):n.load({url:Cr(e,t.uri),type:It.Buffer})}))).then((function(i){return{buffers:i,gltf:t,baseUrl:e,resourceManager:n}})):Promise.resolve({baseUrl:e,gltf:t,resourceManager:n})},t}(Dt);Kr=function(e,t,n,i){for(var r,a=i>1?void 0:i?qr(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Xr(t,n,a),a}([N(It.Perfab,["gltf","glb"])],Kr);var Yr=Object.defineProperty,Qr=Object.getOwnPropertyDescriptor,Zr=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e){return this.request(e.url,hr({},e,{type:"json"}))},t}(Dt);Zr=function(e,t,n,i){for(var r,a=i>1?void 0:i?Qr(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Yr(t,n,a),a}([N(It.JSON,["json"],!1)],Zr);var Jr=function(e,t,n,i){if(void 0===i&&(i=!1),!function(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}(e))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(e,12,13*r),o=67305985===a.getUint32(0,!0),s={buffer:e,glType:a.getUint32(1*r,o),glTypeSize:a.getUint32(2*r,o),glFormat:a.getUint32(3*r,o),glInternalFormat:a.getUint32(4*r,o),glBaseInternalFormat:a.getUint32(5*r,o),pixelWidth:a.getUint32(6*r,o),pixelHeight:a.getUint32(7*r,o),pixelDepth:a.getUint32(8*r,o),numberOfArrayElements:a.getUint32(9*r,o),numberOfFaces:a.getUint32(10*r,o),numberOfMipmapLevels:a.getUint32(11*r,o),bytesOfKeyValueData:a.getUint32(12*r,o),loadType:0};if(0!==s.glType)throw new Error("only compressed formats currently supported");if(s.numberOfMipmapLevels=Math.max(1,s.numberOfMipmapLevels),0===s.pixelHeight||0!==s.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==s.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(s.numberOfFaces!==t)throw new Error("number of faces expected"+t+", but found "+s.numberOfFaces);return n&&(s.mipmaps=function(e,t){for(var n=[],i=64+e.bytesOfKeyValueData,r=e.pixelWidth,a=e.pixelHeight,o=t?e.numberOfMipmapLevels:1,s=0;s<o;s++){var u=new Int32Array(e.buffer,i,1)[0];i+=4;for(var c=0;c<e.numberOfFaces;c++){var l=new Uint8Array(e.buffer,i,u);n.push({data:l,width:r,height:a}),i+=u,i+=3-(u+3)%4}r=Math.max(1,.5*r),a=Math.max(1,.5*a)}return n}(s,!0)),i&&(s.engineFormat=function(e){switch(e){case dn.RGB_S3TC_DXT1_EXT:return cn.DXT1;case dn.RGBA_S3TC_DXT5_EXT:return cn.DXT5;case dn.RGB_ETC1_WEBGL:return cn.ETC1_RGB;case dn.RGB8_ETC2:return cn.ETC2_RGB;case dn.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return cn.ETC2_RGBA5;case dn.RGBA8_ETC2_EAC:return cn.ETC2_RGBA8;case dn.RGB_PVRTC_2BPPV1_IMG:return cn.PVRTC_RGB2;case dn.RGBA_PVRTC_2BPPV1_IMG:return cn.PVRTC_RGBA2;case dn.RGB_PVRTC_4BPPV1_IMG:return cn.PVRTC_RGB4;case dn.RGBA_PVRTC_4BPPV1_IMG:return cn.PVRTC_RGBA4;case dn.RGBA_ASTC_4X4_KHR:return cn.ASTC_4x4;case dn.RGBA_ASTC_5X5_KHR:return cn.ASTC_5x5;case dn.RGBA_ASTC_6X6_KHR:return cn.ASTC_6x6;case dn.RGBA_ASTC_8X8_KHR:return cn.ASTC_8x8;case dn.RGBA_ASTC_10X10_KHR:return cn.ASTC_10x10;case dn.RGBA_ASTC_12X12_KHR:return cn.ASTC_12x12;default:var t=dn[e];throw new Error("this format is not supported in Oasis Engine: "+t)}}(s.glInternalFormat)),s};function $r(e){var t=Jr(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}var ea=Object.defineProperty,ta=Object.getOwnPropertyDescriptor,na=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e,t){var n=this;return new M((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,hr({},e,{type:"arraybuffer"}))}))).then((function(e){for(var n=function(e){for(var t,n,i,r,a=[],o=0;o<e.length;o++){var s=Jr(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(i=s.pixelWidth,r=s.pixelHeight,t=s.glInternalFormat,n=s.engineFormat)}return{mipmapsFaces:a,engineFormat:n,internalFormat:t,width:i,height:r}}(e),r=n.width,a=n.mipmapsFaces,o=n.engineFormat,s=a[0].length>1,u=new oi(t.engine,r,o,s),c=0;c<6;c++)for(var l=a[c].length,f=0;f<l;f++){var h=a[c][f],d=h.data,_=h.width,p=h.height;u.setPixelBuffer(Kn.PositiveX+c,d,f,0,0,_,p)}i(u)})).catch((function(e){r(e)}))}))},t}(Dt);na=function(e,t,n,i){for(var r,a=i>1?void 0:i?ta(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ea(t,n,a),a}([N(It.KTXCube,[])],na);var ia=Object.defineProperty,ra=Object.getOwnPropertyDescriptor,aa=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e,t){var n=this;return new M((function(i,r){n.request(e.url,hr({},e,{type:"arraybuffer"})).then((function(e){for(var n=$r(e),r=n.width,a=n.height,o=n.mipmaps,s=n.engineFormat,u=o.length>1,c=new Tn(t.engine,r,a,s,u),l=0;l<o.length;l++){var f=o[l],h=f.width,d=f.height,_=f.data;c.setPixelBuffer(_,l,0,0,h,d)}i(c)})).catch((function(e){r(e)}))}))},t}(Dt);aa=function(e,t,n,i){for(var r,a=i>1?void 0:i?ra(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ia(t,n,a),a}([N(It.KTX,["ktx"])],aa);var oa=Object.defineProperty,sa=Object.getOwnPropertyDescriptor,ua=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e,t){var n=this;return new M((function(i,r){n.request(e.url,hr({},e,{type:"image"})).then((function(n){var r=new Tn(t.engine,n.width,n.height);if(r._glTexture){if(r.setImageSource(n),r.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");r.name=a[a.length-1]}i(r)}})).catch((function(e){r(e)}))}))},t}(Dt);ua=function(e,t,n,i){for(var r,a=i>1?void 0:i?sa(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&oa(t,n,a),a}([N(It.Texture2D,["png","jpg","webp","jpeg"])],ua);var ca=Object.defineProperty,la=Object.getOwnPropertyDescriptor,fa=function(e){function t(){return e.apply(this,arguments)||this}return dr(t,e),t.prototype.load=function(e,t){var n=this;return new M((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,hr({},e,{type:"image"}))}))).then((function(e){var n=e[0],r=n.width;if(r===n.height){var a=new oi(t.engine,r);if(a._glTexture){for(var o=0;o<6;o++)a.setImageSource(Kn.PositiveX+o,e[o],0);a.generateMipmaps(),i(a)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){r(e)}))}))},t}(Dt);fa=function(e,t,n,i){for(var r,a=i>1?void 0:i?la(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&ca(t,n,a),a}([N(It.TextureCube,[""])],fa);var ha=function(e){function t(t){var n;return(n=e.call(this,t)||this)._hasBuiltNode=!1,n}return dr(t,e),t.prototype.init=function(e){var t=this,n=e.asset,i=void 0===n?null:n,r=e.autoPlay,a=e.loop;if(e.isClone){var o=e.gltfRootName;o&&(this.GLTFNode=this.entity.findByName(o))}if(this.GLTFNode)this._hasBuiltNode=!0;else{var s="GLTF-"+Date.now();e.gltfRootName=s,this.GLTFNode=this.entity.createChild(s),this._hasBuiltNode=!1}this.asset=i,this.loop=a,this.autoPlay=r,this.addEventListener("enabled",(function(){t.GLTFNode.isActive=!0})),this.addEventListener("disabled",(function(){t.GLTFNode.isActive=!1}))},ur(t,[{key:"asset",get:function(){return this._asset},set:function(e){e&&e.defaultSceneRoot===this.GLTFNode||(this._hasBuiltNode||(this.GLTFNode.clearChildren(),null!==e&&(this.GLTFNode&&this.GLTFNode.destroy(),this.GLTFNode=e.defaultSceneRoot.clone(),this._animator=this.GLTFNode.getComponent(mi),this.entity.addChild(this.GLTFNode))),this._asset=e)}},{key:"animator",get:function(){return this._animator}},{key:"autoPlay",get:function(){return this._autoPlay},set:function(e){this._animator&&(e?this._animator.playAnimationClip(e,{wrapMode:this._loop}):this._animator.stop(!1)),this._autoPlay=e}},{key:"loop",get:function(){return this._loop},set:function(e){this._animator&&this.autoPlay&&this._animator.playAnimationClip(this._autoPlay,{wrapMode:e}),this._loop=e}}]),t}(Xe),da=function(){function e(){this.registeredPlugins=new Set,this.plugins=[]}var t=e.prototype;return t.register=function(e){this.registeredPlugins.add(e)},t.boot=function(e){for(var t,n=ar(this.registeredPlugins.values());!(t=n()).done;){var i=t.value;"function"==typeof i&&(i=i(e)),this.plugins.push(i)}},t.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},t.nodeAdded=function(e){this.delegateMethod("nodeAdded",e)},t.delegateMethod=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];this.plugins.forEach((function(t){return t[e]&&t[e].apply(t,n)}))},e}();function _a(e){return function(t,n,i){var r=i.value;i.value=function(){for(var t,n=this,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return e.before&&(t=this.oasis.pluginManager).delegateMethod.apply(t,[e.before].concat(a)),Promise.resolve(r.apply(this,arguments)).then((function(t){return e.after&&n.oasis.pluginManager.delegateMethod(e.after,t),t}))}}}function pa(e,t,n){if(t!==n&&null!=n){var i=[e[n],e[t]];e[t]=i[0],e[n]=i[1]}}function ma(e){return e&&"asset"===e.type}function va(e){for(var t=[],n=Object.getPrototypeOf(e),i=Object.getOwnPropertyDescriptors(n),r=0,a=Object.entries(i);r<a.length;r++){var o=a[r],s=o[0];"function"==typeof o[1].get&&t.push(s)}return t}var ga={astc:1,s3tc:2,pvrtc:3,etc:4,etc1:5},ya=function(){function e(e,t){this.resourceManager=e,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}var t=e.prototype;return t.setMeta=function(){},t.loadWithAttachedResources=function(e,t,n){var i=this;return new Promise((function(r,a){i.load(e,t,n).then((function(){r({resources:[i],structure:{index:0,props:{}}})})).catch((function(e){a(e)}))}))},t.getProps=function(){return{}},t.bind=function(){},t.attach=function(){},t.update=function(e,t){if(ma(t)){var n=this.resourceManager.get(t.id);n?this._resource[e]=n.resource:Ie("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+t.id)}else this._resource[e]=t},t.updateMeta=function(e,t){this._meta[e]=t},t.onDestroy=function(){},ur(e,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),e}(),xa=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;return new Promise((function(r,a){var o,s,u,c;if(i.resourceManager.useCompressedTexture&&null!=t&&null!=(o=t.props)&&null!=(s=o.compression)&&s.compressions.length){var l=n.engine._hardwareRenderer,f=t.props.compression.compressions;f.sort((function(e,t){return ga[e.type]-ga[t.type]}));for(var h=0;h<f.length;h++){var d=f[h];if("ktx"===d.container&&l.canIUse(Ce[d.type])){c=d.url;break}}}c=null!=(u=c)?u:t.url,e.load({url:c,type:It.Texture2D}).then((function(e){i._resource=e,r(i)})).catch((function(e){a(e)}))}))},n.setMeta=function(){this.resource&&(this._meta.name=this.resource.name,this.resource.image&&(this._meta.url=this.resource.image.src))},t}(ya),Ta=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new Ni(e.engine,t.name);for(var a in n.configProps=t.props,n.configProps)ma(n.configProps[a])||(r[a]=n.configProps[a]);n._resource=r,n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,r){var a;t.resource instanceof Ni?a=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?a=n.load(e,t):r("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;va(n._resource).forEach((function(i){if(t[i]instanceof xn){var r=new xa(n.resourceManager,t[i]);n.attachedResources.push(r),e.resources.push(r),e.structure.props[i]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return va(this.resource).forEach((function(n){return t[n]=e.resource[n]})),t},n.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(n){var i=e.configProps[n];if(ma(i)){var r=e.resourceManager.get(i.id);r&&r instanceof xa?(t[n]=r.resource,e._attachedResources.push(r)):(t[n]=null,Ie("PBRMaterialResource: "+e.meta.name+" can't find asset \""+n+'", which id is: '+i.id))}else{if("side"===n)return;t[n]=i}}))},t}(ya),ba=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t,n){var i,r=this;return null!=(i=t.props)&&i.compression&&Rr.init(),e.load({url:t.url,type:It.Perfab}).then((function(e){var n=e;t.props&&(n.newMaterial=t.props.newMaterial),r._resource=n}))},n.loadWithAttachedResources=function(e,t,n){var i=this;return new Promise((function(r){i.load(e,t,n).then((function(){for(var t=i.resource.materials,n=[],a={resources:[i],structure:{index:0,props:{newMaterial:[]}}},o=0;o<t.length;o++){var s=t[o],u=new Ta(i.resourceManager);i._attachedResources.push(u),n.push(u.loadWithAttachedResources(e,{type:"PBRMaterial",name:s.name,resource:s}))}Promise.all(n).then((function(e){var t=a.structure.props.newMaterial;e.forEach((function(e){var n=e.structure,i=e.resources[n.index];for(var r in a.resources.push(i),n.index=a.resources.length-1,n.props)if(n.props.hasOwnProperty(r)){var o=n.props[r],s=e.resources[o.index];a.resources.push(s),o.index=a.resources.length-1}t.push(n)})),r(a)}))}))}))},n.setMeta=function(e){e&&(this.meta.name=e.name)},n.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial)},n.update=function(e,t){"newMaterial"===e?this.bindMaterials(t):this._resource[e]=t},n.bindMaterials=function(e){if(e&&e.length){for(var t=this._resource,n=t.meshes,i=0;i<e.length;i++){var r=this.resourceManager.get(e[i].id);r?(this._attachedResources.push(r),t.materials[i]=r.resource):Ie("GLTFResource: "+this.meta.name+' can\'t find asset "material", which id is: '+e[i].id)}for(var a=0;a<n.length;a++){var o=this.getNodeByMeshIndex(t.nodes,n.length-1-a);if(o)for(var s=0;s<n[a].primitives.length;s++){var u=n[a].primitives[s],c=o.getComponent(yn),l=t.materials[t.materials.length-1-u.materialIndex];c&&l&&l instanceof Ln&&c.setSharedMaterial(s,l)}}}},n.getNodeByMeshIndex=function(e,t){for(var n=0;n<=e.length;n++){var i=e[n];if(i.meshIndex===t)return i}return null},t}(ya),Ea=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.loadShaderDefine=function(e){var t=this;return new Promise((function(n){var i=t.scripts[0].name;if(t.resourceManager.isLocal){var r,a;n(null!=(r=null==(a=e.options)?void 0:a.scripts[i])?r:{})}else{var o=document.getElementById(i);o&&document.body.removeChild(o);var s=document.createElement("script");s.crossOrigin="anonymous",s.onload=function(){var e,t=window.o3Scripts;n(null!=(e=t&&t[i])?e:{})},s.id=i,s.src=t._meta.url,document.body.appendChild(s)}})).then((function(e){var n=e.vertexShader,i=void 0===n?"":n,r=e.fragmentShader,a=void 0===r?"":r,o=e.states,s=void 0===o?{}:o,u=e.uniforms,c=void 0===u?{}:u,l=e.attributes,f=void 0===l?{}:l;t._resource.uniforms=c,t._resource.attributes=f,t._resource.vertexShader=i,t._resource.fragmentShader=a,t._resource.renderStates=s}))},n.createMaterial=function(e){var t=new Ti(e,this.meta.name||"shader_mtl");this._resource=t},n.load=function(e,t,n){var i=this;return this.setMeta(t),this.scripts=t.props.scripts,this.createMaterial(n.engine),this.loadShaderDefine(n).then((function(){return new Promise((function(e,n){try{for(var r in t.props)i._resource[r]=t.props[r];i._resource.updateTechnique(),e(i)}catch(e){n("[shader material] createTechnique error")}}))}))},n.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},n.updateMeta=function(t,n){var i=this;e.prototype.updateMeta.call(this,t,n),"url"===t&&this.loadShaderDefine().then((function(){try{i._resource.updateTechnique()}catch(e){console.error("[shader material] createTechnique error")}}))},n.update=function(e,t){this._resource[e]=t,this._resource.updateTechnique()},t}(ya),Aa={};var Oa=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).isInit=!1,t}dr(t,e);var n=t.prototype;return n.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:$a._components.o3,script:function(e){return function(t){Aa[e]=t}}})},n.load=function(e,t,n){var i=this;return this.initScriptContext(),new Promise((function(e){var r=t.props.scripts;if(i.resourceManager.isLocal){for(var a=0;a<r.length;a++){var o,s=r[a].name;Aa[s]=null==(o=n.options)?void 0:o.scripts[s]}e(i)}else{var u=document.createElement("script");u.crossOrigin="anonymous",i.setMeta(t),u.onload=function(){for(var t=window.o3Scripts,n=0;n<r.length;n++){var a=r[n].name;i._resource=t&&t[a],Aa[a]=i._resource}e(i)},u.src=t.url,document.body.appendChild(u)}}))},n.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},t}(ya),Ca=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(i){var r=new yi(e.engine,t.name);for(var a in t.props)r[a]=t.props[a];n._resource=r,n.setMeta(),i(n)}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},t}(ya),Ra={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Sa=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t,n){var i=this;return new Promise((function(r,a){var o,s,u=[],c=It.TextureCube;if(i.resourceManager.useCompressedTexture&&null!=t&&null!=(o=t.props)&&null!=(s=o.compression)&&s.compressions.length){var l=n.engine._hardwareRenderer,f=t.props.compression.compressions;f.sort((function(e,t){return ga[e.type]-ga[t.type]}));for(var h=0;h<f.length;h++){var d=f[h];if("ktx"===d.container&&l.canIUse(Ce[d.type])){for(var _ in d.files)if(d.files.hasOwnProperty(_)){var p=d.files[_];u[Ra[_]]=p.url}console.warn(d.type),c=It.KTXCube;break}}}if(c===It.TextureCube)for(var m in t.props.images)if(t.props.images.hasOwnProperty(m)){var v=t.props.images[m];u[Ra[m]]=v.url}e.load({urls:u,type:c}).then((function(e){i._resource=e,r(i)})).catch((function(e){a(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},t}(ya),wa=function(e){function t(){return e.apply(this,arguments)||this}dr(t,e);var n=t.prototype;return n.load=function(e,t){var n=this;return new Promise((function(e){n._resource=t,n.setMetaData("name",n.resource.name),n.setMetaData("url",n.resource.url),e(n)}))},n.setMetaData=function(e,t){this._meta[e]=t},t}(ya),Ma=Object.defineProperty,Pa=Object.getOwnPropertyDescriptor,La=function(e,t,n,i){for(var r,a=i>1?void 0:i?Pa(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Ma(t,n,a),a},Ia=function(){function e(e){this.oasis=e,this.abilityMap={}}var t=e.prototype;return t.add=function(e){var t=e.type,n=e.node,i=e.props,r=e.id,a=e.index,o=this.oasis.nodeManager.get(n),s=this.getCompConstructor(t);if(s){var u=this.mixPropsToExplicitProps(i),c=o.addComponent(s),l=u.enabled;if(void 0!==l&&(c.enabled=l),"Model"===t||"GLTFModel"===t||"Particle"===t)c.init(u);else for(var f in u)null!==u[f]&&(c[f]=u[f]);var h=o._components;return pa(h,h.length-1,a),c.id=r,this.abilityMap[r]=c,c}Fe(t+" abiltiy is not defined")},t.update=function(e,t,n){return"Model"===this.get(e).constructor.name?n&&this.checkIsAsset(n)?this.get(e).setProp(t,this.oasis.resourceManager.get(n.id).resource):this.get(e).setProp(t,n):n&&this.checkIsAsset(n)?this.get(e)[t]=this.oasis.resourceManager.get(n.id).resource:this.get(e)[t]=n,{id:e,key:t,value:n}},t.get=function(e){return this.abilityMap[e]},t.delete=function(e){return this.abilityMap[e].destroy(),delete this.abilityMap[e],e},t.getCompConstructor=function(e){var t=e.split(".");if("script"===t[0])return Aa[t[1]];var n=$a._components.o3[e];if(!n)throw new Error(e+" is not defined");return n},t.mixPropsToExplicitProps=function(e){var t=hr({},e);for(var n in e){var i=e[n];if(i&&this.checkIsAsset(i)){var r=this.oasis.resourceManager.get(i.id);r?t[n]=r.resource:(t[n]=null,Ie("AbilityManager: can't get asset \""+n+'", which id is '+i.id))}}return t},t.checkIsAsset=function(e){return"asset"===e.type},e}();La([_a({after:"abilityAdded",before:"beforeAbilityAdded"})],Ia.prototype,"add",1),La([_a({before:"beforeAbilityUpdated",after:"abilityUpdated"})],Ia.prototype,"update",1),La([_a({after:"abilityDeleted",before:"beforeAbilityDeleted"})],Ia.prototype,"delete",1);var Fa=Object.defineProperty,Na=Object.getOwnPropertyDescriptor,Da=function(e,t,n,i){for(var r,a=i>1?void 0:i?Na(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Fa(t,n,a),a},za=function(){function e(e){this.oasis=e,this.nodeMap={},this.root=new Je(this.oasis.engine,"root")}var t=e.prototype;return t.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},t.add=function(e){return this.create(e),this.append(e.id,e.parent,e.index),this.get(e.id)},t.update=function(e,t,n){return this.get(e)[t]=n,{id:e,key:t,value:n}},t.get=function(e){return this.nodeMap[e]},t.reset=function(){this.nodeMap={}},t.delete=function(e){this.nodeMap[e].destroy(),delete this.nodeMap[e]},t.create=function(e){var t=e.isActive,n=e.position,i=e.rotation,r=e.scale,a=e.id,o=e.name,u=new Je(this.oasis.engine,o);return u.isActive=t,u.transform.position=new s(n[0],n[1],n[2]),u.transform.rotation=new s(i[0],i[1],i[2]),u.transform.scale=new s(r[0],r[1],r[2]),u.id=a,this.nodeMap[a]=u,u},t.append=function(e,t,n){var i=this.nodeMap[e],r=this.nodeMap[t]||this.root;r.addChild(i);var a=r._children;pa(a,a.length-1,n)},e}();Da([_a({after:"nodeAdded"})],za.prototype,"add",1),Da([_a({before:"beforeNodeUpdated",after:"nodeUpdated"})],za.prototype,"update",1),Da([_a({before:"beforeNodeDeleted"})],za.prototype,"delete",1);var Va=Object.defineProperty,Ba=Object.getOwnPropertyDescriptor,Ua=function(e,t,n,i){for(var r,a=i>1?void 0:i?Ba(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);return i&&a&&Va(t,n,a),a},ka={script:Oa,gltf:ba,texture:xa,cubeTexture:Sa,PBRMaterial:Ta,PBRSpecularMaterial:Ta,unlitMaterial:Ta,ShaderMaterial:Ea,BlinnPhongMaterial:Ca,base:wa},Ga=new Map;for(var ja in ka)if(ka.hasOwnProperty(ja)){var Ha=ka[ja];Ha===Ta?Ga.set(Ha,"PBRMaterial"):Ga.set(Ha,ja)}var Wa=function(e,t){return new ka[t](e)};var Xa=function(){function e(e){this.oasis=e,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=this.oasis.engine.resourceManager}var t=e.prototype;return t.load=function(e){var t=this,n=Wa(this,e.type),i=n.load(this.oasis.engine.resourceManager,e,this.oasis);return this.maxId=Math.max(+e.id,this.maxId),i.then((function(){t.resourceMap[e.id]=n,t.resourceIdMap.set(n,e.id)})),i},t.add=function(e){var t=this,n=Wa(this,e.type);return new Promise((function(i){n.loadWithAttachedResources(t.oasis.engine.resourceManager,e,t.oasis).then((function(e){i(t.getAddResourceResult(e.resources,e.structure))}))}))},t.remove=function(e){var t=this;return new Promise((function(n){var i=t.resourceMap[e],r=[e],a=!1;if(delete t.resourceMap[e],i)for(var o=i.attachedResources,s=0;s<o.length;s++){var u=o[s],c=t.resourceIdMap.get(u);c&&(a=!0,t.remove(c).then((function(e){r.push.apply(r,e),n(r)})))}a||n(r)}))},t.update=function(e,t,n){var i=this.get(e);return i&&i.update(t,n),{resource:i,id:e,key:t,value:n}},t.updateMeta=function(e,t,n){var i=this.get(e);i&&i.updateMeta(t,n)},t.get=function(e){return this.resourceMap[e]},t.getAll=function(){return I(this.resourceMap)},t.getAddResourceResult=function(e,t){var n=this,i={},r=e[t.index],a=""+ ++this.maxId;for(var o in this.resourceMap[a]=r,this.resourceIdMap.set(r,a),i.id=this.maxId,i.type=Ga.get(r.constructor),i.meta=r.meta,i.props={},t.props)if(t.props.hasOwnProperty(o)){var s=t.props[o];s&&(Array.isArray(s)?i.props[o]=s.map((function(t){return n.getAddResourceResult(e,t)})):i.props[o]=this.getAddResourceResult(e,s))}return i},ur(e,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var e;return null==(e=this.oasis.options.useCompressedTexture)||e}}]),e}();Ua([_a({before:"beforeResourceRemove"})],Xa.prototype,"remove",1),Ua([_a({after:"resourceUpdated",before:"beforeResourceUpdate"})],Xa.prototype,"update",1);var qa=Object.defineProperty,Ka=Object.getOwnPropertyDescriptor,Ya=function(e){function t(t,n){var i,r;return(r=e.call(this,t.engine)||this)._options=t,r.pluginManager=n,r.engine=null,r.oasis=rr(r),r.engine=t.engine,r.resetFeature(),r.schema=t.config,r.timeout=t.timeout,t.scripts=null!=(i=t.scripts)?i:{},r.nodeManager=new za(rr(r)),r.abilityManager=new Ia(rr(r)),r.nodeManager.add=r.nodeManager.add.bind(r.nodeManager),r.abilityManager.add=r.abilityManager.add.bind(r.abilityManager),r.resourceManager=new Xa(rr(r)),t.fps&&(r.engine.targetFrameRate=t.fps,r.engine.vSyncCount=0),r}dr(t,e);var n=t.prototype;return n.updateConfig=function(e){this.schema=e,this.init()},n.init=function(){var e=this;return this.loadResources().then((function(){e.bindResources(),e.parseEntities(),e.parseNodeAbilities(),e.attach(),e.nodeManager.addRootEntity(),e.pluginManager.boot(e)}))},n.loadResources=function(){var e=this,t=this.schema.assets,n=I(void 0===t?{}:t).filter((function(e){return!!ka[e.type]||(console.warn(e.type+" loader is not defined. the "+e.type+" type will be ignored."),!1)})).map((function(t){return e.resourceManager.load(t)}));return Promise.all(n)},n.bindResources=function(){this.resourceManager.getAll().forEach((function(e){e.bind()}))},n.parseEntities=function(){var e=this.schema.nodes;this.bfsNodes().map((function(t){return e[t]})).forEach(this.nodeManager.add)},n.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map((function(t){return hr({id:t},e[t])})).forEach(this.abilityManager.add)},n.bfsNodes=function(){var e=this.schema.nodes,t=I(e).filter((function(t){return!e[t.parent]})).map((function(e){return e.id})),n=[];return function t(i){n=n.concat(i),i.forEach((function(n){var i=e[n].children;i&&t(i)}))}(t),n},n.resetFeature=function(){var e=this.engine.sceneManager.activeScene;e.features.splice(2,1),e.features.splice(3,1),e.hasFogFeature=void 0,e.getFogMacro=void 0,e.bindFogToMaterial=void 0},n.attach=function(){this.resourceManager.getAll().forEach((function(e){e.attach()}))},t.create=function(e,n){var i=new t(e,n);return i.init().then((function(){return e.autoPlay&&i.engine.run(),i}))},ur(t,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),t}(Y);!function(e,t,n,i){for(var r,a=i>1?void 0:i?Ka(t,n):t,o=e.length-1;o>=0;o--)(r=e[o])&&(a=(i?r(t,n,a):r(a))||a);i&&a&&qa(t,n,a)}([_a({after:"schemaParsed"})],Ya.prototype,"init",1);var Qa=["color","center","size","__position","__positionRandomness","__color","__velocity","__velocityRandomness","__acceleration","__accelerationRandomness","_center"];function Za(e){for(var t=Object.keys(e),n=0,i=t.length;n<i;++n){var r=t[n],a=e[r];null!==a&&"object"==typeof a&&a.length>1&&("backgroundColor"===r||"tintColor"===r?e[r]=new v(a[0],a[1],a[2],a[3]):-1!==Qa.indexOf(r)&&(e[r]=new s(a[0],a[1],a[2])))}}function Ja(e){if(void 0===e&&(e={}),e)for(var t=Object.keys(e),n=0,i=t.length;n<i;n++){var r=t[n],a=e[r];if("newMaterial"!==r&&"blendFuncSeparate"!==r&&"scripts"!==r)switch(null==a?void 0:a.length){case 2:e[r]=new _(a[0],a[1]);break;case 3:e[r]=new s(a[0],a[1],a[2]);break;case 4:e[r]=new v(a[0],a[1],a[2],a[3])}}}var $a=function(){function e(){this.pluginManager=new da}var t=e.prototype;return t.parse=function(e){var t,n;3!==(null==e||null==(t=e.config)?void 0:t.version)&&console.warn('schema-parser: schema version "'+(null==e||null==(n=e.config)?void 0:n.version)+'" is out of date, please re-pull the latest version (version 3) of the schema');return function(e){for(var t=e.abilities,n=void 0===t?{}:t,i=e.assets,r=void 0===i?{}:i,a=Object.keys(n),o=Object.keys(r),s=0,u=a.length;s<u;++s)Za(n[a[s]].props);for(var c=0,l=o.length;c<l;++c)Ja(r[o[c]].props)}(e.config),Ya.create(e,this.pluginManager)},t.register=function(e){this.pluginManager.register(e)},t.resetPlugins=function(){this.pluginManager.reset()},e.create=function(){return new e},e.registerComponents=function(e,t){this._components[e]||(this._components[e]={}),Object.assign(this._components[e],t)},e}();$a._components={};$a.create();function eo(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return to(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return to(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function to(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function no(){return(no=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function io(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function ro(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ao(e,t,n){return t&&ro(e.prototype,t),n&&ro(e,n),e}var oo=[];var so=function(){function e(e){this._gl=e,this._vertexShader=null,this._fragmentShader=null,this._vertexShaderSource=null,this._fragmentShaderSource=null,this._program=null,this._attributeCache={},this._uniformCache={}}e.requireProgram=function(t,n){var i=null;if(oo.some((function(e){if(e._gl===n&&e._vertexShaderSource===t.vertexShader&&e._fragmentShaderSource===t.fragmentShader)return i=e,!0})),!i){if(!(i=new e(n)).createFromSource(t.vertexShader,t.fragmentShader,t.attribLocSet))return null;oo.push(i)}return i},e.releaseProgram=function(e){var t=oo.indexOf(e);-1!==t&&oo.splice(t,1)};var t=e.prototype;return t.createFromSource=function(e,t,n){var i=this._gl,r=this._compileShader(i.VERTEX_SHADER,e);if(!r)return!1;var a=this._compileShader(i.FRAGMENT_SHADER,t);if(!a)return!1;var o=i.createProgram();if(i.attachShader(o,r),i.attachShader(o,a),n)for(var s in n)i.bindAttribLocation(o,n[s],s);return i.linkProgram(o),i.validateProgram(o),i.isContextLost()?(Fe("Contex lost while linking program."),i.deleteShader(r),i.deleteShader(a),null):i.getProgramParameter(o,i.LINK_STATUS)||i.isContextLost()?(this._vertexShader=r,this._fragmentShader=a,this._vertexShaderSource=e,this._fragmentShaderSource=t,this._program=o,!0):(Fe("Could not link WebGL program. \n"+i.getProgramInfoLog(o)),i.deleteProgram(o),!1)},t._compileShader=function(e,t){var n,i,r,a=this._gl,o=a.createShader(e);return a.shaderSource(o,t),a.compileShader(o),a.isContextLost()?(Fe("Contex lost while compiling shader."),a.deleteShader(o),null):!Ne||a.getShaderParameter(o,a.COMPILE_STATUS)||a.isContextLost()?o:(Fe("Could not compile WebGL shader.\n"+(i=t.split("\n"),r=(i.length+1).toString().length+6,i.map((function(e,t){if((n="0:"+(t+1)).length>=r)return n.substring(0,r)+e;for(var i=0;i<r-n.length;i++)n+=" ";return n+e})).join("\n")+"\n")+a.getShaderInfoLog(o)),a.deleteShader(o),null)},t.getAttribLocation=function(e,t){return this._attributeCache.hasOwnProperty(t)?this._attributeCache[t]:this._attributeCache[t]=this._gl.getAttribLocation(e,t)},t.getUniformLocation=function(e,t){return this._uniformCache.hasOwnProperty(t)?this._uniformCache[t]:this._uniformCache[t]=this._gl.getUniformLocation(e,t)},t.finalize=function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._program&&t.deleteProgram(this._program),this._vertexShader=null,this._fragmentShader=null,this._vertexShaderSource=null,this._fragmentShaderSource=null,this._program=null,this._attributeCache={},this._uniformCache={},e.releaseProgram(this)},ao(e,[{key:"program",get:function(){return this._program}}]),e}(),uo=function(){function e(e,t){this._rhi=e,this.asset=t}return ao(e,[{key:"rhi",get:function(){return this._rhi}}]),e}(),co=function(e){function t(n,i){var r;(r=e.call(this,n,i)||this).cacheID=++t.cacheCounter,r._tech=i,r._activeTextureCount=0;var a=n.gl;if(r._program=so.requireProgram(i,a),r._program){r.valid=!0;var o=r._program.program;r._attributes={};var s=i.attributes;for(var u in s)r._attributes[u]={name:u,semantic:s[u].semantic,location:r._program.getAttribLocation(o,u)};r._uniforms={};var c=i.uniforms;for(var l in c){var f=r._program.getUniformLocation(o,l);null!==f&&(r._uniforms[l]={name:l,location:f})}}else r.valid=!1;return r}io(t,e);var n=t.prototype;return n.finalize=function(e){this._program&&e&&(this._program=null)},n.begin=function(e){var t=this.rhi.gl,n=this._program.program;this._activeTextureCount=0,t.useProgram(n);var i=this._uniforms,r=this._tech.uniforms;for(var a in r)if(i.hasOwnProperty(a)){var o=e.getValue(a);null!=o&&this._uploadUniformValue(r[a],i[a].location,o)}var s=this.rhi.renderStates;this._tech.states&&(s.pushStateBlock(this._tech.name),this._applyStates(s))},n.end=function(){this._tech.states&&this.rhi.renderStates.popStateBlock()},n._applyStates=function(e){var t=this._tech.states,n=t.enable;if(n)for(var i=0,r=n.length;i<r;i++)e.enable(n[i]);var a=t.disable;if(a)for(var o=0,s=a.length;o<s;o++)e.disable(a[o]);var u=t.functions;if(u)for(var c in u){var l=Array.isArray(u[c])?u[c]:[u[c]];e[c].apply(e,l)}},n._uploadUniformValue=function(e,t,n){var i=this.rhi.gl;switch(e.type){case _e.FLOAT:n.length?i.uniform1fv(t,n):i.uniform1f(t,n);break;case _e.FLOAT_ARRAY:i.uniform1fv(t,n);break;case _e.INT:n.length?i.uniform1iv(t,n):i.uniform1i(t,n);break;case _e.INT_ARRAY:i.uniform1iv(t,n);break;case _e.FLOAT_VEC2:i.uniform2f(t,n.x,n.y);break;case _e.FLOAT_VEC2_ARRAY:i.uniform2fv(t,n);break;case _e.FLOAT_VEC3:i.uniform3f(t,n.x,n.y,n.z);break;case _e.FLOAT_VEC3_ARRAY:i.uniform3fv(t,n);break;case _e.FLOAT_VEC4:i.uniform4f(t,n.x,n.y,n.z,n.w);break;case _e.FLOAT_VEC4_ARRAY:i.uniform4fv(t,n);break;case _e.INT_VEC2:i.uniform2i(t,n.x,n.y);break;case _e.INT_VEC2_ARRAY:i.uniform2iv(t,n);break;case _e.INT_VEC3:i.uniform3i(t,n.x,n.y,n.z);break;case _e.INT_VEC3_ARRAY:i.uniform3iv(t,n);break;case _e.INT_VEC4:i.uniform4i(t,n.x,n.y,n.z,n.w);break;case _e.INT_VEC4_ARRAY:i.uniform4iv(t,n);break;case _e.FLOAT_MAT2:i.uniformMatrix2fv(t,!1,n.elements);break;case _e.FLOAT_MAT2_ARRAY:i.uniformMatrix2fv(t,!1,n);break;case _e.FLOAT_MAT3:i.uniformMatrix3fv(t,!1,n.elements);break;case _e.FLOAT_MAT3_ARRAY:i.uniformMatrix3fv(t,!1,n);break;case _e.FLOAT_MAT4:i.uniformMatrix4fv(t,!1,n.elements);break;case _e.FLOAT_MAT4_ARRAY:i.uniformMatrix4fv(t,!1,n);break;case _e.SAMPLER_2D:this._uploadTexture(n,t);break;case _e.SAMPLER_2D_ARRAY:this._uploadTextures(n,t);break;case _e.SAMPLER_CUBE:this._uploadTexture(n,t);break;case _e.SAMPLER_CUBE_ARRAY:this._uploadTextures(n,t);break;default:Ie("UNKNOWN uniform type: "+e.type)}},n._uploadTexture=function(e,t){if(e){var n=this.rhi.gl,i=this._activeTextureCount++;n.activeTexture(n.TEXTURE0+i),n.bindTexture(e._target,e._glTexture),n.uniform1i(t,i)}},n._uploadTextures=function(e,t){this._tempSamplerArray&&this._tempSamplerArray.length===e.length||(this._tempSamplerArray=new Int32Array(e.length));for(var n=this.rhi.gl,i=0,r=e.length;i<r;i++){var a=e[i];if(a){var o=this._activeTextureCount++;n.activeTexture(n.TEXTURE0+o),n.bindTexture(a._target,a._glTexture),this._tempSamplerArray[i]=o}else this._tempSamplerArray[i]=-1}n.uniform1iv(t,this._tempSamplerArray)},ao(t,[{key:"program",get:function(){return this._program}},{key:"attributes",get:function(){return this._attributes}},{key:"uniforms",get:function(){return this._uniforms}}]),t}(uo);co.cacheCounter=0;var lo=function(){function e(e){this._scale=new _;var t=e.width,n=e.height;this._webCanvas=e,this._width=t,this._height=n}var t=e.prototype;return t.resizeByClientSize=function(e){void 0===e&&(e=window.devicePixelRatio);var t=this._webCanvas;if(t instanceof HTMLCanvasElement){var n=t.clientWidth,i=t.clientHeight;this.width=n*e,this.height=i*e}},t.setScale=function(e,t){this._scale.setValue(e,t),this.scale=this._scale},ao(e,[{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return e instanceof HTMLCanvasElement&&this._scale.setValue(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;t instanceof HTMLCanvasElement&&(t.style.transformOrigin="left top",t.style.transform="scale("+e.x+", "+e.y+")")}}]),e}(),fo=function(){function e(e,t){void 0===t&&(t={}),this._rhi=e,this._objectSet={},this._checkList=[],this._nextID=1,this._enableCollect=void 0===t.enableCollect||!!t.enableCollect}var t=e.prototype;return t.requireObject=function(e,t){var n=null;if(e.cacheID&&(n=this._objectSet[e.cacheID]),!n||e.needRecreate){var i=this._nextID++,r=this._objectSet;n=new t(this._rhi,e),r[i]=n,n.cacheID=i,n.asset=e,e.cacheID=i,e.needRecreate=!1,this._enableCollect&&e.type===Q.Cache&&this._checkList.push(n)}return n.activeFrame=this._rhi.frameCount,n},t.compact=function(){if(this._enableCollect)for(var e=this._rhi.frameCount,t=this._checkList,n=this._objectSet,i=t.length-1;i>=0;i--){var r=t[i];r.activeFrame<e&&(delete n[r.cacheID],t.splice(i,1),r.finalize())}},t.finalize=function(){for(var e in this._objectSet){this._objectSet[e].finalize(!0)}this._objectSet={},this._checkList=[]},e}(),ho=function(){function e(e){this._rhi=e,this.capabilityList=new Map,this.init(),this.compatibleAllInterface()}ao(e,[{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(Ce.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var e=this._rhi.requireExtension(Ce.textureFilterAnisotropic);this._maxAnisoLevel=e?this._rhi.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var e=this._rhi.gl,t=this.canIUse(Ce.multipleSample);this._maxAntiAliasing=t?e.getParameter(e.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]);var t=e.prototype;return t.canIUse=function(e){return this.capabilityList.get(e)},t.canIUseCompressedTextureInternalFormat=function(e){var t=dn.RGBA_ASTC_4X4_KHR,n=dn.RGBA_ASTC_12X12_KHR,i=dn.SRGB8_ALPHA8_ASTC_4X4_KHR,r=dn.SRGB8_ALPHA8_ASTC_12X12_KHR,a=dn.RGB_ETC1_WEBGL,o=dn.R11_EAC,s=dn.SRGB8_ALPHA8_ETC2_EAC,u=dn.RGB_PVRTC_4BPPV1_IMG,c=dn.RGBA_PVRTC_2BPPV1_IMG,l=dn.RGB_S3TC_DXT1_EXT,f=dn.RGBA_S3TC_DXT5_EXT;return e>=t&&n<=n||e>=i&&e<=r?this.canIUse(Ce.astc):e===a?this.canIUse(Ce.etc1):e>=o&&e<=s?this.canIUse(Ce.etc):e>=u&&e<=c?this.canIUse(Ce.pvrtc):e>=l&&e<=f&&this.canIUse(Ce.s3tc)},t.init=function(){var e=this.capabilityList,t=this.rhi.isWebGL2,n=this.rhi.requireExtension.bind(this.rhi),i=Ce.standardDerivatives,r=Ce.shaderTextureLod,a=Ce.elementIndexUint,o=Ce.depthTexture,s=Ce.vertexArrayObject,u=Ce.instancedArrays,c=Ce.multipleSample,l=Ce.drawBuffers,f=Ce.astc,h=Ce.astc_webkit,d=Ce.etc,_=Ce.etc_webkit,p=Ce.etc1,m=Ce.etc1_webkit,v=Ce.pvrtc,g=Ce.pvrtc_webkit,y=Ce.s3tc,x=Ce.s3tc_webkit,T=Ce.textureFloat,b=Ce.textureHalfFloat,E=Ce.textureFloatLinear,A=Ce.textureHalfFloatLinear,O=Ce.WEBGL_colorBufferFloat,C=Ce.colorBufferFloat,R=Ce.colorBufferHalfFloat,S=Ce.textureFilterAnisotropic;e.set(i,t||!!n(i)),e.set(r,t||!!n(r)),e.set(a,t||!!n(a)),e.set(o,t||!!n(o)),e.set(s,t||!!n(s)),e.set(u,t||!!n(u)),e.set(c,t),e.set(l,t||!!n(l)),e.set(T,t||!!n(T)),e.set(b,t||!!n(b)),e.set(E,!!n(E)),e.set(A,t||!!n(A)),e.set(C,t&&!!n(C)||!!n(O)),e.set(R,t&&!!n(C)||!!n(R)),e.set(S,!!n(S)),e.set(f,!(!n(f)&&!n(h))),e.set(d,!(!n(d)&&!n(_))),e.set(p,!(!n(p)&&!n(m))),e.set(v,!(!n(v)&&!n(g))),e.set(y,!(!n(y)&&!n(x)))},t.compatibleInterface=function(e,t){var n,i=this.rhi,r=i.gl;if(n=i.requireExtension(e))for(var a in t){var o=n[t[a]];null!=o&&o.bind?r[a]=o.bind(n):r[a]=o}},t.compatibleAllInterface=function(){var e=Ce.depthTexture,t=Ce.vertexArrayObject,n=Ce.instancedArrays,i=Ce.drawBuffers,r=Ce.textureFilterAnisotropic,a=Ce.textureHalfFloat,o=Ce.colorBufferHalfFloat,s=Ce.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this.compatibleInterface(e,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this.compatibleInterface(t,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this.compatibleInterface(n,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this.compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var u={};if(this.canIUse(Ce.drawBuffers)){for(var c=this.maxDrawBuffers,l=0;l<c;l++)0!=l&&(u["COLOR_ATTACHMENT"+l]="COLOR_ATTACHMENT"+l+"_WEBGL"),u["DRAW_BUFFER"+l]="DRAW_BUFFER"+l+"_WEBGL";this.compatibleInterface(i,no({drawBuffers:"drawBuffersWEBGL"},u))}this.compatibleInterface(a,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this.compatibleInterface(o,{RGBA16F:"RBGA16F_EXT"}),this.compatibleInterface(s,{RGBA32F:"RBGA32F_EXT"})}this.compatibleInterface(r,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},ao(e,[{key:"canIUseMoreJoints",get:function(){return this.canIUse(Ce.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}}]),e}(),_o=function(){function e(e){this.rhi=e,this._requireResult={}}return e.prototype.requireExtension=function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]},e}(),po=function(){function e(e,t){this.vao=new Map,this._primitive=t,this.canUseInstancedArrays=e.canIUse(Ce.instancedArrays),this._useVao=e.canIUse(Ce.vertexArrayObject),this.gl=e.gl}var t=e.prototype;return t.draw=function(e,t){var n=this.gl,i=this._primitive;if(this._useVao){this.vao.has(e.cacheID)||this.registerVAO(e);var r=this.vao.get(e.cacheID);n.bindVertexArray(r)}else this.bindBufferAndAttrib(e);var a=i.indexBufferBinding,o=i.instanceCount,s=i._glIndexType,u=t.topology,c=t.start,l=t.count;if(o)if(this.canUseInstancedArrays)if(a)if(this._useVao)n.drawElementsInstanced(u,l,s,c,o);else{var f=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,f),n.drawElementsInstanced(u,l,s,c,o),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArraysInstanced(u,c,l,o);else Fe("ANGLE_instanced_arrays extension is not supported");else if(a)if(this._useVao)n.drawElements(u,l,s,c);else{var h=a.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,h),n.drawElements(u,l,s,c),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArrays(u,c,l);this._useVao?n.bindVertexArray(null):this.disableAttrib()},t.destroy=function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)}))}},t.bindBufferAndAttrib=function(e){var t=this.gl,n=this._primitive,i=n.vertexBufferBindings;this.attribLocArray=[];var r,a,o=e.attributes,s=n._vertexElementMap;for(var u in o){var c=o[u].location;if(-1!==c){var l=s[o[u].semantic];if(l){var f=i[l.bindingIndex],h=f.buffer,d=f.stride;a!==(r=h._nativeBuffer)&&(a=r,t.bindBuffer(t.ARRAY_BUFFER,r)),t.enableVertexAttribArray(c);var _=l._glElementInfo,p=_.size,m=_.type;t.vertexAttribPointer(c,p,m,l.normalized,d,l.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(c,l.instanceDivisor),this.attribLocArray.push(c)}else Ie("vertex attribute not found: "+u)}}t.bindBuffer(t.ARRAY_BUFFER,null)},t.disableAttrib=function(){for(var e=this.gl,t=0,n=this.attribLocArray.length;t<n;t++)e.disableVertexAttribArray(this.attribLocArray[t])},t.registerVAO=function(e){var t=this.gl,n=t.createVertexArray();t.bindVertexArray(n);var i=this._primitive.indexBufferBinding;i&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.cacheID,n)},e}(),mo=function(){function e(e){this._stateStack=[],this._parameters={},this._gl=e,this._stateStack=[],this._parameters={},this._parameters[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_VERTEX_UNIFORM_VECTORS]=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[e.MAX_VERTEX_ATTRIBS]=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._parameters[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[e.BLEND]=!1,e.disable(e.BLEND),this._parameters[e.CULL_FACE]=!0,e.enable(e.CULL_FACE),this._parameters[e.DEPTH_TEST]=!0,e.enable(e.DEPTH_TEST),this._parameters[e.DITHER]=!1,e.disable(e.DITHER),this._parameters[e.POLYGON_OFFSET_FILL]=!1,e.disable(e.POLYGON_OFFSET_FILL),this._parameters[e.SAMPLE_ALPHA_TO_COVERAGE]=!1,e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),this._parameters[e.SAMPLE_COVERAGE]=!1,e.disable(e.SAMPLE_COVERAGE),this._parameters[e.SCISSOR_TEST]=!1,e.disable(e.SCISSOR_TEST),this._parameters[e.STENCIL_TEST]=!1,e.disable(e.STENCIL_TEST),this._parameters[e.COLOR_WRITEMASK]=[!0,!0,!0,!0],e.colorMask(!0,!0,!0,!0),this._parameters[e.DEPTH_WRITEMASK]=!0,e.depthMask(!0),this._parameters[e.BLEND_SRC_RGB]=e.ONE,this._parameters[e.BLEND_SRC_ALPHA]=e.ONE,this._parameters[e.BLEND_DST_RGB]=e.ZERO,this._parameters[e.BLEND_DST_ALPHA]=e.ZERO,e.blendFunc(e.ONE,e.ZERO),this._parameters[e.BLEND_EQUATION_RGB]=e.FUNC_ADD,this._parameters[e.BLEND_EQUATION_ALPHA]=e.FUNC_ADD,this._parameters[e.CULL_FACE_MODE]=e.BACK,e.cullFace(e.BACK),this._parameters[e.FRONT_FACE]=e.CCW,e.frontFace(e.CCW),this._parameters[e.DEPTH_FUNC]=e.LESS,e.depthFunc(e.LESS),this._parameters[e.DEPTH_RANGE]=[0,1],e.depthRange(0,1),this._parameters[e.POLYGON_OFFSET_FACTOR]=0,this._parameters[e.POLYGON_OFFSET_UNITS]=0,e.polygonOffset(0,0),this._parameters[e.SCISSOR_BOX]=[0,0,e.canvas.width,e.canvas.height],this._parameters[e.STENCIL_FUNC]=e.ALWAYS,this._parameters[e.STENCIL_VALUE_MASK]=255,this._parameters[e.STENCIL_REF]=0,e.stencilFunc(e.ALWAYS,0,255),this._parameters[e.STENCIL_WRITEMASK]=255,e.stencilMask(255),this._parameters[e.STENCIL_FAIL]=e.KEEP,this._parameters[e.STENCIL_PASS_DEPTH_FAIL]=e.KEEP,this._parameters[e.STENCIL_PASS_DEPTH_PASS]=e.KEEP}var t=e.prototype;return t.getParameter=function(e){return this._parameters[e]},t.pushStateBlock=function(e){var t={name:e,states:[]};this._stateStack.push(t)},t.popStateBlock=function(){for(var e,t=eo(this._stateStack.pop().states);!(e=t()).done;){var n=e.value,i=n.func,r=n.args,a=n.parameters;for(var o in i.apply(this._gl,r),a)this._parameters[o]=a[o]}},t._getStateStackTop=function(){var e=this._stateStack.length;return e>0?this._stateStack[e-1]:null},t._pushState=function(e,t,n){var i=this._getStateStackTop();i&&i.states.push({func:e,args:t,parameters:n})},t.enable=function(e){if(!0!==this._parameters[e]){this._parameters[e]=!0,this._gl.enable(e);var t={};t[e]=!1,this._pushState(this._gl.disable,[e],t)}},t.disable=function(e){if(!1!==this._parameters[e]){this._parameters[e]=!1,this._gl.disable(e);var t={};t[e]=!0,this._pushState(this._gl.enable,[e],t)}},t.blendFunc=function(e,t){var n=this._gl,i=this._parameters;if(i[n.BLEND_SRC_RGB]!==e||i[n.BLEND_SRC_ALPHA]!==e||i[n.BLEND_DST_RGB]!==t||i[n.BLEND_DST_ALPHA]!==t){var r=[i[n.BLEND_SRC_RGB],i[n.BLEND_DST_RGB],i[n.BLEND_SRC_ALPHA],i[n.BLEND_DST_ALPHA]],a={};a[n.BLEND_SRC_RGB]=i[n.BLEND_SRC_RGB],a[n.BLEND_DST_RGB]=i[n.BLEND_DST_RGB],a[n.BLEND_SRC_ALPHA]=i[n.BLEND_SRC_ALPHA],a[n.BLEND_DST_ALPHA]=i[n.BLEND_DST_ALPHA],this._pushState(n.blendFuncSeparate,r,a),i[n.BLEND_SRC_RGB]=e,i[n.BLEND_SRC_ALPHA]=e,i[n.BLEND_DST_RGB]=t,i[n.BLEND_DST_ALPHA]=t,n.blendFunc(e,t)}},t.blendFuncSeparate=function(e,t,n,i){var r=this._gl,a=this._parameters;if(a[r.BLEND_SRC_RGB]!==e||a[r.BLEND_SRC_ALPHA]!==n||a[r.BLEND_DST_RGB]!==t||a[r.BLEND_DST_ALPHA]!==i){var o=[a[r.BLEND_SRC_RGB],a[r.BLEND_DST_RGB],a[r.BLEND_SRC_ALPHA],a[r.BLEND_DST_ALPHA]],s={};s[r.BLEND_SRC_RGB]=a[r.BLEND_SRC_RGB],s[r.BLEND_DST_RGB]=a[r.BLEND_DST_RGB],s[r.BLEND_SRC_ALPHA]=a[r.BLEND_SRC_ALPHA],s[r.BLEND_DST_ALPHA]=a[r.BLEND_DST_ALPHA],this._pushState(r.blendFuncSeparate,o,s),a[r.BLEND_SRC_RGB]=e,a[r.BLEND_SRC_ALPHA]=n,a[r.BLEND_DST_RGB]=t,a[r.BLEND_DST_ALPHA]=i,r.blendFuncSeparate(e,t,n,i)}},t.blendEquationSeparate=function(e,t){var n=this._gl,i=this._parameters;if(i[n.BLEND_EQUATION_RGB]!==e||i[n.BLEND_EQUATION_ALPHA]!==t){var r=[i[n.BLEND_EQUATION_RGB],i[n.BLEND_EQUATION_ALPHA]],a={};a[n.BLEND_EQUATION_RGB]=i[n.BLEND_EQUATION_RGB],a[n.BLEND_EQUATION_ALPHA]=i[n.BLEND_EQUATION_ALPHA],this._pushState(n.blendEquationSeparate,r,a),i[n.BLEND_EQUATION_RGB]=e,i[n.BLEND_EQUATION_ALPHA]=t,n.blendEquationSeparate(e,t)}},t.colorMask=function(e,t,n,i){var r=this._gl,a={};a[r.COLOR_WRITEMASK]=this._parameters[r.COLOR_WRITEMASK],this._pushState(r.colorMask,this._parameters[r.COLOR_WRITEMASK],a),this._parameters[r.COLOR_WRITEMASK]=[e,t,n,i],r.colorMask(e,t,n,i)},t.depthMask=function(e){var t=this._gl;if(this._parameters[t.DEPTH_WRITEMASK]!==e){var n={};n[t.DEPTH_WRITEMASK]=this._parameters[t.DEPTH_WRITEMASK],this._pushState(t.depthMask,[this._parameters[t.DEPTH_WRITEMASK]],n),this._parameters[t.DEPTH_WRITEMASK]=e,t.depthMask(e)}},t.cullFace=function(e){var t=this._gl;if(this._parameters[t.CULL_FACE_MODE]!==e){var n={};n[t.CULL_FACE_MODE]=this._parameters[t.CULL_FACE_MODE],this._pushState(t.cullFace,[this._parameters[t.CULL_FACE_MODE]],n),this._parameters[t.CULL_FACE_MODE]=e,t.cullFace(e)}},t.frontFace=function(e){var t=this._gl;if(this._parameters[t.FRONT_FACE]!==e){var n={};n[t.FRONT_FACE]=this._parameters[t.FRONT_FACE],this._pushState(t.frontFace,[this._parameters[t.FRONT_FACE]],n),this._parameters[t.FRONT_FACE]=e,t.frontFace(e)}},t.depthFunc=function(e){var t=this._gl;if(this._parameters[t.DEPTH_FUNC]!==e){var n={};n[t.DEPTH_FUNC]=this._parameters[t.DEPTH_FUNC],this._pushState(t.depthFunc,[this._parameters[t.DEPTH_FUNC]],n),this._parameters[t.DEPTH_FUNC]=e,t.depthFunc(e)}},t.depthRange=function(e,t){var n=this._gl,i=this._parameters[n.DEPTH_RANGE];if(i[0]!==e||i[1]!==t){var r={};r[n.DEPTH_RANGE]=i,this._pushState(n.depthRange,[this._parameters[n.DEPTH_RANGE]],r),this._parameters[n.DEPTH_RANGE]=[e,t],n.depthRange(e,t)}},t.polygonOffset=function(e,t){var n=this._gl;if(this._parameters[n.POLYGON_OFFSET_FACTOR]!==e||this._parameters[n.POLYGON_OFFSET_UNITS]!==t){var i={};i[n.POLYGON_OFFSET_FACTOR]=this._parameters[n.POLYGON_OFFSET_FACTOR],i[n.POLYGON_OFFSET_UNITS]=this._parameters[n.POLYGON_OFFSET_UNITS],this._pushState(n.polygonOffset,[this._parameters[n.POLYGON_OFFSET_FACTOR],this._parameters[n.POLYGON_OFFSET_UNITS]],i),this._parameters[n.POLYGON_OFFSET_FACTOR]=e,this._parameters[n.POLYGON_OFFSET_UNITS]=t,n.polygonOffset(e,t)}},t.scissor=function(e,t,n,i){var r=this._gl,a=this._parameters[r.SCISSOR_BOX];if(a[0]!==e||a[1]!==t||a[2]!==n||a[3]!==i){var o={};o[r.SCISSOR_BOX]=a,this._pushState(r.scissor,a,o),this._parameters[r.SCISSOR_BOX]=[e,t,n,i],r.scissor(e,t,n,i)}},t.stencilFunc=function(e,t,n){var i=this._gl;if(this._parameters[i.STENCIL_FUNC]!==e||this._parameters[i.STENCIL_REF]!==t||this._parameters[i.STENCIL_VALUE_MASK]!==n){var r=[this._parameters[i.STENCIL_FUNC],this._parameters[i.STENCIL_REF],this._parameters[i.STENCIL_VALUE_MASK]],a={};a[i.STENCIL_FUNC]=r[0],a[i.STENCIL_REF]=r[1],a[i.STENCIL_VALUE_MASK]=r[2],this._pushState(i.stencilFunc,r,a),this._parameters[i.STENCIL_FUNC]=e,this._parameters[i.STENCIL_REF]=t,this._parameters[i.STENCIL_VALUE_MASK]=n,i.stencilFunc(e,t,n)}},t.stencilOp=function(e,t,n){var i=this._gl;if(this._parameters[i.STENCIL_FAIL]!==e||this._parameters[i.STENCIL_PASS_DEPTH_FAIL]!==t||this._parameters[i.STENCIL_PASS_DEPTH_PASS]!==n){var r=[this._parameters[i.STENCIL_FAIL],this._parameters[i.STENCIL_PASS_DEPTH_FAIL],this._parameters[i.STENCIL_PASS_DEPTH_PASS]],a={};a[i.STENCIL_FAIL]=r[0],a[i.STENCIL_PASS_DEPTH_FAIL]=r[1],a[i.STENCIL_PASS_DEPTH_PASS]=r[2],this._pushState(i.stencilOp,r,a),this._parameters[i.STENCIL_FAIL]=e,this._parameters[i.STENCIL_BACK_PASS_DEPTH_FAIL]=t,this._parameters[i.STENCIL_PASS_DEPTH_PASS]=n,i.stencilOp(e,t,n)}},t.stencilMask=function(e){var t=this._gl;if(this._parameters[t.STENCIL_WRITEMASK]!==e){var n={};n[t.STENCIL_WRITEMASK]=this._parameters[t.STENCIL_WRITEMASK],this._pushState(t.stencilMask,[this._parameters[t.STENCIL_WRITEMASK]],n),this._parameters[t.STENCIL_WRITEMASK]=e,t.stencilMask(e)}},e}(),vo=function(){function e(e){this.gl=e,this._initVertexAttributes(e),this._vbo=e.createBuffer(),this._maxBatchCount=0,this._vertBuffer=null,this._vertCursor=0,this._drawSpriteCount=0}var t=e.prototype;return t.setMaxBatchCount=function(e){var t=6*e*9;this._vertBuffer&&this._vertBuffer.length>=t||(this._maxBatchCount=e,this._vertBuffer=new Float32Array(t))},t.beginDraw=function(e){this._vertCursor=0,this._drawSpriteCount=0,e>this._maxBatchCount&&this.setMaxBatchCount(e)},t.drawSprite=function(e,t,n){if(this._drawSpriteCount++,this._drawSpriteCount>this._maxBatchCount)Ie("Sprite: sprite count overflow");else{var i=n,r=t.u,a=t.v,o=t.u+t.width,s=t.v+t.height;this._pushVertex(e.leftTop,new _(r,a),i),this._pushVertex(e.leftBottom,new _(r,s),i),this._pushVertex(e.rightBottom,new _(o,s),i),this._pushVertex(e.rightBottom,new _(o,s),i),this._pushVertex(e.rightTop,new _(o,a),i),this._pushVertex(e.leftTop,new _(r,a),i)}},t.endDraw=function(){var e=this._vertCursor/9;if(!(e<=0)){var t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,this._vbo),t.bufferData(t.ARRAY_BUFFER,this._vertBuffer,t.DYNAMIC_DRAW);for(var n=0,i=this._vertAttributes.length;n<i;n++){var r=this._vertAttributes[n];t.vertexAttribPointer(r.lastShaderLoc,r.size,r.type,r.normalized,r.stride,r.offset),t.enableVertexAttribArray(r.lastShaderLoc)}t.drawArrays(t.TRIANGLES,0,e),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),t.bindBuffer(t.ARRAY_BUFFER,null);for(var a=0,o=this._vertAttributes.length;a<o;a++)t.disableVertexAttribArray(this._vertAttributes[a].lastShaderLoc)}},t._initVertexAttributes=function(e){var t={name:"a_pos",size:3,offset:0,lastShaderLoc:0},n={name:"a_uv",size:2,offset:12,lastShaderLoc:1},i={name:"a_color",size:4,offset:20,lastShaderLoc:2};this._vertAttributes=[t,n,i];for(var r,a=eo(this._vertAttributes);!(r=a()).done;){var o=r.value;o.type=e.FLOAT,o.normalized=!1,o.stride=36}},t._pushVertex=function(e,t,n){var i=this._vertBuffer,r=this._vertCursor;i[r]=e.x,i[r+1]=e.y,i[r+2]=e.z,i[r+3]=t.x,i[r+4]=t.y,i[r+5]=n.x,i[r+6]=n.y,i[r+7]=n.z,i[r+8]=n.w,this._vertCursor+=9},t.finalize=function(){this._vbo&&(this.gl.deleteBuffer(this._vbo),this._vbo=null)},e}(),go={name:"spriteTech3D",vertexShader:"\nprecision highp float;\n\nuniform mat4 matProjection;\nuniform mat4 matView;\n\nattribute vec3 a_pos;\nattribute vec2 a_uv;\nattribute vec4 a_color;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  gl_Position = matProjection * matView * vec4(a_pos,1.0);\n  v_uv = a_uv;\n  v_color = a_color;\n}\n",fragmentShader:"\nprecision mediump float;\nprecision mediump int;\n\nuniform sampler2D s_diffuse;\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main()\n{\n  // 只使用贴图的Alpha做Mask，这样Tint Color依然可以控制控件Fade Out\n  vec4 baseColor = texture2D(s_diffuse, v_uv);\n  gl_FragColor = baseColor * v_color;\n}\n",attribLocSet:{a_pos:0,a_uv:1,a_color:2},attributes:{a_pos:{name:"a_pos",semantic:"POSITION",type:_e.FLOAT_VEC3},a_uv:{name:"a_uv",semantic:"TEXCOORD_0",type:_e.FLOAT_VEC2},a_color:{name:"a_color",semantic:"COLOR",type:_e.FLOAT_VEC3}},uniforms:{matProjection:{name:"matProjection",semantic:me.PROJECTION,type:_e.FLOAT_MAT4},matView:{name:"matView",semantic:me.VIEW,type:_e.FLOAT_MAT4},s_diffuse:{name:"s_diffuse",type:_e.SAMPLER_2D}},states:{disable:[ne.CULL_FACE],enable:[ne.BLEND],functions:{blendFunc:[ge.SRC_ALPHA,ge.ONE_MINUS_SRC_ALPHA],depthMask:[!1]}}};var yo,xo,To=function(){function e(e){var t;this._gl=e.gl,this._batchedQueue=[],this._targetTexture=null,this._glSprite=new vo(e.gl),this._glTech=new co(e,go),this._material={values:t={},setValue:function(e,n){t[e]=n},getValue:function(e){return t[e]}},this._camera=null}var t=e.prototype;return t.flush=function(){if(0!==this._batchedQueue.length)if(this._targetTexture){this._material.setValue("s_diffuse",this._targetTexture),this._material.setValue("matView",this._camera.viewMatrix),this._material.setValue("matProjection",this._camera.projectionMatrix),this._glTech.begin(this._material),this._glSprite.beginDraw(this._batchedQueue.length);for(var e=0,t=this._batchedQueue.length;e<t;e++){var n=this._batchedQueue[e].positionQuad,i=this._batchedQueue[e].uvRect,r=this._batchedQueue[e].tintColor;this._glSprite.drawSprite(n,i,r)}this._glSprite.endDraw(),this._glTech.end(),this._batchedQueue=[],this._targetTexture=null,this._camera=null}else Fe("No texture!")},t.canBatch=function(e,t,n){return null===this._targetTexture||e===this._targetTexture&&n===this._camera},t.drawSprite=function(e,t,n,i,r,a){this.canBatch(i,r,a)||this.flush(),this._targetTexture=i,this._camera=a,this._batchedQueue.push({positionQuad:e,uvRect:t,tintColor:n})},t.finalize=function(){this._glSprite.finalize(),this._glTech.finalize()},e}();(xo=yo||(yo={}))[xo.Auto=0]="Auto",xo[xo.WebGL2=1]="WebGL2",xo[xo.WebGL1=2]="WebGL1";var bo=function(){function e(e){void 0===e&&(e={}),this._options=e}ao(e,[{key:"isWebGL2",get:function(){return this._isWebGL2}}]);var t=e.prototype;return t.init=function(e){var t,n=this._options,i=e._webCanvas,r=n.webGLMode||0;if(0!=r&&1!=r||(!(t=i.getContext("webgl2",n))&&i instanceof HTMLCanvasElement&&(t=i.getContext("experimental-webgl2",n)),this._isWebGL2=!0),t||0!=r&&2!=r||(!(t=i.getContext("webgl",n))&&i instanceof HTMLCanvasElement&&(t=i.getContext("experimental-webgl",n)),this._isWebGL2=!1),!t)throw new Error("Get GL Context FAILED.");this._gl=t,this._renderStates=new mo(t),this._assetsCache=new fo(this,n),this._extensions=new _o(this),this._capability=new ho(this),this._frameCount=0,this._options=null},t.createPlatformPrimitive=function(e){return new po(this,e)},t.requireExtension=function(e){return this._extensions.requireExtension(e)},t.canIUse=function(e){return this.capability.canIUse(e)},t.canIUseCompressedTextureInternalFormat=function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)},t.viewport=function(e,t,n,i){var r=this._gl;r.viewport(e,r.drawingBufferHeight-t-i,n,i)},t.colorMask=function(e,t,n,i){this._gl.colorMask(e,t,n,i)},t.beginFrame=function(){this._frameCount++},t.clearRenderTarget=function(e,t){var n=this._gl;switch(e){case J.SOLID_COLOR:n.clearColor(t.x,t.y,t.z,t.w),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);break;case J.DEPTH_ONLY:n.clear(n.DEPTH_BUFFER_BIT);break;case J.COLOR_ONLY:n.clearColor(t.x,t.y,t.z,t.w),n.clear(n.COLOR_BUFFER_BIT);break;case J.STENCIL_ONLY:n.clear(n.STENCIL_BUFFER_BIT);break;case J.ALL_CLEAR:n.clearColor(t.x,t.y,t.z,t.w),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT);break;case J.DONT_CLEAR:}},t.drawPrimitive=function(e,t,n){var i=n.technique._glTechnique;i||(i=n.technique._glTechnique=new co(this,n.technique)),i.valid&&(e&&i?(i.begin(n),e.draw(i,t),i.end()):Fe("draw primitive failed."))},t.drawSprite=function(e,t,n,i,r,a){this._spriteBatcher||(this._spriteBatcher=new To(this)),this._spriteBatcher.drawSprite(e,t,n,i,r,a)},t.flushSprite=function(){this._spriteBatcher&&this._spriteBatcher.flush()},t.activeRenderTarget=function(e,t){var n=this._gl;if(e){e._activeRenderTarget();var i=e.width,r=e.height;n.viewport(0,0,i,r)}else{n.bindFramebuffer(n.FRAMEBUFFER,null);var a=t.viewport,o=n.drawingBufferWidth,s=n.drawingBufferHeight;this.viewport(a.x*o,a.y*s,a.z*o,a.w*s)}},t.blitRenderTarget=function(e){e&&e._MSAAFrameBuffer&&e._blitRenderTarget()},t.setRenderTargetFace=function(e,t){e&&e._setRenderTargetFace(t)},t.endFrame=function(){this._frameCount%8==0&&this._assetsCache.compact()},t.destroy=function(){this._assetsCache.finalize()},ao(e,[{key:"gl",get:function(){return this._gl}},{key:"assetsCache",get:function(){return this._assetsCache}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"frameCount",get:function(){return this._frameCount}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),e}();$a.registerComponents("o3",{GLTFModel:ha,SpriteRenderer:li,PointLight:Ht,AmbientLight:Ut,DirectLight:kt,EnvironmentMapLight:jt,Particle:Di,SkyBox:Fi,BoxCollider:zi,GeometryRenderer:Ci,Camera:St,Component:Xe,SphereCollider:Vi,PlaneProbe:Wi,Model:Li})},function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var i={};function r(e){for(var t in e)/^[A-Z_]/.test(t)&&(i[t]=e[t])}r(WebGLRenderingContext),r(WebGLRenderingContext.prototype)},function(e,t,n){"use strict";n.d(t,"h",(function(){return u})),n.d(t,"i",(function(){return c})),n.d(t,"f",(function(){return l})),n.d(t,"g",(function(){return f})),n.d(t,"b",(function(){return h})),n.d(t,"d",(function(){return d})),n.d(t,"c",(function(){return _})),n.d(t,"e",(function(){return p})),n.d(t,"a",(function(){return m}));var i=n(7),r=n(16),a=n(0),o=n(6),s=o.a.constants;function u(e,t){if(1===e||4===e)t.blendSrc=s.SRC_ALPHA,t.blendDst=s.ONE,t.blendSrcAlpha=s.ONE,t.blendDstAlpha=s.ONE,4===e&&(t.blendEquationAlpha=t.blendEquation=s.FUNC_REVERSE_SUBTRACT);else if(2===e)t.blendSrc=s.DST_COLOR,t.blendDst=s.ONE_MINUS_SRC_ALPHA;else{if(5===e)return t.blendSrc=s.DST_COLOR,t.blendDst=s.DST_ALPHA,t.blendSrcAlpha=s.ZERO,t.blendDstAlpha=s.ONE,1;if(6===e)return t.blendSrc=s.DST_COLOR,t.blendDst=s.ZERO,t.blendSrcAlpha=s.ZERO,t.blendDstAlpha=s.ONE,1;t.blendSrc=s.SRC_ALPHA,t.blendDst=s.ONE_MINUS_SRC_ALPHA,t.blendSrcAlpha=s.ONE,t.blendDstAlpha=s.ONE_MINUS_SRC_ALPHA}return 0}function c(e,t,n){0!==e&&e?(n.stencilTest=!0,n.stencilOpFail=s.KEEP,n.stencilOpZFail=s.KEEP,n.stencilOpZPass=s.KEEP,n.stencilMask=255,n.stencilFuncMask=255,n.stencilFuncRef=t,1===e?(n.stencilFunc=s.ALWAYS,n.stencilOpZPass=s.REPLACE):3===e?n.stencilFunc=s.NOTEQUAL:2===e&&(n.stencilFunc=s.EQUAL)):n.stencilTest=!1}function l(e,t){Object(a.d)(e.getUniformValues(),(function(e){e&&(t?e.isTexture:e.isDataTexture)&&e.destroy()}))}function f(e,t,n,i){if(void 0===n&&(n=1),e.buffer.byteLength<e.BYTES_PER_ELEMENT*t){var r=t*n;isNaN(i)||(r=Math.min(r,i));var a=new ArrayBuffer(e.BYTES_PER_ELEMENT*r),o=new e.constructor(a);return o.set(e),o}return e}function h(e,t){var n={minFilter:(t=t||{}).minFilter||s.LINEAR_MIPMAP_LINEAR,magFilter:t.magFilter||s.LINEAR,dataReleasable:t.dataReleasable,format:t.format||s.RGBA,type:t.type||s.UNSIGNED_BYTE};if(t.clamp?n.wrapS=n.wrapT=s.MIRRORED_REPEAT:n.wrapS=n.wrapT=s.REPEAT,t.compressed&&(n.type=s.UNSIGNED_SHORT_4_4_4_4),null!=e&&e.isTextureContainer)return e;if("string"==typeof e&&e.length)return"#"===e[0]?_(Object(i.d)(e)):(n.src=e,n.flipY=!0,o.a.createTextureContainer(n));var a=e instanceof ImageData,u=e instanceof HTMLVideoElement;return null!=e&&e.src||e instanceof Image||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||u||a?(n.image=e,n.flipY=!1!==t.flipY,!a&&!u||Object(r.a)(e.width)&&Object(r.a)(e.height)||(n.magFilter=n.minFilter=s.NEAREST,n.wrapS=n.wrapT=s.CLAMP_TO_EDGE,n.autoUpdate=u,n.isVideo=u),o.a.createTextureContainer(n)):e instanceof ArrayBuffer?(n.data=e,n.compressed=!0,o.a.createTextureContainer(n)):e}function d(){return _({width:1,height:1,data:new Uint8Array([255])},{format:s.LUMINANCE,internalFormat:s.LUMINANCE})}function _(e,t){return t=t||{},o.a.createTextureContainer({data:e||Object(i.d)("#fff"),type:t.type||s.UNSIGNED_BYTE,format:t.format||s.RGBA,internalFormat:t.format||s.RGBA,wrapS:s.MIRRORED_REPEAT,wrapT:s.MIRRORED_REPEAT,minFilter:s.NEAREST,magFilter:s.NEAREST,dataReleasable:!0})}function p(e){return _(Object(i.e)(e))}function m(e,t,n,i){var r={},o=[],s=(i=i||{}).templateScale||1;return n=n||{},Object(a.d)(t.variables,(function(e,t){if(n.hasOwnProperty(t)&&(e=n[t]),/^image_/.test(t)){var i=e instanceof Array,s=i?e[0]:e;o.push(function(e,t){return n(e,(function(i){return t?n(t,(function(){return e})):e}));function n(e,t){return/^(https?:)?\/\//.test(e)?Object(a.n)(e,{responseType:"blob"}).then(v,t):Promise.resolve(e)}}(s,i&&e[1]).then((function(e){return r[t]=e})))}else r[t]=e})),Promise.all(o).then((function(){return Object(a.i)(e).then((function(e){var n=t.content.replace(/\$([\w_]+)\$/g,(function(e,t){return r[t]})).replace('width="'+t.width+'px"','width="'+t.width*s+'px"').replace('height="'+t.height+'px"','height="'+t.height*s+'px"');return Object(a.i)("data:image/svg+xml,"+encodeURIComponent(n)).then((function(n){var r=i.canvas||document.createElement("canvas");r.width=e.width*s,r.height=e.height*s;var a=r.getContext("2d");return a.clearRect(0,0,r.width,r.height),a.drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height),a.drawImage(n,0,0,n.width,n.height,0,0,t.width*s/t.backgroundWidth*e.width,t.height*s/t.backgroundHeight*e.height),r}))}))}))}function v(e){return new Promise((function(t,n){var i=new FileReader;i.readAsDataURL(e),i.onload=function(){t(i.result)},i.onerror=n}))}},function(e,t,n){"use strict";if(n.d(t,"a",(function(){return i})),!__MarsRI__)throw Error("mars render interface not imported");var i=__MarsRI__},function(e,t,n){"use strict";n.d(t,"d",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return s})),n.d(t,"e",(function(){return u})),n.d(t,"f",(function(){return c})),n.d(t,"b",(function(){return l}));var i=n(0);function r(e){Object(i.h)(e)&&(e=l(e));for(var t=o(1,1),n=t.data,r=0;r<4;r++)n[r]=e[r];return t}function a(e,t){var n=[];if(Object(i.d)(e,(function(e,i){return n.push({color:l(e,t),stop:f(i)})})),(n=n.sort((function(e,t){return e.stop-t.stop}))).length){0!==n[0].stop&&n.unshift({stop:0,color:n[0].color.slice()});var r=n[n.length-1];1!==r.stop&&n.push({stop:1,color:r.color.slice()})}return n}function o(e,t){return{width:e,height:t,data:new Uint8Array(e*t*4)}}function s(e,t,n){if(e.length){for(var i,r=1;r<=e.length-1;r++){var a=e[r-1],o=e[r];if(a.stop<=t&&t<=o.stop){i=c(a.color,o.color,(t-a.stop)/(o.stop-a.stop));break}}return i||(i=e[e.length-1].color),n?i.map((function(e){return e/255})):i}return[0,0,0,0]}function u(e){var t=o(128,1),n=t.data,i=a(e);if(i.length)for(var r=0;r<128;r++){for(var s=r/128,u=void 0,l=void 0,f=0;f<i.length&&(u=i[f],l=i[f+1],!(u.stop<=s&&l.stop>s));f++);var h=c(u.color,l.color,(s-u.stop)/(l.stop-u.stop));n.set(h,4*r)}return t}function c(e,t,n,i){var r=[],a=1-n;if(i)for(var o=0;o<4;o++)r[o]=e[o]*a+t[o]*n;else{for(var s=0;s<3;s++)r[s]=Math.round(Math.sqrt(e[s]*e[s]*a+t[s]*t[s]*n));r[3]=Math.round(e[3]*a+t[3]*n)}return r}function l(e,t){var n;if(Object(i.h)(e)){e=e.replace(/[\s\t\r\n]/g,"");var r=/rgba?\(([.\d]+),([.\d]+),([.\d]+),?([.\d]+)?\)/.exec(e);if(r){var a=+r[4];n=[+r[1],+r[2],+r[3],isNaN(a)?255:255*a]}else/^#[a-f\d]{3}$/i.test(e)?n=[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16),255]:(r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))&&(n=[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),255]||!1)}else e instanceof Array&&(n=[e[0],e[1],e[2],isNaN(e[3])?255:255*e[3]]);if(t)for(var o=0;o<4;o++)n[o]/=255;return n}function f(e){var t=/^(-)?([\d+.]+)%$/.exec(e);return t?+t[2]/100*(t[1]?-1:1):+e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(0),r=function(){function e(e,t){Object(i.k)(this,{delay:0},e),this.renderer=t,this.items=e.items||[],this.engine=t.getParticleOptions().engine,this._onCreate(e),this._time=0}var t=e.prototype;return t.start=function(){return this._started&&!this.ended||(this._started=!0,this._delaying=!0,this._time=0,this._callEnd=!1,this.ended=!1),this},t.createContent=function(){return this._content||(this._content=this._createContent(this.renderer)),this._content},t.createVFXItem=function(e,t){},t.precompile=function(){var e=this;return this._items||(this._items=this.items.map((function(t){return e.createVFXItem(t,e.renderer)}))),this._precompile()},t.stop=function(){this._stop(),this._items&&this._items.forEach((function(e){return e.stop()})),this._started=!1},t.reset=function(){var e=this.renderer;return this.renderer&&(this._content=this._disposeContent(e,this._content),this._items&&(this._items.forEach((function(e){return e.destroy()})),this._items=null)),this._started=!1,this},t.destroy=function(){this.renderer&&(this.reset(),this.onUpdate=function(){return-1},this.renderer=null)},t._onCreate=function(e){},t._stop=function(){this._content&&this._content.stop&&this._content.stop()},t._precompile=function(){return{}},t._disposeContent=function(e){},t._initContent=function(e,t){},t._createContent=function(e){},t._onUpdate=function(e,t){},t.onUpdate=function(e){var t=this;if(this._started){var n=(this._time+=e/1e3)-this.delay;if(this._delaying&&n>=0){this._delaying=!1;var i=this.renderer;this.createContent(),this._initContent(i,this._content),this._items||(this._items=this.items.map((function(e){return t.createVFXItem(e,i)}))),this._items.forEach((function(e){return e.start()}))}if(!this._delaying){var r=this.endBehavior,a=n/this.duration,o=!0;if(this._isEnded(n)){if(o=!1,this._callEnd||this.onEnd(),2!==r){if(this.ended=!0,1===r||3===r?this.renderer.pausePlayer(this):4===r&&(o=!0,a=1),!this.reusable){if(0===r||3===r)return this.destroy();1===r&&(this.endBehavior=2)}}else o=!0;this._callEnd=!0}o&&this._onUpdate(e,Math.min(a,1));var s=this._items;if(s){for(var u=!1,c=0;c<s.length;c++){-1===s[c].onUpdate(e)&&(s[c]=null,u=!0)}u&&(this._items=s.filter((function(e){return e})))}}}},t.destroyItem=function(e){var t,n=null==(t=this._items)?void 0:t.findIndex((function(t){return t.id===e}));n>-1&&(this._items[n].destroy(),this._items.splice(n,1));var i=this.items.findIndex((function(t){return t.id===e}));if(i>-1)return this.items.splice(i,1)[0]},t._isEnded=function(e){return e>this.duration},t.onEnd=function(){},e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return s})),n.d(t,"b",(function(){return u})),n.d(t,"d",(function(){return c}));var i,r=n(11),a="compressedTexture",o=function(e){e&&(this.floatTexture=!!e.getExtension("OES_texture_float"),this.halfFloatTexture=!!e.getExtension("OES_texture_half_float"),this.maxVertexUniforms=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this.maxFragmentUniforms=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this.maxVertexTextures=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.supportWebGL=!0,this[a]=s(e))};function s(e){return Object(r.b)()?e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"):Object(r.a)()?e.getExtension("WEBGL_compressed_texture_astc"):void 0}function u(e){return l()[e]}function c(e,t){return l()[e]=t}function l(){if(!i){var e=document.createElement("canvas");i=new o(e.getContext("webgl"))}return i}},function(e,t,n){"use strict";n.d(t,"b",(function(){return _})),n.d(t,"c",(function(){return p})),n.d(t,"a",(function(){return m}));var i=n(4),r=n(0),a=n(2),o=(n(17),n(6)),s=n(45),u=n.n(s),c=n(46),l=n.n(c),f=n(5),h=n(15);function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _(e){var t=e.renderer,n=3===t.blending?0:+t.blending,i=e.cachePrefix||0,r=e.addition.usePreviewBorder;return{side:t.side,occlusion:t.occlusion,order:t.order,blending:t.blending,previewBorder:r,cachePrefix:i,mask:t.mask,maskMode:t.maskMode,shaderCacheId:i+"$$mars_sprite_."+(r?1:0)+"$$",cacheId:i+"."+ +t.side+"+"+ +t.occlusion+"+"+n+"+"+parseInt(t.order)+"+"+t.maskMode+"."+t.mask+(e.addition.usePreviewBorder?"pb":"")}}var p=8;var m=function(e){var t,n;function s(t,n){var r,a=[];t.previewBorder&&a.push("#define PREVIEW_BORDER 1"),a.length&&a.push("\n");var s=a.join("\n"),c={fragmentShader:s+l.a,vertexShader:s+u.a,shaderCacheId:t.shaderCacheId,renderOrder:t.order,engine:n,states:{side:t.side,depthMask:t.occlusion},matrix:o.a.createMatrix4(),samplers:[{name:"uSamplers",type:[i.a.SAMPLER_2D]}],uniforms:{uViewProjection:"VIEWPROJECTION",uView:"VIEWINVERSE",uModel:"MODEL",uParams:0,uPos:[i.a.FLOAT_VEC4],uRot:[i.a.FLOAT_VEC4],uColor:[i.a.FLOAT_VEC4],uTexParams:[i.a.FLOAT_VEC4],uPreviewColors:[i.a.FLOAT_VEC4]},attributes:["aPoint","aIndex"]},h=Object(f.h)(t.blending,c.states);return Object(f.i)(t.maskMode,t.mask,c.states),(r=e.call(this,{geometry:o.a.createGeometry({attributes:{aPoint:{size:4},aIndex:{size:1}},index:{size:1}},n),material:o.a.createMaterial(c)},n)||this).setUniformValues({uParams:new Float32Array([0,0,+h,0]),uPos:new Float32Array(32),uRot:new Float32Array(32),uColor:new Float32Array(32),uTexParams:new Float32Array(32),uPreviewColors:new Float32Array(32),uSamplers:[]}),r.items=[],r.isSpriteMesh=!0,r.renderCacheId=t.cacheId,r._isDirty=!1,r.maxItemCount=p,r}n=e,(t=s).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,s.fromItems=function(e,t){var n=new s(e[0].renderInfo,t);return n.setItems(e),n};var c,_,m,g=s.prototype;return g.setItems=function(e){var t=0,n=0,i=0,a=0,o=[];this.items=e.slice();for(var s=0;s<e.length;s++){var u=e[s],c=this.getItemInitData(u,s,a);t+=c.aIndex.length,n+=c.aPoint.length,i+=c.index.length,o.push(c),a+=c.aPoint.length/4,this.updateItem(u,!0)}for(var l={aIndex:new Float32Array(t),aPoint:new Float32Array(n),index:new Uint16Array(i)},f={aIndex:0,aPoint:0,index:0},h=function(e){var t=o[e];Object(r.d)(l,(function(e,n){var i=t[n];e.set(i,f[n]),f[n]+=i.length}))},d=0;d<o.length;d++)h(d);var _=this.geometry,p=l.index;_.setIndexData(p),_.setAttributeData("aIndex",l.aIndex),_.setAttributeData("aPoint",l.aPoint),_.drawCount=i,this.setUniformValue("uSamplers",e.map((function(e){return e.renderer.texture})))},g.getItemInitData=function(e,t,n){e.__geoData||(e.__geoData=this._getItemGeometryData(e,t));for(var i=e.__geoData,a=i.index,o=a.length,s=new a.constructor(o),u=0;u<o;u++)s[u]=n+a[u];return{aIndex:Object(r.b)(new Float32Array(i.aPoint.length/4),t),aPoint:i.aPoint,index:s}},g._getItemGeometryData=function(e){var t=e.splits,n=e.renderer;if(n.shape)return n.shape;var i=h.c[n.particleOrigin],r=2,a=2,o=0,s=0;if(1===t.length)r=1,a=1;else{var u=h.a[n.particleOrigin];o=u[0],s=u[1]}for(var c=[],l=[],f=0;f<r;f++)for(var d=0;d<a;d++){var _=2*d+f,p=t[2*d+f],m=p[4]?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0],v=((f+f+1)/r-1)/2,g=((d+d+1)/a-1)/2,y=p[0],x=p[1],T=p[4]?p[3]:p[2],b=p[4]?p[2]:p[3],E=[(i[0]+o)/r+v,(i[1]+s)/a+g,(i[2]+o)/r+v,(i[3]+s)/a+g,(i[4]+o)/r+v,(i[5]+s)/a+g,(i[6]+o)/r+v,(i[7]+s)/a+g];c.push(E[0],E[1],m[0]*T+y,m[1]*b+x,E[2],E[3],m[2]*T+y,m[3]*b+x,E[4],E[5],m[4]*T+y,m[5]*b+x,E[6],E[7],m[6]*T+y,m[7]*b+x);var A=4*_;l.push(A,1+A,2+A,2+A,1+A,3+A)}return{index:l,aPoint:c}},g.setItemInitData=function(e,t){var n=this.geometry;n.setAttributeSubData("aIndex",4*t,e.aIndex),n.setAttributeSubData("aPoint",16*t,e.aPoint),n.setIndexSubData(6*t,e.index)},g.updateItem=function(e,t){var n=this.items.indexOf(e);if(n>-1){var i;this.calculateGroup&&(i=this.calculateGroup.getRenderData(e.parentId));var r=e.getRenderData(e.time,t||i);i=i||v;var o=Object(a.l)(r.pos,r.pos,i.pos);o&&this.getUniformValue("uPos").set(o,4*n);var s=Object(a.l)(r.rot,r.rot,i.rot);s&&this.getUniformValue("uRot").set(s,4*n);var u=Object(a.o)(r.color,r.color,i.color);u&&this.getUniformValue("uColor").set(u,4*n);var c=Object(a.o)(r.size,r.size,i.size);if(c){var l=4*n+3;this.getUniformValue("uPos")[l]=c[0],this.getUniformValue("uRot")[l]=c[1]}var f=this.getUniformValue("uTexParams");if(t){var h=e.renderer;this.getUniformValue("uPreviewColors").set(e.addition.borderColor,4*n);var d=4*n;f[d]=+h.transparentOcclusion,f[d+1]=+(3===h.blending),f[d+2]=h.renderMode,f[d+3]=r.life}else f[4*n+3]=r.life}},g.removeItem=function(e){var t=this.items.indexOf(e);t>-1&&(this.items.splice(t,1),e.__geoData=null,this._isDirty=!0)},g.addItem=function(e){if(this.itemCount<this.maxItemCount){for(var t=0,n=this.items,i=0;i<n.length;i++){if(!(n[i].listIndex<=e.listIndex))break;t++}return this._isDirty=!0,n.splice(t,0,e),t}},g.applyChange=function(){this._isDirty&&(this.setItems(this.items),this._isDirty=!1)},c=s,(_=[{key:"itemCount",get:function(){return this.items.length}},{key:"availableItemCount",get:function(){return p-this.itemCount}},{key:"time",get:function(){return this.getUniformValue("uParams")[0]},set:function(e){this.getUniformValue("uParams")[0]=e}},{key:"listIndexStart",get:function(){return this.items.length?this.items[0].listIndex:-1}},{key:"listIndexEnd",get:function(){var e=this.items.length;return e>0?this.items[e-1].listIndex:-1}}])&&d(c.prototype,_),m&&d(c,m),s}(o.a.Mesh),v={}},function(e,t,n){"use strict";function i(){return!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)}function r(){return/\b[Aa]ndroid\b/.test(navigator.userAgent)}n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return r}))},function(e,t,n){"use strict";n.r(t),n.d(t,"version",(function(){return T}));var i=n(8);n.d(t,"VFXItem",(function(){return i.a}));var r=n(22);n.d(t,"ParticleSystem",(function(){return r.a}));var a=n(21);n.d(t,"TrailMesh",(function(){return a.a}));var o=n(19);n.d(t,"registerPlugin",(function(){return o.c}));var s=n(26);for(var u in s)["default","VFXItem","ParticleSystem","TrailMesh","registerPlugin","setGLStatus","setReporter","MarsPlayer","imageDataFromGradient","createValueGetter","SpriteGroup","SpriteItem","rendererInterface","Composition","getVFXItem","getCompositionByName","loadSceneAsync","version"].indexOf(u)<0&&function(e){n.d(t,e,(function(){return s[e]}))}(u);var c=n(5);n.d(t,"setMtlBlending",(function(){return c.h})),n.d(t,"setMtlStencil",(function(){return c.i})),n.d(t,"destroyMeshTexture",(function(){return c.f})),n.d(t,"enlargeBuffer",(function(){return c.g})),n.d(t,"convertTextureContainer",(function(){return c.b})),n.d(t,"createEmptyTextureContainer",(function(){return c.d})),n.d(t,"createDataTextureContainer",(function(){return c.c})),n.d(t,"createGradientTextureContainer",(function(){return c.e})),n.d(t,"combineImageTemplateAsync",(function(){return c.a}));var l=n(9);n.d(t,"setGLStatus",(function(){return l.d}));var f=n(18);n.d(t,"setReporter",(function(){return f.c}));var h=n(28);n.d(t,"MarsPlayer",(function(){return h.a}));var d=n(7);n.d(t,"imageDataFromGradient",(function(){return d.e}));var _=n(1);n.d(t,"createValueGetter",(function(){return _.d}));var p=n(27);n.d(t,"SpriteGroup",(function(){return p.a}));var m=n(14);n.d(t,"SpriteItem",(function(){return m.a}));var v=n(6);n.d(t,"rendererInterface",(function(){return v.a}));var g=n(20);n.d(t,"Composition",(function(){return g.a}));var y=n(13);n.d(t,"getVFXItem",(function(){return y.b})),n.d(t,"getCompositionByName",(function(){return y.a})),n.d(t,"loadSceneAsync",(function(){return y.c}));var x=n(11);n.d(t,"isiOS",(function(){return x.b})),n.d(t,"isAndroid",(function(){return x.a}));var T="0.4.0-beta.51"},function(e,t,n){"use strict";var i;n.d(t,"c",(function(){return U})),n.d(t,"b",(function(){return k})),n.d(t,"a",(function(){return G}));var r=((i={}).S=["S","B+","A+"],i.A=["A","B+","A+"],i.B=["B","B+"],i);var a=n(11),o=n(24),s=n(9),u=n(5),c=n(2),l=0;function f(e,t,n,i){n=n||2,l=i||0;var r,a,o,s,u,c,f,p=t&&t.length,m=p?t[0]*n:e.length,v=h(e,0,m,n,!0),g=[];if(!v||v.next===v.prev)return g;if(p&&(v=function(e,t,n,i){var r,a,o,s,u,c=[];for(r=0,a=t.length;r<a;r++)o=t[r]*i,s=r<a-1?t[r+1]*i:e.length,(u=h(e,o,s,i,!1))===u.next&&(u.steiner=!0),c.push(E(u));for(c.sort(y),r=0;r<c.length;r++)x(c[r],n),n=d(n,n.next);return n}(e,t,v,n)),e.length>80*n){r=o=e[0],a=s=e[1];for(var T=n;T<m;T+=n)(u=e[T])<r&&(r=u),(c=e[T+1])<a&&(a=c),u>o&&(o=u),c>s&&(s=c);f=0!==(f=Math.max(o-r,s-a))?1/f:0}return _(v,g,n,r,a,f),g}function h(e,t,n,i,r){var a,o;if(r===function(e,t,n,i){for(var r=0,a=t,o=n-i;a<n;a+=i)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,n,i)>0)for(a=t;a<n;a+=i)o=I(a,e[a],e[a+1],o);else for(a=n-i;a>=t;a-=i)o=I(a,e[a],e[a+1],o);return o&&R(o,o.next)&&(F(o),o=o.next),o}function d(e,t){if(!e)return e;t||(t=e);var n,i=e;do{if(n=!1,i.steiner||!R(i,i.next)&&0!==C(i.prev,i,i.next))i=i.next;else{if(F(i),(i=t=i.prev)===i.next)break;n=!0}}while(n||i!==t);return t}function _(e,t,n,i,r,a,o){if(e){!o&&a&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=b(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t,n,i,r,a,o,s,u,c=1;do{for(n=e,e=null,a=null,o=0;n;){for(o++,i=n,s=0,t=0;t<c&&(s++,i=i.nextZ);t++);for(u=c;s>0||u>0&&i;)0!==s&&(0===u||!i||n.z<=i.z)?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,u--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;n=i}a.nextZ=null,c*=2}while(o>1)}(r)}(e,i,r,a);for(var s,u,c=e;e.prev!==e.next;)if(s=e.prev,u=e.next,a?m(e,i,r,a):p(e))t.push(s.i/n+l),t.push(e.i/n+l),t.push(u.i/n+l),F(e),e=u.next,c=u.next;else if((e=u)===c){o?1===o?_(e=v(d(e),t,n),t,n,i,r,a,2):2===o&&g(e,t,n,i,r,a):_(d(e),t,n,i,r,a,1);break}}}function p(e){var t=e.prev,n=e,i=e.next;if(C(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(A(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&C(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function m(e,t,n,i){var r=e.prev,a=e,o=e.next;if(C(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,u=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,c=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,l=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,f=b(s,u,t,n,i),h=b(c,l,t,n,i),d=e.prevZ,_=e.nextZ;d&&d.z>=f&&_&&_.z<=h;){if(d!==e.prev&&d!==e.next&&A(r.x,r.y,a.x,a.y,o.x,o.y,d.x,d.y)&&C(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,_!==e.prev&&_!==e.next&&A(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&C(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;d&&d.z>=f;){if(d!==e.prev&&d!==e.next&&A(r.x,r.y,a.x,a.y,o.x,o.y,d.x,d.y)&&C(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;_&&_.z<=h;){if(_!==e.prev&&_!==e.next&&A(r.x,r.y,a.x,a.y,o.x,o.y,_.x,_.y)&&C(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function v(e,t,n){var i=e;do{var r=i.prev,a=i.next.next;!R(r,a)&&S(r,i,i.next,a)&&P(r,a)&&P(a,r)&&(t.push(r.i/n+l),t.push(i.i/n+l),t.push(a.i/n+l),F(i),F(i.next),i=e=a),i=i.next}while(i!==e);return d(i)}function g(e,t,n,i,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&O(o,s)){var u=L(o,s);return o=d(o,o.next),u=d(u,u.next),_(o,t,n,i,r,a),void _(u,t,n,i,r,a)}s=s.next}o=o.next}while(o!==e)}function y(e,t){return e.x-t.x}function x(e,t){if(t=function(e,t){var n,i=t,r=e.x,a=e.y,o=-1/0;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var s=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=r&&s>o){if(o=s,s===r){if(a===i.y)return i;if(a===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!n)return null;if(r===o)return n;var u,c=n,l=n.x,f=n.y,h=1/0;i=n;do{r>=i.x&&i.x>=l&&r!==i.x&&A(a<f?r:o,a,l,f,a<f?o:r,a,i.x,i.y)&&(u=Math.abs(a-i.y)/(r-i.x),P(i,e)&&(u<h||u===h&&(i.x>n.x||i.x===n.x&&T(n,i)))&&(n=i,h=u)),i=i.next}while(i!==c);return n}(e,t)){var n=L(t,e);d(t,t.next),d(n,n.next)}}function T(e,t){return C(e.prev,e,t.prev)<0&&C(t.next,e,e.next)<0}function b(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function E(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function A(e,t,n,i,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(i-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(r-o)*(i-s)>=0}function O(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&S(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(P(e,t)&&P(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&r<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)&&(C(e.prev,e,t.prev)||C(e,t.prev,t))||R(e,t)&&C(e.prev,e,e.next)>0&&C(t.prev,t,t.next)>0)}function C(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function R(e,t){return e.x===t.x&&e.y===t.y}function S(e,t,n,i){var r=M(C(e,t,n)),a=M(C(e,t,i)),o=M(C(n,i,e)),s=M(C(n,i,t));return r!==a&&o!==s||(!(0!==r||!w(e,n,t))||(!(0!==a||!w(e,i,t))||(!(0!==o||!w(n,e,i))||!(0!==s||!w(n,t,i)))))}function w(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function M(e){return e>0?1:e<0?-1:0}function P(e,t){return C(e.prev,e,e.next)<0?C(e,t,e.next)>=0&&C(e,e.prev,t)>=0:C(e,t,e.prev)<0||C(e,e.next,t)<0}function L(e,t){var n=new N(e.i,e.x,e.y),i=new N(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,a.next=i,i.prev=a,i}function I(e,t,n,i){var r=new N(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function F(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function N(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function D(e,t){for(var n=0,i=e.s,r=0;r<i.length;r++){n+=i[r].length-1}var a,o=new Float32Array(4*n),s=0,u=t.indexBase||0,l=t.uvTransform,h=0,d=0,_=1,p=1;l&&(h=l[0],d=l[1],a=l[4],_=a?l[3]:l[2],p=a?l[2]:l[3]);for(var m=[],v=0===a?0:-Math.PI/2,g=e.p,y=0;y<i.length;y++)for(var x=i[y],T=g[y],b=g[y+1]||g[0],E=x,A=[],O=0;O<E.length-1;O++){z(A,E[O],T,b,T[4],T[5],b[2],b[3]),R(A[0],A[1])}var C=f(o,null,4,u);return{aPoint:o,index:new Uint16Array(C)};function R(e,t){o[s++]=e/2,o[s++]=t/2,l?(m[0]=e,m[1]=t,Object(c.f)(m,m,v),o[s++]=h+(m[0]+1)/2*_,o[s++]=d+(m[1]+1)/2*p):(o[s++]=(e+1)/2,o[s++]=(t+1)/2)}}function z(e,t,n,i,r,a,o,s){var u=1-t,c=u*u*u,l=3*t*u*u,f=3*t*t*u,h=t*t*t;return e[0]=c*n[0]+l*r+f*o+h*i[0],e[1]=c*n[1]+l*a+f*s+h*i[1],e}var V=n(0),B=0;function U(e,t){if(t=t||{},Object(V.h)(e))return e=new URL(e,location.href).href,Object(V.n)(e).then(i);if(Object(V.g)(e)){var n=e;return e=location.href,i(n)}return Promise.reject("fail to load scene");function i(n){var i,r=[];if(t.compositions)for(var o=0;o<t.compositions.length;o++){var c=t.compositions[o],l=G(n.compositions,c);if(!l)return Promise.reject("composition not found");r.push(l)}else r=n.compositions;if(n._imgs){i={};for(var f=0;f<r.length;f++)for(var h=r[f].id,d=n._imgs[h],_=0;_<d.length;_++)i[d[_]]=!0}var p=t.useCompressedTexture&&Object(s.b)(s.a);return Promise.all((n.images||[]).map((function(n,r){if(!i||i[r]){if(Object(V.h)(n))return Object(V.i)(new URL(n,e).href);if(Object(V.g)(n)&&n.url){if(n.template){var o=new URL(n.url,e).href;return Object(u.a)(o,n.template,t.variables,t)}return"video"===n.type?function(e){var t=document.createElement("video");Object(a.a)()&&t.setAttribute("renderer","standard");Object(V.g)(e.url)?t.srcObject=e.url:t.src=e.url;return t.crossOrigin="anonymous",t.muted=!0,t.setAttribute("playsinline","playsinline"),t.play(),new Promise((function(e,n){t.addEventListener("loadeddata",(function n(){e(t),t.removeEventListener("loadeddata",n)}),!0),t.addEventListener("error",(function(e){n(e)}))}))}(n):n.compressed&&p&&(Object(a.b)()?s=n.compressed.iOS:Object(a.a)()&&(s=n.compressed.android),s)?Object(V.n)(new URL(s,e).href,{responseType:"arraybuffer"}):Object(V.i)(new URL(n.url,e).href);var s}}return Promise.resolve(n)}))).then((function(e){var i=Object(s.b)("maxImageSize"),a=document.createElement("canvas");return Object(V.k)({},n,{compositions:r,images:e.map((function(e){if(Object(V.g)(e)){if(e instanceof Image){if(e.width>i||e.height>i){var n=Math.min(i/e.width,i/e.height),r=a.width=Math.min(Math.round(e.width*n),i),o=a.height=Math.min(Math.round(e.height*n),i),s=a.getContext("2d");s.clearRect(0,0,r,o),s.fillStyle="rgba(255,255,255,0.008)",s.fillRect(0,0,r,o),s.drawImage(e,0,0,r,o,0,0,r,o),e=s.getImageData(0,0,r,o)}if(p)return Object(u.b)(e,{compressed:!0})}return t.wrapTexture?Object(u.b)(e):e}}))})}))}}function k(e,t,n,i,a){return B=0,function e(t,n,i,a,s){var c=function(e,t){return e.find((function(e){return e.id===t}))}(t,n);if(!c)throw Error("invalid composition id:"+n);var l,f=c.endBehavior,h=i.options?i.options:c.options;h&&(f=h.endBehavior,l=h.looping||5===f);var d=a.renderLevel,_=a.reusable,p=["options","mask"];isNaN(i.mask)&&(i.mask=0);var m=[];a.textures||(a.textures=a.images.map((function(e){return e&&Object(u.b)(e,{dataReleasable:!0})})));var v=a.imageUsage={},g=!a.fixRenderOrder;return s=s||0,c.items.forEach((function(n){if(!1!==n.visible){var u,c=n.particle||n.config||n.model||n.ui||n.sprite||n.cal||n.content,l=c&&c.options;if(function(e,t){if(!e||!t)return!0;var n=r[t];return!!n&&n.indexOf(e)>-1}(l&&l.renderLevel,d)){var f=n.refId;if(Object(V.f)(f))u=e(t,n.refId,j(n.config,i),a,s+n.delay);else if(n.model){u={model:n.model,duration:n.model.options.duration};var h=n.model.model;h&&Object(V.f)(h.gltf)&&(h.gltf=a.gltf[h.gltf])}else{if(u={},n.particle?u.particle=j(n.particle,i,p):n.sprite?u.sprite=j(n.sprite,i,p):n.cal?u.cal=n.cal:n.content&&(u.content=n.content),n.ui){var v=u.ui=j(n.ui,i,p);!v.options.position&&v.transform&&(v.options.position=v.transform.position),u.duration=n.ui.options.duration,n.particle||(u.particle=null)}var T=u.particle||u.sprite||u.content;if(T){if(T.listIndex=B++,T.renderer){if(T.renderer=y(T.renderer),!T.renderer.mask){var b=T.renderer.maskMode;1===b?T.renderer.mask=++i.mask:2!==b&&3!==b||(T.renderer.mask=i.mask)}var E=T.splits&&T.splits[0];Object(V.f)(T.renderer.shape)?T.renderer.shape=H(a.shapes[T.renderer.shape],E):Object(V.g)(T.renderer.shape)&&(T.renderer.shape=H(T.renderer.shape,E))}else T.renderer={order:0};if(T.trails&&(T.trails=y(T.trails)),T.filter){var A=Object(V.k)({},T.filter);Object(o.b)(A,a.textures).forEach(x),T.filter=A}if(g){var O=n.ro;O&&(T.renderer.order=(T.renderer.order||0)+O)}}}u.name=n.name,u.delay=n.delay||0,u.id=n.id,u.parentId=n.parentId,u.reusable=_,u.refCount=n.refCount,m.push(u)}}})),{id:c.id,duration:c.duration,name:c.name,endBehavior:f,looping:l,items:m,camera:c.camera,startTime:c.st||0};function y(e){var t=e.texture,n=Object(V.k)({},e);return n.texture=x(t)||t,n}function x(e){if(Object(V.f)(e)){var t=a.textures[e],n=t.id;return v.hasOwnProperty(n)||(v[n]=0),v[n]++,t}}}(e,t,n||{},i,a)}function G(e,t){return e.find((function(e){return e.name===t}))}function j(e,t,n){e=e||{},t=t||{};var i={},r=Object.keys(e),a=Object.keys(t),o=Object(V.g)(t);return n=n||[],r.forEach((function(r){var s=e[r];if(-1===n.indexOf(r))if(o&&t.hasOwnProperty(r)){var u=t[r];Array.isArray(s)?i[r]=s.map((function(e,t){return e+u[t]})):Object(V.g)(s)?i[r]=j(s,u):i[r]=s+u,Object(V.c)(a,r)}else i[r]=s;else i[r]=s})),a.forEach((function(e){return-1===n.indexOf(e)&&(i[e]=t[e])})),i}function H(e,t){for(var n=[],i=e.gs?e.gs:[e.g],r=0,a=0,o=0,s=0;s<i.length;s++){var u=D(i[s],{indexBase:r,uvTransform:t});r+=u.aPoint.length/4,n.push(u),a+=u.aPoint.length,o+=u.index.length}if(1===n.length)return n[0];for(var c=new Float32Array(a),l=new Uint16Array(o),f=0,h=0,d=0;f<n[f];f++){var _=n[f];c.set(_.aPoint,h),h+=_.aPoint.length,l.set(_.index,d),d+=_.index.length}return{aPoint:c,index:l}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return f}));var i=n(7),r=n(1),a=n(10),o=n(5),s=n(2),u=n(15);function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=[[0,0,1,1]],f=function(){function e(e,t){var n=e.options||{};this.options={startSpeed:n.startSpeed||0,startSize:n.startSize||1,sizeAspect:n.sizeAspect||1,startColor:Object(r.d)(n.startColor).getValue(0)||[1,1,1,1],startDelay:n.startDelay||0,duration:n.duration||0,looping:!!n.looping,gravity:Object(s.a)(n.gravity),gravityModifier:n.gravityModifier&&Object(r.d)(n.gravityModifier),direction:n.direction?Object(s.q)(n.direction.slice()):Object(s.a)(),endBehavior:n.endBehavior||0};var u=e.transform||{},c=Object(s.a)(u.rotation);n.startRotation&&(c[2]+=n.startRotation||[0]),this.transform={position:Object(s.a)(u.position),rotation:c,path:u.path&&Object(r.d)(u.path)};var f=e.renderer||{};this.renderer={renderMode:f.renderMode||0,particleOrigin:f.particleOrigin||0,blending:f.blending||0,texture:(f.texture||Object(o.d)()).init(t.engine),order:f.order||0,occlusion:!!f.occlusion,transparentOcclusion:!!f.transparentOcclusion||1===f.maskMode,side:f.side||1032,shape:f.shape,mask:f.mask||0,maskMode:f.maskMode||0};var h=e.colorOverLifetime;h&&(this.opacityOverLifetime=h.hasOwnProperty("opacity")&&Object(r.d)(h.opacity),this.colorOverLifetime=h.color&&Object(i.a)(Object(r.e)(h.color)));var d=e.sizeOverLifetime;d&&(d.separateAxes?(this.sizeSeparateAxes=!0,this.sizeXOverLifetime=Object(r.d)(d.x),this.sizeYOverLifetime=Object(r.d)(d.y)):this.sizeXOverLifetime=Object(r.d)(d.size));var _=e.velocityOverLifetime;_&&(this.linearVelOverLifetime={x:_.linearX&&Object(r.d)(_.linearX),y:_.linearY&&Object(r.d)(_.linearY),z:_.linearZ&&Object(r.d)(_.linearZ),asMovement:_.asMovement,enabled:_.linearX||_.linearY||_.linearZ},this.orbitalVelOverLifetime={x:_.orbitalX&&Object(r.d)(_.orbitalX),y:_.orbitalY&&Object(r.d)(_.orbitalY),z:_.orbitalZ&&Object(r.d)(_.orbitalZ),center:Object(s.a)(_.orbCenter),asRotation:_.asRotation,enabled:_.orbitalX||_.orbitalY||_.orbitalZ},this.speedOverLifetime=_.speedOverLifetime&&Object(r.d)(_.speedOverLifetime));var p=e.rotationOverLifetime;if(p){var m=this.rotationOverLifetime={asRotation:p.asRotation,separateAxes:p.separateAxes,z:Object(r.d)(p.separateAxes?p.z:p.angularVelocity)};p.separateAxes&&(m.x=Object(r.d)(p.x||0),m.y=Object(r.d)(p.y||0))}var v=e.addition||{};this.addition={usePreviewBorder:v.usePreviewBorder,borderColor:v.usePreviewBorder?Object(i.b)(Object(r.e)(v.borderColor),!0):[0,0,0,0]},this._time=0,this._maxTime=this.options.duration+this.options.startDelay,this.gravityModifier=this.options.gravityModifier,this.splits=e.splits||l,this.listIndex=e.listIndex||0,t&&(this.cachePrefix=t.cachePrefix,this.parentId=t.parentId,this.reusable=t.reusable,this.name=t.name),this._renderInfo=Object(a.b)(this),this.delay=t&&t.delay||0}var t,n,f,h=e.prototype;return h.willTranslate=function(){var e="_willTranslate";if(!this.hasOwnProperty(e)){var t=this.linearVelOverLifetime;if(t&&t.enabled)return this[e]=!0;var n=this.orbitalVelOverLifetime;if(n&&n.enabled)return this[e]=!0;var i=this.options;return i.gravityModifier&&!Object(s.c)(i.gravity)||i.startSpeed&&!Object(s.c)(i.direction)?this[e]=!0:this[e]=!1}return this[e]},h.updateTime=function(e){var t=e-this.delay,n=this.options.duration;if(t>=this._maxTime&&this.options.looping){for(var i=t-this._maxTime;i>n;)i-=n;this._time=i}else{var r=4===this.options.endBehavior;this._time=r?Math.min(this._maxTime,t):t}},h.stop=function(){this._time=this._maxTime},h._getTextures=function(){var e=[],t=this.renderer.texture;return t&&e.push(t),e},h.getRenderData=function(e,t){var n,r,a,o=this.options,c=[1,1],l=[0,0,0],f=[1,1,1,1],h=e<0?e:Math.max(e-o.startDelay,0),d=h/o.duration,_={life:d},p=this.transform;d=d<0?0:d>1?1:d,this.sizeXOverLifetime&&(c[0]=this.sizeXOverLifetime.getValue(d),this.sizeSeparateAxes?c[1]=this.sizeYOverLifetime.getValue(d):c[1]=c[0],n=!0),(n||t)&&(_.size=[o.startSize*c[0],o.startSize/o.sizeAspect*c[1]]);var m=this.rotationOverLifetime;if(m){var v=function(e){return m.asRotation?e.getValue(d):e.getIntegrateValue(0,d)},g=v(m.z),y=m.separateAxes;l=[y?v(m.x):0,y?v(m.y):0,g],r=!0}(r||t)&&(_.rot=p.rotation.map((function(e,t){return e+l[t]})));var x=this.opacityOverLifetime,T=this.colorOverLifetime;return T&&(f=Object(i.c)(T,d,!0),a=!0),x&&(f[3]*=x.getValue(d),a=!0),(a||t)&&(_.color=o.startColor.map((function(e,t){return e*f[t]}))),(this.willTranslate()||t)&&(_.pos=Object(u.b)(this,o.gravity,h,o.duration,p.position,this.velocity)),p.path&&(_.pos||(_.pos=p.position.slice()),Object(s.k)(_.pos,_.pos,p.path.getValue(d))),_},t=e,(n=[{key:"renderInfo",get:function(){return this._renderInfo}},{key:"isSpriteItem",get:function(){return!0}},{key:"ended",get:function(){return this._time>this._maxTime&&!this.options.looping&&!this.reusable}},{key:"time",get:function(){return this._time}},{key:"velocity",get:function(){return this._velocity||(this._velocity=Object(s.p)([],this.options.direction,this.options.startSpeed)),this._velocity}}])&&c(t.prototype,n),f&&c(t,f),e}()},function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return u}));var i,r,a=n(2);function o(e,t,n,i,r,o,s){var u=[],c=n/i,l=n,f=e.speedOverLifetime;f&&(l=f.getIntegrateValue(0,n,i));var h=e.gravityModifier?e.gravityModifier.getIntegrateByTime(0,n):0;s=s||0;for(var d=0;d<3;d++)u[d]=r[s+d]+o[s+d]*l+t[d]*h;var _=e.linearVelOverLifetime||{},p=e.orbitalVelOverLifetime||{},m=["x","y","z"];if(p.enabled){var v=p.center||[0,0,0],g=[u[0]-v[0],u[1]-v[1],u[2]-v[2]],y=p.asRotation,x=Object(a.h)(g,g,Object(a.d)(m.map((function(e){var t=p[e];return t?.017453292519943295*(y?t.getValue(c):t.getIntegrateValue(0,n,i)):0}))));u=Object(a.k)(u,v,x)}if(_.enabled)for(var T=_.asMovement,b=0;b<3;b++){var E=_[m[b]];E&&(u[b]+=T?E.getValue(c):E.getIntegrateValue(0,n,i))}return u}var s=((i={})[0]=c(0,0),i[5]=c(0,.5),i[4]=c(0,-.5),i[1]=c(.5,-.5),i[2]=c(.5,0),i[3]=c(.5,.5),i[7]=c(-.5,0),i[8]=c(-.5,.5),i[6]=c(-.5,-.5),i),u=((r={})[0]=[0,0],r[5]=[0,.5],r[4]=[0,-.5],r[1]=[.5,-.5],r[2]=[.5,0],r[3]=[.5,.5],r[7]=[-.5,0],r[8]=[-.5,.5],r[6]=[-.5,-.5],r);function c(e,t){for(var n=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],i=0;i<8;i+=2)n[i]+=e,n[i+1]+=t;return n}},function(e,t,n){"use strict";function i(e){return 0==(e&e-1)&&0!==e}function r(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))}n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(2),r=(n(25),function(){function e(){this.items=[],this._itemMap={},this.time=0}var t=e.prototype;return t.getRenderData=function(e){var t=this._itemMap[e];return t?t.renderData:null},t.combineRenderData=function(e,t){return{rot:Object(i.l)(e.rot,e.rot,t.rot),pos:Object(i.l)(e.pos,e.pos,t.pos),color:Object(i.o)(e.color,e.color,t.color),size:Object(i.o)(e.size,e.size,t.size)}},t._onUpdate=function(e){var t=this;this.time+=e/1e3,this.items.forEach((function(n){return n._onUpdate(e,t)}))},t.addItem=function(e){if(e.parentId){var t=this._itemMap[e.parentId],n=this.items.indexOf(t);this.items.splice(n+1,0,e)}else this.items.push(e);var i=e.id;this._itemMap[i]=e},t._removeItemRef=function(e){var t=this._itemMap[e];if(t&&0===--t.refCount){delete this._itemMap[e];var n=this.items.indexOf(t);return this.items.splice(n,1),t}},t.removeItemRef=function(e){var t=this._removeItemRef(e);t&&t.parentId&&this._removeItemRef(t.parentId)},e}())},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"b",(function(){return o}));var i,r=1;function a(e){i=e}function o(e,t){i&&i(e,t),console.error("report error:"+e+"\n"+JSON.stringify(t||{}))}},function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return u}));var i=n(8),r={},a={};function o(e,t,n){a[e]=n,r[e]=t}function s(e){var t=r[e];if(!t)throw Error("plugin "+e+" no registered loader");return new t}var u=function(){function e(e){this.loaders=e}var t=e.prototype;return t.initializeComposition=function(e,t){this.loaders.forEach((function(n){return n.onCompositionInitialized(e,t)}))},t.destroyComposition=function(e){this.loaders.forEach((function(t){return t.onCompositionDestroyed(e)}))},t.createPluginItem=function(e,t,n){var r=a[e];if(!r)throw Error("plugin "+e+" no registered constructor");var o=new r(t,n);if(!(o instanceof i.a))throw Error("plugin "+e+" invalid constructor type");return o},t.loadResourcesAsync=function(e,t,n){var i=this;return Promise.all(this.loaders.map((function(i){return i.prepareResourceAsync(e,t,n)}))).catch((function(e){throw i.unloadResources(n),e}))},t.unloadResources=function(e){this.loaders.forEach((function(t){return t.unloadResource(e)})),this.loaders=[]},e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return R}));var i=n(17),r=n(2),a=function(){function e(){this.regions=[],this._seed=1}var t=e.prototype;return t._getProjectedBounds=function(e,t){var n=e.width/2,i=e.height/2,a=e.x,o=e.y,s=e.z;if(e.parentId){var u=this.calculateGroup.getRenderData(e.parentId);if(u){var c=u.pos;c&&(a+=c[0],o+=c[1],s+=c[2]);var l=u.size;l&&(n*=l[0],i*=l[1])}}var f=[[a-n,o-i,s],[a+n,o-i,s],[a+n,o+i,s],[a-n,o+i,s]].map((function(e){return Object(r.i)(e,e,t)})),h=Math.min(f[0][0],f[1][0],f[2][0],f[3][0]),d=Math.max(f[0][0],f[1][0],f[2][0],f[3][0]),_=Math.min(f[0][1],f[1][1],f[2][1],f[3][1]),p=Math.max(f[0][1],f[1][1],f[2][1],f[3][1]);return e.hitPositions=[[a,o,s]],[h,_,d,p]},t.addRegion=function(e){return this.regions.push(e),e._uid=this._seed++},t.clearRegionBounds=function(){this.regions.forEach((function(e){e.parentId&&(e._bounds=null)}))},t.removeRegion=function(e){var t=this.regions.findIndex((function(t){return t._uid===e}));if(t>-1)return this.regions.splice(t,1)[0]},t.findRegions=function(e,t,n,i){var r,a=this;return this.regions.filter((function(o){if(o.delegate){r||(r=a._getHitTestParams(e,t,n,i));var s=o.delegate.hitTest(r);return o.hitPositions=s,s.length>0}return o._bounds||(o._bounds=a._getProjectedBounds(o,i)),function(e,t,n){return e[0]<t&&e[2]>t&&e[1]<n&&e[3]>n}(o._bounds,e,t)})).sort((function(e,t){return e.z-t.z}))},t._getHitTestParams=function(e,t,n,i){Object(r.b)(o,i);var a=Object(r.i)(s,[e,t,0],o);return Object(r.n)(a,a,n),{x:e,y:t,camera:{viewProjection:i,position:n,direction:Object(r.q)(a)}}},e}(),o=[],s=[];var u=n(12),c=n(5),l=n(10),f=n(0),h=(n(7),n(25)),d=n(1),_=n(8);var p=function(e){var t,n;function i(){return e.apply(this,arguments)||this}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._onCreate=function(e){var t=e.cal.options;this.endBehavior=t.looping?2:t.endBehavior||0,this.duration=t.duration},r._createContent=function(e){var t=e.getParticleOptions();return t.parentId=this.parentId,t.id=this.id,t.refCount=this.refCount,t.reusable=this.reusable,t.delay=this.delay,new h.a(this.cal,t)},r._initContent=function(e,t){var n=this.cal;if(n.addition&&n.addition.showPreview){var i=e.getParticleOptions(),r=this._previewContent=new u.SpriteItem(n,i);r.options.startSize=n.addition.startSize||.1,n.addition.borderColor&&(r.options.startColor=n.addition.borderColor),r.parentId=this.parentId,e.addRenderNode(r)}e.calculateGroup.addItem(t)},r._disposeContent=function(e,t){t&&e.calculateGroup.removeItemRef(t.id),this._previewContent&&e.destroyRenderNode(this._previewContent)},i}(_.a);var m=function(e){var t,n;function i(){return e.apply(this,arguments)||this}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._onCreate=function(e){this.endBehavior=this.ui.options.endBehavior||0,this.duration=this.ui.options.duration,this._particleDestroyed=!0},r._initContent=function(e,t){var n=this.ui,i=n.options,r=n.transform?n.transform.position:i.position;if(i.position=r,this._uid=this.renderer.addInteractiveItem(this.name,i,this),i.showPreview&&"click"===i.type){var a=e.getParticleOptions();a.parentId=this.parentId,a.name="preview:"+this.name;var o=this._previewContent=new u.SpriteItem({options:{startSize:i.width,sizeAspect:i.width/i.height,startColor:i.previewColor,duration:i.duration},renderer:{order:i.renderOrder||999},transform:{position:r}},a);e.addRenderNode(o),this._previewContent=o}},r._disposeContent=function(e,t){e.removeInteractiveItem(this._uid,this.ui.options.type),this._uid=0,this._previewContent&&e.destroyRenderNode(this._previewContent)},i}(_.a);function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g=function(e){var t,n;function i(){return e.apply(this,arguments)||this}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var a,o,s,u=i.prototype;return u._onCreate=function(e){this.type=1,this.options={position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],near:Object(d.d)(e.near),far:Object(d.d)(e.far),fov:Object(d.d)(e.fov)},e.animate&&(this.animation={path:e.path&&Object(d.d)(e.path),rotateX:Object(d.d)(e.rotateX||0),rotateY:Object(d.d)(e.rotateY||0),rotateZ:Object(d.d)(e.rotateZ||0),translateX:Object(d.d)(e.translateX||0),translateY:Object(d.d)(e.translateY||0),translateZ:Object(d.d)(e.translateZ||0)}),(e.scaling||e.separateScaling)&&(this.scaling={scaleX:Object(d.d)(e.scaleX||1),scaleY:Object(d.d)(e.scaleY||1),scaleZ:Object(d.d)(e.scaleZ||1),scaling:Object(d.d)(e.scaling),separate:e.separateScaling})},u.onItemUpdate=function(e,t){var n=this.options,i=new Float32Array(n.position),a=new Float32Array(n.rotation),o=this.target;if(e<0)o&&(o.visible=!1);else if(e>1)o&&(o.visible=4===this.endBehavior);else{var s=this.animation;if(s&&(i=[i[0]+s.translateX.getValue(e),i[1]+s.translateY.getValue(e),i[2]+s.translateZ.getValue(e)],a=[a[0]+s.rotateX.getValue(e),a[1]+s.rotateY.getValue(e),a[2]+s.rotateZ.getValue(e)],s.path&&Object(r.k)(i,i,s.path.getValue(e))),2===this.type){o&&(o.visible=!0);var u=this.scaling;if(u)if(u.separate)o.setScale(u.scaleX.getValue(e),u.scaleY.getValue(e),u.scaleZ.getValue(e));else{var c=u.scaling.getValue(e);o.setScale(c,c,c)}o.setPosition(i[0],i[1],i[2]),o.setRotation(a[0],a[1],a[2])}else if(1===this.type){var l=this.options.far.getValue(e),f=this.options.near.getValue(e),h=this.options.fov.getValue(e);return t.camera={near:f,far:l,fov:h,position:i,rotation:a}}}},a=i,(o=[{key:"target",get:function(){return this._target},set:function(e){this.type=2,this._target=e}}])&&v(a.prototype,o),s&&v(a,s),i}(function(){function e(e,t){this.item=t,this._onCreate(e)}var t=e.prototype;return t._onCreate=function(e){},t.onItemUpdate=function(e){},e}());var y=function(e){var t,n;function i(){return e.apply(this,arguments)||this}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._onCreate=function(e){var t=e.model.options;this.endBehavior=t.endBehavior||0,this.duration=t.duration},r._createContent=function(e){var t=this.model;if(t&&!this.delegate){if(t.model){var n=this._modelNode||this._createNode(e);return this.delegate=new g(t.model,e.getParticleOptions()),n&&(n.name=this.name,e.addRenderNode(n),this.delegate.target=n),this.delegate.endBehavior=this.endBehavior,n}t.camera&&(this.delegate=new g(t.camera,e.getParticleOptions()))}},r._createNode=function(e){var t=this.model;if(t&&t.model&&t.model){var n=this._modelNode=e.createRenderNode(t.model);return n&&(n.name=this.name),n}},r._precompile=function(){return this._createNode(this.renderer),{}},r._disposeContent=function(e,t){t&&e.destroyRenderNode(t)},r._onUpdate=function(e,t){this.delegate&&this.delegate.onItemUpdate(t,this.renderer)},i}(_.a),x=n(22);var T=function(e){var t,n;function i(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._destroyParticleItem=function(e){t.renderer.destroyRenderNode(e),t._particleDestroyed=!0},t}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._onCreate=function(e){var t=e.particle.options;this.endBehavior=t.looping?2:t.endBehavior||0,this.duration=t.duration,this.parentId=e.parentId},r._initContent=function(e,t){return t&&(t.name=this.name,t.start(),t._onDestroy=this._destroyParticleItem,e.addRenderNode(t),this.particle.interaction&&(this._uid=this.renderer.addInteractiveItem(this.name,{delegate:this},this))),t},r.hitTest=function(e){var t=e.camera,n=this.particle.interaction;return this._content.raycast({center:t.position,direction:t.direction,multiple:n.multiple,removeParticle:1===n.behavior,radius:n.radius})},r.stopParticleEmission=function(){this._content&&(this._content.emissionStopped=!0),this._items&&this._items.forEach((function(e){return e.stopParticleEmission&&e.stopParticleEmission()}))},r.resumeParticleEmission=function(){this._content&&(this._content.emissionStopped=!1),this._items&&this._items.forEach((function(e){return e.resumeParticleEmission&&e.resumeParticleEmission()}))},r._precompile=function(){var e=this.createContent();if(e)return{particleMesh:e.particleMesh,trailMesh:e.trailMesh}},r._createContent=function(e){if(this.particle){var t=e.getParticleOptions();return t.reusable=this.reusable,new x.a(this.particle,t)}},r._disposeContent=function(e,t){t&&e.destroyRenderNode(t),this._uid&&e.removeInteractiveItem(this._uid),e.calculateGroup.removeItemRef(this.parentId)},r._isEnded=function(t){return e.prototype._isEnded.call(this,t)&&this._particleDestroyed},r._onUpdate=function(e,t){if(this._content){if(this.parentId){var n=this.renderer.calculateGroup.getRenderData(this.parentId);n&&(this._content.parentTransform=n)}this._content._onUpdate(e)}},i}(_.a),b=n(14);var E=function(e){var t,n;function i(){return e.apply(this,arguments)||this}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._onCreate=function(e){var t=e.sprite.options;this.endBehavior=t.looping?2:t.endBehavior||0,this.duration=t.duration},r._createContent=function(e){var t=e.getParticleOptions();return t.parentId=this.parentId,t.reusable=this.reusable,t.delay=this.delay,t.name=this.name,new b.a(this.sprite,t)},r._initContent=function(e,t){e.addRenderNode(t)},r._disposeContent=function(e,t){t&&e.destroyRenderNode(t)},r._precompile=function(){this.createContent();var e=this._content.renderInfo;return{spriteItem:e,createMesh:function(t){return new l.a(e,t)}}},i}(_.a);function A(e,t){return e.ui?new m(e,t):e.particle?new T(e,t):e.sprite?new E(e,t):e.model?new y(e,t):e.cal?new p(e,t):e.content?t.pluginSystem.createPluginItem(e.content.options.type,e,t):new _.a(e,t)}function O(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}_.a.prototype.createVFXItem=A;var C=1,R=function(){function e(e){this.renderer=e.renderer,this.speed=e.speed||1,this._reset(),this._texInfo=e.imageUsage||{},this._textures=e.textures,this.pluginSystem=e.pluginSystem,this.emissionDelegate=e.emissionDelegate;var t=A(e.content,this);if(!1!==e.precompile&&(this._precompiled=this.renderer.precompile(t)),this.keepResource=e.keepResource,Object(f.e)(e.pausePlayer)&&(this.pausePlayer=e.pausePlayer),this.onMessageItem=e.onMessageItem||f.j,this.autoRefTex=!e.keepResource&&e.imageUsage&&5!==t.endBehavior,this._content=t,Object(f.e)(e.onEnd)){var n=this.name;t.onEnd=function(){setTimeout((function(){return e.onEnd({name:n})}),0)}}this.pluginSystem&&this.pluginSystem.initializeComposition(this,e.scene),e.content.camera&&(this.camera=e.content.camera)}var t,n,r,o=e.prototype;return o._reset=function(){var e=this,t=this.renderer.getParticleOptions().engine;this._clickRegion=new a((function(){return e.renderer.getViewProjection()})),this._spriteItemGroup&&(this._spriteItemGroup.removeAll(),this.renderer.destroyNode(this._spriteItemGroup));var n=this._spriteItemGroup=new u.SpriteGroup({delegate:this},t);this.calculateGroup=this._clickRegion.calculateGroup=n.calculateGroup=new i.a,this.sceneNode&&this.renderer.setRootNode(null);var r=this.sceneNode=u.rendererInterface.createNode({name:"root"+C++},t);r.addChild(n),this._rootNode=r},o.forwardTime=function(e){var t=parseInt(1e3*e);if(t){for(var n=t<0,i=Math.abs(t),r=n?-15:15;i>15;i-=15)this.tick(r);if(i>0){var a=n?-i:i;this.tick(a)}}},o.restart=function(){this._reset(),this.start(),this._content.reset().start(),this.forwardTime(this.startTime)},o.start=function(){this.renderer.setRootNode(this._rootNode)},o._startContent=function(){this._content.start()},o.tick=function(e){var t=e*this.speed;t<0&&this.time+t<this.startTime&&(t=this.startTime-this.time);var n,i=this._textures;(i&&i.forEach((function(e){return e.updateVideo&&e.updateVideo()})),this.calculateGroup._onUpdate(t),this._content.onUpdate(t),this._spriteItemGroup._onUpdate(t),this._clickRegion.clearRegionBounds(),this._content.ended)||(null==(n=this.renderer.parent)||n.invalid())},o.getParticleOptions=function(){if(!this._particleOptions){var e=this._particleOptions=this.renderer.getParticleOptions();e.renderer=this,e.emptyTextureContainer=Object(c.d)(),e.emissionDelegate=this.emissionDelegate}return this._particleOptions},o.addInteractiveItem=function(e,t,n){if("message"===t.type)return this.onMessageItem({name:e,phrase:2}),e;var i=t.position||[0,0,0];return this._clickRegion.addRegion({name:e,width:t.width,height:t.height,x:i[0],y:i[1],z:i[2],behavior:t.behavior||0,parentId:n.parentId,delegate:t.delegate,id:n.id})},o.removeInteractiveItem=function(e,t){if("message"===t&&Object(f.h)(e))this.onMessageItem({name:e,phrase:1});else{var n=this._clickRegion.removeRegion(e);n&&n.parentId&&this.calculateGroup.removeItemRef(n.parentId)}},o.addRenderNode=function(e){e.isSpriteItem?this._spriteItemGroup.addItem(e):this._rootNode.addChild(e)},o.pausePlayer=function(){},o.onSpriteMeshDestroy=function(e){this.destroyRenderNode(e)},o.destroyTextures=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n){if(n.isDataTexture){this.renderer.destroyTexture(n);continue}if(this.autoRefTex){var i=--this._texInfo[n.id];i||(isNaN(i),this.renderer.destroyTexture(n))}}}},o.onSpriteRemoved=function(e){e&&(e.parentId&&this.calculateGroup.removeItemRef(e.parentId),this.destroyTextures(e._getTextures()))},o.createRenderNode=function(e){return this.renderer.createRenderNode(e)},o.destroyRenderNode=function(e){var t;e&&(e.isSpriteItem?this._spriteItemGroup.removeItem(e):(e.isParticleSystem&&this.destroyTextures(e._getTextures()),this.renderer.destroyNode(e)),null==(t=this.renderer.parent)||t.invalid())},o.destroyItem=function(e,t){var n=this;this._content.destroyItem(e)&&t.children&&this._content.items.filter((function(t){return t.parentId===e})).forEach((function(e){return n.destroyItem(e.id,t)}))},o.destroy=function(){this._content.destroy(),this._spriteItemGroup.destroy();var e=this.renderer;this.keepResource||(this._textures&&this._textures.forEach((function(t){return e.destroyTexture(t)})),this._textures=null,e.destroyPrecompiled(this._precompiled)),this._particleOptions&&e.destroyTexture(this._particleOptions.emptyTextureContainer),this.pluginSystem&&this.pluginSystem.destroyComposition(this),e.destroy(),this.renderer=null},t=e,(n=[{key:"camera",set:function(e){this.renderer.camera=e}},{key:"name",get:function(){return this._content.name}},{key:"time",get:function(){return this._content._time}},{key:"shouldDestroy",get:function(){var e=this._content;return e.ended&&(!e.endBehavior||3===e.endBehavior)}},{key:"startTime",get:function(){return this._content.startTime||0}},{key:"shouldRestart",get:function(){var e=this._content;return e.ended&&5===e.endBehavior}}])&&O(t.prototype,n),r&&O(t,r),e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return d}));var i=n(9),r=n(44),a=n.n(r),o=n(23),s=n.n(o),u=n(5),c=n(2),l=n(1),f=n(6);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var d=function(e){var t,n;function r(t,n){var r,o=Object(l.c)(),c=Object(i.b)("maxVertexTextures")>0?"#define ENABLE_VERTEX_TEXTURE 1\n":"",h=0,d={};t.colorOverLifetime&&(c+="#define COLOR_OVER_LIFETIME\n",h|=1,d.uColorOverLifetime=Object(u.e)(t.colorOverLifetime).init(n)),t.colorOverTrail&&(c+="#define COLOR_OVER_TRAIL\n",h|=4,d.uColorOverTrail=Object(u.e)(t.colorOverTrail).init(n));var _=t.maxTrailCount>64;_?(c+="#define ATTR_TRAIL_START 1\n",h|=8):t.uTrailStart=new Float32Array(t.maxTrailCount);var p=t.opacityOverLifetime||Object(l.d)(1);t.uOpacityOverLifetimeValue=p.toUniform(o);var m=t.widthOverTrail.toUniform(o);c+="#define CURVE_VALUE_COUNT "+o.index+"\n",c+="#define MAX_KEY_FRAME_COUNT "+o.max+"\n",o.lineSegCount&&(c+="#define USE_LINE_SEG\n"),o.curveCount&&(c+="#define USE_CURVE_VALUE\n");var v=Math.max(t.pointCountPerTrail,2),g={vertexShader:c+a.a,fragmentShader:c+s.a,renderOrder:t.order,shaderCacheId:t._shaderCachePrefix+":t+"+h+"+"+o.index+"+"+o.max,states:{depthMask:t.occlusion,cullFace:!1},samplers:["uMaskTex","uColorOverLifetime","uColorOverTrail"],uniforms:{uModel:0,uViewProjection:"VIEWPROJECTION",uView:"VIEW",uParams:0,uColorParams:0,uTime:0,uWidthOverTrail:0,uOpacityOverLifetimeValue:0,uTrailStart:0,uTextureMap:0,uVCurveValues:[f.a.constants.FLOAT_VEC4],uFCurveValues:[f.a.constants.FLOAT_VEC4]},engine:n,attributes:["aPos","aDir","aInfo","aColor","aTrailStart","aTrailStartIndex","aSeed"]},y=v*t.maxTrailCount*2,x={attributes:{aPos:{size:4,data:4*y},aDir:{size:3,data:3*y},aInfo:{size:4,data:4*y},aColor:{size:4,data:4*y},aSeed:{size:1,data:y}},index:{size:1,data:6*y},drawCount:6*((v-1)*t.maxTrailCount),combineSubData:!0};if(_)x.attributes.aTrailStart={size:1,data:new Float32Array(y)};else{var T=new Float32Array(y);x.attributes.aTrailStartIndex={size:1,data:T};for(var b=0;b<t.maxTrailCount;b++)for(var E=2*v,A=b*E,O=0;O<E;O++)T[A+O]=b}var C=Object(u.h)(t.blending,g.states);return Object(u.i)(t.maskMode,t.mask,g.states),(r=e.call(this,{material:f.a.createMaterial(g),geometry:f.a.createGeometry(x,n),maxTrailCount:t.maxTrailCount,pointCountPerTrail:v,checkVertexDistance:t.minimumVertexDistance>0,minimumVertexDistance:Math.pow(t.minimumVertexDistance||.001,2),lifetime:t.lifetime,useAttributeTrailStart:_},n)||this).setUniformValues(d),r.setUniformValues({uTime:0,uModel:f.a.createMatrix4().elements,uWidthOverTrail:m,uView:"VIEWINVERSE",uVCurveValues:l.a.getAllData(o),uOpacityOverLifetimeValue:t.uOpacityOverLifetimeValue,uTrailStart:t.uTrailStart,uTextureMap:new Float32Array(t.textureMap||[0,0,1,1]),uParams:new Float32Array([0,v-1,t.width||.5,0]),uMaskTex:(Object(u.b)(t.texture)||Object(u.c)()).init(n),uColorParams:new Float32Array([t.texture?1:0,+C,3===t.blending,t.occlusion&&!t.transparentOcclusion])}),t._matrix&&(r._matrix=t._matrix),r._trailCursors=new Uint16Array(t.maxTrailCount),r.isTrailMesh=!0,r._pointStart=[],r}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var o,d,p,m=r.prototype;return m.addPoint=function(e,t,n){n=n||{};var i=this._trailCursors[e],r=this.pointCountPerTrail,a=this.geometry,o=r-1,s=i%r,u=(i-1)%r,l=(i-2)%r,f=this.getPoint(e,u);if(!(f&&this.checkVertexDistance&&Object(c.r)(f,t)<this.minimumVertexDistance)){var h=e*r+s,d=_(f,t),p=[n.time||this.time,n.lifetime||this.lifetime,i],m=8*h,v=n.size||1,g=new Float32Array(8);g.set(t,0),g[3]=.5*v,g.set(t,4),g[7]=-.5*v,a.setAttributeSubData("aPos",m,g);var y=6*h,x=new Float32Array(6);x.set(d,0),x.set(d,3),a.setAttributeSubData("aDir",y,x);var T=n.color||[1,1,1,1],b=new Float32Array(8);b.set(T,0),b.set(T,4),a.setAttributeSubData("aColor",m,b);var E=new Float32Array(8);E.set(p,0),E.set(p,4),E[3]=0,E[7]=1,a.setAttributeSubData("aInfo",m,E);var A=new Float32Array(2);if(A[0]=A[1]=Math.random(),a.setAttributeSubData("aSeed",2*h,A),u>=0){var O=this.getPoint(e,l),C=new Float32Array(_(O,f,t)),R=6*(e*r+u);a.setAttributeSubData("aDir",R,C),a.setAttributeSubData("aDir",R+3,C);var S=e*r*2,w=[2*u,2*u+1,2*s,2*s,2*u+1,2*s+1].map((function(e){return e+S})),M=6*(e*o+(i-1)%o);a.setIndexSubData(M,new Uint16Array(w))}i=++this._trailCursors[e];var P=this.getUniformValue("uParams"),L=p[2];if(this.useAttributeTrailStart){for(var I=2*r,F=new Float32Array(I),N=0;N<I;N++)F[N]=L;a.setAttributeSubData("aTrailStart",e*F.length,F)}else this.getUniformValue("uTrailStart")[e]=L;P[1]=Math.max(P[1],i-1)-Math.max(0,i-r)}},m.getPoint=function(e,t){var n=this.pointCountPerTrail;if(t>=0&&t<n){var i=8*(e*n+t),r=this.geometry.getAttributeData("aPos");return[r[i],r[1+i],r[2+i]]}},m.clearAllTrails=function(){var e=this.geometry;this._trailCursors=new Uint16Array(this._trailCursors.length),e.setIndexData(new Uint16Array(e.getIndexData().length))},m.reverseTime=function(e){for(var t=this.geometry.getAttributeData("aInfo"),n=0;n<t.length;n+=4)t[n]-=e;this.geometry.setAttributeData("aInfo",t),this.time-=e},m.clearTrail=function(e){if(0!==this._trailCursors[e]){var t=6*(this.pointCountPerTrail-1),n=this.geometry.getIndexData();n.set(new Uint8Array(t),e*t),this.geometry.setIndexData(n),this._indicesCleared=!0,this._trailCursors[e]=0}},m.getPointStartPos=function(e){return this._pointStart[e]},m.setPointStartPos=function(e,t){this._pointStart[e]=t},m.destroy=function(t,n){e.prototype.destroy.call(this,t,n),n&&Object(u.f)(this)},m._onUpdate=function(e){this._indicesCleared=!1},o=r,(d=[{key:"time",get:function(){return this.getUniformValue("uTime")},set:function(e){this.setUniformValue("uTime",e)}}])&&h(o.prototype,d),p&&h(o,p),r}(f.a.Mesh);function _(e,t,n){var i;if(!e&&!n)return[0,0,0];if(e)if(n){var r=Object(c.q)(Object(c.n)([],t,e)),a=Object(c.q)(Object(c.n)([],n,t));i=Object(c.k)(r,r,a)}else i=Object(c.n)([],t,e);else i=Object(c.n)([],n,t);return Object(c.q)(i)}},function(e,t,n){"use strict";n.d(t,"a",(function(){return B}));var i=n(2),r=[0,0,0];function a(e,t,n,a,o){Object(i.n)(r,a,t);var s=Object(i.m)(n,r);if(s<0)return null;Object(i.p)(r,n,s),Object(i.k)(r,t,r);var u=Object(i.r)(a,r),c=o*o;return u>c?null:(Object(i.p)(e,n,s-Math.sqrt(c-u)),Object(i.k)(e,e,t))}var o=n(0),s=n(6),u=n(4),c=n(1),l=n(5),f=n(29),h=n.n(f),d=n(23),_=n.n(d),p=n(24),m=n(9),v=n(18),g=n(15);function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var x=function(e){var t,n;function r(t,n){var i,a=["#define RENDER_MODE "+t.renderMode],f=[],d=[],g=0,y=Object(c.c)(),x=Object(c.c)(),T=Object(m.b)("maxVertexTextures")>0,b={uModel:s.a.createMatrix4().elements};T&&a.push("#define ENABLE_VERTEX_TEXTURE 1"),t.speedOverLifetime&&(a.push("#define SPEED_OVER_LIFETIME 1"),g|=2,b.uSpeedLifetimeValue=t.speedOverLifetime.toUniform(y));var E,A=t.sprite;A&&A.animate&&(a.push("#define USE_SPRITE"),g|=4,b.uFSprite=b.uSprite=new Float32Array([A.col,A.row,A.total,A.blend?1:0]),t._useSprite=!0),t.filter&&"none"!==t.filter.name&&(a.push("#define USE_FILTER 1"),g|=8,E=Object(p.a)(t.filter,x,y,n));var O=t.colorOverLifetime;O.color&&(a.push("#define COLOR_OVER_LIFETIME"),g|=16);var C=O.opacity;b.uOpacityOverLifetimeValue=C?C.toUniform(y):new Float32Array(4);var R,S=t.linearVelOverLifetime,w=t.orbitalVelOverLifetime;["x","y","z"].forEach((function(e,t){var n=0;S[e]&&(b["uLinear"+e.toUpperCase()+"ByLifetimeValue"]=S[e].toUniform(y),n=1,g|=1<<7+t,S.enabled=!0),a.push("#define LINEAR_VEL_"+e.toUpperCase()+" "+n);var i=0;w[e]&&(b["uOrb"+e.toUpperCase()+"ByLifetimeValue"]=w[e].toUniform(y),i=1,g|=1<<10+t,R=!0,w.enabled=!0),a.push("#define ORB_VEL_"+e.toUpperCase()+" "+i)})),S.asMovement&&(a.push("#define AS_LINEAR_MOVEMENT"),g|=32),R&&(w.asRotation&&(a.push("#define AS_ORBITAL_MOVEMENT"),g|=64),b.uOrbCenter=new Float32Array(w.center||3));var M=t.sizeOverLifetime;M&&(a.push("#define SIZE_BY_LIFE 1"),g|=8192,b.uSizeByLifetimeValue=M.x.toUniform(y),M.separateAxes&&(a.push("#define SIZE_Y_BY_LIFE 1"),g|=16384,b.uSizeYByLifetimeValue=M.y.toUniform(y)));var P=t.rotationOverLifetime;P.z&&(b.uRZByLifeTimeValue=P.z.toUniform(y),g|=32768,a.push("#define ROT_Z_LIFETIME 1")),P.x&&(b.uRXByLifeTimeValue=P.x.toUniform(y),g|=65536,a.push("#define ROT_X_LIFETIME 1")),P.y&&(b.uRYByLifeTimeValue=P.y.toUniform(y),g|=1<<17,a.push("#define ROT_Y_LIFETIME 1")),P.asRotation&&(a.push("#define ROT_LIFETIME_AS_MOVEMENT 1"),g|=1<<18);var L=t.gravity;b.uAcceleration=[L[0]||0,L[1]||0,L[2]||0,0],b.uGravityModifierValue=t.gravityModifier.toUniform(y);var I=t.forceTarget;I&&(a.push("#define FINAL_TARGET"),g|=1<<19,b.uFinalTarget=new Float32Array(I.target),b.uForceCurve=I.curve.toUniform(y));var F=Object(m.b)("floatTexture");F&&x.max?(g|=1<<20,b.uFCurveValueTexture=s.a.createTextureContainer({data:c.a.getAllData(x),type:u.a.FLOAT,width:x.index,height:1}).init(n),d.push("#define LOOKUP_TEXTURE_CURVE 1")):b.uFCurveValues=c.a.getAllData(x);var N=Object(m.b)("maxVertexUniforms");if(b.uVCurveValues=c.a.getAllData(y),y.max+y.curves.length-32>N&&y.max&&(F&&T&&(b.uVCurveValueTexture=s.a.createTextureContainer({data:t.uVCurveValues,type:u.a.FLOAT,width:y.max,height:1}).init(n),f.push("#define LOOKUP_TEXTURE_CURVE 1")),Object(v.b)(v.a,{name:t.name})),t.previewBorder){var D="#define PREVIEW_BORDER 1";d.push(D),f.push(D),b.uPreviewColor=new Float32Array(t.previewBorder),g|=1<<21}y.lineSegCount&&(f.push("#define USE_LINE_SEG"),g|=1<<22),x.lineSegCount&&(d.push("#define USE_LINE_SEG"),g|=1<<23),y.curveCount&&(f.push("#define USE_CURVE_VALUE"),g|=1<<24),x.curveCount&&(d.push("#define USE_CURVE_VALUE"),g|=1<<25),f.push("#define CURVE_VALUE_COUNT "+y.index),d.push("#define CURVE_VALUE_COUNT "+x.index),f.push("#define MAX_KEY_FRAME_COUNT "+y.max),d.push("#define MAX_KEY_FRAME_COUNT "+x.max),g=["p",t.renderMode,g,y.index,y.max,x.index,x.max].join("+");var z=a.join("\n"),V={vertexShader:f.join("\n")+"\n"+z+"\n"+h.a,fragmentShader:d.join("\n")+"\n"+z+"\n"+_.a,shaderCacheId:t._shaderCachePrefix+":"+g,renderOrder:t.order,states:{side:t.side,depthMask:t.occlusion},uniforms:{uViewProjection:"VIEWPROJECTION",uView:"VIEWINVERSE",uModel:0,uFinalTarget:0,uForceCurve:0,uVCurveValueTexture:0,uFCurveValueTexture:0,uVCurveValues:[s.a.constants.FLOAT_VEC4],uFCurveValues:[s.a.constants.FLOAT_VEC4],uRZByLifeTimeValue:0,uRYByLifeTimeValue:0,uRXByLifeTimeValue:0,uSpeedLifetimeValue:0,uLinearXByLifetimeValue:0,uLinearYByLifetimeValue:0,uLinearZByLifetimeValue:0,uOrbXByLifetimeValue:0,uOrbYByLifetimeValue:0,uOrbZByLifetimeValue:0,uGravityModifierValue:0,uSizeByLifetimeValue:0,uSizeYByLifetimeValue:0,uPreviewColor:0,uColorParams:0,uOpacityOverLifetime:0,uAcceleration:0,uOrbCenter:0,uSprite:0,uFSprite:0,uOpacityOverLifetimeValue:0,uParams:0,uTexOffset:0},engine:n,samplers:["uMaskTex","uColorOverLifetime"],attributes:["aSprite","aPos","aVel","aRot","aColor","aOffset","aSeed","aDirX","aDirY"]},B=t.diffuse;if(B?(B=t.diffuse.init(n)).onLoad=function(){return i.setUniformValue("uTexOffset",[1/B.width,1/B.height])}:B=Object(l.c)().init(n),t.diffuse=B,b.uTexOffset=new Float32Array(B?[1/B.width,1/B.height]:[0,0]),b.uParams=new Float32Array([0,t.duration,0,0]),b.uMaskTex=B,E){var U=V.uniforms;Object(o.d)(E.uniforms,(function(e,t){if(U[t])throw Error("conflict uniform name:"+t);U[t]=e}));var k=V.samplers;E.samplers.forEach((function(e){if(k.indexOf(e)>-1)throw Error("conflict sampler name:"+e);k.push(e)})),Object(o.d)(E.data,(function(e,t){b[t]=e})),V.fragmentShader=V.fragmentShader.replace("#pragma FILTER",E.fragment),V.vertexShader=V.vertexShader.replace("#pragma FILTER",E.vertex),V.shaderCacheId+=E.name}var G=t.blending,j=Object(l.h)(G,V.states);Object(l.i)(t.maskMode,t.mask,V.states),(i=e.call(this,{material:s.a.createMaterial(V),geometry:s.a.createGeometry(r.geometry(t._useSprite),n),duration:t.duration,particleOrigin:t.particleOrigin,_useSprite:t._useSprite,maxCount:t.maxCount,gravityModifier:t.gravityModifier,linearVelOverLifetime:S,orbitalVelOverLifetime:w,speedOverLifetime:t.speedOverLifetime},n)||this)._time=0,i.forceTarget=I,t._matrix&&(i._matrix=t._matrix),b.uColorParams=new Float32Array([B?1:0,+j,3===G,t.occlusion&&!t.transparentOcclusion]),b.uOpacityOverLifetime=O.opacity?1:0;var H=t.textureMap||[0,0,1,1];return i.textureOffsets=[[0,0],[0,1],[1,0],[1,1]].map((function(e){return[H[0]+e[0]*H[2],H[1]+e[1]*H[3]]})),O.color&&(b.uColorOverLifetime=Object(l.e)(O.color).init(n)),i.setUniformValues(b),i.isParticleMesh=!0,i.particleCount=0,i}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,r.geometry=function(e){var t={aPos:{size:3},aVel:{size:3},aRot:{size:3},aColor:{size:4},aOffset:{size:4},aSeed:{size:1},aDirY:{size:3},aDirX:{size:3}};return e&&(t.aSprite={size:3}),{attributes:t,index:{size:1}}};var a,f,d,x=r.prototype;return x.getPointColor=function(e){var t=this.geometry.getAttributeData("aColor"),n=16*e;return[t[n],t[n+1],t[n+2],t[n+3]]},x.getPointPosition=function(e){var t=this.geometry,n=12*e,i=t.getAttributeData("aPos"),r=t.getAttributeData("aVel"),a=t.getAttributeData("aOffset"),o=this.time-a[16*e+2],s=a[16*e+3],u=Object(g.b)(this,this.getUniformValue("uAcceleration"),o,s,i,r,n);if(this.forceTarget){var c=this.getUniformValue("uFinalTarget"),l=this.forceTarget.curve.getValue(o/s),f=1-l;u[0]=u[0]*f+c[0]*l,u[1]=u[1]*f+c[1]*l,u[2]=u[2]*f+c[2]*l}return u},x.clearPoints=function(){this.geometry.resetData(),this.particleCount=this.geometry.drawCount=this.maxParticleBufferCount=0},x.reverseTime=function(e){for(var t=this.geometry.getAttributeData("aOffset"),n=0;n<t.length;n+=4)t[n+2]-=e;this.geometry.setAttributeData("aOffset",t),this.time-=e},x.removePoint=function(e){e<this.particleCount&&this.geometry.setAttributeSubData("aOffset",16*e,new Float32Array(16))},x.setPoint=function(e,t){t=t||0;var n=this.maxCount;if(t<n){var r=1+t,a=4*r,s=this.geometry,u=r>this.maxParticleBufferCount,c=this.particleCount>0?2:1,f={aPos:new Float32Array(12),aVel:new Float32Array(12),aColor:new Float32Array(16),aRot:new Float32Array(12),aOffset:new Float32Array(16),aSeed:new Float32Array(4),aDirX:new Float32Array(12),aDirY:new Float32Array(12)};this._useSprite&&(f.aSprite=new Float32Array(12));var h,d=this.textureOffsets,_=[0,0,e.delay,e.lifetime],p=[0,1,0,1],m=e.pos,v=e.vel,y=e.color,x=Object(i.a)(e.rot);this._useSprite&&(h=e.sprite);for(var T=g.c[this.particleOrigin],b=Math.random(),E=0;E<4;E++){var A=d[E],O=3*E,C=4*E;f.aPos.set(m,O),f.aVel.set(v,O),f.aColor.set(y,C),f.aRot.set(x,O),f.aSeed[E]=b,this._useSprite&&f.aSprite.set(h,O);var R=e.uv||p;R?(_[0]=R[0]/R[1]+A[0]/R[1],_[1]=R[2]/R[3]+A[1]/R[3]):(_[0]=A[0],_[1]=A[1]),f.aOffset.set(_,C);for(var S=E+E,w=T[S]*e.size[0],M=T[S+1]*e.size[1],P=0;P<3;P++)f.aDirX[O+P]=e.dirX[P]*w,f.aDirY[O+P]=e.dirY[P]*M}var L=new Uint16Array([0,1,2,2,1,3].map((function(e){return e+4*t})));if(u){var I=s.getIndexData(),F=Object(l.g)(I,6*r,c,6*n);F.set(L,6*t),s.setIndexData(F),this.maxParticleBufferCount=F.length/6}else s.setIndexSubData(6*t,L);Object(o.d)(f,(function(e,i){var r=s.getAttributeSize(i);if(u){var o=s.getAttributeData(i),f=Object(l.g)(o,a*r,c,4*n*r);f.set(e,e.length*t),s.setAttributeData(i,f)}else s.setAttributeSubData(i,e.length*t,e)})),this.particleCount=Math.max(r,this.particleCount),s.drawCount=6*this.particleCount}return this},x.destroy=function(t,n){e.prototype.destroy.call(this,t,n),Object(l.f)(this,n)},a=r,(f=[{key:"time",get:function(){return this.getUniformValue("uParams")[0]},set:function(e){this.setUniformValue("uParams",new Float32Array([+e,this.duration,0,0]))}}])&&y(a.prototype,f),d&&y(a,d),r}(s.a.Mesh),T=function(){function e(e){Object(o.k)(this,e)}return e.prototype.generate=function(e){var t=.017453292519943295*b(this.arc,this.arcMode,e),n=[Math.cos(t)*this.radius,Math.sin(t)*this.radius,0],r=Math.tan(.017453292519943295*this.angle),a=Object(i.m)([],n,r);return a[2]+=1,{position:Object(i.m)(n,n,Object(o.l)(0,1)),direction:Object(i.q)(a)}},e}();function b(e,t,n){if(0===t)e=Object(o.l)(0,e);else if(1===t){var i=n.index%(n.total+1);e=e/n.total*i}else if(2===t){var r=n.index/(n.total+1),a=r-Math.floor(r);e*=Math.floor(r)%2?1-a:a}else 3===t&&(e=e*n.burstIndex/n.burstCount);return e}var E=function(){function e(e){Object(o.k)(this,e)}var t=e.prototype;return t.getHorizontalAngle=function(){return Object(o.l)(-90,90)},t.generate=function(e){var t=.017453292519943295*b(this.arc,this.arcMode,e),n=.017453292519943295*this.getHorizontalAngle(),r=this.radius,a=[Math.cos(n),0,Math.sin(n)],o=Object(i.e)(t),s=Object(i.h)(a,a,o);return{position:s.map((function(e){return e*r})),direction:s}},e}(),A=function(e){var t,n;function i(){return e.apply(this,arguments)||this}return n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,i.prototype.getHorizontalAngle=function(){return Object(o.l)(0,90)},i}(E),O=function(){function e(e){Object(o.k)(this,e)}return e.prototype.generate=function(e){var t=.017453292519943295*b(this.arc,this.arcMode,e),n=[Math.cos(t),Math.sin(t),0],i=this.radius;return{direction:n,position:n.map((function(e){return e*i}))}},e}(),C=function(){function e(e){this._d=(e.width||1)/2,this._h=(e.height||1)/2}return e.prototype.generate=function(e){return{direction:[0,0,1],position:[Object(o.l)(-this._d,this._d),Object(o.l)(-this._h,this._h),0]}},e}(),R=function(){function e(e){this._d=(e.width||1)/2,this._h=(e.height||1)/2,this.arcMode=e.arcMode,this.arc=e.arc}return e.prototype.generate=function(e){var t=.017453292519943295*b(this.arc,this.arcMode,e),n=[Math.cos(t),Math.sin(t),0],i=this._d,r=this._h,a=Math.atan2(r,i),o=Math.tan(t);return{direction:n,position:t<a?[i,i*o,0]:t>=a&&t<Math.PI-a?[r/o,r,0]:t<Math.PI+a?[-i,-i*o,0]:t<M-a?[-r/o,-r,0]:[i,i*o,0]}},e}(),S=function(){function e(e){this._d=(e.width||1)/2,this.arcMode=e.arcMode}return e.prototype.generate=function(e){var t=3===this.arcMode?e.burstIndex%e.burstCount/(e.burstCount-1):Object(o.l)(0,1);return{direction:[0,1,0],position:[this._d*(t-.5),0,0]}},e}(),w={Cone:T,Sphere:E,Hemisphere:A,Circle:O,Donut:function(){function e(e){Object(o.k)(this,e)}return e.prototype.generate=function(e){var t=this.donutRadius,n=this.radius-t,r=Object(o.l)(0,M),a=.017453292519943295*b(this.arc,this.arcMode,e),s=Object(i.e)(a),u=[Math.cos(r),Math.sin(r),0],c=[n+Math.cos(r)*t,0,Math.sin(r)*t];return{direction:Object(i.h)(u,u,s),position:Object(i.h)(c,c,s)}},e}(),Rectangle:C,Edge:S,RectangleEdge:R},M=2*Math.PI,P=function(){function e(){}return e.prototype.generate=function(){return{position:[0,0,0],direction:[0,0,0]}},e}();function L(e){if(!e)return new P;var t=Object(o.k)({radius:1,arc:360,angle:0,arcMode:0},e||{}),n=w[e.shape];if(!n)throw Error("invalid shape:"+e.shape);var r=new n(t);return Object(o.k)(r,{alignSpeedDirection:e.alignSpeedDirection,reverseDirection:e.reverseDirection,upDirection:Object(i.q)(e.upDirection||[0,0,1])}),r}var I=function(){function e(e){this.time=+e.time||0,this.interval=+e.interval||1,this.count=e.count instanceof c.b?e.count:Object(c.d)(e.count),this.cycles=+e.cycles||1/0,this.probability=isNaN(e.probability)?1:+e.probability,this.reset()}var t=e.prototype;return t.getGeneratorOptions=function(e,t){var n=e-this.time-this._now,i=this.interval;if(n>i*this._i&&this._cycles>0)return this._cycles--,this._i++,Math.random()<=this.probability?{index:this._i,total:1/i,count:this.count.getValue(t),cycleIndex:this.cycles-this._cycles-1}:null},t.reset=function(){return this._cycles=this.cycles,this._i=0,this._now=0,this},t.clone=function(){return new e(this)},e}(),F=n(21),N=function(e){this.content=e},D=function(){function e(e){this.length=0,this._sort=e}var t=e.prototype;return t.findNodeByContent=function(e){var t=this.first;if(t)do{if(e(t.content))return t}while(t=t.next)},t._insertNode=function(e,t){var n=e.next;e.next=t,t.pre=e,t.next=n,n&&(n.pre=t)},t.shiftNode=function(e){var t=new N(e);if(this.length++,1===this.length)return this.first=this.last=t;for(var n=this.first;n;){if(!(this._sort(n.content,t.content)<=0))return n.pre?this._insertNode(n.pre,t):(this.first=t,t.next=n,n.pre=t),t;if(!n.next)return this._insertNode(n,t),this.last=t;n=n.next}},t.pushNode=function(e){var t=new N(e);if(this.length++,1===this.length)return this.last=this.first=t;for(var n=this.last;n;){if(!(this._sort(t.content,n.content)<=0))return this._insertNode(n,t),n===this.last&&(this.last=t),t;if(this.first===n)return n.pre=t,t.next=n,this.first=t;n=n.pre}},t.removeNode=function(e){var t=this.first;if(this.length--,t===e){var n=this.first=t.next;n&&(n.pre=null)}else if((t=this.last)===e){var i=this.last=t.pre;i&&(i.next=null)}else if(e){var r=e.pre,a=e.next;r.next=a,a&&(a.pre=r)}e.pre=null,e.next=null},t.forEach=function(e,t){var n=this.first,i=0;if(n)do{e.call(t||this,n.content,i++)}while(n=n.next)},t.forEachReverse=function(e,t){var n=this.last,i=this.length-1;if(n)do{e.call(t||this,n.content,i--)}while(n=n.pre)},e}(),z=n(7);function V(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var B=function(e){var t,n;function r(t,n){var r,a=t.options||{};n=n||{};var u=t.addition||{},f=a.duration||1,h=a.gravityModifier,d=t.textureSheetAnimation,_=d?{animationDelay:Object(c.d)(d.animationDelay||0),animationDuration:Object(c.d)(d.animationDuration||1),cycles:Object(c.d)(d.cycles||1),animate:d.animate,col:d.col,row:d.row,total:d.total||d.col*d.row,blend:d.blend}:null,p=s.a.createMatrix4(),m={filter:t.filter,renderMatrix:p,independentEmitter:n.independentEmitter,options:{startLifetime:Object(c.d)(a.startLifetime),startDelay:Object(c.d)(a.startDelay||0),startSpeed:Object(c.d)(a.startSpeed||0),startColor:Object(c.d)(a.startColor||["static",[1,1,1,1]]),endBehavior:isNaN(a.endBehavior)?0:a.endBehavior,duration:f,looping:a.looping||!1,maxCount:a.maxCount||0,gravityModifier:Object(c.d)(h||0).scaleXCoord(f),start3DRotation:!!a.start3DRotation,start3DSize:!!a.start3DSize,startTurbulence:!!a.startTurbulence,turbulence:a.startTurbulence&&[Object(c.d)(a.turbulenceX),Object(c.d)(a.turbulenceY),Object(c.d)(a.turbulenceZ)]},shape:L(t.shape),emission:{rateOverTime:Object(c.d)(t.emission.rateOverTime),rateOverDistance:Object(c.d)(t.emission.rateOverDistance),burstOffsets:U(t.emission.burstOffsets),bursts:(t.emission.bursts||[]).map((function(e){return new I(e)}))},textureSheetAnimation:_,onEnd:t.onEnd||o.j,onIterate:t.onIterate||o.j,name:t.name};a.start3DRotation&&(m.options.startRotationX=Object(c.d)(a.startRotationX||0),m.options.startRotationY=Object(c.d)(a.startRotationY||0),m.options.startRotationZ=Object(c.d)(a.startRotationZ||0)),a.startRotation&&(m.options.startRotation=Object(c.d)(a.startRotation||0)),a.start3DSize?(m.options.startSizeX=Object(c.d)(a.startSizeX),m.options.startSizeY=Object(c.d)(a.startSizeY)):(m.options.startSize=Object(c.d)(a.startSize),m.options.sizeAspect=Object(c.d)(a.sizeAspect||1));var v=t.renderer||{},g={},y=t.rotationOverLifetime;y&&(y.separateAxes?(g.x=y.x&&Object(c.d)(y.x),g.y=y.y&&Object(c.d)(y.y),g.z=y.z&&Object(c.d)(y.z)):g.z=y.angularVelocity&&Object(c.d)(y.angularVelocity),g.asRotation=!!y.asRotation);var T,b=t.velocityOverLifetime||{};b.forceTarget&&(T={target:b.target||[0,0,0],curve:Object(c.d)(b.forceCurve||["lines",[[0,0],[1,1]]])});var E={x:b.linearX&&Object(c.d)(b.linearX),y:b.linearY&&Object(c.d)(b.linearY),z:b.linearZ&&Object(c.d)(b.linearZ),asMovement:b.asMovement},A={x:b.orbitalX&&Object(c.d)(b.orbitalX),y:b.orbitalY&&Object(c.d)(b.orbitalY),z:b.orbitalZ&&Object(c.d)(b.orbitalZ),center:b.orbCenter,asRotation:b.asRotation},O=t.sizeOverLifetime,C=t.colorOverLifetime||{},R=v.order||0,S=n.cachePrefix||"",w={filter:t.filter,name:t.name+"_$mesh",_matrix:p,_shaderCachePrefix:S,renderMode:v.renderMode||0,side:v.side||1032,textureMap:v.textureMap,sizeOverLifetime:O&&{separateAxes:O.separateAxes,x:Object(c.d)(O.separateAxes?O.x:O.size),y:Object(c.d)(O.separateAxes?O.y:O.size)},colorOverLifetime:{color:C.color&&Object(c.e)(C.color),opacity:C.opacity&&Object(c.d)(C.opacity)},gravityModifier:m.options.gravityModifier,gravity:Object(i.a)(a.gravity),duration:a.duration,blending:v.blending||0,rotationOverLifetime:g,linearVelOverLifetime:E,orbitalVelOverLifetime:A,speedOverLifetime:b.speedOverLifetime&&Object(c.d)(b.speedOverLifetime),order:R,previewBorder:u.usePreviewBorder&&Object(z.b)(Object(c.e)(u.borderColor),!0),particleOrigin:v.particleOrigin||0,sprite:_,occlusion:!!v.occlusion,transparentOcclusion:!!v.transparentOcclusion,maxCount:a.maxCount,mask:v.mask,maskMode:v.maskMode,forceTarget:T},M=v.texture;!M&&d&&(M=d.texture),w.diffuse=Object(l.b)(M,{clamp:!_})||Object(l.d)();var P=[];if(_&&!_.animate)for(var N=0;N<_.col;N++)for(var D=0;D<_.row;D++)P.push([N,_.col,D,_.row]);else P.push([0,1,0,1]);m._uvs=P,m.particleMesh=new x(w,n.engine);var V=t.trails;V&&(m.trails={lifetime:Object(c.d)(V.lifetime),dieWithParticles:!1!==V.dieWithParticles,sizeAffectsWidth:V.sizeAffectsWidth,sizeAffectsLifetime:V.sizeAffectsLifetime,inheritParticleColor:V.inheritParticleColor,parentAffectsPosition:V.parentAffectsPosition},m.trailMesh=new F.a({colorOverLifetime:Object(c.e)(V.colorOverLifetime),_matrix:p,minimumVertexDistance:V.minimumVertexDistance||.02,maxTrailCount:a.maxCount,pointCountPerTrail:V.maxPointPerTrail||32,blending:V.blending,texture:V.texture,opacityOverLifetime:Object(c.d)(V.opacityOverLifetime||1),widthOverTrail:Object(c.d)(V.widthOverTrail||1),colorOverTrail:Object(c.e)(V.colorOverTrail),order:R,_shaderCachePrefix:S,lifetime:V.lifetime,occlusion:!!V.occlusion,transparentOcclusion:!!V.transparentOcclusion,textureMap:V.textureMap,mask:v.mask,maskMode:v.maskMode},n.engine)),r=e.call(this,m,n.engine)||this;var B,k=t.transform||{};k.path?B=k.path:t.emitterTransform&&t.emitterTransform.path&&(B=t.emitterTransform.path);var G=Object(i.a)(k.position);r.setPosition(G[0],G[1],G[2]);var j=Object(i.a)(k.rotation);r.setRotation(j[0],j[1],j[2]);var H=k.scale||[1,1,1];r.setScale(H[0],H[1],H[2]),r._transform={position:G,rotation:j,path:B&&Object(c.d)(B)},r.updateMatrixWorld(!0),r._updateEmitterTransform(0);var W=[r.particleMesh];return r.trailMesh&&W.push(r.trailMesh),r.setMeshes(W),r.isParticleSystem=!0,r.reusable=n.reusable,r.independentEmitter=n.independentEmitter,r}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var u,f,h,d=r.prototype;return d._getTextures=function(){var e=[];return t(this.particleMesh),t(this.trailMesh),e;function t(t){t&&Object(o.d)(t.getUniformValues(),(function(n,i){n&&n.isTexture&&(e.push(n),t.setUniformValue(i,null))}))}},d.start=function(){return this._started&&!this._ended||(this.reset(),this._started=!0,this._ended=!1),this},d.stop=function(){this._ended=!0,this._started=!1},d.reset=function(){return this.particleMesh.clearPoints(),this.trailMesh&&this.trailMesh.clearAllTrails(),this._lastUpdate=this._loopStartTime=0,this._lastEmitTime=-1/this.emission.rateOverTime.getValue(0),this._info={generatedCount:0},this._paricleLink=new D((function(e,t){return e[0]-t[0]})),this.emission.bursts.forEach((function(e){return e.reset()})),this._freezed=!1,this},d.getParentMatrix=function(){if(this.parent)return this.parent.getWorldMatrix()},d._onUpdate=function(e){var t=this;if(this.independentEmitter){var n=this.getParentMatrix();n&&(this.particleMesh.setUniformValue("uModel",n),this.trailMesh&&this.trailMesh.setUniformValue("uModel",n))}if(this._started&&!this._freezed){var r=this._lastUpdate+e/1e3,a=this.particleMesh,o=this.trailMesh,s=this.options,u=this._loopStartTime;this._lastUpdate=r;var c=this.emission;a.time=r,o&&(o.time=r,o._onUpdate(e)),this._upDirectionWorld=null;var l=this._paricleLink,f=(r-u)/s.duration,h=this.timePassed,d=!1,_=function(){t.trails&&!d&&(d=!0,l.forEach((function(e){var n=e[0],i=e[1],r=e[2],a=e[3];n<h?t.clearPointTrail(i):h>r&&t.updatePointTrail(i,f,a,r)})))};if(this._ended){if(!s.looping)if(this.reusable);else if(0===s.endBehavior){var p=l.last;p&&p.content[0]-u<h&&(this._onUpdate=function(){return t._onDestroy(t)})}}else{var m=s.duration,v=this.lifetime;if(h<m){var g=1/c.rateOverTime.getValue(v),y=Math.floor((h-this._lastEmitTime)/g),x=y,T=g/y,b=r,E=s.maxCount;this._updateEmitterTransform(h);for(var A=function(){var e=l.first;return t.emissionStopped||l.length===E&&e&&e.content[0]-u>h},O=0;O<x&&O<E&&!A();O++){var C=this.createPoint(v);C.delay+=b+O*T,this._addParticle(C,E),this._lastEmitTime=h}for(var R=c.bursts,S=(null==R?void 0:R.length)-1,w=0;S>=0&&w<E&&!A();S--){var M=R[S],P=!M.disabled&&M.getGeneratorOptions(h,v);if(P){var L=c.burstOffsets[S],I=L&&L[P.cycleIndex]||[0,0,0];M.once&&this.removeBurst(S);for(var F=0;F<P.count&&w<E&&!A();F++){var N=this.initPoint(this.shape.generate({total:P.total,index:P.index,burstIndex:F,burstCount:P.count}));N.delay+=b,w++,Object(i.k)(N.pos,N.pos,I),this._addParticle(N,E)}}}}else if(s.looping)r-=m,this._loopStartTime=r,this._lastEmitTime-=m,this._lastUpdate-=m,_(),c.bursts.forEach((function(e){return e.reset()})),a.reverseTime(m),o&&o.reverseTime(m),this._paricleLink.forEach((function(e){e[0]-=m,e[2]-=m})),this.onIterate(this);else{this._ended=!0,this.onEnd(this),4===s.endBehavior&&(this._freezed=!0)}}_()}},d._updateEmitterTransform=function(e){var t,n=this._parentTransform,r=[0,0,0],a=this._transform;if(n){n.pos&&Object(i.k)(r,r,n.pos);var o=n.rot;o&&(Object(i.k)(o,o,this._transform.rotation),this.setRotation(o[0],o[1],o[2])),t=!0}if(a.path){var s=this.options.duration;Object(i.k)(r,r,a.path.getValue(e/s)),t=!0}t&&(Object(i.k)(r,r,a.position),this.setPosition(r[0],r[1],r[2]),this.updateMatrixWorld())},d._onDestroy=function(e){},d.raycast=function(e){var t=this.timePassed,n=this._paricleLink,i=n.last,r=this.particleMesh,o=[],s=!1;if(i)do{var u=i.content,c=u[1];if(!(u[0]>t))break;var l=r.getPointPosition(c);a([],e.center,e.direction,l,e.radius)&&(e.removeParticle&&(r.removePoint(c),this.clearPointTrail(c),n.removeNode(i),u[0]=0,n.shiftNode(i.content)),o.push(l),e.multiple||(s=!0))}while((i=i.pre)&&!s);return o},d._addParticle=function(e,t){var n,i=this._paricleLink,r=new Float32Array([e.delay+e.lifetime,0,e.delay,e.size[0]]);if(i.length<t)n=r[1]=i.length;else{var a=i.first;i.removeNode(a),n=r[1]=a.content[1]}i.pushNode(r),this.particleMesh.setPoint(e,n),this.clearPointTrail(n),this._parentTransform&&this.trailMesh&&this.trailMesh.setPointStartPos(n,this._parentTransform.pos)},d.clearPointTrail=function(e){this.trails&&this.trails.dieWithParticles&&this.trailMesh.clearTrail(e)},d.updatePointTrail=function(e,t,n,r){var a=this.trails,o=this.particleMesh,s=o.getPointPosition(e),u=a.inheritParticleColor&&o.getPointColor(e),c=1,l=a.lifetime.getValue(t);if(a.sizeAffectsWidth&&(c*=n),a.sizeAffectsLifetime&&(l*=n),a.parentAffectsPosition&&this._parentTransform&&this._parentTransform.pos){Object(i.k)(s,s,this._parentTransform.pos);var f=this.trailMesh.getPointStartPos(e);f&&Object(i.n)(s,s,f)}this.trailMesh.addPoint(e,s,{color:u,lifetime:l,size:c,time:r})},d.onEnd=function(){},d.onIterate=function(){},d.initPoint=function(e){var t=this.options,n=this.lifetime,r=this.shape,a=t.startSpeed.getValue(n),s=this.independentEmitter?this.getModelMatrix():this.getWorldMatrix(),u=Object(i.i)(e.position,e.position,s),c=e.direction;if(r.reverseDirection&&(c=Object(i.m)(c,c,-1)),c=Object(i.q)(Object(i.j)(c,c,s)),t.startTurbulence){var l=Object(i.d)(t.turbulence.map((function(e){return.017453292519943295*e.getValue(n)})));c=Object(i.q)(Object(i.h)(c,c,l))}var f=[1,0,0],h=[0,1,0];r.alignSpeedDirection&&(h=[c[0],c[1],c[2]],this._upDirectionWorld||(this._upDirectionWorld=Object(i.j)([],r.upDirection,s)),f=Object(i.q)(Object(i.g)([],h,this._upDirectionWorld)));var d,_=!1,p=this.textureSheetAnimation;p&&p.animate&&(_=[p.animationDelay.getValue(n),p.animationDuration.getValue(n),p.cycles.getValue(n)]),t.start3DRotation?d=[t.startRotationX.getValue(n),t.startRotationY.getValue(n),t.startRotationZ.getValue(n)]:t.startRotation&&(d=[0,0,t.startRotation.getValue(n)]);var m,v=t.startColor.getValue(n);if(3===v.length&&(v[3]=1),t.start3DSize)m=[t.startSizeX.getValue(n),t.startSizeY.getValue(n)];else{var g=t.startSize.getValue(n);m=[g,g/t.sizeAspect.getValue(n)]}return{vel:Object(i.m)(c,c,a),color:v,pos:u,delay:t.startDelay.getValue(n),lifetime:t.startLifetime.getValue(n),size:m,uv:Object(o.m)(this._uvs,!0),sprite:_,rot:d,dirY:h,dirX:f}},d.addBurst=function(e,t){if(Object(o.a)(this.emission.bursts,e)&&t instanceof Array){var n=this.emission.bursts.indexOf(e);return this.emission.burstOffsets[n]=t,n}return-1},d.removeBurst=function(e){e<this.emission.bursts.length&&(this.emission.burstOffsets[e]=null,this.emission.bursts.splice(e,1))},d.createPoint=function(e){var t={total:this.emission.rateOverTime.getValue(e),index:this._info.generatedCount,burstIndex:0,burstCount:0};return this._info.generatedCount++,this.initPoint(this.shape.generate(t))},d.destroy=function(t,n){e.prototype.destroy.call(this,t,n),this.particleMesh.destroy(t,n);var i=this.trailMesh;i&&i.destroy(t,n)},u=r,(f=[{key:"timePassed",get:function(){return this._lastUpdate-this._loopStartTime}},{key:"lifetime",get:function(){return this.timePassed/this.options.duration}},{key:"parentTransform",set:function(e){this._parentTransform=e}}])&&V(u.prototype,f),h&&V(u,h),r}(s.a.Node);function U(e){var t={};return Array.isArray(e)&&e.forEach((function(e){var n=e instanceof Array,i=n?e[0]:e.index,r=t[i];r||(r=t[i]=[]),n?r.push(e.slice(1,4)):r.push([+e.x,+e.y,+e.z])})),t}},function(e,t){e.exports="precision mediump float;varying float vLife;varying vec2 vTexCoord;varying vec4 vColor;uniform sampler2D uMaskTex;uniform vec4 uColorParams;uniform vec2 uTexOffset;\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n\n#ifdef USE_SPRITE\nvarying vec4 vTexCoordBlend;\n#ifdef USE_FILTER\nuniform vec4 uFSprite;\n#endif\n\n#endif\nvarying float vSeed;\n#ifdef PREVIEW_BORDER\nuniform vec4 uPreviewColor;varying vec2 vPTexCoord;varying vec2 vPTexSize;\n#endif\n\n#ifdef USE_SPRITE\nvec4 getTextureColor(sampler2D a,vec2 texCoord){if(vTexCoordBlend.w>0.){return mix(texture2D(a,texCoord),texture2D(a,vTexCoordBlend.xy+texCoord),vTexCoordBlend.z);}return texture2D(a,texCoord);}\n#else\n\n#define getTextureColor texture2D\n\n#endif\n\n#ifdef USE_FILTER\n\n#pragma FILTER\n\n#endif\nvoid main(){vec4 b=vec4(1.0);vec4 c=vColor;vec2 texOffset=uTexOffset;if(vLife<0.){discard;}\n#ifdef USE_FILTER\n#ifdef USE_SPRITE\ntexOffset=uTexOffset/uFSprite.xy;\n#endif\nb=main_filter(Particle(vTexCoord,texOffset,vLife,vSeed),uMaskTex);\n#else\nif(uColorParams.x>0.0){b=getTextureColor(uMaskTex,vTexCoord);}\n#endif\nif(uColorParams.z==1.){b=vec4(1.,1.,1.,b.r*b.a);}\n#ifdef COLOR_OVER_LIFETIME\n#ifndef ENABLE_VERTEX_TEXTURE\nc*=texture2D(uColorOverLifetime,vec2(vLife,0.));\n#endif\n#endif\nb=b*c;\n#ifdef PREVIEW_BORDER\nfloat d=vPTexSize.x;float e=vPTexSize.y;if(vPTexCoord.x<d||vPTexCoord.x>(1.-d)||vPTexCoord.y<e||vPTexCoord.y>(1.-e)){b.rgb=uPreviewColor.rgb*uPreviewColor.a;}\n#endif\nif(b.a<=0.01&&uColorParams.w>0.){float f=texture2D(uMaskTex,vTexCoord+texOffset).r+texture2D(uMaskTex,vTexCoord+texOffset*-1.).r;if(f<=0.02){discard;}}if(uColorParams.y>0.){b.rgb*=b.a;}gl_FragColor=b;}"},function(e,t,n){"use strict";n.d(t,"b",(function(){return D})),n.d(t,"a",(function(){return z}));var i=n(30),r=n.n(i),a=n(31),o=n.n(a),s=n(32),u=n.n(s),c=n(33),l=n.n(c),f=n(34),h=n.n(f),d=n(35),_=n.n(d),p=n(36),m=n.n(p),v=n(37),g=n.n(v),y=n(38),x=n.n(y),T=n(39),b=n.n(T),E=n(40),A=n.n(E),O=n(41),C=n.n(O),R=n(42),S=n.n(R),w=n(43),M=n.n(w),P=n(0),L=n(1),I=n(5),F=n(2),N={dissolve:{vertex:{variables:{uStrengthValue:["strength",1]}},uniforms:{uClipPoint:{name:"center",default:[.5,.5]}},textures:{uBlend:{src:"blend"},uNoise:{src:"noise"}}},reflect:{vertex:{variables:{uDisplayMinXValue:["displayMinX",0],uDisplayMinYValue:["displayMinY",0],uDisplayMaxXValue:["displayMaxX",1],uDisplayMaxYValue:["displayMaxY",1]}},fragment:{variables:{uOpacityOverYValue:["opacityOverY",1],uOpacityOverXValue:["opacityOverX",1]}},uniforms:{uFlipDir:{name:"direction",default:[1,1],enum:{1:[-1,1],2:[1,-1],3:[-1,-1]}}}},swirl:{vertex:{variables:{uRadiusValue:["radius",1],uAngleValue:["angle",180],uBlendOpacityValue:["blendOpacity",0],uStrengthValue:["strength",1]}},uniforms:{uCenter:{name:"center",default:[.5,.5]}},textures:{uBlend:{src:"blend"}}},distortion:{vertex:{variables:{uMovementValue:["waveMovement",0],uStrengthValue:["strength",1],uPeriodValue:["period",1]}},uniforms:{uWaveParams:function(e){var t=e.center||[.5,.5],n=Object(F.q)(e.direction||[1,0]);return[t[0],t[1],n[0],n[1]]}}},alphaPlayer:{uniforms:{uTexRange:function(e){var t=e.colorRange||[.5,1],n=e.alphaRange||[0,.5];return[n[0],n[1]-n[0],t[0],t[1]-t[0]]}}},wave:{vertex:{variables:{uWaveMovementValue:["waveMovement",0],uWaveHeightValue:["waveHeight",.1],uWaveDampingValue:["waveDamping",1],uBlendOpacityValue:["blendOpacity",0]}},uniforms:{uWaveParams:function(e){var t=e.center||[.5,.5];return[t[0],t[1],e.waveFrequency||4,e.blendMethod||0]}},textures:{uBlend:{src:"blend"}}},mask:{vertex:{variables:{uTextureOffsetX:["texOffsetX",0],uTextureOffsetY:["texOffsetY",0]}},textures:{uBlend:{src:"blend"}}},beauty:{uniforms:{uStrength:{name:"strength",default:3}}},glitch:{vertex:{variables:{uToTalStrength:["strength",1],uShakeStrength:["shakeStrength",1],uColorWaveStrength:["colorWaveStrength",1],uColorDifference:["colorDifference",1],uWhiteNoiseStrength:["whiteNoiseStrength",1],uBKN1Strength:["blockNoiseAStrength",1],uBKN2Strength:["blockNoiseBStrength",1],uWaveNoiseStrength:["waveNoiseStrength",1],uColorClip:["colorClip",0],uBlendOpacity:["blendOpacity",0],uWaveFreq:["waveNoiseFreq",1200]}},textures:{uNoise:{src:"noise"},uBlend:{src:"blend"}}}};function D(e,t){var n=N[e.name],i=[];return n&&Object(P.d)(n.textures,(function(n){var r=n.src,a=e[r];Object(P.f)(a)&&(e[r]=t[a],Object(P.a)(i,a))})),i}function z(e,t,n,i){var r=N[e.name];if(!r)throw Error("invalid filter name:"+e.name);var a={},o={},s=r.vertex||{program:"void main_filter(float l){}"},u=[],c={vertex:s.program,fragment:r.fragment.program,uniforms:a,data:o,name:e.name,samplers:u};return l(r.fragment.variables,t),l(s.variables,n),Object(P.d)(r.uniforms,(function(t,n){var i;if(Object(P.e)(t))i=t(e);else if(Object(P.g)(t)){var r=e[t.name],s=t.enum;s&&(i=s[r]),void 0===i&&(i=t.default)}else i=Object(L.e)(e[t]);if(i===+i)o[n]=i;else{if(!Object(P.g)(i)||!Object(P.e)(i.slice))throw Error("invalid value for:"+n+"->"+t);o[n]=i.slice()}a[n]=0})),Object(P.d)(r.textures,(function(t,n){var r=e[t.src],a=(r?Object(I.b)(r):Object(I.d)()).init(i);Object(P.e)(t.processTexture)&&t.processTexture(e,a),o[n]=a,u.push(n)})),c;function l(t,n){Object(P.d)(t,(function(t,i){var r=e[t[0]];void 0===r&&(r=t[1]),o[i]=Object(L.d)(r).toUniform(n),a[i]=0}))}}Object(P.d)({dissolve:{vs:r.a,fs:o.a},reflect:{vs:u.a,fs:l.a},swirl:{vs:_.a,fs:h.a},wave:{vs:g.a,fs:m.a},distortion:{vs:A.a,fs:C.a},glitch:{fs:x.a,vs:b.a},alphaPlayer:{fs:S.a},beauty:{fs:M.a}},(function(e,t){var n=N[t];n.vertex||(n.vertex={}),n.fragment||(n.fragment={}),n.vertex.program=e.vs||"void main_filter(float l){}",n.fragment.program=e.fs,Object(P.d)(e.textures,(function(e,t){Object(P.k)(n.textures[t],e)}))}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(2);n(17);var r=function(e){var t,n;function r(t,n){var i;return(i=e.call(this,t,n)||this).id=n.id,i.refCount=n.refCount,i.renderData=i.getRenderData(0,!0),i.reusable=n.reusable,i}n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var a=r.prototype;return a.willTranslate=function(){return e.prototype.willTranslate.call(this)||!!this.transform},a._onUpdate=function(e,t){this.updateTime(t.time);var n=this.getRenderData(this.time),r=t.getRenderData(this.parentId);r&&(Object(i.l)(n.pos,n.pos,r.pos),Object(i.l)(n.rot,n.rot,r.rot),Object(i.o)(n.color,n.color,r.color),Object(i.o)(n.size,n.size,r.size)),this.renderData=n},r}(n(14).a)},function(e,t){e.exports={ArcModeRandom:0,ArcModeLoop:1,ArcModePingPong:2,ArcModeBurstSpread:3,RENDER_MODE_BILLBOARD:0,RENDER_MODE_VERTICAL_BILLBOARD:2,RENDER_MODE_HORIZONTAL_BILLBOARD:3,RENDER_MODE_MESH:1,BLEND_MODE_ADDITIVE:1,BLEND_MODE_ALPHA:0,BLEND_MODE_MULTIPLY:2,BLEND_MODE_LUMINANCE_ALPHA:3,BLEND_MODE_SUBTRACT:4,BLEND_MODE_ADD_LIGHT:5,BLEND_MODE_LIGHT:6,PARTICLE_ORIGIN_CENTER:0,PARTICLE_ORIGIN_LEFT_TOP:1,PARTICLE_ORIGIN_LEFT_CENTER:2,PARTICLE_ORIGIN_LEFT_BOTTOM:3,PARTICLE_ORIGIN_CENTER_TOP:4,PARTICLE_ORIGIN_CENTER_BOTTOM:5,PARTICLE_ORIGIN_RIGHT_TOP:6,PARTICLE_ORIGIN_RIGHT_CENTER:7,PARTICLE_ORIGIN_RIGHT_BOTTOM:8,END_BEHAVIOR_DESTROY:0,END_BEHAVIOR_PAUSE:1,END_BEHAVIOR_FORWARD:2,END_BEHAVIOR_PAUSE_AND_DESTROY:3,END_BEHAVIOR_FREEZE:4,END_BEHAVIOR_RESTART:5,FILTER_NAME_NONE:"none",INTERACT_BEHAVIOR_NOTIFY:0,INTERACT_BEHAVIOR_RESUME_PLAYER:1,DEG2RAD:.017453292519943295,MESSAGE_ITEM_PHRASE_BEGIN:2,MESSAGE_ITEM_PHRASE_END:1,CLICK_BEHAVIOR_NONE:0,CLICK_BEHAVIOR_DESTROY_PARTICLE:1,MASK_MODE_NONE:0,MASK_MODE_WRITE_MASK:1,MASK_MODE_READ_MASK:2,MASK_MODE_READ_INVERT_MASK:3,RENDER_LEVEL_B_PLUS:"B+",RENDER_LEVEL_B:"B",RENDER_LEVEL_A_PLUS:"A+",RENDER_LEVEL_A:"A",RENDER_LEVEL_S:"S",SIDE_BOTH:1032,SIDE_FRONT:1028,SIDE_BACK:1029}},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));n(0),n(17);var i=n(6),r=n(14),a=n(10);var o=[],s=function(e){var t,n;function i(t,n){var i;return(i=e.call(this,t,n)||this).time=0,i._meshes=[],i}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var s=i.prototype;return s.addItem=function(e){var t=e instanceof r.a?e:new r.a(e);return this._addToRenderMesh(t),t},s.removeItem=function(e){for(var t=this._meshes,n=0;n<t.length;n++){var i=t[n];if(i.items.indexOf(e)>-1)return i.removeItem(e),this.delegate.onSpriteRemoved(e,this),this.rearrangeMeshes()}},s._addToRenderMesh=function(e){for(var t,n=this,i=e.renderInfo,r=this._meshes,o=r.length,s=this.engine,u=e.listIndex,c=0;c<r.length;c++){var l=r[c];if(-1===l.listIndexStart){o=c;break}var f=l.listIndexEnd;if(u<f){o=c;break}if(u>f){var h=r[c+1];if(!h||h.listIndexStart>u&&l.availableItemCount>0){o=c;break}}}if(o===r.length)(t=new a.a(i,s)).calculateGroup=this.calculateGroup,t.addItem(e),r.push(t);else{t=r[o];var d=i.cacheId;if(!t.itemCount||t.renderCacheId===d&&t.availableItemCount>0)t.addItem(e);else{for(var _,p=t.items,m=p.length,v=0;v<p.length;v++)if(p[v].listIndex>u){m=v;break}if(0===m){var g=a.a.fromItems([e],s);g.calculateGroup=this.calculateGroup,r.splice(o,0,g)}else if(m===p.length){var y=a.a.fromItems([e],s);y.calculateGroup=this.calculateGroup,r.splice(o+1,0,y)}else{var x=p.slice(0,m),T=p.slice(m);x[0].renderInfo.cacheId===d?(x.push(e),_=[x,T]):T[0].renderInfo.cacheId===d?(T.unshift(e),_=[x,T]):_=[x,[e],T],(_=_.map((function(e,i){return(t=a.a.fromItems(e,s)).calculateGroup=n.calculateGroup,t}))).unshift(o,1),r.splice.apply(r,_)}this.rearrangeMeshes()}}return this.resetMeshes(),t},s._onUpdate=function(e){for(var t,n=this.time+=e/1e3,i=this._meshes,r=0;r<i.length;r++){var a=i[r];a.time=n;for(var s=a.items,u=0;u<s.length;u++){var c=s[u];c.updateTime(n),c.ended&&4!==c.options.endBehavior?(o.push(c),t=!0):a.updateItem(c)}for(var l=0;l<o.length;l++){var f=o[l];a.removeItem(f),this.delegate.onSpriteRemoved(f,this)}o.length=0,a.applyChange()}t&&this.rearrangeMeshes()},s.resetMeshes=function(){return this.setMeshes(this._meshes),this._meshes},s.rearrangeMeshes=function(){for(var e=this._meshes,t=[],n=!1,i=0;i<e.length;){for(var r=e[i],o=r.renderCacheId,s=r.items.slice(),u=i+1,c=1,l=u;u<e.length;u++){var f=e[u];if(f.renderCacheId!==o)break;s.push.apply(s,f.items),c++,l++}var h=Math.ceil(s.length/a.c);if(c>h){n=!0;for(var d=i;d<u;d++)this.delegate.onSpriteMeshDestroy(e[d]);for(var _=0;_<h;_++){var p=_*a.c,m=a.a.fromItems(s.slice(p,a.c+p),this.engine);m.calculateGroup=this.calculateGroup,t.push(m)}}else for(var v=i;v<u;v++)t.push(e[v]);i=l}return e.length!==t.length&&(n=!0),e=t,this._meshes=e,1!==e.length||e[0].itemCount||(this.delegate.onSpriteMeshDestroy(e[0]),this._meshes=[]),n&&this.resetMeshes(),e},s.removeAll=function(){for(var e=this._meshes,t=0;t<e.length;t++)this.delegate.onSpriteMeshDestroy(e[t]);this._meshes=[],this.resetMeshes(),this.time=0},s.destroy=function(t){e.prototype.destroy.call(this,t),this.delegate=null},i}(i.a.Node)},function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var i=n(12),r=n(11),a=n(13),o=n(9),s=n(0),u=n(20),c=function(){function e(e){this._targetFPS=e||60,this._interval=1e3/this._targetFPS,this._tickers=[],this._paused=!0,this._lastTime=0,this._tickCount=0,this._tickTime=0,this._measuredFPS=0}var t=e.prototype;return t.start=function(){var e=this;if(this._paused=!1,!this._intervalId){this._lastTime=+new Date;var t,n=this,i=this._interval,r=window.requestAnimationFrame;r&&i<17?(this._useRAF=!0,t=function(){n._intervalId=r(t),e._paused||n._tick()}):t=function(){n._intervalId=setTimeout(t,i),e._paused||n._tick()},t()}},t.stop=function(){this._useRAF?window.cancelAnimationFrame(this._intervalId):clearTimeout(this._intervalId),this._intervalId=null,this._lastTime=0,this._paused=!0,this._tickers=[]},t.pause=function(){this._paused=!0},t.resume=function(){this._paused=!1},t._tick=function(){if(!this._paused){var e=+new Date,t=e-this._lastTime,n=this._tickers;++this._tickCount>=this._targetFPS?(this._measuredFPS=1e3/(this._tickTime/this._tickCount)+.5>>0,this._tickCount=0,this._tickTime=0):this._tickTime+=e-this._lastTime,this._lastTime=e,this._resetTikers&&(n=this._tickers=n.filter((function(e){return e&&e.tick})),this._resetTikers=!1);for(var i=0,r=n.length;i<r;i++){var a=n[i];a&&a.tick(t)}}},t.addTicker=function(e){if(!e||"function"!=typeof e.tick)throw new Error("Ticker: The tick object must implement the tick method.");this._tickers.push(e)},t.removeTicker=function(e){var t=this._tickers,n=t.indexOf(e);n>=0&&(t[n]=0,this._resetTikers=!0)},t.nextTick=function(e){var t=this,n={tick:function(i){t.removeTicker(n),e(i)}};return t.addTick(n),n},e}(),l=n(19);function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=function(){function e(e){var t,n=this;if(this.pausePlayer=function(e){n.pause()&&n.onPausedByItem({name:e.name,player:n})},this._onTouchStart=function(e){1===e.touches.length&&n._onClick(e.touches[0])},this._onClick=function(e){if(n.interactive){var t=e.target.getBoundingClientRect(),i=(e.clientX-t.left)/t.width*2-1,r=1-(e.clientY-t.top)/t.height*2;n.compositions.forEach((function(e){var t=e.renderer,a=e._clickRegion.findRegions(i,r,t.camera.position,t.getViewProjection());if(a.length)for(var o=0;o<a.length;o++){var s=a[o],u=s.behavior;0===u?n.onItemClicked({name:s.name,player:n,composition:e.name,id:s.id,parentId:s.parentId,hitPositions:s.hitPositions}):1===u&&n.resume()}}))}},this._onResume=function(){n.onPlayableUpdate({player:n,playing:!0})},e.canvas)t=e.canvas;else{var a=e.container;t=document.createElement("canvas"),a.appendChild(t)}var o=e.onWebGLContextLost;t.addEventListener("webglcontextlost",this._onWebGLContextLost=function(){Object(s.e)(o)&&o(n),n.destroy(!0)}),this.canvas=t;var u=this.renderer=i.rendererInterface.createPlayerRenderer(t),l=this.ticker=new c(60);this.interactive=e.interactive,l.addTicker(this),this.resize(),this.onMessageItem=e.onMessageItem,u.init({preserveDrawingBuffer:!!e.willCaptureImage,alpha:!!e.transparentBackground,pixelRatio:e.pixelRatio||window.devicePixelRatio}),Object(s.e)(e.onPlayableUpdate)&&(this.onPlayableUpdate=e.onPlayableUpdate),Object(s.e)(e.onPausedByItem)&&(this.onPausedByItem=e.onPausedByItem),Object(s.e)(e.onItemClicked)&&(this.onItemClicked=e.onItemClicked),Object(s.e)(e.onMessageItem)&&(this.onMessageItem=e.onMessageItem),Object(s.e)(e.onRenderError)&&(this.onRenderError=e.onRenderError),Object(r.b)()?t.addEventListener("touchstart",this._onTouchStart):t.addEventListener("click",this._onClick),this._pluginLoaderMap={},this.compositions=[]}var t,n,h,d=e.prototype;return d.getCompositionCurrentTime=function(e){var t=e?this.compositions.find((function(t){return t.name===e})):this.compositions[0];return t&&t.time||0},d.resizeToAspect=function(e,t){t=t||1,e===this.displayAspect&&t===this.displayScale||(this.displayAspect=e,this.displayScale=t),this.resize()},d.resize=function(){var e=this.canvas,t=this.canvas.parentElement,n=this.displayAspect;n?t.clientWidth/t.clientHeight>n?(e.height=t.clientHeight*this.displayScale,e.width=e.height*n):(e.width=t.clientWidth*this.displayScale,e.height=e.width/n):(e.width=t.clientWidth,e.height=t.clientHeight);this.renderer.resize(e.width,e.height)},d._tick=function(e,t){e=Math.min(e,33);for(var n=!1,i=this.compositions,r=0;r<i.length;r++){var a=i[r];a.shouldRestart&&a.restart(),a.tick(e),a.shouldDestroy?(a.destroy(),i[r]=null,n=!0):a.renderer.dispose()}n&&(this.compositions=i.filter((function(e){return e}))),this.paused&&!t||((this.compositions.length||t)&&this.renderer.render(),this._forwardingTime||this.onPlayableUpdate({player:!0,playing:!0}))},d.tick=function(e){try{this._tick(e)}catch(e){this.onRenderError(this,e)}},d.onRenderError=function(e,t){throw t},d.loadSceneAsync=function(e,t){var n=this;if(!this.renderer.supportWebGL)return Promise.reject("webgl not support");var i=this.renderer.gl;return Object(o.c)(i),Object(a.c)(e,Object(s.k)({},t)).then((function(e){return n.prepareSceneAsync(e,t)}))},d.prepareSceneAsync=function(e,t){var n=this;return this.renderer.loadGLTFFilesAsync(e.gltf||[]).then((function(){var i=[];(e.plugins||[]).forEach((function(e){var t=n._pluginLoaderMap[e];t||(t=n._pluginLoaderMap[e]=Object(l.b)(e)),i.push(t)}));var r=new l.a(i);return r.loadResourcesAsync(e,t,n.renderer).then((function(){return e.pluginSystem=r,e}))}))},d.snapshot=function(e){var t,n=e.target||"dataURL",i=this.renderer;if("texture"===n&&(t=this.renderer.createFramebuffer(e.textureSize)).bind(),e.scene?this.play(e.scene,e.playable):i.render(),"dataURL"===n)return i.canvas.toDataURL(e.imageType||"image/png",e.imageQuality);if("data"===n){var r=this.canvas,a=new ImageData(width||r.width,height||r.height),o=i.gl;return o.readPixels(0,0,a.width,a.height,o.RGBA,o.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),a}return t.unbind(),i.destroyFramebuffer(t,!0)},d.config=function(e){var t=Object(s.h)(e.compositionName),n=t&&this.compositions.find((function(t){return t.name===e.compositionName}));if("speed"in e){var i=+e.speed||1;t?n&&(n.speed=i):this.compositions.forEach((function(e){return e.speed=i}))}},d.initializeComposition=function(e,t){if(this.renderer.supportWebGL){t=t||{},e.renderLevel=t.renderLevel;var n=e.reusable=!!t.willReverseTime,i=e.compositionId,r=t.compositionName;if(r){var o=Object(a.a)(e.compositions,r);if(!o)throw Error("composition for name "+r+" not found");i=o.id}e.fixRenderOrder=t.fixRenderOrder;var s=Object(a.b)(e.compositions,i,{transform:t.transform,mask:0},e);isNaN(s.endBehavior)&&(s.endBehavior=1);var c=new u.a({speed:t.speed,precompile:t.precompile,content:s,imageUsage:!n&&e.imageUsage,keepResource:t.keepResource,textures:e.textures,renderer:this.renderer.createCompositionRenderer(),pausePlayer:this.pausePlayer,onMessageItem:this.onMessageItem,onEnd:t.onEnd,pluginSystem:e.pluginSystem,scene:e});return e.imageUsage=e.textures=void 0,c._startContent(),c}},d.play=function(e,t){if(t=t||{},this.renderer.supportWebGL){var n=e instanceof u.a?e:this.initializeComposition(e,t);return t.multipleCompositions?this.compositions.push(n):(this.compositions.forEach((function(e){return e.destroy()})),this.compositions=[n]),n.start(),this.ticker.start(),this.forwardCompositionTime(n,t.currentTime||n.startTime),this._renderFrame({pauseOnFirstFrame:t.pauseOnFirstFrame}),n}},d.forwardCompositionTime=function(e,t){t&&(this._forwardingTime=!0,e.forwardTime(t),this._forwardingTime=!1)},d._renderFrame=function(e){var t=this;this.compositions.forEach((function(n){return t.forwardCompositionTime(n,e.currentTime)})),this._tick(0,!0),e.pauseOnFirstFrame?this.pause():this.resume()},d.onItemClicked=function(e){},d.pause=function(){if(!this.paused)return this.ticker.pause(),this.onPlayableUpdate({player:this,playing:!1}),!0},d.resume=function(){this.paused&&(this.ticker.resume(),this._onResume())},d.onPlayableUpdate=function(){},d.onPausedByItem=function(){},d.destroy=function(){var e=this.renderer,t=e.canvas;this.ticker.stop(),t.removeEventListener("webglcontextlost",this._onWebGLContextLost),t.removeEventListener("click",this._onClick),t.removeEventListener("touchstart",this._onTouchStart),Object(s.d)(this._pluginLoaderMap,(function(t){return t.destroy(e)})),e.destroy(!0)},d.destroyItem=function(e,t){t=t||{};var n=this.compositions[0],i=t.composition;i&&(n=this.compositions.find((function(e){return e===i}))),n&&n.destroyItem(e,t)},t=e,(n=[{key:"currentCompositionName",get:function(){var e=this.compositions[0];return e&&e.name}},{key:"hasPlayable",get:function(){return this.compositions.length>0}},{key:"paused",get:function(){return this.ticker._paused}}])&&f(t.prototype,n),h&&f(t,h),e}()},function(e,t){e.exports="precision highp float;\n#define SHADER_VERTEX 1\n\n#ifdef SHADER_VERTEX\n\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uVCurveValues\n\n#else\n\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uFCurveValues\n\n#endif\n\n#if CURVE_VALUE_COUNT\n\n#ifdef LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n\n#endif\n\n#endif\n\n#ifdef SHADER_VERTEX\nattribute float aSeed;varying float vSeed;\n#define NONE_CONST_INDEX 1\n\n#else\n\n#ifdef LOOKUP_TEXTURE_CURVE\n\n#define NONE_CONST_INDEX 1\n\n#endif\n\n#endif\n\n#ifdef NONE_CONST_INDEX\n\n#define MAX_C  MAX_KEY_FRAME_COUNT\n\n#else\n\n#define MAX_C  CURVE_VALUE_COUNT\n\n#endif\n\n#ifdef USE_CURVE_VALUE\nfloat a(float b,vec4 c,vec4 d){float e=d.x-c.x;float f=c.w*e;float g=d.z*e;float h=(b-c.x)/e;float i=h*h;float j=i*h;return dot(vec4(dot(vec3(2.,-3.,1.),vec3(j,i,1.)),dot(vec3(1,-2.,1),vec3(j,i,h)),j-i,dot(vec2(-2,3),vec2(j,i))),vec4(c.y,f,g,d.y));}float k(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q==o){return lookup_curve(o).y;}vec4 r=lookup_curve(q+n);vec4 s=lookup_curve(q+1+n);\n#else\nif(q<n){continue;}vec4 r=lookup_curve(q);vec4 s=lookup_curve(q+1);if(q==p){return r.y;}\n#endif\nif(b>=r.x&&b<=s.x){return a(b,r,s);}}return lookup_curve(0).y;}\n#endif\n\n#ifdef USE_LINE_SEG\nfloat t(float h,vec2 u,vec2 v){return u.y+(v.y-u.y)*(h-u.x)/(v.x-u.x);}float w(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q>o){return lookup_curve(q).w;}\n#else\nif(q<n){continue;}if(q>p){return lookup_curve(q-2).w;}\n#endif\n#ifdef NONE_CONST_INDEX\nvec4 x=lookup_curve(q+n);\n#else\nvec4 x=lookup_curve(q);\n#endif\nvec2 u=x.xy;vec2 v=x.zw;if(b>=u.x&&b<=v.x){return t(b,u,v);}\n#ifdef NONE_CONST_INDEX\nvec2 y=lookup_curve(q+n+1).xy;\n#else\nvec2 y=lookup_curve(q+1).xy;\n#endif\nif(b>v.x&&b<=y.x){return t(b,v,y);}}return lookup_curve(0).y;}\n#endif\nfloat getValueFromTime(float b,vec4 z){float A=z.x;if(A==0.){return z.y;}else if(A==1.){return mix(z.y,z.z,b/z.w);}\n#ifdef USE_LINE_SEG\nif(A==3.){return w(b,z.y,z.z);}\n#endif\n#ifdef USE_CURVE_VALUE\nif(A==2.){return k(b,z.y,z.z);}\n#endif\nif(A==4.){\n#ifdef SHADER_VERTEX\nfloat seed=aSeed;\n#else\nfloat seed=vSeed;\n#endif\nreturn mix(z.y,z.z,seed);}return 0.;}\n#ifdef USE_CURVE_VALUE\nfloat B(float C,vec4 r,vec4 s){float D=s.x-r.x;float f=r.w*D;float g=s.z*D;float E=r.x;float F=r.y;float G=s.y;float e=E-C;float H=e*e;float I=H*e;vec4 J=vec4(I*e,I,H,e)/vec4(4.*D*D*D,3.*D*D,2.*D,1.);vec4 K=vec4(f+g+2.*F-2.*G,2.*f+g+3.*F-3.*G,f,-F);return dot(J,K);}float L(float C,vec4 r,vec4 s){float D=s.x-r.x;float f=r.w*D;float g=s.z*D;float E=r.x;float F=r.y;float G=s.y;float e=E-C;float H=e*e;float I=H*e;float M=D*D;float N=M*D;vec4 J=vec4(-30.*N,10.*M,5.*D,3.)*vec4(e,H,I,I*e);vec4 K=vec4(F,f,2.*f+g+3.*F-3.*G,f+g+2.*F-2.*G)*vec4(E+C,E+2.*C,E+3.*C,E+4.*C);return dot(J,K)/60./N;}float O(float C,float l,float m){if(C==0.){return 0.;}int n=int(l);int o=int(m-1.);float P=0.;for(int q=0;q<MAX_KEY_FRAME_COUNT;q++){if(q==o){return P;}vec4 r=lookup_curve(q+n);vec4 s=lookup_curve(q+1+n);if(C>r.x&&C<=s.x){return P+L(C,r,s);}P+=L(s.x,r,s);}return P;}float Q(float b,float l,float m){if(b==0.){return 0.;}int n=int(l);int o=int(m-1.);float P=0.;for(int q=0;q<MAX_KEY_FRAME_COUNT;q++){if(q==o){return P;}vec4 r=lookup_curve(q+n);vec4 s=lookup_curve(q+1+n);if(b>r.x&&b<=s.x){return P+B(b,r,s);}P+=B(s.x,r,s);}return P;}\n#endif\nfloat R(float h,vec2 u,vec2 v){float E=u.x;float C=v.x;float S=u.y;float T=v.y;float U=dot(vec4(2.*h*h*h,3.*h*h,-E*E*E,3.*E*E),vec4(S-T,E*T-C*S,2.*S+T,C*S));return U/(E-C)/6.;}float V(float b,vec2 u,vec2 v){float W=b-u.x;float S=u.y;return (S+S+(v.y-S)*W/(v.x-u.x))*W/2.;}\n#ifdef USE_LINE_SEG\nfloat X(float b,float l,float m){if(b==0.){return 0.;}int n=int(l);int o=int(m-1.);float P=0.;for(int q=0;q<MAX_KEY_FRAME_COUNT;q++){if(q>o){return P;}vec4 Y=lookup_curve(q+n);vec2 r=Y.xy;vec2 s=Y.zw;if(b>r.x&&b<=s.x){return P+V(b,r,s);}P+=V(s.x,r,s);vec2 M=lookup_curve(q+n+1).xy;if(b>s.x&&b<=M.x){return P+V(b,s,M);}P+=V(M.x,s,M);}return P;}float Z(float b,float l,float m){if(b==0.){return 0.;}int n=int(l);int o=int(m-1.);float P=0.;for(int q=0;q<MAX_KEY_FRAME_COUNT;q++){if(q>o){return P;}vec4 Y=lookup_curve(q+n);vec2 r=Y.xy;vec2 s=Y.zw;if(b>r.x&&b<=s.x){return P+R(b,r,s);}P+=R(s.x,r,s);vec2 M=lookup_curve(q+n+1).xy;if(b>s.x&&b<=M.x){return P+R(b,s,M);}P+=R(M.x,s,M);}return P;}\n#endif\nfloat getIntegrateFromTime0(float C,vec4 z){float A=z.x;if(A==0.){return z.y*C;}else if(A==1.){vec2 u=vec2(0.,z.y);vec2 v=vec2(z.w,z.z);return V(C,u,v);}\n#ifdef USE_LINE_SEG\nif(A==3.){return X(C,z.y,z.z);}\n#endif\n#ifdef USE_CURVE_VALUE\nif(A==2.){return Q(C,z.y,z.z);}\n#endif\nif(A==4.){return mix(z.y,z.z,aSeed)*C;}return 0.;}float ba(float E,float C,vec4 z){float A=z.x;if(A==0.){return z.y*(C*C-E*E)/2.;}else if(A==1.){vec2 u=vec2(0.,z.y);vec2 v=vec2(z.w,z.z);return R(C,u,v)-R(E,u,v);}\n#ifdef USE_LINE_SEG\nif(A==3.){return Z(C,z.y,z.z)-Z(E,z.y,z.z);}\n#endif\n#ifdef USE_CURVE_VALUE\nif(A==2.){return O(C,z.y,z.z)-O(E,z.y,z.z);}\n#endif\nif(A==4.){return mix(z.y,z.z,aSeed)*(C*C-E*E)/2.;}return 0.;}const float bb=3.141592653589793/180.;attribute vec3 aPos;attribute vec4 aOffset;attribute vec3 aVel;attribute vec3 aRot;attribute vec4 aColor;attribute vec3 aDirX;attribute vec3 aDirY;\n#ifdef USE_SPRITE\nattribute vec3 aSprite;uniform vec4 uSprite;vec2 bc(vec2 bd,float be,out vec3 bf);varying vec4 vTexCoordBlend;\n#endif\n\n#ifdef FINAL_TARGET\nuniform vec3 uFinalTarget;uniform vec4 uForceCurve;\n#endif\nuniform mat4 uModel;uniform mat4 uView;uniform mat4 uViewProjection;uniform vec4 uParams;uniform vec4 uAcceleration;uniform float uOpacityOverLifetime;uniform vec4 uGravityModifierValue;uniform vec4 uOpacityOverLifetimeValue;\n#ifdef ROT_X_LIFETIME\nuniform vec4 uRXByLifeTimeValue;\n#endif\n\n#ifdef ROT_Y_LIFETIME\nuniform vec4 uRYByLifeTimeValue;\n#endif\n\n#ifdef ROT_Z_LIFETIME\nuniform vec4 uRZByLifeTimeValue;\n#endif\n\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\n\n#if LINEAR_VEL_X\nuniform vec4 uLinearXByLifetimeValue;\n#endif\n\n#if LINEAR_VEL_Y\nuniform vec4 uLinearYByLifetimeValue;\n#endif\n\n#if LINEAR_VEL_Z\nuniform vec4 uLinearZByLifetimeValue;\n#endif\n\n#endif\n\n#ifdef SPEED_OVER_LIFETIME\nuniform vec4 uSpeedLifetimeValue;\n#endif\n\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\n\n#if ORB_VEL_X\nuniform vec4 uOrbXByLifetimeValue;\n#endif\n\n#if ORB_VEL_Y\nuniform vec4 uOrbYByLifetimeValue;\n#endif\n\n#if ORB_VEL_Z\nuniform vec4 uOrbZByLifetimeValue;\n#endif\nuniform vec3 uOrbCenter;\n#endif\n\n#ifdef SIZE_BY_LIFE\nuniform vec4 uSizeByLifetimeValue;\n#endif\n\n#ifdef SIZE_Y_BY_LIFE\nuniform vec4 uSizeYByLifetimeValue;\n#endif\nvarying float vLife;varying vec4 vColor;varying vec2 vTexCoord;\n#ifdef PREVIEW_BORDER\nvarying vec2 vPTexCoord;varying vec2 vPTexSize;\n#endif\n\n#ifdef USE_FILTER\n\n#pragma FILTER\n\n#endif\nvec3 bg(float _life,float _dur){vec3 bh=vec3(0.0);\n#ifdef AS_ORBITAL_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#if ORB_VEL_X\nbh.x=FUNC(uOrbXByLifetimeValue);\n#endif\n#if ORB_VEL_Y\nbh.y=FUNC(uOrbYByLifetimeValue);\n#endif\n#if ORB_VEL_Z\nbh.z=FUNC(uOrbZByLifetimeValue);\n#endif\n#undef FUNC\nreturn bh;}vec3 bi(float _life,float _time,float _dur){vec3 bj=vec3(0.0);\n#ifdef AS_LINEAR_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_time/_dur,a) * _dur\n#endif\n#if LINEAR_VEL_X\nbj.x=FUNC(uLinearXByLifetimeValue);\n#endif\n#if LINEAR_VEL_Y\nbj.y=FUNC(uLinearYByLifetimeValue);\n#endif\n#if LINEAR_VEL_Z\nbj.z=FUNC(uLinearZByLifetimeValue);\n#endif\n#undef FUNC\nreturn bj;}mat3 bk(vec3 bl){vec3 bm=sin(bl*bb);vec3 bn=cos(bl*bb);return mat3(1.,0.,0.,0,bn.x,-bm.x,0.,bm.x,bn.x)*mat3(bn.y,0.,bm.y,0.,1.,0.,-bm.y,0,bn.y)*mat3(bn.z,-bm.z,0.,bm.z,bn.z,0.,0.,0.,1.);}\n#ifdef USE_SPRITE\nvec2 bc(vec2 bd,float be,out vec3 bf){float h=clamp((be-aSprite.x)/aSprite.y,0.0,1.)*aSprite.z;float bo=uSprite.z*h;float bp=max(ceil(bo)-1.,0.);float bq=floor((bp+0.1)/uSprite.x);float br=bp-bq*uSprite.x;vec2 bs=(vec2(br,bq)+bd)/uSprite.xy;if(uSprite.w>0.){float bt=bo-bp;float bu=min(ceil(bo),uSprite.z-1.);float bv=floor((bu+0.1)/uSprite.x);float bw=bu-bv*uSprite.x;vec2 bx=(vec2(bw,bv)+bd)/uSprite.xy-bs;bf=vec3(bx.x,1.-bx.y,bt);}return vec2(bs.x,1.-bs.y);}\n#endif\nvec3 by(vec3 bz,float E,float C,float bA){float e=C-E;float bB=ba(0.,e,uGravityModifierValue);vec3 bC=uAcceleration.xyz*bB;\n#ifdef SPEED_OVER_LIFETIME\nreturn bz*getIntegrateFromTime0(e/bA,uSpeedLifetimeValue)*bA+bC;\n#endif\nreturn bz*e+bC;}mat3 bD(vec3 bE,float b){vec3 bl=bE;\n#ifdef ROT_LIFETIME_AS_MOVEMENT\n#define FUNC1 getValueFromTime\n#else\n#define FUNC1 getIntegrateFromTime0\n#endif\n#ifdef ROT_X_LIFETIME\nbl.x+=FUNC1(b,uRXByLifeTimeValue);\n#endif\n#ifdef ROT_Y_LIFETIME\nbl.y+=FUNC1(b,uRYByLifeTimeValue);\n#endif\n#ifdef ROT_Z_LIFETIME\nbl.z+=FUNC1(b,uRZByLifeTimeValue);\n#endif\nif(dot(bl,bl)==0.0){return mat3(1.0);}\n#undef FUNC1\nreturn bk(bl);}void main(){float b=uParams.x-aOffset.z;float bA=aOffset.w;if(b<0.||b>bA){gl_Position=vec4(-3.,-3.,-3.,1.);}else{float bF=clamp(b/bA,0.0,1.0);vLife=bF;\n#ifdef USE_SPRITE\nvec3 bG;vTexCoord=bc(aOffset.xy,b,bG);vTexCoordBlend=vec4(bG,uSprite.w);\n#else\nvTexCoord=vec2(aOffset.x,1.-aOffset.y);\n#endif\nvColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(bF,0.));\n#endif\n#endif\nif(uOpacityOverLifetime>0.0){vColor.a*=clamp(getValueFromTime(bF,uOpacityOverLifetimeValue),0.,1.);}vec2 bH=vec2(1.0);\n#ifdef SIZE_BY_LIFE\nbH=vec2(getValueFromTime(bF,uSizeByLifetimeValue));\n#endif\n#ifdef SIZE_Y_BY_LIFE\nbH.y=getValueFromTime(bF,uSizeYByLifetimeValue);\n#endif\n#ifdef PREVIEW_BORDER\nvPTexCoord=aOffset.xy;vPTexSize=bH*0.05;\n#endif\nvec3 bI=bD(aRot,bF)*(aDirX*bH.x+aDirY*bH.y);vec3 bJ=by(aVel,aOffset.z,uParams.x,bA);vec3 bK=aPos+bJ;\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\nbK=(bK-uOrbCenter)*bk(bg(bF,bA));bK+=uOrbCenter;\n#endif\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\nbK.xyz+=bi(bF,b,bA);\n#endif\n#ifdef FINAL_TARGET\nfloat bL=getValueFromTime(bF,uForceCurve);vec4 bM=vec4(mix(bK,uFinalTarget,bL),1.);\n#else\nvec4 bM=vec4(bK,1.0);\n#endif\n#if RENDER_MODE == 1\nbM.xyz+=bI;bM=uModel*bM;\n#elif RENDER_MODE == 3\nbM=uModel*bM;bM.xyz+=uView[0].xyz*bI.x+uView[2].xyz*bI.y;\n#elif RENDER_MODE == 2\nbM=uModel*bM;bM.xy+=bI.xy;\n#elif RENDER_MODE == 0\nbM=uModel*bM;bM.xyz+=uView[0].xyz*bI.x+uView[1].xyz*bI.y;\n#endif\ngl_Position=uViewProjection*bM;vSeed=aSeed;\n#ifdef USE_FILTER\nmain_filter(bF);\n#endif\n}}"},function(e,t){e.exports="uniform vec4 uStrengthValue;varying float vStrength;void main_filter(float lifetime){vStrength=getValueFromTime(lifetime,uStrengthValue);}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform sampler2D uNoise;uniform sampler2D uBlend;uniform vec2 uClipPoint;varying float vStrength;vec4 main_filter(Particle a,sampler2D texture){float b=1.0-length(a.texCoord-uClipPoint)/sqrt(0.5);vec2 c=fract(a.texCoord+vec2(a.seed));float d=texture2D(uNoise,c).r;float e=(b+d)/2.+vStrength;if(e>1.){return getTextureColor(uBlend,a.texCoord);}return getTextureColor(texture,a.texCoord);}"},function(e,t){e.exports="uniform vec4 uDisplayMinXValue;uniform vec4 uDisplayMinYValue;uniform vec4 uDisplayMaxXValue;uniform vec4 uDisplayMaxYValue;varying vec4 vDisplayRange;void main_filter(float lifetime){vDisplayRange=vec4(getValueFromTime(lifetime,uDisplayMinXValue),getValueFromTime(lifetime,uDisplayMaxXValue),getValueFromTime(lifetime,uDisplayMinYValue),getValueFromTime(lifetime,uDisplayMaxYValue));}"},function(e,t){e.exports="\n#ifdef SHADER_VERTEX\n\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uVCurveValues\n\n#else\n\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uFCurveValues\n\n#endif\n\n#if CURVE_VALUE_COUNT\n\n#ifdef LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n\n#endif\n\n#endif\n\n#ifdef SHADER_VERTEX\nattribute float aSeed;varying float vSeed;\n#define NONE_CONST_INDEX 1\n\n#else\n\n#ifdef LOOKUP_TEXTURE_CURVE\n\n#define NONE_CONST_INDEX 1\n\n#endif\n\n#endif\n\n#ifdef NONE_CONST_INDEX\n\n#define MAX_C  MAX_KEY_FRAME_COUNT\n\n#else\n\n#define MAX_C  CURVE_VALUE_COUNT\n\n#endif\n\n#ifdef USE_CURVE_VALUE\nfloat a(float b,vec4 c,vec4 d){float e=d.x-c.x;float f=c.w*e;float g=d.z*e;float h=(b-c.x)/e;float i=h*h;float j=i*h;return dot(vec4(dot(vec3(2.,-3.,1.),vec3(j,i,1.)),dot(vec3(1,-2.,1),vec3(j,i,h)),j-i,dot(vec2(-2,3),vec2(j,i))),vec4(c.y,f,g,d.y));}float k(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q==o){return lookup_curve(o).y;}vec4 r=lookup_curve(q+n);vec4 s=lookup_curve(q+1+n);\n#else\nif(q<n){continue;}vec4 r=lookup_curve(q);vec4 s=lookup_curve(q+1);if(q==p){return r.y;}\n#endif\nif(b>=r.x&&b<=s.x){return a(b,r,s);}}return lookup_curve(0).y;}\n#endif\n\n#ifdef USE_LINE_SEG\nfloat t(float h,vec2 u,vec2 v){return u.y+(v.y-u.y)*(h-u.x)/(v.x-u.x);}float w(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q>o){return lookup_curve(q).w;}\n#else\nif(q<n){continue;}if(q>p){return lookup_curve(q-2).w;}\n#endif\n#ifdef NONE_CONST_INDEX\nvec4 x=lookup_curve(q+n);\n#else\nvec4 x=lookup_curve(q);\n#endif\nvec2 u=x.xy;vec2 v=x.zw;if(b>=u.x&&b<=v.x){return t(b,u,v);}\n#ifdef NONE_CONST_INDEX\nvec2 y=lookup_curve(q+n+1).xy;\n#else\nvec2 y=lookup_curve(q+1).xy;\n#endif\nif(b>v.x&&b<=y.x){return t(b,v,y);}}return lookup_curve(0).y;}\n#endif\nfloat getValueFromTime(float b,vec4 z){float A=z.x;if(A==0.){return z.y;}else if(A==1.){return mix(z.y,z.z,b/z.w);}\n#ifdef USE_LINE_SEG\nif(A==3.){return w(b,z.y,z.z);}\n#endif\n#ifdef USE_CURVE_VALUE\nif(A==2.){return k(b,z.y,z.z);}\n#endif\nif(A==4.){\n#ifdef SHADER_VERTEX\nfloat seed=aSeed;\n#else\nfloat seed=vSeed;\n#endif\nreturn mix(z.y,z.z,seed);}return 0.;}\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nvarying vec4 vDisplayRange;uniform vec2 uFlipDir;uniform vec4 uOpacityOverXValue;uniform vec4 uOpacityOverYValue;vec4 main_filter(Particle B,sampler2D texture){vec2 texCoord=B.texCoord;float C=B.lifetime;if(texCoord.x<vDisplayRange.x||texCoord.x>vDisplayRange.y||texCoord.y<vDisplayRange.z||texCoord.y>vDisplayRange.w){return vec4(0.);}float D=getValueFromTime(texCoord.x,uOpacityOverXValue)*getValueFromTime(texCoord.y,uOpacityOverYValue);vec2 E=(texCoord-0.5)*uFlipDir+0.5;return getTextureColor(texture,E)*D;}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform vec2 uCenter;uniform sampler2D uBlend;varying vec4 vFilterParams;vec4 main_filter(Particle a,sampler2D texture){vec2 texCoord=a.texCoord;float b=vFilterParams.x;float c=distance(texCoord,uCenter);const float d=3.14159/180.;if(b>c){float e=vFilterParams.y*d;float f=(b-c)/b;float g=f*f*e*vFilterParams.w;float h=sin(g);float i=cos(g);texCoord-=uCenter;texCoord=vec2(dot(texCoord,vec2(i,-h)),dot(texCoord,vec2(h,i)));texCoord+=uCenter;}vec4 j=getTextureColor(texture,texCoord);float k=vFilterParams.z;if(k>0.){return mix(j,getTextureColor(uBlend,texCoord),k);}return j;}"},function(e,t){e.exports="uniform vec4 uRadiusValue;uniform vec4 uAngleValue;uniform vec4 uBlendOpacityValue;uniform vec4 uStrengthValue;varying vec4 vFilterParams;void main_filter(float a){vFilterParams=vec4(getValueFromTime(a,uRadiusValue),getValueFromTime(a,uAngleValue),getValueFromTime(a,uBlendOpacityValue),getValueFromTime(a,uStrengthValue));}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform vec4 uWaveParams;uniform sampler2D uBlend;varying vec4 vWaveParams;vec3 a(vec2 b,float c,float d,float e){float f=distance(b,uWaveParams.xy);float g=(c-f)*d;return vec3(b,cos(g*uWaveParams.z)*max(1.-g*g,0.)*e);}vec4 main_filter(Particle h,sampler2D texture){const vec3 i=vec3(0.,0.,-1.);float j=h.lifetime;vec2 k=h.texCoord;float l=uWaveParams.w;float m=vWaveParams.x;float d=vWaveParams.y;float n=vWaveParams.z;float e=vWaveParams.w;float g=(m-distance(k,uWaveParams.xy))*d;vec4 o;vec3 p=a(k,m,d,e);vec3 q=a(k+vec2(h.texOffset.x*uWaveParams.z,0.),m,d,e);vec3 r=a(k+vec2(0.,h.texOffset.y*uWaveParams.z),m,d,e);vec3 s=refract(i,normalize(cross(p-q,p-r)),0.8);float t=s.z==0.?0.:-p.z/s.z;o=getTextureColor(texture,k+t*s.xy);if(l==0.){return o;}vec4 u=getTextureColor(uBlend,k);if(l==2.){float f=distance(k,uWaveParams.xy);float g=clamp((m-f)*d+1.,0.,1.);n=g*n;}return mix(o,u,n);}"},function(e,t){e.exports="uniform vec4 uWaveMovementValue;uniform vec4 uWaveHeightValue;uniform vec4 uWaveDampingValue;uniform vec4 uBlendOpacityValue;varying vec4 vWaveParams;void main_filter(float a){vWaveParams=vec4(getValueFromTime(a,uWaveMovementValue),getValueFromTime(a,uWaveDampingValue),clamp(getValueFromTime(a,uBlendOpacityValue),0.,1.),getValueFromTime(a,uWaveHeightValue));}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nvarying vec4 uGlitchParams;varying vec4 uNoiseParams;varying float vColorClip;varying float vBlendOpacity;varying float vWaveFreq;uniform sampler2D uNoise;uniform sampler2D uBlend;uniform vec2 uResolution;float a(vec2 b){return fract(sin(dot(b.xy,vec2(12.9898,78.233)))*43758.5453);}float c(vec2 d){return texture2D(uNoise,fract(d)).r;}const vec4 e=vec4(1.,0.,0.,1.);const vec4 f=vec4(0,1.,0.,1.);const vec4 g=vec4(0.,0.,1.,1.);vec4 h(sampler2D i,sampler2D j,vec2 texCoord,float k){vec4 l=vec4(0.);vec4 m=vec4(0.);if(k<1.){l=getTextureColor(i,texCoord);}if(k>0.){m=getTextureColor(j,texCoord);}return mix(l,m,k);}vec4 n(float x,float y,float o,sampler2D texture){vec4 p=h(texture,uBlend,vec2(x+o,y),vBlendOpacity)*e;vec4 q=h(texture,uBlend,vec2(x,y),vBlendOpacity)*f;vec4 r=h(texture,uBlend,vec2(x-o,y),vBlendOpacity)*g;return p+q+r;}vec4 main_filter(Particle s,sampler2D texture){float t=s.lifetime;vec2 u=s.texCoord;vec2 v=1./s.texOffset;float w=uGlitchParams.x;vec2 x=vec2(w*8.0+0.5)*vec2(a(vec2(t))*2.0-1.0,a(vec2(t*2.0))*2.0-1.0)/v*uGlitchParams.y;float y=u.y*v.y;float z=(c(vec2(y*0.01,t*400.0))*(2.0+w*32.0)*c(vec2(y*0.02,t*200.0))*(1.0+w*4.0)+step(0.9995,sin(y*0.005+t*1.6))*12.0+step(0.9999,sin(y*0.005+t*2.0))*-18.0)/v.x*uGlitchParams.z;float A=(6.0+sin(t*500.0+u.y*40.0)*(20.0*w+1.0))/v.x*uGlitchParams.w;float B=u.x+z;vec4 C=n(B+x.x,u.y+x.y,A,texture);float D=(a(u+mod(t,10.0))*2.0-1.0)*(0.15+w*0.15)*uNoiseParams.x;float E=floor(t*20.0)*200.0;float F=step((c(vec2(u.x*3.0,E))+1.0)/2.0,0.12+w*0.3);float G=step((c(vec2(u.y*3.0,E))+1.0)/2.0,0.12+w*0.3);float H=F*G*uNoiseParams.y;float I=u.x+sin(E)*0.2+z;vec4 J=vec4(0.);if(H>0.){J=n(I,u.y,A,texture)*H;}float K=floor(t*25.0)*300.0;float L=step((c(vec2(u.x*2.0,K))+1.0)/2.0,0.12+w*0.5);float M=step((c(vec2(u.y*8.0,K))+1.0)/2.0,0.12+w*0.3);float N=L*M*uNoiseParams.z;vec4 O=vec4(0.);if(N>0.){O=n(I,u.y,A,texture)*N;}float P=(sin(u.y*vWaveFreq)+1.0)/2.0*(0.15+w*0.2)*uNoiseParams.w;vec4 Q=clamp(C*(1.0-H-N)+(D+J+O-P),0.,1.);if(dot(Q.xyz,vec3(Q.a))<vColorClip){discard;}return Q;}"},function(e,t){e.exports="varying vec4 uGlitchParams;varying vec4 uNoiseParams;varying float vColorClip;varying float vBlendOpacity;varying float vWaveFreq;uniform vec4 uToTalStrength;uniform vec4 uShakeStrength;uniform vec4 uColorWaveStrength;uniform vec4 uColorDifference;uniform vec4 uWhiteNoiseStrength;uniform vec4 uBKN1Strength;uniform vec4 uBKN2Strength;uniform vec4 uWaveNoiseStrength;uniform vec4 uColorClip;uniform vec4 uBlendOpacity;uniform vec4 uWaveFreq;void main_filter(float a){uGlitchParams=vec4(getValueFromTime(a,uToTalStrength),getValueFromTime(a,uShakeStrength),getValueFromTime(a,uColorWaveStrength),getValueFromTime(a,uColorDifference));uNoiseParams=vec4(getValueFromTime(a,uWhiteNoiseStrength),getValueFromTime(a,uBKN1Strength),getValueFromTime(a,uBKN2Strength),getValueFromTime(a,uWaveNoiseStrength));vColorClip=getValueFromTime(a,uColorClip);vBlendOpacity=getValueFromTime(a,uBlendOpacity);vWaveFreq=getValueFromTime(a,uWaveFreq);}"},function(e,t){e.exports="uniform vec4 uMovementValue;uniform vec4 uStrengthValue;uniform vec4 uPeriodValue;varying vec3 vWaveParams;void main_filter(float lifetime){const float a=3.14159265;vWaveParams=vec3(getValueFromTime(lifetime,uPeriodValue)*a,getValueFromTime(lifetime,uMovementValue)*a,getValueFromTime(lifetime,uStrengthValue));}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform vec4 uWaveParams;varying vec3 vWaveParams;vec4 main_filter(Particle a,sampler2D texture){vec2 b=a.texCoord-uWaveParams.xy;float c=dot(b,uWaveParams.zw);float d=sin(vWaveParams.x*c+vWaveParams.y)*vWaveParams.z;vec2 e=vec2(-uWaveParams.w,uWaveParams.z)*d;return getTextureColor(texture,clamp(a.texCoord+e,0.,1.));}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform vec4 uTexRange;vec4 main_filter(Particle a,sampler2D texture){vec2 texCoord=a.texCoord;float x=uTexRange.x+texCoord.x*uTexRange.y;vec4 b=getTextureColor(texture,vec2(x,texCoord.y));x=uTexRange.z+texCoord.x*uTexRange.w;vec4 c=getTextureColor(texture,vec2(x,texCoord.y));return vec4(c.rgb,b.r);}"},function(e,t){e.exports="\n#ifdef USE_FILTER\nstruct Particle{vec2 texCoord;vec2 texOffset;float lifetime;float seed;};\n#endif\nuniform float uStrength;float a(float b){if(b<=0.5) b=b*b*2.0;else b=1.0-((1.0-b)*(1.0-b)*2.0);return b;}vec4 main_filter(Particle c,sampler2D texture){const vec3 d=vec3(0.299,0.587,0.114);vec2 texCoord=c.texCoord;vec2 texOffset=c.texOffset;\n#define texG(x,y) texture2D(texture,texCoord + vec2(x,y) * texOffset).g\nvec3 e=texture2D(texture,texCoord).rgb;float f=e.g*20.0;f+=texG(0.,-10.);f+=texG(0.,10.);f+=texG(10.,0.);f+=texG(-10.,0.);f+=texG(5.,-8.);f+=texG(5.,8.);f+=texG(-5.,8.);f+=texG(-5.,-8.);f+=texG(8.,5.);f+=texG(8.,-5.);f+=texG(-8.,5.);f+=texG(-8.,-5.);f+=texG(0.,-6.)*2.0;f+=texG(0.,6.)*2.0;f+=texG(6.,0.)*2.0;f+=texG(-6.,0.)*2.0;f+=texG(-4.,-4.)*2.0;f+=texG(-4.,4.)*2.0;f+=texG(4.,-4.)*2.0;f+=texG(4.,4.)*2.0;f=f/48.0;float g=e.g-f+0.5;for(int h=0;h<5;h++){g=a(g);}float i=dot(e,d);float j=pow(i,1./uStrength);vec3 k=e+(e-vec3(g))*j*0.1;return vec4(mix(k.rgb,max(k,e),j),1.0);}"},function(e,t){e.exports="precision mediump float;\n#define SHADER_VERTEX 1\n\n#ifdef SHADER_VERTEX\n\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uVCurveValues\n\n#else\n\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n\n#define CURVE_VALUE_ARRAY uFCurveValues\n\n#endif\n\n#if CURVE_VALUE_COUNT\n\n#ifdef LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n\n#endif\n\n#endif\n\n#ifdef SHADER_VERTEX\nattribute float aSeed;varying float vSeed;\n#define NONE_CONST_INDEX 1\n\n#else\n\n#ifdef LOOKUP_TEXTURE_CURVE\n\n#define NONE_CONST_INDEX 1\n\n#endif\n\n#endif\n\n#ifdef NONE_CONST_INDEX\n\n#define MAX_C  MAX_KEY_FRAME_COUNT\n\n#else\n\n#define MAX_C  CURVE_VALUE_COUNT\n\n#endif\n\n#ifdef USE_CURVE_VALUE\nfloat a(float b,vec4 c,vec4 d){float e=d.x-c.x;float f=c.w*e;float g=d.z*e;float h=(b-c.x)/e;float i=h*h;float j=i*h;return dot(vec4(dot(vec3(2.,-3.,1.),vec3(j,i,1.)),dot(vec3(1,-2.,1),vec3(j,i,h)),j-i,dot(vec2(-2,3),vec2(j,i))),vec4(c.y,f,g,d.y));}float k(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q==o){return lookup_curve(o).y;}vec4 r=lookup_curve(q+n);vec4 s=lookup_curve(q+1+n);\n#else\nif(q<n){continue;}vec4 r=lookup_curve(q);vec4 s=lookup_curve(q+1);if(q==p){return r.y;}\n#endif\nif(b>=r.x&&b<=s.x){return a(b,r,s);}}return lookup_curve(0).y;}\n#endif\n\n#ifdef USE_LINE_SEG\nfloat t(float h,vec2 u,vec2 v){return u.y+(v.y-u.y)*(h-u.x)/(v.x-u.x);}float w(float b,float l,float m){int n=int(l);int o=int(m-1.);int p=n+o;for(int q=0;q<MAX_C;q++){\n#ifdef NONE_CONST_INDEX\nif(q>o){return lookup_curve(q).w;}\n#else\nif(q<n){continue;}if(q>p){return lookup_curve(q-2).w;}\n#endif\n#ifdef NONE_CONST_INDEX\nvec4 x=lookup_curve(q+n);\n#else\nvec4 x=lookup_curve(q);\n#endif\nvec2 u=x.xy;vec2 v=x.zw;if(b>=u.x&&b<=v.x){return t(b,u,v);}\n#ifdef NONE_CONST_INDEX\nvec2 y=lookup_curve(q+n+1).xy;\n#else\nvec2 y=lookup_curve(q+1).xy;\n#endif\nif(b>v.x&&b<=y.x){return t(b,v,y);}}return lookup_curve(0).y;}\n#endif\nfloat getValueFromTime(float b,vec4 z){float A=z.x;if(A==0.){return z.y;}else if(A==1.){return mix(z.y,z.z,b/z.w);}\n#ifdef USE_LINE_SEG\nif(A==3.){return w(b,z.y,z.z);}\n#endif\n#ifdef USE_CURVE_VALUE\nif(A==2.){return k(b,z.y,z.z);}\n#endif\nif(A==4.){\n#ifdef SHADER_VERTEX\nfloat seed=aSeed;\n#else\nfloat seed=vSeed;\n#endif\nreturn mix(z.y,z.z,seed);}return 0.;}attribute vec4 aPos;attribute vec3 aDir;attribute vec4 aInfo;attribute vec4 aColor;\n#ifdef ATTR_TRAIL_START\nattribute float aTrailStart;\n#else\nuniform float uTrailStart[64];attribute float aTrailStartIndex;\n#endif\nuniform mat4 uView;uniform mat4 uModel;uniform mat4 uViewProjection;uniform vec4 uTextureMap;uniform float uTime;uniform vec4 uParams;uniform vec4 uColorParams;uniform vec4 uOpacityOverLifetimeValue;uniform vec4 uWidthOverTrail;\n#ifdef COLOR_OVER_TRAIL\nuniform sampler2D uColorOverTrail;\n#endif\n\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\nvarying float vLife;varying vec2 vTexCoord;varying vec4 vColor;void main(){vec4 B=uViewProjection*vec4(aPos.xyz,1.);vec4 C=uViewProjection*vec4(aPos.xyz+aDir,1.);vec2 D=normalize(C.xy/C.w-B.xy/B.w);vec2 E=vec2(-D.y,D.x);vec4 F=uModel*vec4(aPos.xyz,1.);\n#ifdef ATTR_TRAIL_START\nfloat G=aTrailStart;\n#else\nfloat G=uTrailStart[int(aTrailStartIndex)];\n#endif\nfloat H=(G-aInfo.z)/uParams.y;float I=aPos.w*getValueFromTime(H,uWidthOverTrail)/max(abs(E.x),abs(E.y));F.xyz+=(uView[0].xyz*E.x+uView[1].xyz*E.y)*I;float b=min((uTime-aInfo.x)/aInfo.y,1.0);gl_Position=uViewProjection*F;vColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(b,0.));\n#endif\n#endif\n#ifdef COLOR_OVER_TRAIL\nvColor*=texture2D(uColorOverTrail,vec2(H,0.));\n#endif\nvColor.a*=clamp(getValueFromTime(b,uOpacityOverLifetimeValue),0.,1.);vLife=b;vTexCoord=uTextureMap.xy+vec2(H,aInfo.w)*uTextureMap.zw;vSeed=aSeed;}"},function(e,t){e.exports="precision highp float;\n#define SHADER_VERTEX 1\nattribute vec4 aPoint;attribute float aIndex;uniform vec4 uParams;uniform vec4 uPos[8];uniform vec4 uRot[8];uniform vec4 uColor[8];uniform vec4 uTexParams[8];uniform mat4 uModel;uniform mat4 uView;uniform mat4 uViewProjection;\n#ifdef PREVIEW_BORDER\nuniform vec4 uPreviewColors[8];varying vec4 vPreviewColor;\n#endif\nvarying vec4 vColor;varying vec4 vTexCoord;varying vec2 vParams;const float a=3.141592653589793/180.;mat3 b(vec3 c){vec3 d=sin(c*a);vec3 e=cos(c*a);return mat3(1.,0.,0.,0,e.x,-d.x,0.,d.x,e.x)*mat3(e.y,0.,d.y,0.,1.,0.,-d.y,0,e.y)*mat3(e.z,-d.z,0.,d.z,e.z,0.,0.,0.,1.);}void main(){int f=int(aIndex);vec4 g=uTexParams[f];float h=g.w;if(h<0.||h>1.){gl_Position=vec4(3.,3.,3.,1.);}else{vec4 i=uRot[f];vec4 j=uPos[f];vec3 k=b(i.xyz)*vec3(aPoint.xy*vec2(j.w,i.w),0.);vec4 l=vec4(j.xyz,1.0);float m=g.z;if(m==0.){l=uModel*l;l.xyz+=uView[0].xyz*k.x+uView[1].xyz*k.y;}else if(m==1.){l.xyz+=k;l=uModel*l;}else if(m==2.){l=uModel*l;l.xy+=k.xy;}else if(m==3.){l=uModel*l;l.xyz+=uView[0].xyz*k.x+uView[2].xyz*k.y;}gl_Position=uViewProjection*l;vTexCoord=vec4(aPoint.zw,g.xy);vColor=uColor[f];\n#ifdef PREVIEW_BORDER\nvPreviewColor=uPreviewColors[f];\n#endif\nvParams=vec2(aIndex,uParams.z);}}"},function(e,t){e.exports="precision mediump float;varying vec4 vColor;varying vec4 vTexCoord;varying vec2 vParams;uniform sampler2D uSamplers[8];\n#ifdef PREVIEW_BORDER\nvarying vec4 vPreviewColor;\n#endif\nvec4 a(float b,vec2 c);void main(){vec4 d=vec4(1.0);float b=ceil(vParams.x);d=a(b,vTexCoord.xy);if(vTexCoord.w>0.){d=vec4(1.,1.,1.,d.r*d.a);}d*=vColor;if(vParams.y>0.){d.rgb*=d.a;}\n#ifdef PREVIEW_BORDER\nif(vTexCoord.x<0.05||vTexCoord.x>0.95||vTexCoord.y<0.05||vTexCoord.y>0.95){gl_FragColor=vPreviewColor;}else{\n#endif\nif(vTexCoord.z==0.&&d.a<0.01){discard;}else{gl_FragColor=d;}\n#ifdef PREVIEW_BORDER\n}\n#endif\n}vec4 a(float b,vec2 c){\n#define t_tex(i, c) return texture2D(uSamplers[i], c)\nif(b<4.){if(b==0.){t_tex(0,c);}else if(b==1.){t_tex(1,c);}else if(b==2.){t_tex(2,c);}t_tex(3,c);}else if(b<6.){if(b==4.){t_tex(4,c);}t_tex(5,c);}else if(b==6.){t_tex(6,c);}t_tex(7,c);\n#undef t_tex\n}"},function(e,t,n){"use strict";n.r(t);n(3),n(48);var i=n(12);for(var r in i)["default"].indexOf(r)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(r)},function(e,t,n){"use strict";var i,r,a,o=n(11),s=n(0),u=n(3),c=n(4);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var h=((i={})[c.a.FLOAT]=Float32Array,i[c.a.UNSIGNED_INT]=Uint32Array,i[c.a.INT]=Int32Array,i[c.a.UNSIGNED_SHORT]=Uint16Array,i),d=((r={})[c.a.UNSIGNED_BYTE]=u.n.UInt8,r[c.a.UNSIGNED_SHORT]=u.n.UInt16,r[c.a.UNSIGNED_INT]=u.n.UInt32,r),_=function(){this.vertexBufferMap={},this.dataMaps={},this.updateFlags={}},p=function(){this.updateFlag={start:Number.MAX_SAFE_INTEGER,end:Number.MIN_SAFE_INTEGER}},m=function(e){function t(){return e.apply(this,arguments)||this}return f(t,e),t.prototype.render=function(){this.geometry&&this.geometry._update(),u.m.prototype.render.apply(this,arguments)},t}(u.m),v=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).updateBufferWithDiscard=!1,t._vertexData=new _,t._indexData=new p,t}f(t,e);var n,i,r,a=t.prototype;return a.getAttributeNames=function(){return this._attrNames},a.getAttributeSize=function(e){return this._primitive._vertexElementMap[e].elementInfo.size},a.getAttributeData=function(e){return this._vertexData.dataMaps[e]},a.setAttributeData=function(e,t){var n=this._vertexData,i=n.dataMaps,r=n.updateFlags[e];i[e]=t,this.updateBufferWithDiscard||(r.start=0,r.end=t.length)},a.setAttributeSubData=function(e,t,n){var i=this._vertexData,r=i.dataMaps,a=i.updateFlags;r[e].set(n,t),this.updateBufferWithDiscard||this._compareUpdateFlag(a[e],t,t+n.length)},a.setIndexSubData=function(e,t){this._indexData.indexBufferData.set(t,e),this.updateBufferWithDiscard||this._compareUpdateFlag(this._indexData.updateFlag,e,e+t.length)},a.setIndexData=function(e){if(this._indexData.indexBufferData=e,!this.updateBufferWithDiscard){var t=this._indexData.updateFlag;t.start=0,t.end=e.length}},a.getIndexData=function(){return this._indexData.indexBufferData},a.resetData=function(){var e=this,t=this._vertexData.dataMaps;Object(s.d)(t,(function(t,n){e.setAttributeData(n,new t.constructor(0))}));var n=this.getIndexData();this.setIndexData(new n.constructor(0))},a.initialize=function(e,n,i){var r=this,a=this._vertexData,o=a.dataMaps,l=a.vertexBufferMap,f=a.updateFlags,_=0,p=[];if(Object(s.d)(e,(function(e,n){var a=t._vertexSizeMap[e.size],s=new u.I(n,0,a,_),c=s.elementInfo,d=c.type,m=c.size,v=new h[d](e.data||0);f[n]={start:Number.MAX_SAFE_INTEGER,end:Number.MIN_SAFE_INTEGER},o[n]=v;var g=new u.c(i,u.d.VertexBuffer,0,u.f.Dynamic);l[n]=g,r.setVertexBufferBinding(new u.H(g,4*m),_++),p.push(s),r.setAttributeData(n,v)})),this.setVertexElements(p),this._attrNames=Object.keys(o),n){var m=new u.c(i,u.d.IndexBuffer,0,u.f.Dynamic),v=n.type||c.a.UNSIGNED_SHORT,g=this._indexData,y=new h[v](n.data||0);g.indexBufferData=y,g.indexBuffer=m,this.setIndexBufferBinding(m,d[v]),this.setIndexData(y)}return this},a._update=function(){var e=this._vertexData,t=e.dataMaps,n=e.vertexBufferMap,i=e.updateFlags;for(var r in n){var a=n[r],o=t[r],s=o.byteLength;if(s>a.byteLength&&a.resize(s),this.updateBufferWithDiscard)a.setData(o,0,0,o.length,u.A.Discard);else{var c=i[r],l=c.start,f=c.end;l!=Number.MAX_SAFE_INTEGER&&(a.setData(o,4*l,l,f-l),c.start=Number.MAX_SAFE_INTEGER,c.end=Number.MIN_SAFE_INTEGER)}}var h=this._indexData,d=h.indexBuffer;if(d){var _=h.indexBufferData,p=_.byteLength;if(p>d.byteLength&&d.resize(p),this.updateBufferWithDiscard)d.setData(_,0,0,_.length,u.A.Discard);else{var m=h.updateFlag,v=m.start,g=m.end;v!=Number.MAX_SAFE_INTEGER&&(d.setData(_,v*_.BYTES_PER_ELEMENT,v,g-v),m.start=Number.MAX_SAFE_INTEGER,m.end=Number.MIN_SAFE_INTEGER)}}},a._compareUpdateFlag=function(e,t,n){e.start=Math.min(e.start,t),e.end=Math.max(e.end,n)},a.destroy=function(){this._primitive&&(this._primitive.destroy(!0),this._primitive=null),this._vertexData&&Object(s.d)(this._vertexData.vertexBufferMap,(function(e){e.destroy(!0)})),this._indexData&&this._indexData.indexBuffer.destroy(!0),this._indexData=this._vertexData=null},n=t,(i=[{key:"drawCount",get:function(){return this.subGeometry.count},set:function(e){this.subGeometry.count=e}},{key:"drawStart",get:function(){return this.subGeometry.offset},set:function(e){this.subGeometry.offset=0}}])&&l(n.prototype,i),r&&l(n,r),t}(u.e);v._vertexSizeMap={1:u.J.Float,2:u.J.Vector2,3:u.J.Vector3,4:u.J.Vector4};var g,y,x=((a={})[c.a.LINES]=u.u.Lines,a[c.a.TRIANGLE_FAN]=u.u.TriangleFan,a[c.a.TRIANGLE_STRIP]=u.u.TriangleStrip,a[c.a.LINE_STRIP]=u.u.LineStrip,a[c.a.LINE_LOOP]=u.u.LineLoop,a[c.a.POINTS]=u.u.Points,a);var T={float:u.h.FLOAT,vec2:u.h.FLOAT_VEC2,vec3:u.h.FLOAT_VEC3,vec4:u.h.FLOAT_VEC4,bool:u.h.BOOL,mat2:u.h.FLOAT_MAT2,mat3:u.h.FLOAT_MAT3,mat4:u.h.FLOAT_MAT4,int:u.h.INT,sampler2D:u.h.SAMPLER_2D,samplerCube:u.h.SAMPLER_CUBE},b=((g={})[c.a.FLOAT]=u.h.FLOAT_ARRAY,g[c.a.FLOAT_VEC2]=u.h.FLOAT_VEC2_ARRAY,g[c.a.FLOAT_VEC3]=u.h.FLOAT_VEC3_ARRAY,g[c.a.FLOAT_VEC4]=u.h.FLOAT_VEC4_ARRAY,g[c.a.SAMPLER_2D]=u.h.SAMPLER_2D_ARRAY,g);var E=function(e){var t,n;function i(t,n){var i;return(i=e.call(this,n.engine,n.name)||this)._technique=t,i.renderType=u.p.TRANSPARENT,i.renderOrder=n.renderOrder,i.shaderCacheId=n.shaderCacheId,i}return n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n,i.prototype.setValue=function(t,n){var i=this._technique;if(i){var r=i.uniforms[t];if(r){var a=r._tempVal;Object(s.g)(a)&&(n=a.setValueByArray(n))}}e.prototype.setValue.call(this,t,n)},i}(u.o),A=((y={})[u.h.FLOAT_VEC2]=u.E,y[u.h.FLOAT_MAT3]=u.s,y[u.h.FLOAT_MAT4]=u.r,y[u.h.FLOAT_VEC3]=u.F,y[u.h.FLOAT_VEC4]=u.G,y);var O={get:function(){return!1},set:function(){}};function C(e,t,n){var i={};return function e(t,n,i,r){var a=t.precompile(),o=[];if(a){a.particleMesh&&o.push(a.particleMesh),a.trailMesh&&o.push(a.trailMesh);var s=a.spriteItem;if(s){var u=s.shaderCacheId;if(-1===n.indexOf(u)){var c=a.createMesh(i);o.push(c),n.push(u),c.geometry.destroy()}}}for(var l=0;l<o.length;l++){var f=o[l],h=f.material.shaderCacheId;if(!r[h]){var d=f.material._technique;R(d,i)?r[h]=d:f.disabled=!0}}t._items.forEach((function(t){return e(t,n,i,r)}))}(e,[],t,i),i}function R(e,t){return u.k.requireProgram(e,t._hardwareRenderer.gl)}function S(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var w=function(){function e(e){var t=this.engine=e.engine;this.gl=t._hardwareRenderer.gl,this._container=e.container,this.unsedNode=[],this._tempVPMat4=new u.r,this.parent=e.parent,this.independentEmitter=e.independentEmitter,this.cameraLayer=e.cameraLayer,e.cameraComp?this.cameraComp=e.cameraComp:this.cameraLayer&&this.createCamera()}var t,n,i,r=e.prototype;return r.createRenderNode=function(e){var t=this.parent.createRenderNode(e);return t&&M(t,this.cameraLayer),t},r.createCamera=function(){var e=this._cameraNode=this._container.createChild("camera:"+this.cameraLayer),t=this.cameraComp=e.addComponent(u.g);this.cameraLayer&&(t.cullingMask=e.layer=this.cameraLayer),t.setClearMode(0),e.transform.lookAt(new u.F)},r.setRootNode=function(e){this._rootNode&&(this._container.removeChild(this._rootNode),this.destroyNode(this._rootNode),this._rootNode.addChild=s.j),this._rootNode=e,e&&(M(e,this.cameraLayer),this._container.addChild(e))},r.dispose=function(){this.unsedNodes&&(this.unsedNodes.forEach((function(e){e.destroy()})),this.unsedNodes.length=0)},r.destroyTexture=function(e){e&&e.destroy&&e.destroy()},r.getParticleOptions=function(){return{engine:this.engine,independentEmitter:this.independentEmitter}},r.getViewProjection=function(){var e=this.cameraComp;if(e){var t=this._tempVPMat4;return u.r.multiply(e.projectionMatrix,e.viewMatrix,t),t.elements}return new Float32Array(16)},r.precompile=function(e){return C(e,this.engine)},r.destroyPrecompiled=function(e){var t,n;t=e,n=this.engine,Object(s.d)(t,(function(e,t){n.renderhardware.assetsCache.requireObject(e,u.l).finalize(!0)}))},r.destroyNode=function(e){this.unsedNodes||(this.unsedNodes=[]),this._rootNode&&this._rootNode.removeChild(e),e.destroy&&Object(s.a)(this.unsedNodes,e)},r.destroy=function(){this.parent&&(this.setRootNode(null),this._cameraNode&&this._cameraNode.destroy(),this._container=this.parent=null),this.dispose()},t=e,(n=[{key:"camera",get:function(){return this._camera},set:function(e){var t=this._camera={near:e.near||.1,far:e.far||20,fov:e.fov||60},n=this.cameraComp;if(n){var i=n.entity.transform,r=e.position||[0,0,0];r&&(t.position=[r[0],r[1],r[2]],i.setPosition(r[0],r[1],r[2]));var a=e.rotation||[0,0,0];a&&(t.rotation=[a[0],a[1],a[2]],i.setRotation(a[0],a[1],a[2])),n.aspectRatio=this.canvas.width/this.canvas.height,n.farClipPlane=t.far,n.nearClipPlane=t.near,n.fieldOfView=t.fov}}},{key:"canvas",get:function(){return this.gl.canvas}}])&&S(t.prototype,n),i&&S(t,i),e}();function M(e,t){t&&(e.layer=t,e.children.forEach((function(e){return M(e,t)})))}function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var L=Math.pow(2,-31),I=u.q.degreeToRadFactor,F=Math.cos,N=Math.sin,D=new u.v,z=function(e){var t,n;function i(t,n){var i;return(i=e.call(this,n,t.name)||this).setMeshes([]),Object(s.k)(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(i),t),i._isViewMatrixDirty=i.transform.registerWorldChangeFlag(),i.addComponent(u.z).onUpdate=function(){i._dirty&&(i._setMeshes(i._omeshes),i._empMeshes=null,i._dirty=!1)},i}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r,a,o,c=i.prototype;return c.getChildByName=function(e){return this.findByName(e)},c.getModelMatrix=function(){return this.transform.localMatrix.elements},c.setMeshes=function(e){this._dirty=!0,this._omeshes=e},c._setMeshes=function(){var e=this,t={},n=[];this._omeshes.map((function(i){if(!i.disabled){var r=e.addComponent(m);r.geometry=i.geometry,r.material=i.material;var a=i.material.renderOrder||0,o=t[a];isNaN(o)?t[a]=1:(t[a]++,a+=o*L),r.renderPriority=a,i._component=r,n.push(r)}})),this._meshRenderers&&this._meshRenderers.forEach((function(e){return e.destroy()})),this._meshRenderers=n},c.removeMesh=function(e){var t=this.getMeshes(),n=t.indexOf(e);n>-1&&(t.splice(n,1),this.setMeshes(t))},c.getMeshes=function(){return this._omeshes},c.addChild=function(t){e.prototype.addChild.call(this,t),M(t,this.layer)},c.addMesh=function(e,t){var n=this.getMeshes();isNaN(t)?n.push(e):n.splice(t,0,e),this.setMeshes(n)},c.setPosition=function(e,t,n){this.transform.setPosition(e,t,n)},c.setRotation=function(e,t,n){this._rotationEuler(e*I,t*I,n*I),this.transform.setRotationQuaternion(D.x,D.y,D.z,D.w)},c.setScale=function(e,t,n){this.transform.setScale(e,t,n)},c.updateMatrixWorld=function(){this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,this.transform.worldMatrix)},c.getWorldMatrix=function(){return this.transform.worldMatrix.elements},c.destroy=function(){var t;e.prototype.destroy.call(this),null==(t=this._meshRenderers)||t.forEach((function(e){return e.destroy()}))},c._rotationEuler=function(e,t,n){var i=F(e/2),r=F(t/2),a=F(n/2),o=N(e/2),s=N(t/2),u=N(n/2);D.x=o*r*a-i*s*u,D.y=i*s*a+o*r*u,D.z=i*r*u-o*s*a,D.w=i*r*a+o*s*u},r=i,(a=[{key:"visible",get:function(){return this.isActive},set:function(e){this.isActive=!!e}}])&&P(r.prototype,a),o&&P(r,o),i}(u.j);z.prototype.isNode=!0;var V=u.j.prototype.createChild;function B(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}u.j.prototype.createChild=function(){var e=V.apply(this,arguments);return e.layer=this.layer,e};var U=function(){function e(e){this.canvas=e,this._cl=0}var t,n,i,r=e.prototype;return r.invalid=function(){this._invalid=!0},r.getChildByName=function(e){return this.engine.sceneManager.activeScene.rootEntities.find((function(t){return t.name===e}))},r.createFramebuffer=function(e){throw Error("not implement")},r.destroyFramebuffer=function(e,t){throw Error("not implement")},r.init=function(e){this.pixelRatio=e.pixelRatio;var t,n=this.canvas;if(n){try{this.resize(n.width,n.height),t=this.engine=new u.i(new u.K(n),new u.M({alpha:e.alpha,preserveDrawingBuffer:!!e.preserveDrawingBuffer,stencil:!0,webGLMode:u.L.WebGL1}))}catch(e){}if(t){var i=t.sceneManager.activeScene,r=t.createEntity();i.addRootEntity(r),this._rootNode=r,r.addComponent(u.a),t.update(),this.init=s.j}}},r.loadGLTFFilesAsync=function(e){var t=this,n=this.engine;if(!n)return Promise.reject("lost webgl");var i=n.resourceManager,r={};return this._gltfMap&&(this._gltfMap={}),Promise.all(e.map((function(e){return i.load({url:e,type:u.b.Perfab}).then((function(t){return r[e]=t}))}))).then((function(){return t._resetGLTFMap(r,n)}))},r._resetGLTFMap=function(e,t){var n=this;function i(e){var t=e.getComponent(u.g);e.children.forEach(i),t&&t.destroy()}return this._gltfMap=e,Object(s.d)(this._gltfMap,(function(e){i(e.defaultSceneRoot);var r=n._rootNode.addComponent(u.g);!function(e,t,n){e.nodes.forEach((function(e){e._components.forEach((function(e){if(e instanceof u.t){var i=e.mesh.primitives,r=e._sharedMaterials;if(i)for(var a=0,o=r.length;a<o;a++){var s=r[a];if(s){var c=u.w._getRenderContext(n);s.prepareDrawing(c,e,i[a]),R(s.technique,t)}}}}))}))}(e,t,r),r.destroy()})),e},r.createRenderNode=function(e){var t=this._gltfMap[e.gltf];if(t){var n=t.defaultSceneRoot;if(e.root){var i=n.findByName(e.root);i&&(n=i)}var r=new z({name:e.name},this.engine);return r.addChild(n.clone()),r}},r.createCompositionRenderer=function(){var e=this._cl++;return new w({engine:this.engine,parent:this,container:this._rootNode,cameraLayer:1<<e%16+1})},r.resize=function(e,t){var n=this.pixelRatio||1;if(this.engine){var i=this.engine.canvas;i.width=e*n,i.height=t*n}var r=this.canvas;r.width=e*n,r.height=t*n,r.style.width=e+"px",r.style.height=t+"px"},r.render=function(){if(this._invalid){var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this.engine.update(),this._invalid=!1}},r.destroy=function(e){this.engine&&(this.engine.destroy(),this.engine=null)},t=e,(n=[{key:"gl",get:function(){return this.engine._hardwareRenderer.gl}},{key:"isInvalid",get:function(){return this._invalid}},{key:"supportWebGL",get:function(){return!!this.engine}}])&&B(t.prototype,n),i&&B(t,i),e}(),k=n(16);var G=1,j=[],H=function(e){var t,n;function i(t){var n;n=e.call(this,t)||this;var i=t._hardwareRenderer,r=i.gl;return n._rhi=i,n._target=r.TEXTURE_2D,n._glTexture=r.createTexture(),j.push(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(n)),n}n=e,(t=i).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var r=i.prototype;return r._createTexture=function(e){var t=e.image=this.resizeImage(e.image),n=e.format,i=e.type,r=e.data,a=this._rhi.gl,o=(t||r).width,u=(t||r).height;return a.bindTexture(a.TEXTURE_2D,this._glTexture),r?(this.isDataTexture=!0,a.texImage2D(a.TEXTURE_2D,0,n,o,u,0,n,i,r.data)):(a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,+e.flipY),a.texImage2D(a.TEXTURE_2D,0,n,n,i,t),Object(s.g)(t)&&t.videoWidth&&(o=t.videoWidth,u=t.videoHeight),Object(k.a)(o)&&Object(k.a)(u)&&a.generateMipmap(a.TEXTURE_2D)),this._width=o,this._height=u,a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e.minFilter),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e.magFilter),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,e.wrapS),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,e.wrapT),a.bindTexture(a.TEXTURE_2D,null),this},r.bufferVideo=function(e){var t=this._rhi,n=this._glTexture;if(t&&n){var i=t.gl;e&&(i.bindTexture(i.TEXTURE_2D,n),i.texImage2D(i.TEXTURE_2D,0,i.RGB,i.RGB,i.UNSIGNED_BYTE,e))}},r.destroy=function(){e.prototype.destroy.call(this),this._glTexture=null,Object(s.c)(j,this)},r.resizeImage=function(e){if(e){var t=e.width,n=e.height,i=Object(k.b)(t),r=Object(k.b)(n);if(r!==n||i!==t){var a=document.createElement("canvas");return a.width=i,a.height=r,a.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i,r),console.warn("image resize from "+t+"x"+n+" to "+i+"x"+r),a}return e}},i}(u.B),W=function(){function e(e){this.options=e,this.isTextureContainer=!0,this.id=G++}var t=e.prototype;return t.updateVideo=function(){var e=this.options;e.isVideo&&this._texture&&this._texture.bufferVideo(e.image)},t.init=function(e){var t=this;if(!this._texture){var n=this.options;if(n.src){var i=this._texture=new H(e);Object(s.i)(n.src).then((function(e){var n=t.options;i._createTexture(Object(s.k)({},n,{data:null,image:e}))}))}else this._texture=n.compressed?function(e,t){var n=Object(u.N)(e.data),i=n.width,r=n.height,a=n.mipmaps,o=n.engineFormat,s=new u.C(t,i,r,o,!1);if(s._glTexture)for(var c=0;c<a.length;c++){var l=a[c],f=l.width,h=l.height,d=l.data;s.setPixelBuffer(d,c,0,0,f,h)}return s}(n,e):new H(e)._createTexture(n),n.isVideo&&n.image.addEventListener("ended",(function(e){n.isVideo=!1,n.image=null,e.target.src=""}));this._texture.isGCIgnored=!0,this._texture.id=this.id}return this._texture},t.destroy=function(){this._texture&&(this._texture.destroy(),this._texture=null)},e}();function X(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}Object.defineProperty(u.B.prototype,"isTexture",{value:!0,writable:!1,enumerable:!1});var q=function(){function e(e,t){Object(s.k)(this,e),this.engine=t}var t,n,i,r=e.prototype;return r.setUniformValue=function(e,t){this.material.setValue(e,t)},r.getUniformValue=function(e){return this.material.getValue(e)},r.getUniformValues=function(){return this.material._values},r.setUniformValues=function(e){var t=this.material;Object(s.d)(e,(function(e,n){t.setValue(n,e)}))},r.destroy=function(){this.geometry.destroy(),this.material.destroy(!0),this._component&&this._component.destroy()},t=e,(n=[{key:"disabled",get:function(){return this._disabled},set:function(e){this._component&&e&&this._component.destroy(),this._disabled=e}},{key:"isMesh",get:function(){return!0}}])&&X(t.prototype,n),i&&X(t,i),e}();["x","y","z","w"].forEach((function(e,t){var n={set:function(t){this[e]=t},get:function(){return this[e]}};Object.defineProperty(u.G.prototype,t+"",n),Object.defineProperty(u.F.prototype,t+"",n),Object.defineProperty(u.E.prototype,t+"",n)}));var K={Mesh:q,Node:z,Geometry:v,createMatrix4:function(){return new u.r},constants:c.a,createTextureContainer:function(e){return new W(e)},createMaterial:function(e){var t=function(e,t){for(var n,i=/\buniform[\s\t]+((float|mat|vec|bool|int|sampler2D|samplerCube)[234]?)[\s\t]+([\w_\d]+)\b/gm,r={};n=i.exec(e);){r[n[3]]=T[n[1]]}for(;n=i.exec(t);){r[n[3]]=T[n[1]]}return r}(e.fragmentShader,e.vertexShader),n={};Object(s.d)(e.uniforms,(function(e,i){Object(s.f)(e)?n[i]={name:i,type:e||t[i]}:Object(s.h)(e)?n[i]={name:i,type:t[i],semantic:u.D[e]}:e instanceof Array&&(n[i]={name:i,type:b[e[0]]});var r=n[i].type,a=A[r];a&&(n[i]._tempVal=new a)})),e.samplers.forEach((function(e){if(Object(s.h)(e))n[e]={name:e,type:t[e]};else{var i=e;e=i.name;var r=i.type;n[e]={name:e,type:Array.isArray(r)?b[r[0]]:r}}}));var i=function(e){for(var t,n=/\battribute[\s\t]+((float|mat|vec|bool|int)[234]?)[\s\t]+([\w_\d]+)\b/gm,i={};t=n.exec(e);){i[t[3]]=T[t[1]]}return i}(e.vertexShader),r={};e.attributes.forEach((function(e){if(e.indexOf("#")>-1){var t=e.split("#");e=t[0],r[t[0]]={name:e,type:i[e],semantic:t[1]}}else r[e]={name:e,type:i[e],semantic:e}}));var a=new u.y(e.name);a.isValid=!0,a.attributes=r,a._uniforms=n,a.vertexShader=e.vertexShader,a.fragmentShader=e.fragmentShader,a.autoConvert=!1;var o=e.states,l=o.side||1032,f=o.stencilTest;return a.states={disable:[],enable:[u.x.BLEND],functions:{depthMask:[o.depthMask],frontFace:[c.a.CCW]}},1032===l?a.states.disable.push(u.x.CULL_FACE):1028===l?a.states.functions.cullFace=[c.a.BACK]:1029===l&&(a.states.functions.cullFace=[c.a.FRONT]),o.blendEquation&&(a.states.functions.blendEquationSeparate=[o.blendEquation,o.blendEquationAlpha]),"blendDstAlpha"in o||(o.blendDstAlpha=c.a.ONE_MINUS_SRC_ALPHA,o.blendSrcAlpha=c.a.ONE),a.states.functions.blendFuncSeparate=[o.blendSrc,o.blendDst,o.blendSrcAlpha,o.blendDstAlpha],f?(a.states.enable.push(c.a.STENCIL_TEST),a.states.functions.stencilFunc=[o.stencilFunc,o.stencilFuncRef,o.stencilFuncMask],a.states.functions.stencilOp=[o.stencilOpFail,o.stencilOpZFail,o.stencilOpZPass],a.states.functions.stencilMask=[o.stencilMask]):a.states.disable.push(c.a.STENCIL_TEST),Object.defineProperty(a,"_needCompile",O),new E(a,e)},createGeometry:function(e,t){var n=new v(t,e.name);return n.initialize(e.attributes,e.index,t),n.addSubGeometry(0,e.drawCount,x[e.mode]),e.combineSubData&&(n.updateBufferWithDiscard=!0),n},createNode:function(e,t){return new z(e,t)},createMesh:function(e){return new q(e,e.engine)},createPlayerRenderer:function(e){return new U(e)},OasisCompositionRenderer:w,texCaches:j};"object"==typeof window&&(window.__MarsRI__=K);if(Object(o.b)()){var Y=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(e){return"WEBGL_compressed_texture_astc"===e?null:Y.apply(this,arguments)}}Object(s.e)(Object.values)||(Object.values=function(e){return Object.keys(e).map((function(t){return e[t]}))})}])}));
